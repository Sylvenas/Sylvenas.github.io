webpackJsonp([0xa13a206da4c8],{548:function(n,s){n.exports={data:{markdownRemark:{html:'<h3 id="应用场景"><a href="#%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>应用场景</h3>\n<p>现在前端主流的技术方案都是<a href="https://www.freecodecamp.org/news/what-exactly-is-client-side-rendering-and-hows-it-different-from-server-side-rendering-bd5c786b340d/">服务端渲染</a>，那就面临着一个问题，Node.js需要承担接口转发的任务，所以原来的<a href="https://www.freecodecamp.org/news/what-exactly-is-client-side-rendering-and-hows-it-different-from-server-side-rendering-bd5c786b340d/">客户端渲染</a>的<code class="gatsby-code-text">http</code>请求的路线(brower -> server),需要调整为(Node.js -> server);看上去没有什么本质的区别，无非是原来是又浏览器发起请求，现在改为Node.js发起请求。</p>\n<p>但是高并发呢？举个例子，假如有1000000个请求，原来从browser请求到server,server端如果没有做限流处理，那么部分请求就会一直处于<code class="gatsby-code-text">pendding</code>状态；但是1000000个<code class="gatsby-code-text">pendding</code>是分布在每个客户端上的，所以并没有什么压力；但是如果是Node.js发起的请求，则会出现很大一部分请求在Node.js端处于<code class="gatsby-code-text">pendding</code>状态，则会导致Node.js的CPU和内存占用压力剧增。</p>\n<h3 id="promise-timeout方案"><a href="#promise-timeout%E6%96%B9%E6%A1%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Promise timeout方案</h3>\n<p>前端<code class="gatsby-code-text">http</code>请求的代码一般会添加一个<code class="gatsby-code-text">timeout</code>的时间限制，配合<code class="gatsby-code-text">Promise.race</code>大概的代码思路是：</p>\n<div class="gatsby-highlight">\n      <pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">function</span> <span class="token function">timeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> ms <span class="token operator">=</span> <span class="token number">2000</span><span class="token punctuation">;</span>\n    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            <span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n                code<span class="token punctuation">:</span> <span class="token number">999</span><span class="token punctuation">,</span>\n                msg<span class="token punctuation">:</span> <span class="token template-string"><span class="token string">` 调用接口超时: ></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ms<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">ms`</span></span><span class="token punctuation">,</span>\n            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span><span class="token punctuation">,</span> ms<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\nPromise<span class="token punctuation">.</span><span class="token function">race</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> option<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">timeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>\n        res <span class="token operator">=></span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n        err <span class="token operator">=></span> <span class="token punctuation">{</span>\n            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'请求失败\'</span><span class="token punctuation">)</span>\n            <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n                code<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>\n                msg<span class="token punctuation">:</span> <span class="token string">\'加载失败\'</span><span class="token punctuation">,</span>\n            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">)</span></code></pre>\n      </div>\n<p>上面的代码很简单，借助<code class="gatsby-code-text">Promise.race</code>,如果期望的fetch请求在2000ms内没有返回，则timeout中的<code class="gatsby-code-text">promise</code>会进入<code class="gatsby-code-text">rejected</code>状态，导致整个promise reject,相当于正常的fetch请求我们不会继续处理，直接抛弃了。</p>\n<p>但是事实如此吗？这个被我们抛弃的Promise实际上依然处于<code class="gatsby-code-text">pendding</code>状态，直到http请求结束，promise进入<code class="gatsby-code-text">resolve or reject</code>状态，下图可见，错误日志已经打印出来了，但是http依然处于<code class="gatsby-code-text">pendding</code>的状态；可见<code class="gatsby-code-text">Promise.race</code>并不能真正的”抛弃请求”。内存占用，cpu占用依然存在。</p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/promise-timeout-d1eeb13b949a765178b35954fc0ef954-ce390.jpg"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 840px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 54.706533776301214%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABmklEQVQoz41SDW/rIAzk///FblnXrfmChHwHSMrtTKqqm57eZunEAbYx9qlhHLCsK7ZtwzzPqI1GXhUJb5czKlMnFHUJ3RhorVHXNZqmSf7jOGKapseq3L4hxB1innyJIYFPwGEn91y3tF/jlvxu+40FHDFiURBj4kpfrxj42tRZosPS92nfliUsKxFuigImzzG2LTr+wGpWWJWJG/rNfZdiR2uhen5lMAZ+Gh9Yhx4jvze2DVY6d0xQXz8x2RZeWsSzmXzivaNvmCfyFiuTKnyzeOBe/j/t+e6Je+exsw0q/i/4F7sxNj4ShiOh9x5BEAKcc7wguBfunrnnwBgkcD4gUBmB56KOfd+xLtzzXFVVjctnjrKqUEjz2c+W/ZBVpNGQy1oZi0If0I1NA7M87znEfhgwUDYSp7LzO07ZBTmTaTqZIkfxcYFno7d1wbbMCXN3DGEduoSFwxDMVIcMTSbelAXU+fSC7OWE7C1LohUJyBSjd2yMv4M8+O/wxyp+jpMXZUgBqi9f8XF+5ZfrpHTpCe5C/Qt+KuILm49S9LYMov8AAAAASUVORK5CYII=\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"\n        alt="promise-timeout"\n        title=""\n        src="/static/promise-timeout-d1eeb13b949a765178b35954fc0ef954-a6b71.jpg"\n        srcset="/static/promise-timeout-d1eeb13b949a765178b35954fc0ef954-1839a.jpg 210w,\n/static/promise-timeout-d1eeb13b949a765178b35954fc0ef954-6c621.jpg 420w,\n/static/promise-timeout-d1eeb13b949a765178b35954fc0ef954-a6b71.jpg 840w,\n/static/promise-timeout-d1eeb13b949a765178b35954fc0ef954-ce390.jpg 903w"\n        sizes="(max-width: 840px) 100vw, 840px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>上面的例子是发生在browser,问题不大，因为通常一个页面请求不会超过10个，对于单个用户机器来说，性能完全没有什么问题。</p>\n<p><strong>但是如果上述事件是发生在Node.js请求server的过程中呢？大量的请求堆积在Node.js端，导致机器cpu或者内存占满，别忘了我们是服务端渲染，这个时候，用户打开页面将会异常缓慢(肯本没有机会继续处理页面渲染了)，或者长时间的等待之后502</strong>。</p>\n<blockquote>\n<p>上面的例子是在云音乐项目中实际案例。</p>\n</blockquote>\n<p>所以我们需要找到另外一种解决方案(能真正取消fetch请求的方案)，此时<code class="gatsby-code-text">[AbortController](https://developer.mozilla.org/en-US/docs/Web/API/AbortController)</code>映入眼帘。</p>\n<h3 id="abortcontroller使用方法"><a href="#abortcontroller%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>AbortController使用方法</h3>\n<p>使用方法很简单，直接看文档。\n<a href="https://developer.mozilla.org/en-US/docs/Web/API/AbortController">MDN文档</a><br>\n<a href="https://developers.google.com/web/updates/2017/09/abortable-fetch">Google Developers: abortable-fetch</a></p>\n<p>现在我们已经确定<code class="gatsby-code-text">AbortController</code>可以真正的取消请求，但是对性能的影响呢？下面我们做个实验：</p>\n<h3 id="使用abortcontroller取消-nodejs---java-server的请求"><a href="#%E4%BD%BF%E7%94%A8abortcontroller%E5%8F%96%E6%B6%88-nodejs---java-server%E7%9A%84%E8%AF%B7%E6%B1%82" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用AbortController取消 Node.js -> java server的请求</h3>\n<h4 id="测试代码："><a href="#%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81%EF%BC%9A" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>测试代码：</h4>\n<div class="gatsby-highlight">\n      <pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">const</span> fetch <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'node-fetch\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> AbortController <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'abort-controller\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> controller <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AbortController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> signal <span class="token operator">=</span> controller<span class="token punctuation">.</span>signal<span class="token punctuation">;</span>\n    Promise<span class="token punctuation">.</span><span class="token function">race</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token function">fetchInterface</span><span class="token punctuation">(</span>signal<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">timeout</span><span class="token punctuation">(</span>controller<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>res <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token comment">// console.log(\'请求成功\')</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span> err <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token comment">//console.log(\'请求失败\')</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span>\n\n<span class="token punctuation">}</span>\n<span class="token keyword">function</span> <span class="token function">timeout</span><span class="token punctuation">(</span>controller<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> ms <span class="token operator">=</span> <span class="token number">2000</span>\n    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            <span class="token comment">// 是否取消请求</span>\n            controller<span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n                code<span class="token punctuation">:</span> <span class="token number">999</span><span class="token punctuation">,</span>\n                msg<span class="token punctuation">:</span> <span class="token template-string"><span class="token string">` 调用接口超时: ></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ms<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">ms`</span></span><span class="token punctuation">,</span>\n            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span><span class="token punctuation">,</span> ms<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">fetchInterface</span><span class="token punctuation">(</span>signal<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">\'http://xx.xx.xx.xx:xxxx/fiveseconds\'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n        signal\n    <span class="token punctuation">}</span><span class="token punctuation">)</span>\n        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>response<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token comment">// handle success</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span>\n        <span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token comment">// handle error</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n\n\n<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> index <span class="token operator">&lt;</span> <span class="token number">10000</span><span class="token punctuation">;</span> index<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// 全部延迟到6s之后关闭进程</span>\n<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'测试结束\'</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">6000</span><span class="token punctuation">)</span></code></pre>\n      </div>\n<h4 id="nodejs-进程性能监控"><a href="#nodejs-%E8%BF%9B%E7%A8%8B%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Node.js 进程性能监控</h4>\n<h5 id="监控工具"><a href="#%E7%9B%91%E6%8E%A7%E5%B7%A5%E5%85%B7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>监控工具</h5>\n<p>Node.js 版本 - v10.16.3<br>\n<a href="https://github.com/nearform/node-clinic">node-clinic</a></p>\n<p>测试命令：<code class="gatsby-code-text">clinic doctor -- node abort.js</code></p>\n<h5 id="测试方法"><a href="#%E6%B5%8B%E8%AF%95%E6%96%B9%E6%B3%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>测试方法</h5>\n<p>在Node.js端连续发起<strong>10000</strong>次(<del>再多电脑散热器要揭竿而起</del>)fetch请求,请求随机延迟0-5秒之后响应；</p>\n<p>设置2s的超时期限；分别测试2s之后，取消请求与不取消请求的差别下Node.js进程的性能对比；</p>\n<blockquote>\n<p>最后采用<code class="gatsby-code-text">setTimeout 6s</code>的原因是全部延迟Node.js进程到6s之后结束,取消请求会导致2s后进程关闭，后面的性能数据无法继续采集</p>\n</blockquote>\n<h6 id="测试结果"><a href="#%E6%B5%8B%E8%AF%95%E7%BB%93%E6%9E%9C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>测试结果</h6>\n<ul>\n<li>\n<p>不取消请求的结果</p>\n<ul>\n<li>相同点：2s之后<code class="gatsby-code-text">Promise.race</code>返回的promise毫无疑问处于rejected状态</li>\n<li><strong>不同点：2s之后，原来发起的请求，依然处于pending状态，Node.js进程并未结束，需等待所有异步请求结束之后才会结束进程</strong></li>\n</ul>\n</li>\n<li>\n<p>取消请求的结果</p>\n<ul>\n<li>相同点：2s之后<code class="gatsby-code-text">Promise.race</code>返回的promise毫无疑问处于rejected状态</li>\n<li><strong>不同点：2s之后，原来发起的请求，处于canceled状态，Node.js进程结束</strong></li>\n</ul>\n</li>\n<li>\n<p>性能图对比：</p>\n<ul>\n<li>\n<p>不取消请求</p>\n<ul>\n<li>cpu持续占用，最高600%</li>\n<li>内存逐渐小幅度增加，最高252MB</li>\n<li>active handles到结束逐渐减少\n\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/不取消请求-b0ff5c90a827f999ea6c136cbabcdc91-d1e36.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 840px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 48.802083333333336%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABYklEQVQoz62QzU7DMBCE/RBAaWI7TpqkcZISQn9SWn4kEBceAnHhiUC87jDrliIQBw4cPu1OnFmPVy2Ge9Rnm4BvL1F9Y32o02bYa/Z7LZ7t7SNWmwcs13fw1GrWX6FsB6R+AVucw5U9EiI1Ky9Ij4JnbbdB6ZfIqzmHrTh4QFmvkNIj2LRGZAqoJqnhrceQztC5Bq2jTjwyO0WkC0RxjqLqYScddNpCZzOY7AxGNHudNojp0fTG9KgFU/R5h5tyjm1xgWV+jjWZ85tzHomQNUzRMUUDwyQ7GlgOFJLJDp1UUDafYZxMcaRzHDPRCWOfsI5YI1NiTPKyw5SkTK6ptaQPZ0V4pvSfqMhWYbLhz4L+Qczzul2EIYLjNyFlcrnABu+O8GQje3FNeIKg9xw092McDc6HiwN7LUNkLZ+rkQuVJPgzyVcf/ULMxGo0Mjg9NRj/AzJHXb+8Y/X8hvnT67/wAeosKplSp104AAAAAElFTkSuQmCC\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"\n        alt="不取消请求"\n        title=""\n        src="/static/不取消请求-b0ff5c90a827f999ea6c136cbabcdc91-acf85.png"\n        srcset="/static/不取消请求-b0ff5c90a827f999ea6c136cbabcdc91-c1418.png 210w,\n/static/不取消请求-b0ff5c90a827f999ea6c136cbabcdc91-5d5d8.png 420w,\n/static/不取消请求-b0ff5c90a827f999ea6c136cbabcdc91-acf85.png 840w,\n/static/不取消请求-b0ff5c90a827f999ea6c136cbabcdc91-de0cd.png 1260w,\n/static/不取消请求-b0ff5c90a827f999ea6c136cbabcdc91-bd6c2.png 1680w,\n/static/不取消请求-b0ff5c90a827f999ea6c136cbabcdc91-d1e36.png 1920w"\n        sizes="(max-width: 840px) 100vw, 840px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </li>\n</ul>\n</li>\n<li>\n<p>取消请求</p>\n<ul>\n<li>2s内cpu持续占用，最高355%，2s后极速降低为0</li>\n<li>2s内内存逐渐小幅度增加，最高248MB，2后极速降低到133MB</li>\n<li>active handles 2s后极速降低到0\n\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/取消请求-9c7686ae5764435812e81ddd5b47728c-d1e36.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 840px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 48.802083333333336%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABL0lEQVQoz62QSW7CQBBF+xYB291uz7PNYIwBoSiKsskhomxyokS57s/vZlIQEhsWT7+rXMMvi379iqLZWPJ6JJsbjMiq9fH7eI7Ldovd8zuG7RtWI+cwFt1iz4I1kqJHmM7J4qiXd5z3qLsd0nLge8lhg+1JyxWCeGZRQQlHJhBu0MJvXuBFc0zdGFOZnnGMegmitIOKWnhBAy/sqNU/XF0SqsogomyGuNpC040KazY21OaiJsftQcLFYQUdd/AtrcXEJzw/hwjjBlLRDZ046uDqmpgOc6L9gs6TmzUW9gslM0hOVkReYXMqR1H3dnuoC2gib9Qa7MmaZwT8B5pnaX2iuLyZN8PM2dKcfqdOOHRwD9e/X3OoKyAmTxKTicT0AZg5Yv/1i+HzB8uP74fwB4WUKhsJFVXHAAAAAElFTkSuQmCC\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"\n        alt="取消请求"\n        title=""\n        src="/static/取消请求-9c7686ae5764435812e81ddd5b47728c-acf85.png"\n        srcset="/static/取消请求-9c7686ae5764435812e81ddd5b47728c-c1418.png 210w,\n/static/取消请求-9c7686ae5764435812e81ddd5b47728c-5d5d8.png 420w,\n/static/取消请求-9c7686ae5764435812e81ddd5b47728c-acf85.png 840w,\n/static/取消请求-9c7686ae5764435812e81ddd5b47728c-de0cd.png 1260w,\n/static/取消请求-9c7686ae5764435812e81ddd5b47728c-bd6c2.png 1680w,\n/static/取消请求-9c7686ae5764435812e81ddd5b47728c-d1e36.png 1920w"\n        sizes="(max-width: 840px) 100vw, 840px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<blockquote>\n<p>CPU占用超过100%的原因JS为单线程，但是Node.js为多线程，Node.js会启用其他线程进行垃圾回收，性能优化等等,所以CPU占用是一个综合之后的数据</p>\n</blockquote>\n<h3 id="node-fetch-timeout"><a href="#node-fetch-timeout" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>node-fetch timeout</h3>\n<p>现在在Node.js端做转发请求一般会使用<a href="https://github.com/node-fetch/node-fetch">node-fetch</a>库，node-fetch本身实现了<code class="gatsby-code-text">timeout</code>的option，node-fetch <code class="gatsby-code-text">timeout</code>的实现原理如下：</p>\n<div class="gatsby-highlight">\n      <pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>timeout<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    req<span class="token punctuation">.</span><span class="token function">once</span><span class="token punctuation">(</span><span class="token string">\'socket\'</span><span class="token punctuation">,</span> socket <span class="token operator">=></span> <span class="token punctuation">{</span>\n        reqTimeout <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FetchError</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`network timeout at: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>request<span class="token punctuation">.</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">,</span> <span class="token string">\'request-timeout\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token function">finalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code></pre>\n      </div>\n<p>node-fetch并不推荐使用<code class="gatsby-code-text">timeout</code>，而是建议使用标准的<code class="gatsby-code-text">AbortController</code>来控制超时：</p>\n<ul>\n<li><a href="https://github.com/node-fetch/node-fetch#request-cancellation-with-abortsignal">node-fetch timeout vs abortsignal</a></li>\n<li><a href="https://stackoverflow.com/questions/54204342/node-fetch-why-is-signal-recommended-over-timeout">建议使用AbortController的原因</a></li>\n</ul>\n<h3 id="结论"><a href="#%E7%BB%93%E8%AE%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>结论</h3>\n<p>引入<a href="https://www.npmjs.com/package/abort-controller"><code class="gatsby-code-text">abort-controller</code></a> polyfill包 <strong>3kb</strong>，还是值得的,周下载量超过200万，应该是挺多人在使用。</p>',frontmatter:{title:"Abort-Controller",img:"./img/2016-09-23.jpeg",author:["Sylvenas"],excerpt:null,catalogue:null},fields:{date:"January 17, 2020",path:"blog/http/2020-01-18-abort-controller.md",slug:"/blog/2020/01/18/abort-controller.html"}},allMarkdownRemark:{edges:[{node:{
frontmatter:{title:"俄罗斯套娃娃 - Monad"},fields:{slug:"/blog/2020/02/12/俄罗斯套娃娃.html"}}},{node:{frontmatter:{title:"纪念刘和珍君"},fields:{slug:"/blog/2020/02/07/记念刘和珍君.html"}}},{node:{frontmatter:{title:"应用函子 - Applicative"},fields:{slug:"/blog/2020/02/05/应用函子.html"}}},{node:{frontmatter:{title:"加法是自然之道 - Monoid"},fields:{slug:"/blog/2020/02/02/加法是自然之道.html"}}},{node:{frontmatter:{title:"动物庄园"},fields:{slug:"/blog/2020/02/01/动物庄园.html"}}},{node:{frontmatter:{title:"薛定谔的 Maybe - IO"},fields:{slug:"/blog/2020/01/30/薛定谔的Maybe.html"}}},{node:{frontmatter:{title:"Abort-Controller"},fields:{slug:"/blog/2020/01/18/abort-controller.html"}}},{node:{frontmatter:{title:"Catch React Error"},fields:{slug:"/blog/2020/01/02/catch-react-error.html"}}},{node:{frontmatter:{title:"Node.js 集群"},fields:{slug:"/blog/2019/11/12/node-cluster.html"}}},{node:{frontmatter:{title:"黑珍珠号的诅咒 - Functor"},fields:{slug:"/blog/2019/09/10/黑珍珠号的诅咒.html"}}}]}},pathContext:{slug:"/blog/2020/01/18/abort-controller.html"}}}});