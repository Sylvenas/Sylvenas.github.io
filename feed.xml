<?xml version="1.0" encoding="UTF-8"?><rss xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/" xmlns:atom="http://www.w3.org/2005/Atom" version="2.0"><channel><title><![CDATA[Little Forest]]></title><description><![CDATA[A JavaScript library for building user interfaces]]></description><link>https://reactjs.org</link><generator>RSS for Node</generator><lastBuildDate>Mon, 05 Nov 2018 05:02:32 GMT</lastBuildDate><item><title><![CDATA['类'模式]]></title><description><![CDATA[<h3 id="oop"><a href="#oop" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>oop</h3>
<p>面向对象编程强调的是数据和操作数据的行为本质上是相互关联的(当然，不同的数据有不同的行为)，因此好的设计就是把数据以及和它相关的行为打包(封装)起来，这在正是的计算机科学中有时候被称为数据结构。</p>
<p>举例来说：用来表示一个单词或者短语的<code>一串字符通</code>常被称为字符串。字符就是<code>数据</code>。但是你关心的往往不是<code>数据是什么</code>，而是<code>可以对数据做什么</code>，所以可以应用在这种数据上的行为(计算长度、添加数据、搜索，等等)都被设计成<code>String</code>类的方法。</p>
<p>所有字符串都是<code>String</code>类的一个实例，也就是说它是一个包裹，包含字符数据和我们可以 应用在数据上的函数。</p>
<p>我们来看一个常见的例子，“汽车”可以被看作“交通工具”的一种特例，后者是更广泛的类。</p>
<p>我们可以在软件中定义一个<code>Vehicle</code>类和一个<code>Car</code>类来对这种关系进行建模。
<code>Vehicle</code>的定义可能包含推进器(比如引擎)、载人能力等等，这些都是<code>Vehicle</code>的行为。我们在<code>Vehicle</code>中定义的是(几乎)所有类型的交通工具(飞机、火车和汽车)都包含的东西。
在我们的软件中，对不同的交通工具重复定义“载人能力”是没有意义的。相反，我们只在<code>Vehicle</code>中定义一次，定义<code>Car</code>时，只要声明它<code>继承</code>(或者扩展)了<code>Vehicle</code>的这个基础定义就行。<code>Car</code>的定义就是对通用<code>Vehicle</code>定义的特殊化。
虽然<code>Vehicle</code>和<code>Car</code>会定义相同的方法，但是实例中的数据可能是不同的，比如每辆车独一无二的 VIN(Vehicle Identification Number，车辆识别号码)，等等。</p>
<p>这就是<code>类</code>、<code>继承</code>和<code>实例化</code>。
类的另一个核心概念是<code>多态</code>，这个概念是说父类的通用行为可以被子类<code>用更特殊的行为重写</code>。实际上，相对多态性允许我们从重写行为中引用基础行为。</p>
<p>类理论强烈建议父类和子类使用相同的方法名来表示特定的行为，从而让子类重写父类。</p>
<p>总结一下经典的面向对象编程的思维导图：
</p>
<h3 id="类与实例"><a href="#%E7%B1%BB%E4%B8%8E%E5%AE%9E%E4%BE%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>类与实例</h3>
<p>举例来说类和实例的关系，服装设计师会设计好每个服装的模型，包括领口多款，袖子多长，等等模版；设计师并不关心他设计的模版衣服会在哪里生产，会生产多少件。</p>
<p>而生产厂家拿到了衣服的模版之后，就会让工人来批量生产衣服。</p>
<p>那么生产完成之后的具体的每一件衣服。也就是模版的一份物理实例，本质上就是对模版的复制。</p>
<p>一个类就是一个模版。为了获得真正可以交互的对象，我们必须按照类来建造(也可以说<code>实例化</code>)一个东西，这个东西通常被称为<code>实例</code>，有需要的话，我们可以直接在实例上调用方法并访问其所有公有数据属性。
这个对象就是类中描述的所有特性的一份副本。</p>
<h3 id="构造函数"><a href="#%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>构造函数</h3>
<p>类实例是由一个特殊的类方法构造的，这个方法名通常和类名相同，被称为构造函数。这
个方法的任务就是初始化实例需要的所有信息(状态)。 举例来说，思考下面这个关于类的伪代码(编造出来的语法):</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code><span class="token keyword">class</span> <span class="token class-name">CoolGuy</span> <span class="token punctuation">{</span>
  specialTrick <span class="token operator">=</span> nothing
  <span class="token function">CoolGuy</span><span class="token punctuation">(</span> trick <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    specialTrick <span class="token operator">=</span> trick
<span class="token punctuation">}</span>
  <span class="token function">showOff</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">output</span><span class="token punctuation">(</span> <span class="token string">"Here's my trick: "</span><span class="token punctuation">,</span> specialTrick <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
      </div>
<p>我们可以调用类构造函数来生成一个<code>CoolGuy</code>实例:</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code>Joe <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CoolGuy</span><span class="token punctuation">(</span> <span class="token string">"jumping rope"</span> <span class="token punctuation">)</span>
Joe<span class="token punctuation">.</span><span class="token function">showOff</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 这是我的绝技:跳绳</span>
</code></pre>
      </div>
<p>注意，<code>CoolGuy</code>类有一个<code>CoolGuy()</code>构造函数，执行<code>new</code>它。构造函数会返回一个对象(也就是类的一个实例)，之后我们可以在这个对象上调用<code>showOff()</code>方法，来输出指定 <code>CoolGuy</code>的特长。
类构造函数属于类，而且通常和类同名。此外，构造函数大多需要用<code>new</code>来调，这样语言引擎才知道你想要构造一个新的类实例。</p>
<h3 id="类的继承"><a href="#%E7%B1%BB%E7%9A%84%E7%BB%A7%E6%89%BF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>类的继承</h3>
<p>在面向类的语言中，你可以先定义一个类，然后定义一个继承前者的类。
后者通常被称为“子类”，前者通常被称为“父类”。这些术语显然是类比父母和孩子，不过在意思上稍有扩展，你很快就会看到。
对于父母的亲生孩子来说，父母的基因特性会被复制给孩子。显然，在大多数生物的繁殖系统中，双亲都会贡献等量的基因给孩子。但是在编程语言中，我们假设只有一个父类。
一旦孩子出生，他们就变成了单独的个体。虽然孩子会从父母继承许多特性，但是他是一个独一无二的存在。如果孩子的头发是红色，父母的头发未必是红的，也不会随之变红，二者之间没有直接的联系。</p>
<p>同理，定义好一个子类之后，相对于父类来说它就是一个独立并且完全不同的类。子类会包含父类行为的原始副本，但是也可以重写所有继承的行为甚至定义新行为。
非常重要的一点是，我们讨论的父类和子类并不是实例。父类和子类的比喻容易造成一些误解，实际上我们应当把父类和子类称为父类 DNA 和子类 DNA。我们需要根据这些 DNA 来创建(或者说实例化)一个人，然后才能和他进行沟通。</p>
<p>好了，我们先抛开现实中的父母和孩子，来看一个稍有不同的例子:不同类型的交通工具。这是一个非常典型(并且经常被抱怨)的讲解继承的例子。</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code><span class="token keyword">class</span> <span class="token class-name">Vehicle</span> <span class="token punctuation">{</span>
  engines <span class="token operator">=</span> <span class="token number">1</span>
  <span class="token function">ignition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">output</span><span class="token punctuation">(</span><span class="token string">"Turning on my engine."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">drive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">ignition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">output</span><span class="token punctuation">(</span><span class="token string">"Steering and moving forward!"</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">Car</span> inherits Vehicle <span class="token punctuation">{</span>
  wheels <span class="token operator">=</span> <span class="token number">4</span>
  <span class="token function">drive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    inherited<span class="token punctuation">:</span> <span class="token function">drive</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">output</span><span class="token punctuation">(</span><span class="token string">"Rolling on all "</span><span class="token punctuation">,</span> wheels<span class="token punctuation">,</span> <span class="token string">" wheels!"</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">SpeedBoat</span> inherits Vehicle <span class="token punctuation">{</span>
  engines <span class="token operator">=</span> <span class="token number">2</span>
  <span class="token function">ignition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">output</span><span class="token punctuation">(</span><span class="token string">"Turning on my "</span><span class="token punctuation">,</span> engines<span class="token punctuation">,</span> <span class="token string">" engines."</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">pilot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    inherited<span class="token punctuation">:</span> <span class="token function">drive</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">output</span><span class="token punctuation">(</span><span class="token string">"Speeding through the water with ease!"</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
      </div>
<p>我们通过定义<code>Vehicle</code>类来假设一种发动机，一种点火方式，一种驾驶方法。但是你不可 能制造一个通用的“交通工具”，因为这个类只是一个抽象的概念。
接下来我们定义了两类具体的交通工具:<code>Car</code>和<code>SpeedBoat</code>。它们都从<code>Vehicle</code>继承了通用的特性并根据自身类别修改了某些特性。汽车需要四个轮子，快艇需要两个发动机，因此 它必须启动两个发动机的点火装置。</p>
<h4 id="多态"><a href="#%E5%A4%9A%E6%80%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>多态</h4>
<p><code>Car</code>重写了继承自父类的<code>drive()</code>方法，但是之后<code>Car</code>调用了<code>inherited:drive(</code>)方法， 这表明<code>Car</code>可以引用继承来的原始<code>drive()</code>方法。快艇的<code>pilot()</code>方法同样引用了原始<code>drive()</code>方法。
这个技术被称为多态或者虚拟多态。在本例中，更恰当的说法是相对多态。
多态是一个非常广泛的话题，我们现在所说的“相对”只是多态的一个方面:任何方法都
可以引用继承层次中高层的方法(无论高层的方法名和当前方法名是否相同)。之所以说 “相对”是因为我们并不会定义想要访问的绝对继承层次(或者说类)，而是使用相对引用 “查找上一层”。
在许多语言中可以使用<code>super</code>来代替本例中的 inherited:，它的含义是“超类” (superclass)，表示当前类的父类/祖先类。
多态的另一个方面是，在继承链的不同层次中一个方法名可以被多次定义，当调用方法时 会自动选择合适的定义。
在之前的代码中就有两个这样的例子:drive() 被定义在<code>Vehicle</code>和<code>Car</code>中，<code>ignition()</code>被定义在<code>Vehicle</code>和<code>SpeedBoat</code>中。</p>
<h3 id="maxin"><a href="#maxin" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>maxin</h3>
<p>上面是描述的经典的面向对象编程中的基本的概念以及特征。</p>
<blockquote>
<p>我个人认为更应该叫面向类编程，而JavaScript才是真正的面向对象编程，JavaScript中只有对象而没有类的概念,并且可以不通过类就能直接创建对象。</p>
</blockquote>
<p>在继承或者实例化时，JavaScript的对象机制并不会自动执行复制行为。简单来说,JavaScript中只有对象，并不存在可以被实例化的“类”。一个对象并不会被复制到其他对象，它们会被<code>关联</code>起来。</p>
<p>由于在其他语言中类表现出来的都是复制行为，因此JavaScript开发者也想出了一个方法来模拟类的复制行为，这个方法就是混入。接下来我们会看到两种类型的混入:显式和隐式。</p>
<h4 id="显式混入"><a href="#%E6%98%BE%E5%BC%8F%E6%B7%B7%E5%85%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>显式混入</h4>
<p>首先我们来回顾一下之前提到的<code>Vehicle</code>和<code>Car</code>。由于<code>JavaScript</code>不会自动实现<code>Vehicle</code>到<code>Car</code>的复制行为，所以我们需要手动实现复制功能。这个功能在许多库和框架中被称为<code>extend(..)</code>，但是为了方便理解我们称之为<code>mixin(..)</code>。</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code><span class="token comment" spellcheck="true">// 非常简单的 mixin(..) 例子 :</span>
<span class="token keyword">function</span> <span class="token function">mixin</span><span class="token punctuation">(</span>sourceObj<span class="token punctuation">,</span> targetObj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> key <span class="token keyword">in</span> sourceObj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 只会在不存在的情况下复制</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>key <span class="token keyword">in</span> targetObj<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      targetObj<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> sourceObj<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> targetObj<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> Vehicle <span class="token operator">=</span> <span class="token punctuation">{</span>
  engines<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  ignition<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Turning on my engine."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  drive<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">ignition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Steering and moving forward!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> Car <span class="token operator">=</span> <span class="token function">mixin</span><span class="token punctuation">(</span>Vehicle<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  wheels<span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
  drive<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Vehicle<span class="token punctuation">.</span>drive<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
      <span class="token string">"Rolling on all "</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>wheels <span class="token operator">+</span> <span class="token string">" wheels!"</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
      </div>
<blockquote>
<p>有一点需要注意，我们处理的已经不再是类了，因为在 JavaScript 中不存在 类，Vehicle 和 Car 都是对象，供我们分别进行复制和粘贴。</p>
</blockquote>
<p>现在<code>Car</code>中就有了一份<code>Vehicle</code>属性和函数的副本了。从技术角度来说，函数实际上没有被复制，复制的是函数引用。所以，<code>Car</code>中的属性<code>ignition</code>只是从<code>Vehicle</code>中复制过来的对于<code>ignition()</code>函数的引用。相反，属性<code>engines</code> 就是直接从<code>Vehicle</code>中复制了值 1。
<code>Car</code>已经有了<code>drive</code>属性(函数)，所以这个属性引用并没有被<code>mixin</code>重写，从而保留了<code>Car</code>中定义的同名属性，实现了“子类”对“父类”属性的重写(参见 mixin(..) 例子中 的 if 语句)。</p>
<h4 id="显式多态"><a href="#%E6%98%BE%E5%BC%8F%E5%A4%9A%E6%80%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>显式多态</h4>
<p>我们来分析一下这条语句:<code>Vehicle.drive.call(this)</code>。这就是我所说的显式多态。还记得吗，在之前的伪代码中对应的语句是<code>inherited:drive()</code>，我们称之为<code>相对多态</code>。
JavaScript(在 ES6之前;参见附录A)并没有相对多态的机制。所以，由于<code>Car</code>和<code>Vehicle</code>中都有<code>drive()</code>函数，为了指明调用对象，我们必须使用绝对(而不是相对)引 用。我们通过名称显式指定<code>Vehicle</code>对象并调用它的<code>drive()</code>函数。
但是如果直接执行<code>Vehicle.drive()</code>，函数调用中的<code>this</code>会被绑定到<code>Vehicle</code>对象而不是<code>Car</code>对象，这并不是我们想要的。因此，我们会使用<code>.call(this)</code>来确保 drive() 在<code>Car</code>对象的上下文中执行。</p>
<p>复制操作完成后，<code>Car</code>就和<code>Vehicle</code>分离了，向<code>Car</code>中添加属性不会影响<code>Vehicle</code>，反之亦然。</p>
<blockquote>
<p>这里跳过了一些小细节，实际上，在复制完成之后两者之间仍然有一些巧妙 的方法可以“影响”到对方，例如引用同一个对象(比如一个数组)。</p>
</blockquote>
<p>由于两个对象引用的是同一个函数，因此这种复制(或者说混入)实际上并不能完全模拟面向类的语言中的复制。
JavaScript中的函数无法(用标准、可靠的方法)真正地复制，所以你只能复制对共享函数对象的引用(函数就是对象,只不过是可调用的对象)。如果你修改了共享的函数对象(比如 ignition())，比如添加了一个属性，那<code>Vehicle</code>和<code>Car</code>都会受到影响。
显式混入是JavaScript中一个很棒的机制，不过它的功能也没有看起来那么强大。虽然它可以把一个对象的属性复制到另一个对象中，但是这其实并不能带来太多的好处，无非就是少几条定义语句，而且还会带来我们刚才提到的函数对象引用问题。</p>
<p>在支持相对多态的面向类的语言中，<code>Car</code>和<code>Vehicle</code>之间的联系只在类定义的开头被创建,从而只需要在这一个地方维护两个类的联系。</p>
<p>但是在JavaScript中(由于屏蔽)使用显式伪多态会在所有需要使用(伪)多态引用的地 方创建一个函数关联，这会极大地增加维护成本。此外，由于显式伪多态可以模拟多重继承，所以它会进一步增加代码的复杂度和维护难度。
使用伪多态通常会导致代码变得更加复杂、难以阅读并且难以维护，因此应当尽量避免使 用显式伪多态，因为这样做往往得不偿失。</p>
<h3 id="solution"><a href="#solution" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>solution</h3>
<p>类是一种设计模式。许多语言提供了对于面向类软件设计的原生语法。JavaScript也有类似的语法，但是和其他语言中的类完全不同。</p>
<p>类意味着复制。</p>
<p>传统的类被实例化时，它的行为会被复制到实例中。类被继承时，行为也会被复制到子类中。</p>
<p>多态(在继承链的不同层次名称相同但是功能不同的函数)看起来似乎是从子类引用父类，但是本质上引用的其实是复制的结果。</p>
<p>JavaScript并不会(像类那样)自动创建对象的副本。</p>
<p>混入模式可以用来模拟类的复制行为，但是通常会产生丑陋并且脆弱的语法，比如显式伪多态<code>(OtherObj.methodName.call(this, ...))</code>，这会让代码更加难懂并且难以维护。</p>
<p>此外，显式混入实际上无法完全模拟类的复制行为，因为对象(和函数!别忘了函数也 是对象)只能复制引用，无法复制被引用的对象或者函数本身。忽视这一点会导致许多问题。
总地来说，在<code>JavaScript</code>中模拟类是得不偿失的，虽然能解决当前的问题，但是可能会埋下更多的隐患。</p>]]></description><link>https://reactjs.org/blog/2018/08/24/class-pattern.html</link><guid isPermaLink="false">https://reactjs.org/blog/2018/08/24/class-pattern.html</guid><pubDate>Thu, 23 Aug 2018 16:00:00 GMT</pubDate></item><item><title><![CDATA[代理模式]]></title><description><![CDATA[<h3 id="模仿类"><a href="#%E6%A8%A1%E4%BB%BF%E7%B1%BB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>模仿类</h3>
<p>多年以来，JavaScript中有一种奇怪的行为一直在被无耻地滥用，那就是<code>模仿类</code>。我们会仔细分析这种方法。
这种奇怪的“类似类”的行为利用了函数的一种特殊特性:所有的函数默认都会拥有一个名为<code>prototype</code>的公有并且不可枚举的属性，它会指向另一个对象:</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code><span class="token keyword">function</span> <span class="token function">Foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// ...</span>
<span class="token punctuation">}</span>
Foo<span class="token punctuation">.</span>prototype<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// { }</span>

<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

Object<span class="token punctuation">.</span><span class="token function">getPrototypeOf</span><span class="token punctuation">(</span> a <span class="token punctuation">)</span> <span class="token operator">===</span> Foo<span class="token punctuation">.</span>prototype<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// true</span>
</code></pre>
      </div>
<p>这个对象通常被称为<code>Foo的原型</code>，因为我们通过名为<code>Foo.prototype</code>的属性引用来访问它。</p>
<p>调用<code>new Foo()</code>时会创建<code>a</code>，其中的一步就是给<code>a</code>一个内部的<code>[[Prototype]]</code>链接，关联到<code>Foo.prototype</code>指向的那个对象。
下面是<code>new</code>操作符的具体实现，也就是假如没有<code>new</code>操作符的时候，我们该怎么实现<code>new</code>呢？</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code><span class="token keyword">function</span> <span class="token function">newObject</span><span class="token punctuation">(</span>Constructor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> obj <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>Constructor<span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Constructor<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token operator">...</span>arguments<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> obj<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
      </div>
<p>在面向类的语言中，类可以被复制(或者说实例化)多次，就像用模具制作东西一样。之所以会这样是因为实例化(或者继承)一个类就意味着“把类的行为复制到物理对象中”，对于每一个新实例来说都会重复这个过程。
但是在JavaScript中，并没有类似的复制机制。你不能创建一个类的多个实例，只能创建多个对象，它们<code>[[Prototype]]</code>关联的是同一个对象。但是在默认情况下并不会进行复制， 因此这些对象之间并不会完全失去联系，它们是互相关联的。</p>
<p><code>new Foo()</code>会生成一个新对象(我们称之为a)，这个新对象的内部链接<code>[[Prototype]]</code>关联的是<code>Foo.prototype</code>对象。</p>
<p>最后我们得到了两个对象，它们之间互相关联，就是这样。</p>
<p>我们并没有初始化一个类，实际上我们并没有从“类”中复制任何行为到一个对象中，只是让两个对象互相关联。</p>
<p>继承意味着复制操作，JavaScript(默认)并不会复制对象属性。</p>
<p>相反，JavaScript会在两个对象之间创建一个关联，这样一个对象就可以通过委托访问另一个对象的属性和函数。</p>
<p><code>Object.create(..)</code> 是一个大英雄，现在是时候来弄明白为 什么了:</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code><span class="token keyword">var</span> foo <span class="token operator">=</span> <span class="token punctuation">{</span>
something<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">"Tell me something good..."</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> bar <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span> foo <span class="token punctuation">)</span><span class="token punctuation">;</span> bar<span class="token punctuation">.</span><span class="token function">something</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Tell me something good...</span>
</code></pre>
      </div>
<p><code>Object.create(..)</code> 会创建一个新对象(<code>bar</code>)并把它关联到我们指定的对象(<code>foo</code>)，这样 我们就可以充分发挥<code>[[Prototype]]</code>机制的威力(委托)并且避免不必要的麻烦(比如使用<code>new</code>的构造函数调用会生成<code>.prototype</code> 和<code>.constructor</code>引用)。</p>
<p>换句话说JavaScript中这个原型链机制的本质就是对象之间的关联关系，对象之间从未存在过“继承”这种东西</p>]]></description><link>https://reactjs.org/blog/2018/08/24/代理-pattern.html</link><guid isPermaLink="false">https://reactjs.org/blog/2018/08/24/代理-pattern.html</guid><pubDate>Thu, 23 Aug 2018 16:00:00 GMT</pubDate></item><item><title><![CDATA[What is 'this' in JavaScript]]></title><description><![CDATA[<p>JavaScript里有个太常见的<code>this</code>关键字，不过却有很多的开发人员弄不懂<code>this</code>关键字在不同的环境中的指向，也弄不清楚应该怎样使用这个关键字。</p>
<p>当你彻底理解了<code>闭包</code>和<code>this</code>的时候，你也就弄明白了JavaScript的核心精髓了。</p>
<p>在理解this的绑定之前，首先要理解调用位置：调用位置就是函数在代码中的调用位置(此处绝不是说函数的声明位置)，这个过程中最重要是分析函数的调用栈(就是为了到达当前调用位置所调用的所有的函数)。</p>
<p>我们首先来看看关于<code>this</code>两种常见的<strong>误解</strong>:</p>
<h4 id="指向自身"><a href="#%E6%8C%87%E5%90%91%E8%87%AA%E8%BA%AB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>指向自身</h4>
<p>很多人认为<code>this</code>是指向的函数自身！为什么要从函数的内部引用函数自身呢？最常见的用处是递归。看看下面的代码：</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'foo: '</span><span class="token operator">+</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>count<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
foo<span class="token punctuation">.</span>count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token function">foo</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// foo： 1</span>
<span class="token function">foo</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// foo： 2</span>
<span class="token function">foo</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// foo： 3</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>foo<span class="token punctuation">.</span>count<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 0 .. why?</span>
</code></pre>
      </div>
<p>上面的代码显然<code>foo</code>函数执行了三次，但是<code>foo.count</code>的结果还是<code>0</code>，那么说明函数内的<code>this</code>指向函数本身这种观点显然是错误的。</p>
<p>那么我们代码内的<code>count</code>,到底是谁的<code>count</code>呢？实际上我们是隐式的创建了一个全局变量<code>count</code>，初始化的值是<code>undefined</code>,执行<code>++</code>操作的时候就会变成<code>NaN</code>;</p>
<h4 id="它的作用域"><a href="#%E5%AE%83%E7%9A%84%E4%BD%9C%E7%94%A8%E5%9F%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>它的作用域</h4>
<p>第二种常见的误解是，this指向函数的作用域，这个问题有点复杂，因为在有些情况下它是正确的，而在有些情况下它是错误的。</p>
<p>在JavaScript内部，作用域确实和对象类似，可见的标识符都是它的属性。但是作用域“对象”无法通过JavaScript代码访问，它仅仅存在于JavaScript内部。</p>
<p>思考一下下面的代码，它试图(但是没有成功)跨越边界，使用this来隐式引用函数的词法作用域。</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//referenceError:a is not defined</span>
</code></pre>
      </div>
<p>这段代码的错误不止一个，虽然这段代码看起来好像是我们故意写出来的例子，这段代码非常完美的展示了<code>this</code>多么容易误导人。</p>
<p>首先这段代码试图通过<code>this.bar</code>来引用<code>bar()</code>函数。这样调用能成功纯属意外,我们之后会解释原因。调用bar函数最自然的方式是声落前面的this,直接使用词法引用标识符。</p>
<p>此外，这段代码还试图使用this,来联通foo和bar的作用域，从而让bar可以访问到foo作用域中的变量a,这是不可能实现的，使用this,不可能在词法作用域中查到什么</p>
<h4 id="this到底是什么"><a href="#this%E5%88%B0%E5%BA%95%E6%98%AF%E4%BB%80%E4%B9%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>this到底是什么</h4>
<p>this是在运行时进行绑定的，并不是在编写时绑定，它的上下文取决于函数调用时的各种条件。this的绑定和函数声明的位置毫无关系，只取决于函数的调用方式。</p>
<p><strong>当一个函数被调用的时候，会创建一个<code>活动记录</code>(也叫<code>执行上下文</code>)，这个记录会包含函数在哪里被调用(调用栈)，函数的调用方式，传入的参数等信息。<code>this</code>就是这个记录的一个属性，它会在函数执行的过程中用到</strong></p>
<p><code>this</code>的运行机制不是那么的容易让人理解，下面，我会尽量解释清楚不同环境下的<code>this</code>，首先我们从<code>global</code> environment开始(确保你已经安装了<code>node</code>,然后打开node command)。</p>
<h4 id="this-in-global-environment-默认绑定"><a href="#this-in-global-environment-%E9%BB%98%E8%AE%A4%E7%BB%91%E5%AE%9A" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>‘this’ in Global Environment (默认绑定)</h4>
<p>在全局环境下，<code>this</code>就完全等于一个叫<code>global</code>的全局对象</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code><span class="token operator">></span> <span class="token keyword">this</span> <span class="token operator">===</span> global
<span class="token comment" spellcheck="true">//true</span>
</code></pre>
      </div>
<p>但是上面的代码，只有在node command中成立。如果我们尝试在一个JS文件中运行上面的代码，则会返回false,为了测试这个代码，创建一个<code>index.js</code>文件，然后里面的代码写:</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">===</span> global<span class="token punctuation">)</span>
</code></pre>
      </div>
<p>然后使用node command运行这个文件</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-cmd"><code>$ node index.js
false</code></pre>
      </div>
<p>因为在一个js文件中，<code>this</code>是完全等于<code>module.exports</code>的，而不是<code>global</code></p>
<h4 id="this-inside-functions-默认绑定"><a href="#this-inside-functions-%E9%BB%98%E8%AE%A4%E7%BB%91%E5%AE%9A" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>‘this’ inside Functions (默认绑定)</h4>
<p>函数内部的<code>this</code>一般是由函数的调用者来决定的，所以在函数每次执行的时候，其内部的<code>this</code>可能都不一样。</p>
<p>在<code>index.js</code>文件中写一个简单的函数，来检查一下函数内部的<code>this</code>是不是等于<code>global</code>：</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code><span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">===</span> global<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
      </div>
<p>如果我们用node执行上面的代码，我们将会看到打印出来<code>true</code>,但是如果我们在index.js的头部添加<code>use strict</code>,然后再次运行index.js，这个时候，会打印出来<code>false</code>,因为这个时候，函数内部的<code>this</code>是<code>undefined</code>。</p>
<p>那么为什么<code>test</code>在非严格模式下调用的时候，内部的this,是<code>global</code>呢？因为这其中发生了<strong>默认绑定</strong>，什么情况下会发生默认绑定呢？就是<code>test()</code>是直接使用<strong>不带任何修饰符的函数引用进行调用的</strong>，因此只能使用默认绑定到全局<code>global</code>对象上。</p>
<p>为了更加仔细的了解这一点，我们看另外一个例子,我们有一个函数用来创建超级英雄的真名和绰号</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code><span class="token keyword">function</span> <span class="token function">Hero</span><span class="token punctuation">(</span>heroName<span class="token punctuation">,</span>realName<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>realName <span class="token operator">=</span> realName<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>heroName <span class="token operator">=</span> heroName<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> superman <span class="token operator">=</span> <span class="token function">Hero</span><span class="token punctuation">(</span><span class="token string">'Superman'</span><span class="token punctuation">,</span><span class="token string">'Clart'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>superman<span class="token punctuation">)</span>
</code></pre>
      </div>
<p>上面的代码不是在严格模式(<code>use strict</code>)下运行的,在node下运行这段代码，将会打印出来<code>undefined</code>，而不是我们期望的<code>Superman</code>和<code>Clart</code>。</p>
<p>其中的原因就是我们这段代码不是在严格模式下运行的，函数内的<code>this</code>就是<code>global</code>对象</p>
<p>但是如果我们在严格模式下运行这段代码，我们将会得到一个错误，因为JavaScript不允许给<code>undefined</code>添加属性(这可以帮助我们，避免创建全局变量)。</p>
<p>最后，函数的首字母大些，意味着这个函数是一个构造函数，我们应该用一个<code>new</code>操作符来调用函数。替换最后两行代码如下：</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code><span class="token keyword">const</span> superman <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Hero</span><span class="token punctuation">(</span><span class="token string">'Superman'</span><span class="token punctuation">,</span><span class="token string">'Clart'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>superman<span class="token punctuation">)</span>
</code></pre>
      </div>
<p>这个时候再次运行index.js,就可以得到我们预期的结果</p>
<h4 id="this-inside-constructors-new-绑定"><a href="#this-inside-constructors-new-%E7%BB%91%E5%AE%9A" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>‘this’ inside constructors (new 绑定)</h4>
<p>JavaScript本身根本没有特殊的<code>constructor</code>函数,我们所做不过是使用<code>new</code>操作符来替换函数调用。</p>
<p>当我们使用<code>new</code>操作符，调用一个构造函数的时候，实际上就是创建一个新的对象，并把函数内部的<code>this</code>赋值为这个对象，然后这个对象会被函数隐式的返回(除非有另外一个对象或者函数被显式的返回)。</p>
<p>在<code>Hero</code>函数的最后添加代码：</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code><span class="token keyword">return</span> <span class="token punctuation">{</span>
    heroName<span class="token punctuation">:</span><span class="token string">'Batman'</span><span class="token punctuation">,</span>
    realname<span class="token punctuation">:</span><span class="token string">'Bruce Wayne'</span>
<span class="token punctuation">}</span>
</code></pre>
      </div>
<p>我们再次使用node command 运行index.js，我们会发现得到的结果<code>superman</code>被替换成了<code>{heroName:'Batman',realname:'Bruce Wayne'}</code>。但是如果我们显式的return任何非对象类型和非函数类型的数据，则最后的结果不会被显式的替换掉。</p>
<h4 id="this-in-method-隐式绑定"><a href="#this-in-method-%E9%9A%90%E5%BC%8F%E7%BB%91%E5%AE%9A" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>‘this’ in Method (隐式绑定)</h4>
<p>当一个函数作为对象的属性方法来调用的时候，函数内部的<code>this</code>就指向对象本身。</p>
<p>看个例子，在对象<code>hero</code>中有一个方法<code>dialogue</code>,<code>dialogue</code>的<code>this</code>就是指向<code>hero</code>自身，<code>hero</code>对象会被认为是方法<code>dialogue</code>的调用者。</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code><span class="token keyword">const</span> hero <span class="token operator">=</span> <span class="token punctuation">{</span>
    heroName<span class="token punctuation">:</span><span class="token string">"Batman"</span><span class="token punctuation">,</span>
    <span class="token function">dialogue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`I am </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>heroName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

hero<span class="token punctuation">.</span><span class="token function">dialogue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
      </div>
<p>这是一个简单的例子，但是在真实的世界中，有时候我们很难确定方法的调用者，看看如下的代码：</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code><span class="token keyword">const</span> saying <span class="token operator">=</span> hero<span class="token punctuation">.</span>dialogue<span class="token punctuation">;</span>
<span class="token function">saying</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
      </div>
<p>在这段代码中，把<code>hero.dialogue</code>方法赋值给另一个变量<code>saying</code>,然后把这个变量当作一个方法来调用，在node中运行这段代码，就会发现这个时候<code>this.heroName</code>会变成<code>undefined</code>,这是因为这个时候方法丢失了它的调用者，这种情况下的<code>this</code>会指向<code>global</code>,而不是<code>hero</code>。</p>
<p>方法的调用者丢失的情况经常发生在，我们把一个方法作为callback传递给定外一个的时候，这个时候我们可以利用闭包，或者通过<code>bind</code>到我们想要的对象。</p>
<h4 id="call-and-apply-强制绑定"><a href="#call-and-apply-%E5%BC%BA%E5%88%B6%E7%BB%91%E5%AE%9A" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>call and apply (强制绑定)</h4>
<p>通常情况下函数的<code>this</code>都是隐式的被设定的，但是我们也可以显式的使用<code>call</code>和<code>apply</code>方法来设置方法内部的<code>this</code>。
看看下面的代码：</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code><span class="token keyword">function</span> <span class="token function">dialogue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`I am </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>heroName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> hero <span class="token operator">=</span> <span class="token punctuation">{</span> heroName<span class="token punctuation">:</span><span class="token string">'Batman'</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
      </div>
<p>如果我想把<code>hero</code>对象作为<code>dialogue</code>函数的调用者，我们可以这么做：</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code>dialogue<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>hero<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// or</span>
dialogue<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>hero<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
      </div>
<p>如果你在严格模式之外使用<code>call</code>和<code>apply</code>,并且传入的参数是<code>null</code>或者<code>undefined</code>,这个时候，<code>null</code>和<code>undefined</code>会被JavaScript engine 忽落掉。所以建议大家在严格模式下写代码。</p>
<h4 id="bind-强制绑定"><a href="#bind-%E5%BC%BA%E5%88%B6%E7%BB%91%E5%AE%9A" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>bind (强制绑定)</h4>
<p>当我们把一个方法作为一个callback,传递给另一个函数的时候，经常会发生丢失this,或者this指向不对的情况。</p>
<p>这个时候<code>bind</code>函数就会登场了，<code>bind</code>函数会创建一个新的函数，并且新的函数内部的<code>this</code>指向bind的参数。</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code><span class="token keyword">const</span> hero <span class="token operator">=</span> <span class="token punctuation">{</span>
    heroName<span class="token punctuation">:</span><span class="token string">"Batman"</span><span class="token punctuation">,</span>
    <span class="token function">dialogue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`I am </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>heroName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">setTimeOut</span><span class="token punctuation">(</span>hero<span class="token punctuation">.</span>dialogue<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>hero<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
      </div>
<p>但是有一点需要注意，通过bind生成的新的函数，内部的<code>this</code>是固定的，无法通过<code>call</code>或者<code>apply</code>进行修改。</p>
<h4 id="catching-this-inside-an-arrow-function-lexical-scope"><a href="#catching-this-inside-an-arrow-function-lexical-scope" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Catching ‘this’ inside an Arrow Function (lexical scope)</h4>
<p>箭头函数中<code>this</code>和其他JavaScript中函数大不相同，箭头函数本身没有属于自己的<code>this</code>,而是获取定义的时候的上下文作为自己的<code>this</code>。</p>
<p>箭头函数在定义的时候，已经确定了<code>this</code>的指向，使用call和apply，也无法改变箭头函数内部的<code>this</code>。</p>
<p>为了演示箭头函数内的<code>this</code>工作原理，我们看一下下面的例子：</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code><span class="token keyword">const</span> batman <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> burce <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">===</span> batman<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">burce</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
      </div>
<p>我们先把<code>this</code>赋值给一个变量<code>batman</code>,然后在箭头函数内部比较函数内的<code>this</code>和<code>batman</code>，我们发现两者完全相同 。</p>
<p>箭头函数内部的<code>this</code>无法被显式的设置，同样的箭头函数会忽略来自<code>call</code>、<code>apply</code>和<code>bind</code>传递的第一个参数,箭头函数内部的<code>this</code>始终指向创建时，所在的上下文环境。</p>
<p>箭头函数无法作为构造函数来使用，也是因为我们无法重新分配函数内部的<code>this</code>。</p>
<p>那么箭头函数内部的<code>this</code>到底有什么用处呢？</p>
<p>箭头函数可以帮助我们在callback中访问到正确的<code>this</code>，看下面的这个例子：</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code><span class="token keyword">const</span> counter <span class="token operator">=</span> <span class="token punctuation">{</span>
    count<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token function">increase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token operator">++</span><span class="token keyword">this</span><span class="token punctuation">.</span>count<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

counter<span class="token punctuation">.</span><span class="token function">increase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
      </div>
<p>通过<code>node index.js</code>来执行上面的代码，我们只会得到<code>NaN</code>,这是因为<code>this.count</code>并不是指向的<code>counter</code>对象内部的<code>count</code>属性，而是只想的<code>global.count</code>。那么结果不言而喻。</p>
<p>现在使用箭头函数改写我们的代码：</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code><span class="token keyword">const</span> counter <span class="token operator">=</span> <span class="token punctuation">{</span>
    count<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token function">increase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token operator">++</span><span class="token keyword">this</span><span class="token punctuation">.</span>count<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

counter<span class="token punctuation">.</span><span class="token function">increase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
      </div>
<p>现在的情况是箭头函数在定义的时候，自动捕获了<code>increase</code>函数内的<code>this</code>,也就是<code>counter</code>对象，这个时候记事起就能正常工作了。</p>
<h4 id="this-in-classes-new-绑定"><a href="#this-in-classes-new-%E7%BB%91%E5%AE%9A" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>‘this’ in Classes (new 绑定)</h4>
<p><code>class</code>现在是JavaScript中非常重要的一员了，下面看看<code>class</code>中的this是怎么工作的。</p>
<p>每一个<code>class</code>都包含一个<code>constructor</code>,在该构造函数内的<code>this</code>指向的是新创建的对象。</p>
<p>和对象属性上的方法一样，<code>class</code>内方法的<code>this</code>也可以指定为其他的value,同样的，有时候也会丢失<code>this</code>。</p>
<p>我们使用<code>class</code>来重新创建上面的<code>Hero</code>：</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code><span class="token keyword">class</span> <span class="token class-name">Hero</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span>heroName<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>heroName <span class="token operator">=</span> heroName<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">dialogue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`I am </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>heroName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> batman <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Hero</span><span class="token punctuation">(</span><span class="token string">'Batman'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
batman<span class="token punctuation">.</span><span class="token function">dialogue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
      </div>
<p><code>constructor</code>内的<code>this</code>就等于新创建的实例<code>batman</code>,当我们调用<code>batman.dialogue()</code>的时候，<code>batman</code>是作为<code>dialogue</code>方法的调用者。</p>
<p>不过当我们把<code>batman.dialogue</code>赋值给另外一个变量的时候，然后把这个变量作为一个函数来调用，毫无疑问，我们将会再次丢失函数内部的<code>this</code>,这个时候方法内的this,实际上指向的是<code>undefined</code>。</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code><span class="token keyword">const</span> say <span class="token operator">=</span> batman<span class="token punctuation">.</span>dialogue<span class="token punctuation">;</span>
<span class="token function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
      </div>
<p>为什么会这样呢？因为<code>class</code>内的代码是隐式的在严格模式下执行的。我们直接调用了<code>say()</code>,而没有绑定任何<code>this</code>,为了解决这个问题，可以采用<code>bind</code>方法，来绑定函数内部的this。</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code><span class="token keyword">const</span> say <span class="token operator">=</span> batman<span class="token punctuation">.</span>dialogue<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>batman<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
      </div>
<p>也可以在<code>class</code>的<code>constructor</code>中进行预先绑定好：</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code><span class="token function">constructor</span><span class="token punctuation">(</span>heroName<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>heroName <span class="token operator">=</span> heroName<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>dialogue <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>dialogue<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
      </div>
<h3 id="solution"><a href="#solution" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>solution</h3>
<p>上面讲解了各种情况下的<code>this</code>的绑定机制，那么到底如何确定一个函数内部的<code>this</code>的指向呢？</p>
<ul>
<li>函数是否在<code>new</code>操作符中调用(new 绑定)，如果是：<code>this</code>绑定的就是新创建的对象；<code>var bar = new Foo()</code></li>
<li>函数是否通过<code>call</code>,<code>apply</code>(显式绑定)调用？如果是：<code>this</code>绑定的是制定的对象; <code>var bar = foo.call(obj)</code></li>
<li>函数是否在某个<code>上下文对象</code>中调用(隐式绑定)？如果是：<code>this</code>绑定的就是当前的上下文对象：<code>var bar = obj.foo()</code></li>
<li>如果都不是的话，那么就会使用默认绑定，也就是全局对象<code>global</code>;如果是在严格模式下，就是绑定到<code>undefined</code>; <code>var bar = foo()</code></li>
</ul>]]></description><link>https://reactjs.org/blog/2018/06/24/this.html</link><guid isPermaLink="false">https://reactjs.org/blog/2018/06/24/this.html</guid><pubDate>Sat, 23 Jun 2018 16:00:00 GMT</pubDate></item><item><title><![CDATA[react 性能优化：arrow function in react]]></title><description><![CDATA[<p>在react中最常见的一个操作就是把一个数组的数据map成一个react组件的数组，然后其中的每一个组件都要绑定事件，看一下下面的这个例子：</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> render <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"react-dom"</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>PureComponent</span> <span class="token punctuation">{</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> name<span class="token punctuation">,</span> onDeleteClick<span class="token punctuation">,</span> id <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> just rendered`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>button<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Delete<span class="token punctuation">"</span></span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>onDeleteClick<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span>
        <span class="token punctuation">{</span>name<span class="token punctuation">}</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">App</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>
      users<span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">"Cory"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">"Meg"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">"Bob"</span> <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  deleteUser <span class="token operator">=</span> id <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span>prevState <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        users<span class="token punctuation">:</span> prevState<span class="token punctuation">.</span>users<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>user <span class="token operator">=></span> user<span class="token punctuation">.</span>id <span class="token operator">!==</span> id<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>Users<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">></span></span>
          <span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>users<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>user <span class="token operator">=></span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span>
              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>User</span>
                <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>user<span class="token punctuation">.</span>id<span class="token punctuation">}</span></span>
                <span class="token attr-name">name</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>user<span class="token punctuation">.</span>name<span class="token punctuation">}</span></span>
                <span class="token attr-name">id</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>user<span class="token punctuation">.</span>id<span class="token punctuation">}</span></span>
                <span class="token attr-name">onDeleteClick</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">deleteUser</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">}</span></span>
              <span class="token punctuation">/></span></span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> App<span class="token punctuation">;</span>

<span class="token function">render</span><span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>App</span> <span class="token punctuation">/></span></span><span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"root"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
      </div>
<p>上面代码的关键在于<code>deleteUser</code>方法的使用，我们是使用了一个闭包来保存<code>user.id</code>的数据，然后在后面用户点击按钮的时候，能获取到用户点击的是哪一个<code>li</code>;</p>
<h3 id="so-whats-the-problem"><a href="#so-whats-the-problem" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>So What’s the Problem?</h3>
<p>上面的代码看上去及其简单，那么问题出现在哪里呢?</p>
<p>当我们点击删除按钮删除<code>Cory</code>的时候，我们发现<code>Meg</code>和<code>Bob</code>都重新渲染了，为何会这样？明明我们只是删除了<code>Cory</code>，和另外两个没有一点点关系的，并且<code>User</code>组件是<code>PureComponent</code>,也就是说，只有内部的<code>state</code>或者<code>props</code>发生改变的时候，才会触发重新渲染。<code>User</code>组件根本没有内部的<code>state</code>，那也就是只有一个可能，就是传递过来的<code>props</code>发生了变化。</p>
<p>再次分析一下，我们传递给<code>User</code>组件的数据，<code>key</code>,<code>name</code>,<code>id</code>,都不可能发生变化，那就只能是<code>onDeleteClick</code>发生了变化。</p>
<p>here is why ?当我们删除其中的一个user的时候，会触发App组件的<code>re-render</code>,在这个过程中，<code>this.deleteUser</code>方法会重新执行并返回一个新的函数，而这就是触发另外两个user <code>re-render</code>的原因，确实是收到了新的props。</p>
<h3 id="whats-the-solution"><a href="#whats-the-solution" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>What’s the Solution?</h3>
<p>那就是尽量在<code>render</code>方法中避免使用arrow function，而是抽取出<code>User</code>组件，在<code>User</code>组件的内部完成id的传输，看具体的代码：</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> render <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-dom'</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>PureComponent</span> <span class="token punctuation">{</span>
  onDeleteClick <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// No bind needed since we can compose the relevant data for this item here</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span><span class="token function">onClick</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>user<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>user<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> just rendered`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>button<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Delete<span class="token punctuation">"</span></span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>onDeleteClick<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span>
        <span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>user<span class="token punctuation">.</span>name<span class="token punctuation">}</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">App</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>
      users<span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">'Cory'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">'Meg'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">'Bob'</span><span class="token punctuation">}</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  deleteUser <span class="token operator">=</span> id <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span>prevState <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        users<span class="token punctuation">:</span> prevState<span class="token punctuation">.</span>users<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>user <span class="token operator">=></span> user<span class="token punctuation">.</span>id <span class="token operator">!==</span> id<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  renderUser <span class="token operator">=</span> user <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>User</span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>user<span class="token punctuation">.</span>id<span class="token punctuation">}</span></span> <span class="token attr-name">user</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>user<span class="token punctuation">}</span></span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>deleteUser<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>Users<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">></span></span>
          <span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>users<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>renderUser<span class="token punctuation">)</span><span class="token punctuation">}</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">render</span><span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>App</span> <span class="token punctuation">/></span></span><span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'root'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
      </div>
<p>在上面的这个代码中，我们在<code>render</code>方法中去掉了使用闭包来保存<code>id</code>的箭头函数，而是在<code>User</code>组件中<code>onDeleteClick</code>方法中来传递id,这样不管我们点击删除任何一个user的时候，都不会触发别的user的<code>re-render</code>;</p>
<h4 id="other-solution"><a href="#other-solution" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Other Solution</h4>
<p>我们也可以把id属性，绑定到html元素上的方式，来避免使用arrow function;</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">App</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>  
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>      
      users<span class="token punctuation">:</span> <span class="token punctuation">[</span>        
        <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">'Cory'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>         
        <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">'Meg'</span> <span class="token punctuation">}</span>      
      <span class="token punctuation">]</span>    
    <span class="token punctuation">}</span><span class="token punctuation">;</span>  
  <span class="token punctuation">}</span>

  deleteUser <span class="token operator">=</span> e <span class="token operator">=></span> <span class="token punctuation">{</span>   
    <span class="token keyword">const</span> id <span class="token operator">=</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span>prevState <span class="token operator">=></span> <span class="token punctuation">{</span>      
      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        users<span class="token punctuation">:</span> prevState<span class="token punctuation">.</span>users<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span> user <span class="token operator">=></span> user<span class="token punctuation">.</span>id <span class="token operator">!==</span> id<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>    
    <span class="token punctuation">}</span><span class="token punctuation">)</span>  
  <span class="token punctuation">}</span>   
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    
    <span class="token keyword">return</span> <span class="token punctuation">(</span>      
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>        
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>Users<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>        
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">></span></span>        
        <span class="token punctuation">{</span>           
          <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>users<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span> user <span class="token operator">=></span> <span class="token punctuation">{</span>            
            <span class="token keyword">return</span> <span class="token punctuation">(</span>              
              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>user<span class="token punctuation">.</span>id<span class="token punctuation">}</span></span><span class="token punctuation">></span></span>                
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span>                   
                  <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>button<span class="token punctuation">"</span></span>                   
                  <span class="token attr-name">value</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>user<span class="token punctuation">.</span>id<span class="token punctuation">}</span></span>                   
                  <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>deleteUser<span class="token punctuation">}</span></span>
                <span class="token punctuation">></span></span>
                  Delete
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>             
                  <span class="token punctuation">{</span>user<span class="token punctuation">.</span>name<span class="token punctuation">}</span>              
              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>            
            <span class="token punctuation">)</span>          
          <span class="token punctuation">}</span><span class="token punctuation">)</span>        
        <span class="token punctuation">}</span>        
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">></span></span>      
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    
    <span class="token punctuation">)</span><span class="token punctuation">;</span>  
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> App<span class="token punctuation">;</span>
</code></pre>
      </div>]]></description><link>https://reactjs.org/blog/2018/06/15/arrow-in-react.html</link><guid isPermaLink="false">https://reactjs.org/blog/2018/06/15/arrow-in-react.html</guid><pubDate>Thu, 14 Jun 2018 16:00:00 GMT</pubDate></item><item><title><![CDATA[react 条件渲染]]></title><description><![CDATA[<p>在react中通常我们需要根据各种不同的条件来渲染数据，例如最为常见的根据loading状态渲染loading动画组件还是渲染数据；</p>
<p>在项目中遇到的太多次上面的场景，故总结如下：</p>
<h3 id="三元运算符"><a href="#%E4%B8%89%E5%85%83%E8%BF%90%E7%AE%97%E7%AC%A6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>三元运算符</h3>
<p>在JSX中，你可以使用<code>三元运算符</code>去处理条件渲染:</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code><span class="token keyword">class</span> <span class="token class-name">Todo</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>
            todoList<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            loading<span class="token punctuation">:</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> loading<span class="token punctuation">,</span> todoList <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>
                <span class="token punctuation">{</span>loading <span class="token operator">?</span> <span class="token string">'loading'</span> <span class="token punctuation">:</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TodoList</span> <span class="token attr-name">list</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>todoList<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">}</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
      </div>
<p>可能存在的问题：如果有多个嵌套的<code>if</code>条件怎么处理？</p>
<h3 id="辅助方法"><a href="#%E8%BE%85%E5%8A%A9%E6%96%B9%E6%B3%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>辅助方法</h3>
<p>这是一个有用的方法，但是当组件更大时，你需要在辅助方法和<code>render()</code>方法之间上下跳跃,并且能把判断逻辑封装到相应的辅助方法中</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code><span class="token keyword">class</span> <span class="token class-name">Todo</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>
            todoList<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            loading<span class="token punctuation">:</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">renderTodos</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>loading<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token string">'loading'</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TodoList</span> <span class="token attr-name">list</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>todoList<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span>
    <span class="token punctuation">}</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>
                <span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">renderTodos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
      </div>
<h3 id="getter方法"><a href="#getter%E6%96%B9%E6%B3%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>getter方法</h3>
<p>如果你不喜欢在render方法中调用函数，可以使用对象的getter方法,可以使代码更优雅，getter方法更强大的地方在于可以把所有的判断条件抽取出来,组合成最终的结果</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code><span class="token keyword">class</span> <span class="token class-name">Todo</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>
            todoList<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            loading<span class="token punctuation">:</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">get</span> <span class="token function">renderTodos</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>loading<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token string">'loading'</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TodoList</span> <span class="token attr-name">list</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>todoList<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span>
    <span class="token punctuation">}</span>
    <span class="token keyword">get</span> <span class="token function">canShowSomeComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>loading
            <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ptops<span class="token punctuation">.</span>test
            <span class="token comment" spellcheck="true">// .... 其他条件</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>
                <span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>renderTodos<span class="token punctuation">}</span>
                <span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>canShowSomeComponent <span class="token operator">&amp;&amp;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>SomeComponent</span> <span class="token punctuation">/></span></span><span class="token punctuation">}</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
      </div>
<h3 id="hideif"><a href="#hideif" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><Hideif/></h3>
<p>我们可以自己简单封装一个隐藏的<Hideif/>组件来实现我们的目标:</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code><span class="token keyword">class</span> <span class="token class-name">Todo</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>
            todoList<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            loading<span class="token punctuation">:</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> loading<span class="token punctuation">,</span> todoList <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>HideIf</span> <span class="token attr-name">condition</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>loading<span class="token punctuation">}</span></span><span class="token punctuation">></span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TodoList</span> <span class="token attr-name">list</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>todoList<span class="token punctuation">}</span></span><span class="token punctuation">/></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>HideIf</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> HideIf <span class="token operator">=</span> <span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>props<span class="token punctuation">.</span>condition<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">'loading'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// children is what's inside &lt;HideIf> element</span>
<span class="token punctuation">}</span>
</code></pre>
      </div>
<h3 id="其他方案"><a href="#%E5%85%B6%E4%BB%96%E6%96%B9%E6%A1%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>其他方案</h3>
<p>现在前端环境最大的好处之一就是你想要什么功能，否可以去github上去找找，关于react中处理条件渲染的库，比较优秀的有:</p>
<ul>
<li><a href="https://github.com/ajwhite/render-if">render-if</a></li>
<li><a href="https://github.com/MicheleBertoli/react-only-if">react-only-if</a></li>
<li><a href="https://github.com/AlexGilleran/jsx-control-statements">jsx-control-statements</a></li>
</ul>]]></description><link>https://reactjs.org/blog/2018/05/26/react-if.html</link><guid isPermaLink="false">https://reactjs.org/blog/2018/05/26/react-if.html</guid><pubDate>Fri, 25 May 2018 16:00:00 GMT</pubDate></item><item><title><![CDATA[higher-order component(HOC)]]></title><description><![CDATA[<p>在函数式编程中，有一个概念叫做<a href="">高阶函数</a>,高阶函数通常意义上来说会对传入的函数进行增强，返回一个添加了额外功能的新函数。</p>
<p>当高阶函数的概念应用到React组件上的时候，被称为高阶组件，首先来看一下高阶组件长什么样子：</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code><span class="token keyword">const</span> hoc <span class="token operator">=</span> InnerComponent <span class="token operator">=></span> EnhancedComponent
</code></pre>
      </div>
<p>高阶组件其实就是一个函数，它接收组件作为参数，对组件进行增强后返回。</p>
<blockquote>
<p>个人觉得其实应该叫<code>组件工厂</code>更为合理</p>
</blockquote>
<p>具体看一下高阶组件的实现方法：</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code><span class="token keyword">function</span> <span class="token function">HOC</span><span class="token punctuation">(</span>InnerComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
  <span class="token keyword">return</span> <span class="token keyword">class</span> <span class="token class-name">extends</span> React<span class="token punctuation">.</span>Component <span class="token punctuation">{</span>
	state <span class="token operator">=</span> <span class="token punctuation">{</span>
			<span class="token comment" spellcheck="true">// ... some state</span>
	<span class="token punctuation">}</span>  
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      
      <span class="token keyword">return</span> <span class="token operator">&lt;</span>InnerComponent <span class="token punctuation">{</span><span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">}</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">}</span><span class="token operator">/</span><span class="token operator">></span>    
    <span class="token punctuation">}</span>  
  <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre>
      </div>
<p>其实<code>HOC</code>就是接收一个组件作为参数,然后新生成一个组件，不管这个新的组件内做了什么操作，获取了什么数据，统统通过<code>props</code>传递给<code>InnerComponent</code>,并返回新生成的组件</p>
<blockquote>
<p>这里也可以理解为 props proxy</p>
</blockquote>
<h3 id="高阶组件的主要用途"><a href="#%E9%AB%98%E9%98%B6%E7%BB%84%E4%BB%B6%E7%9A%84%E4%B8%BB%E8%A6%81%E7%94%A8%E9%80%94" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>高阶组件的主要用途</h3>
<h4 id="操作props"><a href="#%E6%93%8D%E4%BD%9Cprops" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>操作props</h4>
<p>由于<code>InnerComponent</code>的所有的<code>props</code>都是由<code>HOC</code>函数返回的新组件所提供的，所以我们可以通过高阶组件自由的操作传递给<code>InnerComponent</code>的<code>props</code>。</p>
<p>可以对props执行编辑、删除、新增等等操作,下面的例子展示了把state转换为props传给给InnerComponent,也可以对原有的props,进行新增一个属性之后传递给InnerComponent。</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code><span class="token keyword">function</span> <span class="token function">HOC</span><span class="token punctuation">(</span>InnerComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
  <span class="token keyword">return</span> <span class="token keyword">class</span> <span class="token class-name">extends</span> React<span class="token punctuation">.</span>Component <span class="token punctuation">{</span>
	state <span class="token operator">=</span> <span class="token punctuation">{</span>
		<span class="token comment" spellcheck="true">// ... some state</span>
	<span class="token punctuation">}</span>  
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	  <span class="token keyword">const</span> newProps<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">,</span> a <span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token operator">&lt;</span>InnerComponent <span class="token punctuation">{</span><span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">}</span> <span class="token punctuation">{</span><span class="token operator">...</span>newProps<span class="token punctuation">}</span><span class="token operator">/</span><span class="token operator">></span>    
    <span class="token punctuation">}</span>  
  <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre>
      </div>
<h4 id="在高阶组件中处理数据逻辑以及partial-applocation的使用"><a href="#%E5%9C%A8%E9%AB%98%E9%98%B6%E7%BB%84%E4%BB%B6%E4%B8%AD%E5%A4%84%E7%90%86%E6%95%B0%E6%8D%AE%E9%80%BB%E8%BE%91%E4%BB%A5%E5%8F%8Apartial-applocation%E7%9A%84%E4%BD%BF%E7%94%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>在高阶组件中处理数据逻辑以及partial applocation的使用</h4>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code><span class="token keyword">const</span> withData <span class="token operator">=</span> url <span class="token operator">=></span> InnerComponent <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">class</span> <span class="token class-name">extends</span> Component <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>
        data<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>InnerComponent<span class="token punctuation">{</span><span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">}</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> endPoint <span class="token operator">=</span> <span class="token keyword">typeof</span> url <span class="token operator">===</span> <span class="token string">'function'</span>
        <span class="token operator">?</span> <span class="token function">url</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">)</span>
        <span class="token punctuation">:</span> url<span class="token punctuation">;</span>

      <span class="token function">fetch</span><span class="token punctuation">(</span>endPoint<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>res <span class="token operator">=></span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>data <span class="token operator">=></span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          data
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> List <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> data<span class="token punctuation">:</span> gists<span class="token punctuation">,</span> <span class="token operator">...</span>props <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">></span></span>
    <span class="token punctuation">{</span>gists<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>gist <span class="token operator">=></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>gist<span class="token punctuation">.</span>id<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token punctuation">{</span>gist<span class="token punctuation">.</span>updated_at<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span><span class="token punctuation">)</span><span class="token punctuation">}</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">></span></span>
<span class="token punctuation">)</span>


<span class="token keyword">const</span> withGists <span class="token operator">=</span> <span class="token function">withData</span><span class="token punctuation">(</span>props <span class="token operator">=></span> <span class="token template-string"><span class="token string">`https://api.github.com/users/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>props<span class="token punctuation">.</span>username<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/gists`</span></span><span class="token punctuation">)</span>

<span class="token keyword">const</span> ListWithGists <span class="token operator">=</span> <span class="token function">withGists</span><span class="token punctuation">(</span>List<span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> ListWithGists
</code></pre>
      </div>
<h4 id="在高阶组件中处理ref指向不符合预期"><a href="#%E5%9C%A8%E9%AB%98%E9%98%B6%E7%BB%84%E4%BB%B6%E4%B8%AD%E5%A4%84%E7%90%86ref%E6%8C%87%E5%90%91%E4%B8%8D%E7%AC%A6%E5%90%88%E9%A2%84%E6%9C%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>在高阶组件中处理ref指向不符合预期</h4>
<p>有时候我们想要使用ref来获取实例或者DOM节点，看下面的例子：</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code><span class="token keyword">class</span> <span class="token class-name">Input</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
    state <span class="token operator">=</span> <span class="token punctuation">{</span> value<span class="token punctuation">:</span> <span class="token string">'init-value'</span> <span class="token punctuation">}</span>
    onchange <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> target <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> value<span class="token punctuation">:</span> target<span class="token punctuation">.</span>value <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">&lt;</span>input name<span class="token operator">=</span><span class="token string">'input1'</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">}</span> onChange<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>onchange<span class="token punctuation">}</span><span class="token operator">/</span><span class="token operator">></span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">HOC</span><span class="token punctuation">(</span>InnerComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">class</span> <span class="token class-name">extends</span> React<span class="token punctuation">.</span>Component <span class="token punctuation">{</span>
        <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">const</span> <span class="token punctuation">{</span> props <span class="token punctuation">}</span><span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>InnerComponent</span> <span class="token spread"><span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token attr-value">props</span><span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> InputHoc <span class="token operator">=</span> <span class="token function">HOC</span><span class="token punctuation">(</span>Input<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span><span class="token punctuation">{</span>
	textRef <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>InputHoc</span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>textRef<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span>
	<span class="token punctuation">}</span>
	<span class="token function">componentDidMounted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>textRef<span class="token punctuation">)</span> 
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
      </div>
<p>这个时候我们会发现实际上我们获取到的<code>this.textRef</code>并不是指向原本的我们想要获取的<code>InnerComponent</code>的实例，而是指向了<code>HOC</code>函数返回的新的包装组件。</p>
<p>而这就是所说的高阶组件会导致<code>ref</code>指向不符合预期的问题，那么如何解决这个问题呢？</p>
<p>我们只要在<code>HOC</code>函数中添加一个新的<code>ref</code>属性，来指向我们的目标<code>InnerComponent</code>即可，看代码：</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code><span class="token keyword">function</span> <span class="token function">HOC</span><span class="token punctuation">(</span>InnerComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">class</span> <span class="token class-name">extends</span> React<span class="token punctuation">.</span>Component <span class="token punctuation">{</span>
        innerRef <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> props <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>
                <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">,</span>
                <span class="token punctuation">{</span> ref<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>innerRef <span class="token punctuation">}</span>
            <span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>InnerComponent</span> <span class="token spread"><span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token attr-value">props</span><span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
      </div>
<p>此时在<code>Test</code>组件中，我们使用<code>this.textRef.current.innerRef</code>即可指向我们的<code>InnerComponent</code>组件的<code>ref</code></p>
<h3 id="solution"><a href="#solution" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>solution</h3>
<p>高阶组件在React工具链中使用的比较多，最为典型的就是React-Redux库提供的<a href="https://github.com/reduxjs/react-redux/blob/master/src/connect/connect.js">connect</a>方法,其实和我们上面例子中的<code>withData</code>思路类似，只不过接收的参数不是url,而是<code>mapStateToProps</code>、<code>mapDispatchToProps</code>等参数</p>
<p>高阶组件还有一种方式实现，就是新创建的组件继承<code>InnerComponent</code>,简单的代码如下：</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code><span class="token keyword">function</span> <span class="token function">HOC</span><span class="token punctuation">(</span>InnerComponent<span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">class</span> <span class="token class-name">extends</span> InnerComponent<span class="token punctuation">{</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>loading<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Loading</span><span class="token punctuation">/></span></span>
      <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
      </div>
<p>这种使用方式甚至可以通过<code>super.render()</code>获取到<code>InnerComponent</code>的<code>element tree</code>,配合<code>React.cloneElement</code>方法，继而可以对tree进行编辑，删除等等(注意不要修改共享状态，尽量使用纯函数)，不过这种实现高阶组件的方式，在React社区不是特别的流行，不做过多介绍</p>]]></description><link>https://reactjs.org/blog/2018/05/21/hight-order-component.html</link><guid isPermaLink="false">https://reactjs.org/blog/2018/05/21/hight-order-component.html</guid><pubDate>Sun, 20 May 2018 16:00:00 GMT</pubDate></item><item><title><![CDATA[arrow function this]]></title><description><![CDATA[<p>ES6中值得称赞的特性之一就是提供函数表达式缩写定义的箭头函数语法。你很难发现关于ES6（或者甚至甚少与其相关的）的一篇文章、会议演讲或者书都没有首要介绍<code>=></code>是新的<code>function</code>。</p>
<p>其中有一点是最让人困惑的，就是箭头函数内的<code>this</code>到底指向哪里？举个例子来说：</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"id:"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
foo<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span> <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">42</span> <span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// id: 42</span>
</code></pre>
      </div>
<p>这里的<code>=></code>箭头函数似乎绑定了它的<code>this</code>到父函数<code>foo()</code>的this上,不过也仅仅是看上去如此罢了，那么到底是怎么回事呢？，我们把上面的代码稍微修改一下：</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">var</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
   <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"id:"</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
foo<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span> <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">42</span> <span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// id: 42</span>
</code></pre>
      </div>
<blockquote>
<p>变量名self是一个绝对可怕的，有误导的名字。它意味着this是函数本身的引用。但它从来没有。var that = this语义上同样无益，尤其当有多个作用域生效的时候（that1,that2,…）。如果你想要一个恰当的名字，使用var context = this，因为那就是this真正的含义：一个动态的上下文</p>
</blockquote>
<p>在上面这个片段中，你可以看到我们甚至没有在内部函数使用<code>this</code>。相反，我们回退到一个更可预见性的机制：词法变量。我们在外部函数声明一个变量<code>self</code>，然后简单的在内部函数引用它。</p>
<p>这种完全消除了<code>this</code>绑定规则（对于内部函数，也是）。取而代之的是仅仅依赖<code>词法作用域</code>规则，实际上是闭包。</p>
<p>最终的结果似乎和<code>=></code>箭头函数一样，换句话说，这里的（不严谨的）含义是<code>=></code>箭头函数有一个了类似词法环境/闭包机制的方式的“词法this”行为</p>
<p>在看一个例子：</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"id:"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
foo<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span> <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">42</span> <span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// id: 42</span>
</code></pre>
      </div>
<p>正如你看到的.bind(this)，这里的内部函数被强制绑定到外部函数的this，也意味着不管setTimeout(…)如何调用函数，调用函数始终使用foo()函数使用的this。</p>
<p>是的，这个版本有着和先前两个代码片段同样可观察到的行为。因此，它更精确吗？很多人认为这就是<code>=></code>箭头函数实际上运行原理。</p>
<p><strong>然而上面的结论应该都是错误的，就像是高中的时候，虽然一个题我们得到了最终的结果，但是老师会提出我们的整个计算过程都是错误的！</strong></p>
<p>关于箭头函数内的<code>this</code>的指向，正确的解释应该是：<code>=></code>从不绑定自己的<code>this</code>,而是直接获取当前<code>词法作用域</code>上下文作为自己的this，换句话说就是既然箭头函数没有自己的<code>this</code>,但是当你在箭头函数内部使用<code>this</code>的时候，普通<code>词法作用域</code>的规则是生效的,引用被解析为包含最近的外部作用域定义的this。
看这段代码：</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
         <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"id:"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
foo<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">42</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">// id: 42</span>
</code></pre>
      </div>
<p>在这个片段中，你认为有多少个<code>this</code>绑定？大多数可能认为是4个，每个函数一个。
准确无误的来说，只有一个，是在<code>foo()</code>函数中。
相继嵌套的<code>=></code>箭头函数没有声明自己的this，因此<code>this.id</code>简单的沿着作用域链解析直到找到<code>foo()</code>，第一个确切绑定<code>this</code>的函数。</p>
<p>和其他的普通的词法变量的处理方式是一样的。</p>
<p>如果你含糊不清地解释<code>=></code>对this的行为，你最终认为<code>箭头函数仅仅是function的语法糖……</code>,这是非常危险的，它们显然不是，也不是<code>var self = this</code>或者<code>.bind(this)</code>的语法糖。</p>
<p>事实上，<code>=></code>箭头函数不绑定<code>this</code>、<code>arguments</code>、<code>super(ES6)</code>或者<code>new.target(ES6)</code>。
看下面的代码：</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token function">setTimeout</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"args:"</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">foo</span><span class="token punctuation">(</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">8</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// args: [2, 4, 6, 8]</span>
</code></pre>
      </div>
<p>在这个片段中，<code>arguments</code>没有被<code>=></code>限定，因此它被解析到<code>foo()</code>函数的<code>arguments</code>。<code>super</code>和<code>new.target</code>也是同样的结果。</p>
<p>所以为什么对箭头函数<code>.bind({...})</code>不能得到我们想要的修改函数内部<code>this</code>指向的结果呢？</p>
<p>如果你对<code>=></code>箭头函数的this有不准确的理解，你不得不假设可以这样解释：<code>在arrow function 中 this是不可改变的</code>，虽然结论是正确的，但是思考过程确实错误的。</p>
<p>简单正确的答案是既然<code>=></code>没有this，当然<code>.bind(obj)</code>没有什么可以操作！类似地，<code>=></code>不能被<code>new</code>操作符调用。既然没有<code>this</code>，<code>new</code>没有东西可以绑定。</p>]]></description><link>https://reactjs.org/blog/2018/03/16/arrow-function-this.html</link><guid isPermaLink="false">https://reactjs.org/blog/2018/03/16/arrow-function-this.html</guid><pubDate>Thu, 15 Mar 2018 16:00:00 GMT</pubDate></item><item><title><![CDATA[web image 加载优化方案--responsive-image]]></title><description><![CDATA[<p>所谓响应式的图片，就是让我们在不同的平台，不同的设备上使用的图片都不一样，设计师切图给我们的时候，一般都会把给我1x,2x,3x,4x的图片，有的时候，那么这几张图片我们该怎么使用呢？</p>
<p>这个时候就会有HTML5的img,<a href="https://developer.mozilla.org/zh-CN/docs/Web/HTML/Element/img">srcset</a>属性出场的时候到了，srcset可以让我们支持在一个img元素中预设多张图片，方便浏览器在不同的设备中选择最合适的那一张图片。   </p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>small.jpg<span class="token punctuation">"</span></span> <span class="token attr-name">srcset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>medium.jpg 1000w, large.jpg 2000w<span class="token punctuation">"</span></span> <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>yah<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
</code></pre>
      </div>
<p>简单介绍一个srcset的使用方法：
以逗号分隔的一个或多个字符串列表表明一系列用户代理使用的可能的图像。每一个字符串由以下组成：</p>
<ul>
<li>
<p>一个图像的URL。</p>
</li>
<li>
<p>可选的，空格后跟以下的其一：</p>
<ul>
<li>一个宽度描述符，这是一个正整数，后面紧跟<code>'w'</code>符号。该整数宽度除以sizes属性给出的资源(source)大小来计算得到有效的像素密度，即换算成和x描述符等价的值。</li>
<li>一个像素密度描述符，这是一个正浮点数，后面紧跟<code>'x'</code>符号。</li>
</ul>
</li>
<li>
<p>如果没有指定源描述符，那它会被指定为默认的<code>1x</code>。</p>
</li>
<li>
<p>在相同的<code>srcset</code>属性中混合使用宽度描述符和像素密度描述符时，会导致该值无效。重复的描述符（比如，两个源 在相同的srcset两个源都是 ‘2x’）也是无效的。</p>
</li>
</ul>
<h3 id="第二个参数的说明"><a href="#%E7%AC%AC%E4%BA%8C%E4%B8%AA%E5%8F%82%E6%95%B0%E7%9A%84%E8%AF%B4%E6%98%8E" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第二个参数的说明</h3>
<h4 id="如果为1x，2x，3x之类的"><a href="#%E5%A6%82%E6%9E%9C%E4%B8%BA1x%EF%BC%8C2x%EF%BC%8C3x%E4%B9%8B%E7%B1%BB%E7%9A%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如果为1x，2x，3x之类的</h4>
<p>1x表示是一倍屏，也是最常见的一种电脑屏幕了，2x表示的两倍屏，一般现在apple的macbook都是两倍屏，现在新的手机，会出现3倍屏，4倍屏之类的，这个很好理解，</p>
<h4 id="如果第二为w的应当如何理解"><a href="#%E5%A6%82%E6%9E%9C%E7%AC%AC%E4%BA%8C%E4%B8%BAw%E7%9A%84%E5%BA%94%E5%BD%93%E5%A6%82%E4%BD%95%E7%90%86%E8%A7%A3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如果第二为w的应当如何理解</h4>
<p>举例来说明：
如果我们要显示一张图片为320px宽度在1x屏幕上，并且我们现在手中有三张图片，分别是small.jpg(500px wide),middle.jpg(1000px wide), large.jpg (2000px wide)。</p>
<p>那个浏览器该如何判断选用哪一张图片呢？先做个简单的计算
500 / 320 = 1.5625
1000 / 320 = 3.125
2000 / 320 = 6.25</p>
<p>如果是1x的屏幕，那么1.5625是最接近的一张，尽管这张图片<code>分辨率</code>也有一点点高,但是却是这三张图片里面最合适的了。</p>
<p>如果是2x的屏幕，尽管1.5625还是最接近的一张图片，但是这张图片对于2x的屏幕来说却是有一点不够清楚，会让用户觉得图片有点模糊，那么很明显这个时候3.125是更好的选择</p>
<h4 id="also-sizes"><a href="#also-sizes" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Also, sizes</h4>
<p>还有一个与<code>srcset</code>属性配合使用sizes属性，
表示资源大小的以逗号隔开的一个或多个字符串。每一个资源大小包括：</p>
<ul>
<li>一个媒体条件。最后一项一定是被忽略的。</li>
<li>一个资源尺寸的值。</li>
</ul>
<p>资源尺寸的值被用来指定图像的预期尺寸。当srcset使用 ‘w’ 描述符时，用户代理使用当前图像大小来选择srcset中合适的一个图像URL。 被选中的尺寸影响图像的显示大小（如果没有CSS样式被应用的话）。如果没有设置srcset属性，或者没值，那么sizes属性也将不起作用。</p>
<p>其实sizes属性并没有那么的必要，有时候使用起来或许还有点危险，因为这是相当于把CSS的一部分功能放进了HTMl标记中，举例来说：</p>
<p><code>sizes="(min-width: 800px) 50vw, 100vw"</code></p>
<p>这个属性的意思是，如果浏览器的窗口大于等于800px的情况下，那么该图片应该显示视口的一半宽度，否则应当显示为满屏。</p>
<h4 id="responsivewebp-images-in-html"><a href="#responsivewebp-images-in-html" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Responsive&#x26;Webp images in HTML</h4>
<p>最基本的<code>img</code>标签又一个<code>src</code>属性可以指向图片的URL:</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>image.jpg<span class="token punctuation">"</span></span> <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>image description<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
</code></pre>
      </div>
<p>但是你可以更进一步使用<code>srcset</code>属性，根据不同屏幕的像素密度因子制定不同清晰度的图片：</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">srcset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>image_1x.jpg 1x, image_2x.jpg 2x<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>image_1x.jpg<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
</code></pre>
      </div>
<p>我们使用了两种不同的像素密度因子：<code>1x</code>和<code>2x</code>,根据实际的硬件设备，浏览器会选择正确的那个，同时使用<code>src</code>属性指向回退选项。</p>
<p>目前除了IE,Edge之外的大多数浏览器都实现了<code>srcset</code>属性。</p>
<p>但是对于相同的像素密度因子，无论显示大小如何，你的浏览器都会选择相同的图片，不过有时候我们却想在web端显示大而清晰的图片，而在手机端的时候，我们要选择小而清晰的图片。</p>
<p><code>srcset</code>属性除了能接受像素密度因子，之外，还可以接受宽度单位<code>w</code>,相当于CSS像素。使用宽度，可以使浏览器能够显示我们想要的正确的图像。</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span>
    <span class="token attr-name">srcset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>image-sm.jpg 600w,
    image-md.jpg 900w,
    image-lg.jpg 1440w<span class="token punctuation">"</span></span>
    <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>image_1x.jpg<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
</code></pre>
      </div>
<p>但是这里又一个问题就是，有了宽度浏览器去决定要获取哪一个图片的时候，它还不知道我们的CSS设置，因为在这个时候，CSS文件还没有请求到，这个时候浏览器只能假设我们要显示一个全宽的图片。</p>
<p>如果全宽的图像正是你想要的，那么OK！但是如果你只想在一个<code>50vw</code>宽度的容器内显示图像呢，那么<code>sizes</code>属性可以为你解决这个问题</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span>
    <span class="token attr-name">srcset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>image-sm.jpg 600w,
    image-md.jpg 900w,
    image-lg.jpg 1440w<span class="token punctuation">"</span></span>
    <span class="token attr-name">sizes</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>50vw<span class="token punctuation">"</span></span>
    <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>image_1x.jpg<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
</code></pre>
      </div>
<p>通过添加<code>sizes=50vw</code>属性，我们告诉浏览器图片将会被渲染在<code>50vw</code>的宽度内，基于这个信息，浏览器可以选择使用哪张图片了</p>
<p>但是如果你想在一个大屏幕上使用<code>50vw</code>来展示一张图片，然后在手机端使用<code>100vw</code>全屏来展示一张图片，这个时候该怎么做呢，<code>sizes</code>属性还支持媒体查询</p>
<p>你可以在<code>600px</code>一下的时候，使用全屏宽度来展示图片，如果宽度超过<code>600px</code>，就可以使用<code>50vw</code>来展示图片。</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span>
    <span class="token attr-name">srcset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>image-sm.jpg 600w,
    image-md.jpg 900w,
    image-lg.jpg 1440w<span class="token punctuation">"</span></span>
    <span class="token attr-name">size</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>(max-width: 600px) 100vw, 50vw<span class="token punctuation">"</span></span>
    <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>image_1x.jpg<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
</code></pre>
      </div>
<p>这个解决方案，看上去很不错啦，不过我们发现我们的像素密度因子去哪了？如果我们使用上面的方案，我们会在<code>1x</code>和<code>2x</code>的屏幕上选择相同的图片。</p>
<html><head></head><body><h4>picture&#x5143;&#x7D20;</h4>
HTML5&#x7684;`picture`&#x5143;&#x7D20;&#x53EF;&#x4EE5;&#x63A5;&#x53D7;`source`&#x548C;`img`&#x5143;&#x7D20;&#x4F5C;&#x4E3A;&#x5B50;&#x5143;&#x7D20;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;`source`&#x5143;&#x7D20;&#x5217;&#x51FA;&#x6765;&#x6211;&#x4EEC;&#x60F3;&#x8981;&#x63D0;&#x4F9B;&#x7ED9;&#x6D4F;&#x89C8;&#x5668;&#x7684;&#x5176;&#x4ED6;&#x56FE;&#x7247;&#x3002;
``` html
<picture>
    <source srcset="image.webp" type="image/webp">
    
</picture>
```
&#x8BA9;&#x6211;&#x4EEC;&#x5728;`picture`&#x5143;&#x7D20;&#x4E2D;&#x6DFB;&#x52A0;`source`&#x5143;&#x7D20;&#x4F5C;&#x4E3A;`WebP`&#x683C;&#x5F0F;&#x7684;&#x7B2C;&#x4E00;&#x4E2A;&#x9009;&#x9879;&#xFF0C;&#x7136;&#x540E;&#x662F;&#x6307;&#x5411;&#x5E38;&#x89C4;JPG&#x56FE;&#x50CF;&#x7684;`img`&#x3002; &#x73B0;&#x5728;&#xFF0C;&#x5F53;&#x6D4F;&#x89C8;&#x5668;&#x4E0D;&#x652F;&#x6301;WebP&#x65F6;&#xFF0C;&#x5B83;&#x5C06;&#x4F18;&#x96C5;&#x5730;&#x56DE;&#x9000;&#x5230;`img` &#x5143;&#x7D20;(&#x4F8B;&#x5982;Safari)&#x3002;
`source`&#x5143;&#x7D20;&#x5411;&#x6211;&#x4EEC;&#x6253;&#x5F00;&#x4E86;&#x4E00;&#x4E2A;&#x65B0;&#x4E16;&#x754C;&#xFF0C;&#x5B83;&#x53EF;&#x4EE5;&#x63A5;&#x53D7;&#x5A92;&#x4F53;&#x67E5;&#x8BE2;&#xFF0C;&#x9996;&#x5148;&#x5728;`media`&#x5C5E;&#x6027;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x4F7F;&#x7528;&#x5A92;&#x4F53;&#x67E5;&#x8BE2;&#xFF0C;&#x7136;&#x540E;&#x5728;`srcset`&#x5C5E;&#x6027;&#x4E2D;&#xFF0C;&#x653E;&#x7F6E;&#x5408;&#x9002;&#x7684;&#x56FE;&#x50CF;&#xFF0C;&#x5C3D;&#x53EF;&#x80FD;&#x7684;&#x4F7F;&#x7528;`source`&#x5143;&#x7D20;&#x589E;&#x52A0;&#x6211;&#x4EEC;&#x7684;&#x9009;&#x9879;
``` html
<picture>
    <source media="(min-width: 900px)" srcset="image-lg.webp" type="image/webp">
    <source media="(min-width: 600px)" srcset="image-md.webp" type="image/webp">
    <source srcset="image-sm.webp" type="image/webp">
    
</picture>
```
&#x4E0A;&#x9762;&#x6211;&#x4EEC;&#x5DF2;&#x7ECF;&#x51C6;&#x5907;&#x4E86;&#x4E09;&#x4E2A;WebP&#x683C;&#x5F0F;&#x7684;&#x56FE;&#x50CF;&#xFF0C;&#x8FD9;&#x53D6;&#x51B3;&#x4E8E;&#x663E;&#x793A;&#x5668;&#x7684;&#x5927;&#x5C0F;&#xFF0C;&#x5E76;&#x4E14;&#x4E00;&#x4E2A;JPG&#x56FE;&#x50CF;&#x4F5C;&#x4E3A;&#x56DE;&#x9000;&#x9009;&#x9879;&#x3002;</body></html>
<p><code>srcset</code>属性的最后一个秘密是它也接受像素密度因子，我们可以决定在哪个屏幕上以及在哪个像素密度因子下提供不同的图像。方法就是在图像的<code>srcset</code>中，后跟一个空格和像素密度因子，例如：<code>1x</code>,<code>2x</code>,<code>3x</code>,<code>4x</code>.</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>picture</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>source</span>
        <span class="token attr-name">media</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>(min-width: 900px)<span class="token punctuation">"</span></span>
        <span class="token attr-name">srcset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>image-lg_1x.webp 1x, image-lg_2x.webp 2x<span class="token punctuation">"</span></span>
        <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>image/webp<span class="token punctuation">"</span></span> <span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>source</span>
        <span class="token attr-name">media</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>(min-width: 601px)<span class="token punctuation">"</span></span>
        <span class="token attr-name">srcset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>image-md_1x.webp 1x, image-md_2x.webp 2x<span class="token punctuation">"</span></span>
        <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>image/webp<span class="token punctuation">"</span></span> <span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>source</span>
        <span class="token attr-name">media</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>(max-width: 600px)<span class="token punctuation">"</span></span>
        <span class="token attr-name">srcset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>image-sm_1x.webp 1x, image-sm_1x.webp 1x<span class="token punctuation">"</span></span>
        <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>image/webp<span class="token punctuation">"</span></span> <span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span>
        <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>image-lg_1x.jpg<span class="token punctuation">"</span></span>
        <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>image/jpeg<span class="token punctuation">"</span></span>
        <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>image description<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>picture</span><span class="token punctuation">></span></span>
</code></pre>
      </div>
<p>上面我们使用了WebP格式的图片和像素密度因子，但是有些浏览器不支持WebP格式，我们必须在<code>img</code>标签内设置回退选项。</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>picture</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>source</span>
        <span class="token attr-name">media</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>(min-width: 900px)<span class="token punctuation">"</span></span>
        <span class="token attr-name">srcset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>image-lg_1x.webp 1x, image-lg_2x.webp 2x<span class="token punctuation">"</span></span>
        <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>image/webp<span class="token punctuation">"</span></span> <span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>source</span>
        <span class="token attr-name">media</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>(min-width: 601px)<span class="token punctuation">"</span></span>
        <span class="token attr-name">srcset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>image-md_1x.webp 1x, image-md_2x.webp 2x<span class="token punctuation">"</span></span>
        <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>image/webp<span class="token punctuation">"</span></span> <span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>source</span>
        <span class="token attr-name">srcset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>image-sm_1x.webp 1x, image-sm_2x.webp 2x<span class="token punctuation">"</span></span>
        <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>image/webp<span class="token punctuation">"</span></span> <span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> 
        <span class="token attr-name">srcset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>image-sm_1x.jpg 600w,
            image-md_1x.jpg 900w,
            image-lg_1x.jpg 1440w<span class="token punctuation">"</span></span>
        <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>image_lg_1x.jpg<span class="token punctuation">"</span></span>
        <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>image/jpeg<span class="token punctuation">"</span></span>
        <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>image description<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>picture</span><span class="token punctuation">></span></span>
</code></pre>
      </div>
<p>我们用<code>picture</code>元素替换了<code>img</code>元素。在可能的情况下，我们希望根据显示尺寸和2种不同的像素密度，以三种不同的大小提供WebP格式的图像。如果览器不支持 <code>picture</code>元素或<code>WebP</code>格式，它将回落到具有三种不同大小<code>JPG</code>的标准<code>img</code>元素。</p>
<blockquote>
<p>请注意，在<code>img</code>元素中，<code>srcset</code>属性应放置在<code>src</code>属性之前。否则，浏览器会首先下载<code>src</code>图像，如果在<code>srcset</code>中找到了更好的图像，它也会下载这个图像。这样我们最终会得到两个图像。</p>
</blockquote>
<h4 id="how-to-use-responsive-images-in-css"><a href="#how-to-use-responsive-images-in-css" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>How To Use Responsive Images In CSS</h4>
<p>借助less等预编译语言，配合webp是否支持的方案，可以写出如下代码：</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-less"><code><span class="token selector">.retinabg(<span class="token variable">@file-2x</span>; <span class="token variable">@reg-2x</span>; <span class="token variable">@reg-1x</span>; <span class="token variable">@type</span>) when (isstring(<span class="token variable">@reg-2x</span>))</span> <span class="token punctuation">{</span>
    <span class="token property">background-image</span><span class="token punctuation">:</span> <span class="token url">url("@{file-2x}.@{reg-1x}.@{type}")</span><span class="token punctuation">;</span>
    <span class="token selector">.webpa &amp;</span> <span class="token punctuation">{</span>
        <span class="token property">background-image</span><span class="token punctuation">:</span> <span class="token url">url('@{file-2x}.@{reg-1x}.@{type}.webp')</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token atrule">@media only screen and <span class="token punctuation">(</span> min-device-pixel-ratio<span class="token punctuation">:</span> 2<span class="token punctuation">)</span>,
    only screen and <span class="token punctuation">(</span> min-resolution<span class="token punctuation">:</span> 192dpi<span class="token punctuation">)</span>,
    only screen and <span class="token punctuation">(</span> min-resolution<span class="token punctuation">:</span> 2dppx<span class="token punctuation">)</span></span> <span class="token punctuation">{</span>
        <span class="token property">background-image</span><span class="token punctuation">:</span> <span class="token url">url("@{file-2x}.@{reg-2x}.@{type}")</span><span class="token punctuation">;</span>
        <span class="token selector">.webpa &amp;</span> <span class="token punctuation">{</span>
            <span class="token property">background-image</span><span class="token punctuation">:</span> <span class="token url">url('@{file-2x}.@{reg-2x}.@{type}.webp')</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token selector">.retinabg-test</span> <span class="token punctuation">{</span>
    <span class="token mixin-usage function">.retinabg</span><span class="token punctuation">(</span><span class="token string">'./bg.jpg'</span><span class="token punctuation">,</span><span class="token string">'2x'</span><span class="token punctuation">,</span><span class="token string">'1x'</span><span class="token punctuation">,</span><span class="token string">'jpg'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
      </div>
<p>编译之后的结果为：</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-css"><code><span class="token selector">.retinabg-test</span> <span class="token punctuation">{</span>
  <span class="token property">background-image</span><span class="token punctuation">:</span> <span class="token url">url("./bg.jpg.1x.jpg")</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">.webpa .retinabg-test</span> <span class="token punctuation">{</span>
  <span class="token property">background-image</span><span class="token punctuation">:</span> <span class="token url">url('./bg.jpg.1x.jpg.webp')</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token atrule"><span class="token rule">@media</span> only screen and <span class="token punctuation">(</span><span class="token property">min-device-pixel-ratio</span><span class="token punctuation">:</span> 2<span class="token punctuation">)</span>, only screen and <span class="token punctuation">(</span><span class="token property">min-resolution</span><span class="token punctuation">:</span> 192dpi<span class="token punctuation">)</span>, only screen and <span class="token punctuation">(</span><span class="token property">min-resolution</span><span class="token punctuation">:</span> 2dppx<span class="token punctuation">)</span></span> <span class="token punctuation">{</span>
  <span class="token selector">.retinabg-test</span> <span class="token punctuation">{</span>
    <span class="token property">background-image</span><span class="token punctuation">:</span> <span class="token url">url("./bg.jpg.2x.jpg")</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token selector">.webpa .retinabg-test</span> <span class="token punctuation">{</span>
    <span class="token property">background-image</span><span class="token punctuation">:</span> <span class="token url">url('./bg.jpg.2x.jpg.webp')</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
      </div>
<h4 id="how-to-generate-reponsive-images"><a href="#how-to-generate-reponsive-images" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>How To Generate Reponsive Images</h4>
<p>上面提到了不同屏幕，尺寸，格式下的图片都需要不同的图片，不过设计师一般给我们的都是一张图片，应当如何处理呢，特别是存在大量图片的时候，我们需要一个能够批量处理图片的工具。</p>
<p>我们可以选择支持三个分界线的图片：<code>600px</code>,<code>900px</code>,<code>1440px</code>和两种像素密度因子(用来支持retina屏和普通屏)，这样就是由原来的一张图片转换为了6张图片，同时我们要尽可能的支持WebP,那么这时候，就是12张图片了。</p>
<p><a href="http://www.imagemagick.org/script/index.php">ImageMagic</a>和<a href="http://www.graphicsmagick.org/">GraphicsMagick</a>都是免费且强大的图片处理工具，并且现在都有node.js的版本，这是我们前端开发工程师擅长的领域。</p>
<p><a href="https://github.com/aheckmann/gm">gm</a>就是node.js版本的GraphicsMagick,使用方法如下：
首先安装GraphicsMagick和ImageMagick</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-none"><code>brew install graphicsmagick
brew install imagemagick --with-webp</code></pre>
      </div>
<p>然后安装gm:</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-none"><code>npm install gm</code></pre>
      </div>
<p>然后我们就可以写代码批量处理某个文件夹的所有文件,gm的<a href="http://aheckmann.github.io/gm/">具体api</a>很简单，直接看文档就可以了，不再具体说明。</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> gm <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gm'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    dir <span class="token operator">=</span> __dirname <span class="token operator">+</span> <span class="token string">'/imgs'</span><span class="token punctuation">,</span>
    imageMagick <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"imagemagick"</span><span class="token punctuation">)</span>

<span class="token keyword">var</span> filePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'./imgs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

fs<span class="token punctuation">.</span><span class="token function">readdir</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>err<span class="token punctuation">,</span> files<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//遍历读取到的文件列表  </span>
        files<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>filename<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//获取当前文件的绝对路径  </span>
            <span class="token keyword">var</span> filedir <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//根据文件路径获取文件信息，返回一个fs.Stats对象  </span>
            fs<span class="token punctuation">.</span><span class="token function">stat</span><span class="token punctuation">(</span>filedir<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>eror<span class="token punctuation">,</span> stats<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>eror<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'获取文件stats失败'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token keyword">var</span> isFile <span class="token operator">=</span> stats<span class="token punctuation">.</span><span class="token function">isFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//是文件   </span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>isFile<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">var</span> name <span class="token operator">=</span> filename<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
                        <span class="token keyword">var</span> type <span class="token operator">=</span> filename<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                        <span class="token keyword">const</span> createFun <span class="token operator">=</span> <span class="token function">createResponsiveImgs</span><span class="token punctuation">(</span>filedir<span class="token punctuation">,</span> name<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">createFun</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token string">'sm'</span><span class="token punctuation">,</span> <span class="token string">'1x'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">createFun</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token string">'sm'</span><span class="token punctuation">,</span> <span class="token string">'2x'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">createFun</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token string">'md'</span><span class="token punctuation">,</span> <span class="token string">'1x'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">createFun</span><span class="token punctuation">(</span><span class="token number">800</span><span class="token punctuation">,</span> <span class="token string">'md'</span><span class="token punctuation">,</span> <span class="token string">'2x'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">createFun</span><span class="token punctuation">(</span><span class="token number">800</span><span class="token punctuation">,</span> <span class="token string">'lg'</span><span class="token punctuation">,</span> <span class="token string">'1x'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">createFun</span><span class="token punctuation">(</span><span class="token number">1600</span><span class="token punctuation">,</span> <span class="token string">'lg'</span><span class="token punctuation">,</span> <span class="token string">'2x'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">createResponsiveImgs</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> fileType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>size<span class="token punctuation">,</span> name<span class="token punctuation">,</span> density<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> file <span class="token operator">=</span> <span class="token function">gm</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        file<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`resImg/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>fileName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>density<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>fileType<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">,</span> err <span class="token operator">=></span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>

                imageMagick<span class="token punctuation">.</span><span class="token function">convert</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token template-string"><span class="token string">`resImg/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>fileName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>density<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>fileType<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">,</span> <span class="token template-string"><span class="token string">`resImg/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>fileName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>density<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.webp`</span></span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    err <span class="token operator">=></span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
                        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>fileName <span class="token operator">+</span> <span class="token string">'创建成功'</span><span class="token punctuation">)</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
      </div>
<p>原文件的图像都在imgs文件夹内，新生成的图像在resImg文件夹内，新生成的图像具有一下命名结构：    </p>
<p><strong>originName _ description _ density.type</strong>  </p>
<p>在我的项目中，原图片的大小为486kb,新生成的12个图片中，最大的为 124kb,最小的为7kb,这样计算的话，我们减少了<code>4-70</code>倍的大小，对于网速加载速度而言，自然会快很多，尤其是在不同的终端，不同的分辨率之下！</p>]]></description><link>https://reactjs.org/blog/2018/03/10/responsive-img.html</link><guid isPermaLink="false">https://reactjs.org/blog/2018/03/10/responsive-img.html</guid><pubDate>Fri, 09 Mar 2018 16:00:00 GMT</pubDate></item><item><title><![CDATA[web image 加载优化方案--placeholder]]></title><description><![CDATA[<p>大概的placeholder的技术方案基本思路都是先加载一个很小的模糊但是能基本展示图片的轮廓和色调的图片作为占位符，然后再加载真正要展示的图像，大的图像加载完成之后，使用一个渐变的效果隐藏小的图片，展示真正的图片。</p>
<p>placeholder也分为很多类型，常见的有：</p>
<html><head></head><body><div style="text-align:center;margin-top:20px" align="center">
  
  <a class="gatsby-resp-image-link" href="/static/4d40261bd96a94d0c8f164b2d0eaeb6f-7d35d.png" style="display: block" target="_blank" rel="noopener">
  
  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 840px; margin-left: auto; margin-right: auto;">
    <span class="gatsby-resp-image-background-image" style="padding-bottom: 51.2%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsSAAALEgHS3X78AAABJ0lEQVQoz2NQVVVVU1VVV1XTANGkAQYgdrC28XB09nFxs7Wx0dfXJ02zpaWlp6enm5ubo6Ojubk5aZp1dXX1wMDQ0BAiCrRfXV0dyAjw8U6OjQaiyJAgHR0ddzc3CxMjVxcXbW1tqGagNogeCCM4OBjokKioKKCKeZP6Lx/aC0TbVyxxdHBYu2DO1NzE+f2dNjY2WDQDjU9JSdHS0goPD7e1tUXW7OLicmjDqlWlaZvmTAFKYdGspqZmYWFhYGBgbGwM5CJrtrSzbZkxsTkzorQ839jUFKoZ6Dw9GEALEnd31/RQ/8yYiNCQIFU1NRVtLXUNdWV1NUSAQcLMFGwYEABdbmJiArQcwjUBA6CLgHa4urra29s7OztramoiNBMJgFGgBgYQLgAGEYgBAzMUggAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;">
      <img class="gatsby-resp-image-image" style="width: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;" alt="placeholders" title="" src="/static/4d40261bd96a94d0c8f164b2d0eaeb6f-acf85.png" srcset="/static/4d40261bd96a94d0c8f164b2d0eaeb6f-c1418.png 210w,
/static/4d40261bd96a94d0c8f164b2d0eaeb6f-5d5d8.png 420w,
/static/4d40261bd96a94d0c8f164b2d0eaeb6f-acf85.png 840w,
/static/4d40261bd96a94d0c8f164b2d0eaeb6f-de0cd.png 1260w,
/static/4d40261bd96a94d0c8f164b2d0eaeb6f-bd6c2.png 1680w,
/static/4d40261bd96a94d0c8f164b2d0eaeb6f-7d35d.png 2000w" sizes="(max-width: 840px) 100vw, 840px">
    </span>
  </span>
  
  </a>
    
</div></body></html>
<ul>
<li>使用一片空白占位：这样可以在图像还没有加载出来的时候出现页面塌陷和跳动，不仅用户体验比较差，性能上会导致浏览器的重绘</li>
<li>一张固定图片作为占位符：我们经常会在用户头像的地方使用这个方案，在用户头像没有设置的时候，或者用户头像家在失败的时候，我们可以使用一个内联的矢量图像(e.g.:svg/base64)作为默认的图像</li>
<li>纯色：从图像中获取主颜色，并将其用作占位符的背景颜色，这样可以在你从没有图像到图像家在成功的时候有一个视觉上更加平滑的过度(eg:twitter)。</li>
<li>使用渐变色：使用渐变色，可以获取最终图像的更准确的预览，效果上比纯色更棒(eg:tumblr)。</li>
<li>模糊图像：也称为模糊技术。首先渲染一个低像素和提及很小的模糊话的图像，然后在大图像加载成功的时候，隐藏模糊图像，也会有一个平滑的过度(eg:Quartz).</li>
</ul>
<p>我们可以先了解一下，目前国内外访问量比较大，比较优秀的网站对图片的优化方案</p>
<h4 id="facebook"><a href="#facebook" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>facebook</h4>
<p>facebook的技术方案:<a href="https://code.fb.com/android/the-technology-behind-preview-photos/">https://code.fb.com/android/the-technology-behind-preview-photos/</a></p>
<h4 id="quartz"><a href="#quartz" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a href="https://qz.com/894001/theres-a-wrong-and-a-right-way-to-talk-to-your-dog-according-to-science/">Quartz</a></h4>
<ul>
<li>1.首先加载一个非常小的的<code>&#x3C;img/></code>，在他们的网页中他们使用了50px宽度和80%质量的图片</li>
<li>2.使用css来使图片模糊化</li>
<li>3.在小的图片加载完成的时候，开始加载大的图片</li>
<li>4.在大图片加载完毕的时候，隐藏小的图片的同时通过<code>transition:opacity .3s</code>来展现大的图片</li>
<li>
<p>5.在用户禁用JavaScript的时候，使用一个<code>&#x3C;noscript></code>里面包含一个<code>&#x3C;img></code>作为回退方案</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>picture</span><span class="token style-attr language-css"><span class="token attr-name"> <span class="token attr-name">style</span></span><span class="token punctuation">="</span><span class="token attr-value"><span class="token property">padding-bottom</span><span class="token punctuation">:</span> 56.23333333333328%<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://qzprod.files.wordpress.com/2018/03/ap_17162770351982-e1520487757701.jpg?quality<span class="token punctuation">=</span>80<span class="token entity" title="&amp;">&amp;amp;</span>strip<span class="token punctuation">=</span>all<span class="token entity" title="&amp;">&amp;amp;</span>w<span class="token punctuation">=</span>50<span class="token punctuation">"</span></span>
    <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>progressive-image-thumbnail<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">sizes</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>(max-width: 320px) 320px, (max-width: 640px) 640px, (max-width: 940px) 940px, 100vw<span class="token punctuation">"</span></span>    
    <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>progressive-image-large<span class="token punctuation">"</span></span>
    <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>AP Photo/Paul Sakluma, File<span class="token punctuation">"</span></span>
    <span class="token attr-name">title</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span> 
    <span class="token attr-name">srcset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://qzprod.files.wordpress.com/2018/03/ap_17162770351982-e1520487757701.jpg?quality<span class="token punctuation">=</span>80<span class="token entity" title="&amp;">&amp;amp;</span>strip<span class="token punctuation">=</span>all<span class="token entity" title="&amp;">&amp;amp;</span>w<span class="token punctuation">=</span>320 320w,
        https://qzprod.files.wordpress.com/2018/03/ap_17162770351982-e1520487757701.jpg?quality<span class="token punctuation">=</span>80<span class="token entity" title="&amp;">&amp;amp;</span>strip<span class="token punctuation">=</span>all<span class="token entity" title="&amp;">&amp;amp;</span>w<span class="token punctuation">=</span>640 640w, 
        https://qzprod.files.wordpress.com/2018/03/ap_17162770351982-e1520487757701.jpg?quality<span class="token punctuation">=</span>80<span class="token entity" title="&amp;">&amp;amp;</span>strip<span class="token punctuation">=</span>all<span class="token entity" title="&amp;">&amp;amp;</span>w<span class="token punctuation">=</span>940 940w, 
        https://qzprod.files.wordpress.com/2018/03/ap_17162770351982-e1520487757701.jpg?quality<span class="token punctuation">=</span>80<span class="token entity" title="&amp;">&amp;amp;</span>strip<span class="token punctuation">=</span>all<span class="token entity" title="&amp;">&amp;amp;</span>w<span class="token punctuation">=</span>1600 1600w, 
        https://qzprod.files.wordpress.com/2018/03/ap_17162770351982-e1520487757701.jpg?quality<span class="token punctuation">=</span>80<span class="token entity" title="&amp;">&amp;amp;</span>strip<span class="token punctuation">=</span>all<span class="token entity" title="&amp;">&amp;amp;</span>w<span class="token punctuation">=</span>3200 3200w<span class="token punctuation">"</span></span>
    <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://qzprod.files.wordpress.com/2018/03/ap_17162770351982-e1520487757701.jpg?quality<span class="token punctuation">=</span>80<span class="token entity" title="&amp;">&amp;amp;</span>strip<span class="token punctuation">=</span>all<span class="token entity" title="&amp;">&amp;amp;</span>w<span class="token punctuation">=</span>3000<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>noscript</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">itemprop</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>image<span class="token punctuation">"</span></span> 
        <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://qzprod.files.wordpress.com/2018/03/ap_17162770351982-e1520487757701.jpg?quality<span class="token punctuation">=</span>80<span class="token entity" title="&amp;">&amp;amp;</span>strip<span class="token punctuation">=</span>all<span class="token entity" title="&amp;">&amp;amp;</span>w<span class="token punctuation">=</span>3000<span class="token punctuation">"</span></span>
        <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>(AP Photo/Paul Sakluma, File)<span class="token punctuation">"</span></span> 
        <span class="token attr-name">title</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>noscript</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>picture</span><span class="token punctuation">></span></span>
</code></pre>
      </div>
</li>
</ul>
<h4 id="quora"><a href="#quora" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a href="https://www.quora.com">Quora</a></h4>
<p>quora也是先渲染一个模糊的<code>canvas</code>作为placeholder,然后懒加载一个大的图片，先看一下html结构：</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token style-attr language-css"><span class="token attr-name"> <span class="token attr-name">style</span></span><span class="token punctuation">="</span><span class="token attr-value"><span class="token property">position</span><span class="token punctuation">:</span> relative<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token comment" spellcheck="true">&lt;!-- a canvas with a data-uri containing the thumbnail --></span>
    <span class="token comment" spellcheck="true">&lt;!-- which is in PNG format and very small (in this page 6x10 px) --></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span><span class="token style-attr language-css"><span class="token attr-name"> <span class="token attr-name">style</span></span><span class="token punctuation">="</span><span class="token attr-value"><span class="token property">position</span><span class="token punctuation">:</span> relative</span><span class="token punctuation">"</span></span>
        <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>499<span class="token punctuation">"</span></span>
        <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>874<span class="token punctuation">"</span></span>
        <span class="token attr-name">data-src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>data:image/PNG;base64,UklGRmgAAABXRUJQVlA4IFwAAADwAQCdASoGAAoAAUAmJYgCdEf/g…iD0z/yA/5ipcuk5xHSdrS38j8CkH7s+vKeZu9EwRy0f/KPIlo/+UifdfcpiRcJiRnXXAAAAA<span class="token punctuation">=</span><span class="token punctuation">=</span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">></span></span>
    <span class="token comment" spellcheck="true">&lt;!-- a lazy image with src set as data-src and master_src --></span>
    <span class="token comment" spellcheck="true">&lt;!-- data-src is a webp image (at least when requested using Chrome). --></span>
    <span class="token comment" spellcheck="true">&lt;!-- the size for data-src in this page is ~34kB --></span>
    <span class="token comment" spellcheck="true">&lt;!-- master_src is a png image. Its size in this page is ~177kB --></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span><span class="token style-attr language-css"><span class="token attr-name"> <span class="token attr-name">style</span></span><span class="token punctuation">="</span><span class="token attr-value"><span class="token property">opacity</span><span class="token punctuation">:</span>0<span class="token punctuation">;</span> <span class="token property">position</span><span class="token punctuation">:</span> absolute<span class="token punctuation">;</span> <span class="token property">left</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span> <span class="token property">top</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span>
        <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span>
        <span class="token attr-name">data-src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://qph.ec.quoracdn.net/main-qimg-f35a9a38e575bfbe76806b7838eba025-p<span class="token punctuation">"</span></span>
        <span class="token attr-name">master_src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://qph.ec.quoracdn.net/main-qimg-f35a9a38e575bfbe76806b7838eba025<span class="token punctuation">"</span></span>
        <span class="token attr-name">master_w</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>499<span class="token punctuation">"</span></span>
        <span class="token attr-name">master_h</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>874<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
</code></pre>
      </div>
<ul>
<li>
<p>1.外层的容器<code>div</code>和<code>canvas</code>都设置了<code>position:relative</code>,然后设置<code>img</code>标签<code>position:absolute</code>来让img标签可以完全重叠在canvas上，并且设置img标签<code>opacity:0</code>，使用户可以看到模糊的图片，模糊的图片的内容用<code>base64</code>内嵌在html中，这样可以减少一次http请求，加快渲染速度。</p>
</li>
<li>
<p>2.这里使用<code>canvas</code>作为placeholder而不是<code>img</code>标签的原因是，我们需要手动设置占位符图像的宽度和高度，如果你希望输出的图像的宽高比和源图像的宽高比不一样的话，这个时候img标签就无能为力了</p>
</li>
<li>
<p>3.使用JavaScript来操作展现全部的canvas,首先获取全部带有<code>data-src</code>属性的<code>canvas</code>标签，然后遍历，并获取<code>canvas</code>上的<code>data-src</code>属性，然后使用该值动态创建<code>img</code>，<code>img</code>的load事件中在canvas中绘制出来新建的图片，用户就可以看到模糊的图片了</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code><span class="token keyword">function</span> <span class="token function">loadPlaceholderImage</span><span class="token punctuation">(</span>placeholder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>placeholder<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">'data-src'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> placeholder_img <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        placeholder_img<span class="token punctuation">.</span>src <span class="token operator">=</span> placeholder<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">'data-src'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> width <span class="token operator">=</span> placeholder<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">'width'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> height <span class="token operator">=</span> placeholder<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">'height'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> ctx <span class="token operator">=</span> placeholder<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">'2d'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        placeholder_img<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ctx<span class="token punctuation">.</span><span class="token function">drawImage</span><span class="token punctuation">(</span>
            placeholder_img<span class="token punctuation">,</span>
            <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token number">0</span><span class="token punctuation">,</span>
            width<span class="token punctuation">,</span>
            height<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">loadPlaceholderImages</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">var</span> placeholders <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span><span class="token string">'canvas[data-src]'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// Progressively load placeholder images on page load</span>
<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span>forEach<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>placeholders<span class="token punctuation">,</span> loadPlaceholderImage<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">// We want to load the placeholder images as soon as possible</span>
<span class="token function">loadPlaceholderImages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
      </div>
</li>
<li>
<p>4.在页面加载完成之后，直接获取所有带有<code>data-src</code>属性的img标签，并便利，重新设置<code>img</code>的<code>src</code>属性，在该<code>img</code>元素加载完毕之后，设置该元素的<code>opacity</code>的值为1(让清晰的img元素显示出来)，并隐藏原来的占位符<code>canvas</code>元素(记得中间添加过度的动画元素) </p>
</li>
</ul>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code><span class="token keyword">function</span> <span class="token function">loadDeferredImages</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> imgDefer <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span><span class="token string">'img[data-src]'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> imgDefer<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">loadDeferredImage</span><span class="token punctuation">(</span>imgDefer<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">loadDeferredImage</span><span class="token punctuation">(</span>img_element<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>img_element<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">'data-src'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        img_element<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'src'</span><span class="token punctuation">,</span> img_element<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">'data-src'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        img_element<span class="token punctuation">.</span><span class="token function">removeAttribute</span><span class="token punctuation">(</span><span class="token string">'data-src'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        img_element<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            img_element<span class="token punctuation">.</span>style<span class="token punctuation">.</span>opacity <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// hide the placeholder image</span>
            <span class="token keyword">var</span> placeholder_elm <span class="token operator">=</span> img_element<span class="token punctuation">.</span>previousElementSibling<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>placeholder_elm <span class="token operator">&amp;&amp;</span> placeholder_elm<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">'qtext_image_placeholder'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Without timeout, we would see a flash of white before the image loads in.</span>
            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                placeholder_elm<span class="token punctuation">.</span>style<span class="token punctuation">.</span>visibility <span class="token operator">=</span> <span class="token string">'hidden'</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

window<span class="token punctuation">.</span>onload <span class="token operator">=</span> loadDeferredImages<span class="token punctuation">;</span>
</code></pre>
      </div>
<ul>
<li>5.为什么清晰的<code>img</code>元素上面还要添加<code>master_src</code>属性，是为了在用户点击的时候，可以全屏展现更大更清晰的图片</li>
</ul>
<p><a href="https://jsfiddle.net/zhangela/wmppojjq/">在线的例子</a></p>
<h4 id="clicktorelease"><a href="#clicktorelease" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a href="https://www.clicktorelease.com/">Clicktorelease</a></h4>
<p>先看一下html结构：</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>hero image<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> the lazy loaded image <span class="token operator">--</span><span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> thumb<span class="token operator">-</span>src is a matrix <span class="token keyword">of</span> DCT coefficients <span class="token operator">--</span><span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> note that a background<span class="token operator">-</span>color is also <span class="token keyword">set</span> so <span class="token operator">--</span><span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> it is rendered <span class="token keyword">while</span> the image is fetched <span class="token operator">--</span><span class="token operator">></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">thumb-lazy</span>
        <span class="token attr-name">original-src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/images/graphical-web-2016.jpg<span class="token punctuation">"</span></span>
        <span class="token attr-name">thumb-src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/images/graphical-web-2016-thumb.png<span class="token punctuation">"</span></span>
        <span class="token attr-name">thumb-width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>2880<span class="token punctuation">"</span></span> <span class="token attr-name">thumb-height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>1800<span class="token punctuation">"</span></span><span class="token style-attr language-css"><span class="token attr-name">
        <span class="token attr-name">style</span></span><span class="token punctuation">="</span><span class="token attr-value"><span class="token property">background-color</span><span class="token punctuation">:</span>#121513<span class="token punctuation">;</span><span class="token property">width</span><span class="token punctuation">:</span>100%</span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> a div <span class="token keyword">with</span> intrinsic ratio <span class="token operator">--</span><span class="token operator">></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token style-attr language-css"><span class="token attr-name"> <span class="token attr-name">style</span></span><span class="token punctuation">="</span><span class="token attr-value"><span class="token property">padding-bottom</span><span class="token punctuation">:</span>62.5%</span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> fallback <span class="token keyword">for</span> browsers not using JS <span class="token operator">/</span> bots <span class="token operator">--</span><span class="token operator">></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>noscript</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/images/graphical-web-2016.jpg<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>noscript</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
</code></pre>
      </div>
<ul>
<li>使用<code>div</code>上的<code>thumb-src</code>属性值创建一个<code>img</code>元素,一般是一个16X16的png图片，大小一般在300B之内</li>
<li>使用上一步创建的img,动态创建<code>&#x3C;canvas/></code>标签，<code>canvas</code>中的内容是<code>img</code></li>
<li>使用<code>div</code>上的<code>original-src</code>请求大的图片，如果支持webp的时候，可以使用webp</li>
</ul>
<p>上面的代码还添加了一个使用<code>&#x3C;noscript>&#x3C;img src="/images/graphical-web-2016.jpg">&#x3C;/noscript></code>，这是一个渐进增强的例子，<code>&#x3C;noscript></code>可以在用户禁用JavaScript的时候，提供一个很好的替代方案，并且从一个纯色的背景到一个模糊的渐变色。</p>
<p><a href="https://codepen.io/jmperez/pen/yYjPER">在线的例子</a></p>
<h4 id="medium"><a href="#medium" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>medium</h4>
<ul>
<li>1.创建一个<code>div</code>标签作为placeholder，并且使用<code>padding-bottom</code>属性，来设置该div的宽高比和图像的宽高比一样，防止图片在加载的时候出现塌陷的问题</li>
<li>2.请求一个很小的图片，一般是一个很小的jpeg图片，并且有很低的分辨率(e.g.20%),可以使用一个img标签来使浏览器自动去加载该图片资源</li>
<li>3.在小图片的<code>onload</code>的时候，把小图片渲染进<code>canvas</code>标签中，同时使用一个自定义的模糊化函数来使图像模糊化，类似于<a href="http://www.quasimondo.com/StackBlurForCanvas/StackBlurDemo.html">StackBlur</a>,同时，开始加载大的image图像</li>
<li>
<p>在大图片加载完成的时候，显示大的图片，然后隐藏<code>canvas</code><br>
在上述步骤中，注意使用css动画和渐变，来使上面的过程更加平缓和渐进</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>figure</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>7012<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>7012<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>graf--figure graf--layoutFillWidth graf-after--h4<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>aspectRatioPlaceholder is-locked<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>aspect-ratio-fill<span class="token punctuation">"</span></span><span class="token style-attr language-css"><span class="token attr-name"> <span class="token attr-name">style</span></span><span class="token punctuation">="</span><span class="token attr-value"><span class="token property">padding-bottom</span><span class="token punctuation">:</span> 66.7%<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>progressiveMedia js-progressiveMedia graf-image is-canvasLoaded is-imageLoaded<span class="token punctuation">"</span></span> <span class="token attr-name">data-image-id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>1*sg-uLNm73whmdOgKlrQdZA.jpeg<span class="token punctuation">"</span></span> <span class="token attr-name">data-width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>2000<span class="token punctuation">"</span></span> <span class="token attr-name">data-height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>1333<span class="token punctuation">"</span></span> <span class="token attr-name">data-scroll</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>native<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://cdn-images-1.medium.com/freeze/max/27/1*sg-uLNm73whmdOgKlrQdZA.jpeg?q<span class="token punctuation">=</span>20<span class="token punctuation">"</span></span> <span class="token attr-name">crossorigin</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>anonymous<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>progressiveMedia-thumbnail js-progressiveMedia-thumbnail<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>progressiveMedia-canvas js-progressiveMedia-canvas<span class="token punctuation">"</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>75<span class="token punctuation">"</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>47<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>progressiveMedia-image js-progressiveMedia-image __web-inspector-hide-shortcut__<span class="token punctuation">"</span></span> <span class="token attr-name">data-src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://cdn-images-1.medium.com/max/1800/1*sg-uLNm73whmdOgKlrQdZA.jpeg<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://cdn-images-1.medium.com/max/1800/1*sg-uLNm73whmdOgKlrQdZA.jpeg<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>noscript</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>js-progressiveMedia-inner<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>progressiveMedia-noscript js-progressiveMedia-inner<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://cdn-images-1.medium.com/max/1800/1*sg-uLNm73whmdOgKlrQdZA.jpeg<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>noscript</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>figure</span><span class="token punctuation">></span></span>
</code></pre>
      </div>
</li>
</ul>
<h3 id="基于svg的placeholders"><a href="#%E5%9F%BA%E4%BA%8Esvg%E7%9A%84placeholders" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>基于SVG的placeholders</h3>
<p>SVG对于矢量图像非常理想，但是我们作为开发人员大多数拿到的图像都是位图，那么问题就是我们应该如何是量化位图，整体上来说，有三种解决方案：描绘轮廓，形状和区域。 </p>
<ul>
<li>
<p>使用轮廓：我们可以尝试找出图像的边缘并创建动画<br>
<a href="https://codepen.io/jmperez/pen/oogqdp">使用轮廓动画</a>      </p>
</li>
<li>
<p>形状：SVG可以用于从图像中绘制区域而不是轮廓，在某种程度上，我们可以用三角形来是量化一个位图，从而创建一个占位符，三角形的生成基于<a href="https://en.wikipedia.org/wiki/Delaunay_triangulation">三角剖分</a>，很明显三角形越多，对图像的描绘会更多，但是体积也会更大<br>
<a href="https://codepen.io/jmperez/pen/BmaWmQ">三角形占位符</a>         </p>
</li>
<li>
<p>Primitive：使用<a href="https://github.com/fogleman/primitive">Primitive</a>库可以将位图转化由重叠的图像(三角形，矩形，圆形)组成的SVG,它的尺寸很小使其适合内嵌到页面中,从上到下分别是10个，100个多边形组成的图像和原图</p>
</li>
</ul>
<html><head></head><body><div style="text-align:center;margin-top:20px" align="center">
  
  <a class="gatsby-resp-image-link" href="/static/20a6ddabd34fc74d7d1c588108a60fd0-38dad.png" style="display: block" target="_blank" rel="noopener">
  
  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 200px; margin-left: auto; margin-right: auto;">
    <span class="gatsby-resp-image-background-image" style="padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAIAAAAC64paAAAACXBIWXMAAAsSAAALEgHS3X78AAACu0lEQVQ4y3XTaU8aQRjA8f1apsq1HEJRi7SlFlQorYKr4tEalAXBqyoIKoeLUQSE5VBYUMtVryamadWmqUlTjy/TZ7NxLUiT/4t5Mb/Mk8kMYvO48TXClc1YQjG2N31Ym1ymVLRqDb29CyuWcHx4betxCLPbXzrAt+LMGl8PqZTP5M0SPpcHcVCJIxy1bSfrY2s4vn5UnIwmGGxzzUtFIpTLk4rFgIUCQSy1vpTL2+OpR3gjMpNIAZ4mUzTejFrGTQIOF5JJaNzeJt9LepLUFvgpMl2FbW6XM5sFPJfaoadY9gwadQyG8wF3a1Q50l3O+kgqAn4muTNC3GO7fWzlIA94MUPfmX1qXK1SMljE58PMowNvqfgSYChGRcHPpnZHiDCNHfjQdpEeeylHWf2BfoO2saGRwZAYRUOrE6f51QrlY3yU2gb/MZ354A8iztmxUmUT8PJ+3jhsEqFoY8MTFrdImzdX8Yuy/+cR8WU/wPgwFQPvS0QQwms7LQeihzlvfkeICnkcHr+Jw2KpSOhzmi9KvquTIHReIQ5zfvAhikxQYYQMzwHer0TSnyISoYjXxGUl06QZO7/H0K/j4FmBHqGQDSAHGQ/gk/LacZlokz/lc2qxvuvV96KXxUw/DonExhwCkk3dAffMq8FKmeQ8O39d9lyX3Tcl123ReVdY/E1NX5LWKtzX24lya08Wcrlfg8N3u7bblOUmbv4T/fDNa/w801WafF2FJ8YMgkdjQ8HRjiu/kelsQVvAVVAa11ThKWt/XewwdddIyIVjNRiri0cw3WVg8F8ZwXXwuhAq6WJ7b9LVxSZDd2zawMo9vGMWH3RYTPTzZLKaB+pKqFUq0SjkLPaP6we0Kqzz+QMewvT/w8wnISc0IIPGVr1Cqm0RQw941NSjftmukMskAkFdb333wqkW9LSgjIT+AtvdOeLhomWmAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;">
      <img class="gatsby-resp-image-image" style="width: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;" alt="primitive 10" title="" src="/static/20a6ddabd34fc74d7d1c588108a60fd0-38dad.png" srcset="/static/20a6ddabd34fc74d7d1c588108a60fd0-38dad.png 200w" sizes="(max-width: 200px) 100vw, 200px">
    </span>
  </span>
  
  </a>
    
  
  <a class="gatsby-resp-image-link" href="/static/d9efe2adb2f5313cb7dc78851270d734-38dad.png" style="display: block" target="_blank" rel="noopener">
  
  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 200px; margin-left: auto; margin-right: auto;">
    <span class="gatsby-resp-image-background-image" style="padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAIAAAAC64paAAAACXBIWXMAAAsSAAALEgHS3X78AAAD8UlEQVQ4y1WU6VMadxjH99+q7MGiQgQGTxJTb40i6qLBIxoRaTzqfVQQEOVa2ZNlKeFYqrjaaUZNk9amjaNGix2bzLR90Zl2pn3b9cDYne/sPC9+n+fz3X3xAwx2vMVBtK3QLcukwUm1uel2F1n+yChHC0oqqx50dDfMrDYv4UYnIb2bl4J3AxjdlMFJmtbY9hXGtMp0edmuRSeCoHl5MAyjClSh1BQbHXi7m8Y8ZJszdLUCb5HW2QNAT4A1+9kePCJhZh9rIbgnUxMQCOd9AkIgAoNwYaHSEqR6g+FuP2PykCYPgbmCmMNncniBYZKx0twwG3kaCg+R3CgTfjI2DMogib+MDFIqVZ/TrI1kLCQ3zERsTNgSovq8eKfTB0yw9DgfmYpFFxL8fJz/IsaZbZYbEoQls1qrmaXXJ8PsXISZ4PmxCC/xVpIaIQjAzlOLzzlXOuoW+BUhupLiq5oab2E5IreODboTjDvBSnHFGXucW45z7hjt5kkAT1D+NEdmeCbDEwmyFTPCEJLrDKNy1LU6vy7QuMCEUjSVplmBIgU2mAyvfUkBsXQoLdLPtyObYtjYYZAj6K0WBGHpbwfWlyObTHSDjm+QcWE9mQqmkgE+SeDRELCT9u7vEC93yO2UXyI/aiVYBkn83NTQ/pZ/X/Ttif7dLf922reZ9EoRkn7gtYgf7gR+3PbvpZwoqoDuwNfy+xW6NxnHgbjyneh5Ja5JW77Z8H6dcL9IOIBj0ZkVHeei/W3GodOqYQi+a5aKaNT3jjam320vHIr2o69mT9KTJ8LEUWryIDYBnMZG329Mf8jMnibHm2r0EPTRCV4NSoX8JDGSTQ5lBdvPSVs2bj2PD2dj1qPwU+CMMGcDbRdE5wXX39P6EAKhWzg3QN/iPVmu+4wxn9GPz6jOUxI7IkxvgxhwHsR+Ic0XdO/7yMBId90tcAlD8HWRzwxlJ/am4/n645m63WefRnrLX0/XHc43An+88v59wv/z69a/v+0tTA/9r/MVLC0yPtBeeIzH9uZNS+Vmv35rQJ/pLUtbqoAPcdvvgu1P8dlf+/Pjg6057WWuH2kw39f8NKDfwXTRpiJXtWrqoXKwvKCjVAW88WA/rGG7q12ZwECvsVL6ZlAG3sDgDdxfo9sfrf1+pDIzoF97pOEelx7YW2K2WmCxr66vVqfX3tMUKjT5cuTquATIcn4pxfnyCpWiWVfg6yqPWSo9fVVYTWmVthBQKxS1JUXjbfqGMnWxUiHLae8mH4H1hShtrng3V79UX9RZrrLWaJpLlEB/U4V/qCE+0x6yNdbrtTCMSDdIrjMMXwVFEEMRutyiG6suqFajugJUmy+X8h9V4jlv9QsdLAAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;">
      <img class="gatsby-resp-image-image" style="width: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;" alt="primitive 100" title="" src="/static/d9efe2adb2f5313cb7dc78851270d734-38dad.png" srcset="/static/d9efe2adb2f5313cb7dc78851270d734-38dad.png 200w" sizes="(max-width: 200px) 100vw, 200px">
    </span>
  </span>
  
  </a>
    
  
  <a class="gatsby-resp-image-link" href="/static/6e44d7f94ed837b2b95fe5f846d2d2f1-38dad.png" style="display: block" target="_blank" rel="noopener">
  
  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 200px; margin-left: auto; margin-right: auto;">
    <span class="gatsby-resp-image-background-image" style="padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAIAAAAC64paAAAACXBIWXMAAAsSAAALEgHS3X78AAAD+0lEQVQ4y2WQ+09aZxjHz/9VONwE5aZTKraMCWpRrIKitqhVKmiZlyoiKogocj+HcwURD1dxVbNLZ9c421Vrq9hu6ZYsy7LslyVmx+KlSZNPnrw/PJ/3m+cLNNjDjTPhJkfkjgPSOKDmObjVida2dPHKJRJFU61+QGMLaGahpplwoz3cMB1S24LqSb9qwlc/5gXaXHDbQlTnRvQ0i2jHEqadcIJM7hVcgaTTBeud0XYn3DYPtc6FtbMh7UyweToA9Hjxez7CSOMnjAGiLxTTmkdZTDaLyQHPYfN5gsEgYVzBjV78/hLW40G7F6MGN9zpigAmiByCYmY4ZkFiw0jciiX0FittfoT+gi0SSa1I3AKR5gjxMIybgtiAH+n3Rfu8MDBOkBNkbDIWm4zHbaur9uRax5CppJWQSKTjEDRJxiYIchwnRlHCGsVGYHQYigKuNXQhibkp3EMRy+mYP5dQNzeDlyaHyTYPD3oo0p3EF9Yw1yo6H0fmSMSBw3YsAkAUBqdwJE1gmRieJts79FdV0XIFi0X4HGiajFI4TGGRdTSURAIJ2B+HvGQYWMsgySyayuO5Qkyvb/u0Zxp5OS8TdaVy+HoOW8uiiTQST0VJCiaSEJYIA9s5eCcf/a6AbqUgFkinnQMy2CCDcx4Ocpecj78toDt5ZDsLb2Whb9KRQiq0sR7MJwPAXt7/cyHwcjP0A7VcupPWLh/05Crlshebob2NAL35POd7nvU9S3t3U8tP1z3AUW727cb8yabrdGuRz+V92vO5z+QoZFXHmwtH+fnXudnDrONVZuaXlP0lNb2/bgOKqZF3mUe/5r7+UJj4Uib9XK4WC9/nxorpRyepkWNq+O265U3S/DoxdLhqAo6jXUWk6x3a/RtxX19f87nMYXGKuPEU6zlBuunlN7DhCOo8DOsPgjqg6Go5dd9979V9iNwfblNcawzW5f0cm7Z6f0x18Fh9NNWwa1GGdbLvzcoXoyrgv33fWZE6++PHsz/35qasV4VdyyBHd0vyu89wYG958rB+s19R6FPsDCq3+xXAX9Tg31nLP0/G/931WHtbr9LAi7ZpmdtXJ3rVLcu3VGIqsUcpnlNJTXWie3IR8NTWsu/WHwZ7d1d6+5tvgUwWnXkxS+Egd0xT88za+JNJme6Su5UiQic7ct7NPFACfmP9UKPsC0G5qExQJRBcm8wLmQ6/Laqo4QtaK8sDuptEv3LJcFtfXaGprACEZeWGm2Jnu1xbI66tEDAZIPMGk3mDUZoff+FU8ctq+Hy8s/Z46o5LLTXIhLam6m65GBhQyVZ6VdlRjavnK3W1EGSUnJJ//qAv54LsrkqBu0E6VidsEJZVlfGqeNxKHvd/7l9COwx7zekAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;">
      <img class="gatsby-resp-image-image" style="width: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;" alt="primitive origin" title="" src="/static/6e44d7f94ed837b2b95fe5f846d2d2f1-38dad.png" srcset="/static/6e44d7f94ed837b2b95fe5f846d2d2f1-38dad.png 200w" sizes="(max-width: 200px) 100vw, 200px">
    </span>
  </span>
  
  </a>
    
</div>      </body></html>
<ul>
<li>
<p>SQIP:SQIP试图在模糊化的图像和<code>Primitive</code>之间寻找一个平衡点：它利用Primitive生成一个由几个简单形状组成的SVG,近似于原图像的主要特征，然后使用SVGO为SVG添加一个模糊的效果，这样可以生成一个仅占据800-1000字节的SVG占位符，这样可以在屏幕上看起来很流畅，并提供了图像内容的视觉提示，它和其他网站使用的模糊话的技术不一样的地方在于，这里使用的是SVG的矢量图，而其他大都是使用的位图(eg JPG or WebP).SQIP也可以生成Base64编码的模糊化的图像，直接内嵌在html中，这样可以减少一次网络请求</p>
<html><head></head><body><div style="text-align:center;margin-top:20px" align="center">

  <a class="gatsby-resp-image-link" href="/static/fd4ecefbeee29208b17f7fc68526bbde-38dad.png" style="display: block" target="_blank" rel="noopener">
  
  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 200px; margin-left: auto; margin-right: auto;">
    <span class="gatsby-resp-image-background-image" style="padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAIAAAAC64paAAAACXBIWXMAAAsSAAALEgHS3X78AAAD6klEQVQ4y13OW1MaZxzH8X05velFO9ObTCKapGlmYqpJBeWkIrIontgFIkQFOehqUEBgxYCIoLscFhaW0y67nFHxkIy20xfUJdpO7Mxnnrvv8/sDwSz5nwMitXcUtG/b1drFN5Pq1xPgKKgxWla2Aqgbj3sSqf8BIoV8mMqFcg89msAdXs8UpHshA/ulqrdTs7BlfSsU8iZTKJFB06SfyHiTxENMNqoJlo7kqdC3OECkNgKBKd3ygBTsl6jeKGa1Fttu5DhMURhN4wwTK5ZDWYr/ohfXbi7K5814heb3+Xg/TdgDBzKt4cnY1FOx8q1idtlmD8ZxslotddrlTqfQahEcF8kXfMkU0L69rn/pUq1atFjgx9FUam3PNwQu/vhO/otwUqTSIE4kmSWYTovrXnCXXbZ7QZ910hwXSsaBzt1N6/aK6Xb4cX7ZFYvBto2XEuUPg2M/vZerFxYC6E6+kOTaNe7irNd3z7nzTrnOYoko0Lm94tWuz9McHYhjFpdLMbckGBT//Fr0ZEii12sjIVe5gHHVPNdi+S+q7Wq1ybBsjiSOgPZVo33dbnQbZCnjCezNwbrBYZmgT/hUIHz52+iyXhsNu+n8CUcnuQp/bJZjSa5CcHSimI0AzUau1co36lkyE9l1WmVSxYBA2P9shPfrcxG8NB8JuspUlCthXBl/UOJhdD4GNNl4k03UK3EqHXI7LdKxif5nD/FzgXBGBQZ8SIGM9OLHmMIJ0KzgvEYFL5KHPpdtQjZ5X96Tj024t8xUMlgrYzUar5Xx6jf8fi9uMNh9XModoR6HQq74Phb9Lv60ChVi7vNStMtgFwx2xmAdBmvROJePAjX69FE8/igeeiWyLqlIdP2S3L+jo3+yp3fs6S17+pU5aecOgUrh+N+zw17+bOmjs18NCOGp8WMErkeRr9n9v8pHf1eivNviYR13A1Tqc53BeBQRdG2bxaLx7+OBPqFyVOJd1VB+YyvquEy6vmT8NxlfC3Mm/WbgJLxLUxG2FEue+jatyyPD0oE+vhl5zhOMvBAIxcNixKCO78BMwFgLrdbDluqhJe0z+Td0gHfHjB17CAwNoYh5WTsxKhcPSyTvJNL3EtkfUvmIdFoyboVmjhGo6NVX/AbG/yHr0R8i8LZZCyDr+r1Pa6jLuuswmXULMDitVSoh5TQ83aNTqT7MgDZ47rMVInf0Zbchv2s4QXQeM7RpggCHCdpcgZEV3YYJtuoW1xY0K3Ozq7z5e5q1RY1dt+hbg+Ob+pzTwL+oGd4yQRtGCLCZtDw7z6i16BeMczN6UHXPAIIGNWjUqC3QvPOj9siuwxHdgRXe/gg5jD3/AJAslkcczKnJAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;">
      <img class="gatsby-resp-image-image" style="width: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;" alt="sqip" title="" src="/static/fd4ecefbeee29208b17f7fc68526bbde-38dad.png" srcset="/static/fd4ecefbeee29208b17f7fc68526bbde-38dad.png 200w" sizes="(max-width: 200px) 100vw, 200px">
    </span>
  </span>
  
  </a>
    
</div>  </body></html>
</li>
</ul>
<p>从上面可以看出几乎所有的网站都会采用placeholder的技术方案,并且经过向网站开发人员的查证，也基本罗列了他们基本的技术思路。</p>
<h3 id="how-to-generate-placeholder-image"><a href="#how-to-generate-placeholder-image" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>How To Generate Placeholder Image</h3>
<p>primitive生成的图片更为优美和更高还原度，但是图片体积比较大,sqip生成的svg体积超小，更为适合作为placeholder，primitive基于go开发，而sqip是完全基于node.js开发的，天然的对前端开发人员更为熟悉。简单介绍一下sqip的使用方法，更详细的参数的用法可以去看看官方文档。</p>
<blockquote>
<p>primitive有一个应用场景就是可以实现，“很科幻”的图片渐变的清晰的效果，类似于铁血战士的视角镜头中，从很模糊的一个会动的红点，到一个异性的基本轮廓，再到很清晰的影像，再到肩炮的设计</p>
</blockquote>
<p>我们可以使用<a href="https://github.com/technopagan/sqip"><code>sqip</code></a>生成svg格式的placeholder图片,首先安装sqip</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-none"><code>npm install -g sqip</code></pre>
      </div>
<p>然后，直接在node.js中调用sqip方法即可：</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code><span class="token comment" spellcheck="true">/**
 * 创建svg图片
 * @param {string} filePath 
 * @param {string} fileName 
 */</span>
<span class="token keyword">function</span> <span class="token function">createSVG</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> fileName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">sqip</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        filename<span class="token punctuation">:</span> filePath<span class="token punctuation">,</span>
        numberOfPrimitives<span class="token punctuation">:</span> <span class="token number">10</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> svgName <span class="token operator">=</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>fileName<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.svg`</span></span><span class="token punctuation">;</span>
    fs<span class="token punctuation">.</span><span class="token function">writeFile</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`./svg/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>svgName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">,</span> result<span class="token punctuation">.</span>final_svg<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'svg 生成成功'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
      </div>
<h3 id="placeholder-drawbacks"><a href="#placeholder-drawbacks" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>placeholder drawbacks</h3>
<ul>
<li>会增加一次http请求，增加用户体验的同时，增加了整体的加载时间</li>
<li>在配合lazy-load的时候，实际上placeholder并不会被用户察觉</li>
</ul>
<h3 id="面向未来的更炫酷的placeholder的案例于技术分享"><a href="#%E9%9D%A2%E5%90%91%E6%9C%AA%E6%9D%A5%E7%9A%84%E6%9B%B4%E7%82%AB%E9%85%B7%E7%9A%84placeholder%E7%9A%84%E6%A1%88%E4%BE%8B%E4%BA%8E%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>面向未来的更炫酷的placeholder的案例于技术分享</h3>
<ul>
<li><a href="https://codepen.io/jmperez/pen/BmaWmQ">https://codepen.io/jmperez/pen/BmaWmQ</a></li>
<li><a href="https://codepen.io/jmperez/pen/oogqdp">https://codepen.io/jmperez/pen/oogqdp</a></li>
<li><a href="https://codepen.io/ainalem/full/aLKxjm/">https://codepen.io/ainalem/full/aLKxjm/</a></li>
<li><a href="https://github.com/EmilTholin/image-trace-loader">https://github.com/EmilTholin/image-trace-loader</a></li>
</ul>]]></description><link>https://reactjs.org/blog/2018/03/09/placeholder.html</link><guid isPermaLink="false">https://reactjs.org/blog/2018/03/09/placeholder.html</guid><pubDate>Thu, 08 Mar 2018 16:00:00 GMT</pubDate></item><item><title><![CDATA[web image 加载优化方案--lazy-load]]></title><description><![CDATA[<h3 id="lazy-loading"><a href="#lazy-loading" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Lazy loading</h3>
<p>几乎所有的懒加载都是通过JavaScript来实现的</p>
<h4 id="scroll-listeners-and-relayout"><a href="#scroll-listeners-and-relayout" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Scroll Listeners and relayout</h4>
<p>我们一般会通过监听元素的<code>scroll</code>事件，来检查图像的占位符是否位于当前可是区域内，如果是，则开始加载，这是目前我们大多数人采用的思路，但是<code>scroll</code>事件可能会对页面性能产生负面影响，在滚动期间，浏览器会多次触发<code>scroll</code>事件，并加载我们即将要被加载的图像，这会导致浏览器的重新布局，这是一个很影响性能的操作，可以尽量给scroll监听的事件添加<code>防抖</code>来降低触发频率，或者我们可以缓存某些元素的位置，这样可以防止反弹的发生，类似于<code>Quora</code>的解决方案</p>
<p>首先回忆几个基本概念：</p>
<ul>
<li>
<p>clientHeight:clientHeight描述的是可见内容的高度，不包括由垂直滚动条引起的隐藏内容。并且要去除掉水平滚动条和border和margin的大小，因为他们不是实际可见内容。<br>
所以 <code>clientHeight = visible content + padding</code></p>
</li>
<li>
<p>scrollHeight:描述的是内容的总高度。包括可见内容的高度和填充(padding);由于垂直滚动条导致的隐藏的内容和padding的高度。 注意这里不包括border和margin,以为这两个也不是真正的内容。<br>
所以 <code>scrollHright = entier content + padding</code></p>
</li>
<li>
<p>offsetHeight:描述的是元素在html页面中占用的空间量。包括一下内容：可见内容的高度和可见的填充(不包括由垂直滚动条引起的隐藏内容高度)；顶部和底部的边框；如果有水平滚动条的情况下，还应该包括水平滚动条的高度。注意这里也不包括margin,因为margin看作是该元素和它的邻居之间的距离，而不是它本身所占据的空间。<br>
所以 <code>offsetHeight = visible content + padding + border + horizontal scrollbar</code></p>
</li>
</ul>
<p><a href="http://usefulangle.com/post/40/javascript-client-height-vs-offset-height-vs-scroll-height">详细图解</a></p>
<ul>
<li>
<p>scrollTop:代表有滚动条时，滚动条向下滚动的距离，也就是元素顶部被遮挡住的高度，在没有滚动条的时候scrollTop===0,可读可设置。</p>
</li>
<li>
<p>offsetTop:当前元素顶部距离最近父元素顶部的距离，和有没有滚动条没有关系，是只读属性。</p>
</li>
</ul>
<p><a href="https://www.imooc.com/article/17571">详细图解</a></p>
<p>根据以上概念，判断滚动条即将(eg.500px)滚动到底部的逻辑如下:</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code><span class="token comment" spellcheck="true">/**
 * 判断滚动条即将滚动到底部
 * @param {Event} event scroll 事件
 */</span>
<span class="token keyword">function</span> <span class="token function">handleDocScroll</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> htmlHeight <span class="token operator">=</span> document<span class="token punctuation">.</span>documentElement<span class="token punctuation">.</span>scrollHeight <span class="token operator">||</span> document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>scrollHeight<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">//clientHeight是网页在浏览器中的可视高度，</span>
    <span class="token keyword">var</span> clientHeight <span class="token operator">=</span> document<span class="token punctuation">.</span>documentElement<span class="token punctuation">.</span>clientHeight <span class="token operator">||</span> document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>clientHeight<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">//scrollTop是浏览器滚动条的top位置，</span>
    <span class="token keyword">var</span> scrollTop <span class="token operator">=</span> document<span class="token punctuation">.</span>documentElement<span class="token punctuation">.</span>scrollTop <span class="token operator">||</span> document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>scrollTop<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">//通过判断滚动条的top位置与可视网页之和与整个网页的高度是否相等来决定是否加载内容；</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>scrollTop <span class="token operator">+</span> clientHeight <span class="token operator">>=</span> htmlHeight <span class="token operator">-</span> <span class="token number">600</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'即将滚动到底部'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
      </div>
<p>上面的<code>handleDocScroll</code>函数在页面滚动的时候会频繁触发，而我们想要的是在用户滚动结束之后，执行该监听函数，这个时候就需要<code>防抖</code>，</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code><span class="token comment" spellcheck="true">/**
 * 函数防抖，滚动事件结束之后，在执行
 * @param {Function} fn 
 * @param {Number} wait 
 * @returns {Function}
 */</span>
<span class="token keyword">const</span> debounce <span class="token operator">=</span> <span class="token punctuation">(</span>fn<span class="token punctuation">,</span> wait<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> timeout <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">clearInterval</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        timeout <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> wait<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
      </div>
<p>判断元素是否在可是区域内</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code><span class="token comment" spellcheck="true">/**
* @params {HTMLElement} el
*/</span>
<span class="token keyword">function</span> <span class="token function">isElementInViewport</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> rect <span class="token operator">=</span> el<span class="token punctuation">.</span><span class="token function">getBoundingClientRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">(</span>
    rect<span class="token punctuation">.</span>top <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
    rect<span class="token punctuation">.</span>left <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
    rect<span class="token punctuation">.</span>bottom <span class="token operator">&lt;=</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>innerHeight <span class="token operator">||</span> document<span class="token punctuation">.</span>documentElement<span class="token punctuation">.</span>clientHeight<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
    rect<span class="token punctuation">.</span>right <span class="token operator">&lt;=</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>innerWidth <span class="token operator">||</span> document<span class="token punctuation">.</span>documentElement<span class="token punctuation">.</span>clientWidth<span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
      </div>
<h4 id="passive-event-listeners"><a href="#passive-event-listeners" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>passive event listeners</h4>
<p>DOM2.0中<code>addEventListeners</code>函数,可以接收三个参数，其中第三个参数是用来控制监听器是在事件捕获阶段执行还是事件冒泡阶段执行，<code>true</code>为捕获阶段，<code>false</code>为冒泡阶段，默认值为<code>false(冒泡阶段)</code>，因为传<code>true</code>的情况太少了</p>
<html><head></head><body><div style="text-align:center;margin-top:20px" align="center">
  
  <a class="gatsby-resp-image-link" href="/static/49f48c734ad38d8779ac7892c8d3fdb5-9fb2e.jpg" style="display: block" target="_blank" rel="noopener">
  
  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 640px; margin-left: auto; margin-right: auto;">
    <span class="gatsby-resp-image-background-image" style="padding-bottom: 53.59375000000001%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAECBf/EABUBAQEAAAAAAAAAAAAAAAAAAAAB/9oADAMBAAIQAxAAAAHt3cQo/8QAFxABAAMAAAAAAAAAAAAAAAAAEQAgIf/aAAgBAQABBQLWNP/EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABUQAQEAAAAAAAAAAAAAAAAAACAx/9oACAEBAAY/Aqv/xAAcEAEAAQQDAAAAAAAAAAAAAAABABARITFRYYH/2gAIAQEAAT8hQYXPcu+cwDrNGn//2gAMAwEAAgADAAAAEPwf/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPxA//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxA//8QAHBABAAMAAgMAAAAAAAAAAAAAAQARIRAxUXGx/9oACAEBAAE/EMAJu/gTai6auqSCWkeQs46nuGk//9k=&apos;); background-size: cover; display: block;">
      <img class="gatsby-resp-image-image" style="width: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;" alt="capture bubble" title="" src="/static/49f48c734ad38d8779ac7892c8d3fdb5-9fb2e.jpg" srcset="/static/49f48c734ad38d8779ac7892c8d3fdb5-94804.jpg 210w,
/static/49f48c734ad38d8779ac7892c8d3fdb5-3f4d9.jpg 420w,
/static/49f48c734ad38d8779ac7892c8d3fdb5-9fb2e.jpg 640w" sizes="(max-width: 640px) 100vw, 640px">
    </span>
  </span>
  
  </a>
    
</div>  </body></html>
<p>此过程被称为事件传播，会以此执行捕获阶段的监听函数和冒泡阶段的监听函数(注意<code>触发事件元素本身的监听函数，会按照监听顺序执行，而不是先执行捕获阶段的，后执行冒泡阶段的</code>，因为目标本身只有一个，自己本身没有捕获和冒泡,自然会按照监听的顺序执行)。在捕获过程中最外层的祖先元素最先响应，然后依次向目标元素捕获；而在冒泡过程中，子元素最先响应，然后依次向父元素冒泡。</p>
<p>在事件处理函数中，会传递<code>Event</code>对象作为参数，而这个参数最常用的2个方法就是：</p>
<ul>
<li>event.stopPaopagation()   阻止事件传播</li>
<li>event.preventDefault()    阻止事件的默认行为</li>
</ul>
<p>我们可以使用如下代码绑定事件：</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code>div<span class="token punctuation">.</span><span class="token function">addEventListeners</span><span class="token punctuation">(</span><span class="token string">"touchstart"</span><span class="token punctuation">,</span><span class="token keyword">function</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 逻辑代码</span>
    <span class="token comment" spellcheck="true">// e.preventDefault()  浏览器在没有执行上面的逻辑代码的时候不知道这里会有阻止默认事件的方法</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
      </div>
<p>由于<code>touchstart</code>事件对象的<code>cancelable</code>属性为<code>true</code>，也就是说它的默认行为可以被监听器通过<code>e.preventDefault()</code>方法阻止，那它的默认行为是什么呢，通常来说就是滚动当前页面（还可能是缩放页面），如果它的默认行为被阻止了，页面就必须静止不动。但浏览器无法预先知道一个监听器会不会调用<code>e.preventDefault()</code>，它能做的只有等监听器执行完后再去执行默认行为，而监听器执行是要耗时的，有些甚至耗时很明显，这样就会导致页面卡顿。视频里也说了，即便监听器是个空函数，也会产生一定的卡顿，毕竟空函数的执行也会耗时。</p>
<p>统计发现，有<code>80%</code>的滚动事件监听器是不会阻止默认行为的，也就是说大部分情况下，浏览器是白等了。所以，<code>passive监听器</code>诞生了，passive 的意思是“顺从的”，表示它不会对事件的默认行为说 no，浏览器知道了一个监听器是<code>passive</code>的，它就可以在两个线程里同时执行监听器中的JavaScript代码和浏览器的默认行为了</p>
<p>这里有一个视频，可以看到<code>passive监听器</code>和普通监听对页面性能的影响<a href="https://www.webreflection.co.uk/blog/2016/04/17/new-dom4-standards">视频地址</a>，现在大部分的浏览器都支持<code>passive</code>,我们可以用起来了，不过也要做好回退的方案。</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code><span class="token keyword">let</span> passiveEventSupported <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> opts <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'passive'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            passiveEventSupported <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> opts<span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>

<span class="token keyword">const</span> passiveEvent <span class="token operator">=</span> passiveEventSupported <span class="token operator">?</span> <span class="token punctuation">{</span> capture<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> passive<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span> <span class="token punctuation">:</span> <span class="token boolean">false</span>

div<span class="token punctuation">.</span><span class="token function">addEventListeners</span><span class="token punctuation">(</span><span class="token string">"touchstart"</span><span class="token punctuation">,</span><span class="token keyword">function</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>passiveEvent<span class="token punctuation">)</span>
</code></pre>
      </div>
<p>如果我们在<code>passive</code>监听器中调用了<code>e.preventDefault</code>函数会如何呢？不用担心，这个时候<code>e.preventDefault</code>函数将不会起作用，并且浏览器会发出警告。</p>
<h4 id="intersectionobserver"><a href="#intersectionobserver" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>IntersectionObserver</h4>
<p><a href="https://developer.mozilla.org/en-US/docs/Web/API/Intersection_Observer_API">IntersectionObserver</a>是一个处于试验阶段的api,可以直接监听image元素进入可视区域内，并触发回调函数,由于目前只有较新版本的浏览器支持，就不在做讲解，如果感兴趣可以去看一下文档，不过这个可能也是未来的发展方向，可以保持关注</p>
<p><a href="https://jmperezperez.com/high-performance-lazy-loading/">lazy-load &#x26; IntersectionObserver的react案例</a></p>]]></description><link>https://reactjs.org/blog/2018/03/08/lazy-loading.html</link><guid isPermaLink="false">https://reactjs.org/blog/2018/03/08/lazy-loading.html</guid><pubDate>Wed, 07 Mar 2018 16:00:00 GMT</pubDate></item></channel></rss>