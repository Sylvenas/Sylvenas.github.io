<?xml version="1.0" encoding="UTF-8"?><rss xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/" xmlns:atom="http://www.w3.org/2005/Atom" version="2.0"><channel><title><![CDATA[Little Forest]]></title><description><![CDATA[A JavaScript library for building user interfaces]]></description><link>https://reactjs.org</link><generator>RSS for Node</generator><lastBuildDate>Mon, 20 Jan 2020 03:13:16 GMT</lastBuildDate><item><title><![CDATA[Abort-Controller]]></title><description><![CDATA[<h3 id="应用场景"><a href="#%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>应用场景</h3>
<p>现在前端主流的技术方案都是<a href="https://www.freecodecamp.org/news/what-exactly-is-client-side-rendering-and-hows-it-different-from-server-side-rendering-bd5c786b340d/">服务端渲染</a>，那就面临着一个问题，Node.js需要承担接口转发的任务，所以原来的<a href="https://www.freecodecamp.org/news/what-exactly-is-client-side-rendering-and-hows-it-different-from-server-side-rendering-bd5c786b340d/">客户端渲染</a>的<code class="gatsby-code-text">http</code>请求的路线(brower -> server),需要调整为(Node.js -> server);看上去没有什么本质的区别，无非是原来是又浏览器发起请求，现在改为Node.js发起请求。</p>
<p>但是高并发呢？举个例子，假如有1000000个请求，原来从browser请求到server,server端如果没有做限流处理，那么部分请求就会一直处于<code class="gatsby-code-text">pendding</code>状态；但是1000000个<code class="gatsby-code-text">pendding</code>是分布在每个客户端上的，所以并没有什么压力；但是如果是Node.js发起的请求，则会出现很大一部分请求在Node.js端处于<code class="gatsby-code-text">pendding</code>状态，则会导致Node.js的CPU和内存占用压力剧增。</p>
<h3 id="promise-timeout方案"><a href="#promise-timeout%E6%96%B9%E6%A1%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Promise timeout方案</h3>
<p>前端<code class="gatsby-code-text">http</code>请求的代码一般会添加一个<code class="gatsby-code-text">timeout</code>的时间限制，配合<code class="gatsby-code-text">Promise.race</code>大概的代码思路是：</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">function</span> <span class="token function">timeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> ms <span class="token operator">=</span> <span class="token number">2000</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
            <span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                code<span class="token punctuation">:</span> <span class="token number">999</span><span class="token punctuation">,</span>
                msg<span class="token punctuation">:</span> <span class="token template-string"><span class="token string">` 调用接口超时: ></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ms<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">ms`</span></span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> ms<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

Promise<span class="token punctuation">.</span><span class="token function">race</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> option<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">timeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
        res <span class="token operator">=></span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        err <span class="token operator">=></span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'请求失败'</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                code<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
                msg<span class="token punctuation">:</span> <span class="token string">'加载失败'</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">)</span></code></pre>
      </div>
<p>上面的代码很简单，借助<code class="gatsby-code-text">Promise.race</code>,如果期望的fetch请求在2000ms内没有返回，则timeout中的<code class="gatsby-code-text">promise</code>会进入<code class="gatsby-code-text">rejected</code>状态，导致整个promise reject,相当于正常的fetch请求我们不会继续处理，直接抛弃了。</p>
<p>但是事实如此吗？这个被我们抛弃的Promise实际上依然处于<code class="gatsby-code-text">pendding</code>状态，直到http请求结束，promise进入<code class="gatsby-code-text">resolve or reject</code>状态，下图可见，错误日志已经打印出来了，但是http依然处于<code class="gatsby-code-text">pendding</code>的状态；可见<code class="gatsby-code-text">Promise.race</code>并不能真正的”抛弃请求”。内存占用，cpu占用依然存在。</p>
<p>
  <a
    class="gatsby-resp-image-link"
    href="/static/promise-timeout-d1eeb13b949a765178b35954fc0ef954-ce390.jpg"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block; ; max-width: 840px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 54.706533776301214%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABmklEQVQoz41SDW/rIAzk///FblnXrfmChHwHSMrtTKqqm57eZunEAbYx9qlhHLCsK7ZtwzzPqI1GXhUJb5czKlMnFHUJ3RhorVHXNZqmSf7jOGKapseq3L4hxB1innyJIYFPwGEn91y3tF/jlvxu+40FHDFiURBj4kpfrxj42tRZosPS92nfliUsKxFuigImzzG2LTr+wGpWWJWJG/rNfZdiR2uhen5lMAZ+Gh9Yhx4jvze2DVY6d0xQXz8x2RZeWsSzmXzivaNvmCfyFiuTKnyzeOBe/j/t+e6Je+exsw0q/i/4F7sxNj4ShiOh9x5BEAKcc7wguBfunrnnwBgkcD4gUBmB56KOfd+xLtzzXFVVjctnjrKqUEjz2c+W/ZBVpNGQy1oZi0If0I1NA7M87znEfhgwUDYSp7LzO07ZBTmTaTqZIkfxcYFno7d1wbbMCXN3DGEduoSFwxDMVIcMTSbelAXU+fSC7OWE7C1LohUJyBSjd2yMv4M8+O/wxyp+jpMXZUgBqi9f8XF+5ZfrpHTpCe5C/Qt+KuILm49S9LYMov8AAAAASUVORK5CYII='); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
        alt="promise-timeout"
        title=""
        src="/static/promise-timeout-d1eeb13b949a765178b35954fc0ef954-a6b71.jpg"
        srcset="/static/promise-timeout-d1eeb13b949a765178b35954fc0ef954-1839a.jpg 210w,
/static/promise-timeout-d1eeb13b949a765178b35954fc0ef954-6c621.jpg 420w,
/static/promise-timeout-d1eeb13b949a765178b35954fc0ef954-a6b71.jpg 840w,
/static/promise-timeout-d1eeb13b949a765178b35954fc0ef954-ce390.jpg 903w"
        sizes="(max-width: 840px) 100vw, 840px"
      />
    </span>
  </span>
  
  </a>
    </p>
<p>上面的例子是发生在browser,问题不大，因为通常一个页面请求不会超过10个，对于单个用户机器来说，性能完全没有什么问题。</p>
<p><strong>但是如果上述事件是发生在Node.js请求server的过程中呢？大量的请求堆积在Node.js端，导致机器cpu或者内存占满，别忘了我们是服务端渲染，这个时候，用户打开页面将会异常缓慢(肯本没有机会继续处理页面渲染了)，或者长时间的等待之后502</strong>。</p>
<blockquote>
<p>上面的例子是在云音乐项目中实际案例。</p>
</blockquote>
<p>所以我们需要找到另外一种解决方案(能真正取消fetch请求的方案)，此时<code class="gatsby-code-text">[AbortController](https://developer.mozilla.org/en-US/docs/Web/API/AbortController)</code>映入眼帘。</p>
<h3 id="abortcontroller使用方法"><a href="#abortcontroller%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>AbortController使用方法</h3>
<p>使用方法很简单，直接看文档。
<a href="https://developer.mozilla.org/en-US/docs/Web/API/AbortController">MDN文档</a><br>
<a href="https://developers.google.com/web/updates/2017/09/abortable-fetch">Google Developers: abortable-fetch</a></p>
<p>现在我们已经确定<code class="gatsby-code-text">AbortController</code>可以真正的取消请求，但是对性能的影响呢？下面我们做个实验：</p>
<h3 id="使用abortcontroller取消-nodejs---java-server的请求"><a href="#%E4%BD%BF%E7%94%A8abortcontroller%E5%8F%96%E6%B6%88-nodejs---java-server%E7%9A%84%E8%AF%B7%E6%B1%82" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用AbortController取消 Node.js -> java server的请求</h3>
<h4 id="测试代码："><a href="#%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81%EF%BC%9A" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>测试代码：</h4>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">const</span> fetch <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'node-fetch'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> AbortController <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'abort-controller'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> controller <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AbortController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> signal <span class="token operator">=</span> controller<span class="token punctuation">.</span>signal<span class="token punctuation">;</span>
    Promise<span class="token punctuation">.</span><span class="token function">race</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token function">fetchInterface</span><span class="token punctuation">(</span>signal<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">timeout</span><span class="token punctuation">(</span>controller<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>res <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token comment">// console.log('请求成功')</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> err <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token comment">//console.log('请求失败')</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">timeout</span><span class="token punctuation">(</span>controller<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> ms <span class="token operator">=</span> <span class="token number">2000</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
            <span class="token comment">// 是否取消请求</span>
            controller<span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                code<span class="token punctuation">:</span> <span class="token number">999</span><span class="token punctuation">,</span>
                msg<span class="token punctuation">:</span> <span class="token template-string"><span class="token string">` 调用接口超时: ></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ms<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">ms`</span></span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> ms<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">fetchInterface</span><span class="token punctuation">(</span>signal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'http://xx.xx.xx.xx:xxxx/fiveseconds'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        signal
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// handle success</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// handle error</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>


<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> index <span class="token operator">&lt;</span> <span class="token number">10000</span><span class="token punctuation">;</span> index<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 全部延迟到6s之后关闭进程</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'测试结束'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">6000</span><span class="token punctuation">)</span></code></pre>
      </div>
<h4 id="nodejs-进程性能监控"><a href="#nodejs-%E8%BF%9B%E7%A8%8B%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Node.js 进程性能监控</h4>
<h5 id="监控工具"><a href="#%E7%9B%91%E6%8E%A7%E5%B7%A5%E5%85%B7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>监控工具</h5>
<p>Node.js 版本 - v10.16.3<br>
<a href="https://github.com/nearform/node-clinic">node-clinic</a></p>
<p>测试命令：<code class="gatsby-code-text">clinic doctor -- node abort.js</code></p>
<h5 id="测试方法"><a href="#%E6%B5%8B%E8%AF%95%E6%96%B9%E6%B3%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>测试方法</h5>
<p>在Node.js端连续发起<strong>10000</strong>次(<del>再多电脑散热器要揭竿而起</del>)fetch请求,请求随机延迟0-5秒之后响应；</p>
<p>设置2s的超时期限；分别测试2s之后，取消请求与不取消请求的差别下Node.js进程的性能对比；</p>
<blockquote>
<p>最后采用<code class="gatsby-code-text">setTimeout 6s</code>的原因是全部延迟Node.js进程到6s之后结束,取消请求会导致2s后进程关闭，后面的性能数据无法继续采集</p>
</blockquote>
<h6 id="测试结果"><a href="#%E6%B5%8B%E8%AF%95%E7%BB%93%E6%9E%9C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>测试结果</h6>
<ul>
<li>
<p>不取消请求的结果</p>
<ul>
<li>相同点：2s之后<code class="gatsby-code-text">Promise.race</code>返回的promise毫无疑问处于rejected状态</li>
<li><strong>不同点：2s之后，原来发起的请求，依然处于pending状态，Node.js进程并未结束，需等待所有异步请求结束之后才会结束进程</strong></li>
</ul>
</li>
<li>
<p>取消请求的结果</p>
<ul>
<li>相同点：2s之后<code class="gatsby-code-text">Promise.race</code>返回的promise毫无疑问处于rejected状态</li>
<li><strong>不同点：2s之后，原来发起的请求，处于canceled状态，Node.js进程结束</strong></li>
</ul>
</li>
<li>
<p>性能图对比：</p>
<ul>
<li>
<p>不取消请求</p>
<ul>
<li>cpu持续占用，最高600%</li>
<li>内存逐渐小幅度增加，最高252MB</li>
<li>active handles到结束逐渐减少

  <a
    class="gatsby-resp-image-link"
    href="/static/不取消请求-b0ff5c90a827f999ea6c136cbabcdc91-d1e36.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block; ; max-width: 840px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 48.802083333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABYklEQVQoz62QzU7DMBCE/RBAaWI7TpqkcZISQn9SWn4kEBceAnHhiUC87jDrliIQBw4cPu1OnFmPVy2Ge9Rnm4BvL1F9Y32o02bYa/Z7LZ7t7SNWmwcs13fw1GrWX6FsB6R+AVucw5U9EiI1Ky9Ij4JnbbdB6ZfIqzmHrTh4QFmvkNIj2LRGZAqoJqnhrceQztC5Bq2jTjwyO0WkC0RxjqLqYScddNpCZzOY7AxGNHudNojp0fTG9KgFU/R5h5tyjm1xgWV+jjWZ85tzHomQNUzRMUUDwyQ7GlgOFJLJDp1UUDafYZxMcaRzHDPRCWOfsI5YI1NiTPKyw5SkTK6ptaQPZ0V4pvSfqMhWYbLhz4L+Qczzul2EIYLjNyFlcrnABu+O8GQje3FNeIKg9xw092McDc6HiwN7LUNkLZ+rkQuVJPgzyVcf/ULMxGo0Mjg9NRj/AzJHXb+8Y/X8hvnT67/wAeosKplSp104AAAAAElFTkSuQmCC'); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
        alt="不取消请求"
        title=""
        src="/static/不取消请求-b0ff5c90a827f999ea6c136cbabcdc91-acf85.png"
        srcset="/static/不取消请求-b0ff5c90a827f999ea6c136cbabcdc91-c1418.png 210w,
/static/不取消请求-b0ff5c90a827f999ea6c136cbabcdc91-5d5d8.png 420w,
/static/不取消请求-b0ff5c90a827f999ea6c136cbabcdc91-acf85.png 840w,
/static/不取消请求-b0ff5c90a827f999ea6c136cbabcdc91-de0cd.png 1260w,
/static/不取消请求-b0ff5c90a827f999ea6c136cbabcdc91-bd6c2.png 1680w,
/static/不取消请求-b0ff5c90a827f999ea6c136cbabcdc91-d1e36.png 1920w"
        sizes="(max-width: 840px) 100vw, 840px"
      />
    </span>
  </span>
  
  </a>
    </li>
</ul>
</li>
<li>
<p>取消请求</p>
<ul>
<li>2s内cpu持续占用，最高355%，2s后极速降低为0</li>
<li>2s内内存逐渐小幅度增加，最高248MB，2后极速降低到133MB</li>
<li>active handles 2s后极速降低到0

  <a
    class="gatsby-resp-image-link"
    href="/static/取消请求-9c7686ae5764435812e81ddd5b47728c-d1e36.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block; ; max-width: 840px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 48.802083333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABL0lEQVQoz62QSW7CQBBF+xYB291uz7PNYIwBoSiKsskhomxyokS57s/vZlIQEhsWT7+rXMMvi379iqLZWPJ6JJsbjMiq9fH7eI7Ldovd8zuG7RtWI+cwFt1iz4I1kqJHmM7J4qiXd5z3qLsd0nLge8lhg+1JyxWCeGZRQQlHJhBu0MJvXuBFc0zdGFOZnnGMegmitIOKWnhBAy/sqNU/XF0SqsogomyGuNpC040KazY21OaiJsftQcLFYQUdd/AtrcXEJzw/hwjjBlLRDZ046uDqmpgOc6L9gs6TmzUW9gslM0hOVkReYXMqR1H3dnuoC2gib9Qa7MmaZwT8B5pnaX2iuLyZN8PM2dKcfqdOOHRwD9e/X3OoKyAmTxKTicT0AZg5Yv/1i+HzB8uP74fwB4WUKhsJFVXHAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
        alt="取消请求"
        title=""
        src="/static/取消请求-9c7686ae5764435812e81ddd5b47728c-acf85.png"
        srcset="/static/取消请求-9c7686ae5764435812e81ddd5b47728c-c1418.png 210w,
/static/取消请求-9c7686ae5764435812e81ddd5b47728c-5d5d8.png 420w,
/static/取消请求-9c7686ae5764435812e81ddd5b47728c-acf85.png 840w,
/static/取消请求-9c7686ae5764435812e81ddd5b47728c-de0cd.png 1260w,
/static/取消请求-9c7686ae5764435812e81ddd5b47728c-bd6c2.png 1680w,
/static/取消请求-9c7686ae5764435812e81ddd5b47728c-d1e36.png 1920w"
        sizes="(max-width: 840px) 100vw, 840px"
      />
    </span>
  </span>
  
  </a>
    </li>
</ul>
</li>
</ul>
</li>
</ul>
<blockquote>
<p>CPU占用超过100%的原因JS为单线程，但是Node.js为多线程，Node.js会启用其他线程进行垃圾回收，性能优化等等,所以CPU占用是一个综合之后的数据</p>
</blockquote>
<h3 id="node-fetch-timeout"><a href="#node-fetch-timeout" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>node-fetch timeout</h3>
<p>现在在Node.js端做转发请求一般会使用<a href="https://github.com/node-fetch/node-fetch">node-fetch</a>库，node-fetch本身实现了<code class="gatsby-code-text">timeout</code>的option，node-fetch <code class="gatsby-code-text">timeout</code>的实现原理如下：</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>timeout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    req<span class="token punctuation">.</span><span class="token function">once</span><span class="token punctuation">(</span><span class="token string">'socket'</span><span class="token punctuation">,</span> socket <span class="token operator">=></span> <span class="token punctuation">{</span>
        reqTimeout <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
            <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FetchError</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`network timeout at: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>request<span class="token punctuation">.</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">,</span> <span class="token string">'request-timeout'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">finalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
      </div>
<p>node-fetch并不推荐使用<code class="gatsby-code-text">timeout</code>，而是建议使用标准的<code class="gatsby-code-text">AbortController</code>来控制超时：</p>
<ul>
<li><a href="https://github.com/node-fetch/node-fetch#request-cancellation-with-abortsignal">node-fetch timeout vs abortsignal</a></li>
<li><a href="https://stackoverflow.com/questions/54204342/node-fetch-why-is-signal-recommended-over-timeout">建议使用AbortController的原因</a></li>
</ul>
<h3 id="结论"><a href="#%E7%BB%93%E8%AE%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>结论</h3>
<p>引入<a href="https://www.npmjs.com/package/abort-controller"><code class="gatsby-code-text">abort-controller</code></a> polyfill包 <strong>3kb</strong>，还是值得的,周下载量超过200万，应该是挺多人在使用。</p>]]></description><link>https://reactjs.org/blog/2020/01/18/abort-controller.html</link><guid isPermaLink="false">https://reactjs.org/blog/2020/01/18/abort-controller.html</guid><pubDate>Fri, 17 Jan 2020 16:00:00 GMT</pubDate></item><item><title><![CDATA[Catch React Error]]></title><description><![CDATA[<h3 id="catch-react-error"><a href="#catch-react-error" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>catch-react-error</h3>
<p>English | <a href="./doc/catch-react-error.md">简体中文</a></p>
<p><a href="./doc/catch-react-error_EN.md">Why we create catch-react-error</a></p>
<h3 id="introduction"><a href="#introduction" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Introduction</h3>
<p>This project make it easy to protect your react source code。</p>
<p>We combine decorators and React Error Boundaries together.</p>
<p>The React Error Boundaries don’t support the Server Side Rendering，so we use <code class="gatsby-code-text">try/catch</code> to deal such condition.</p>
<p>The catch-react-error takes only one argument,<a href="https://reactjs.org/docs/error-boundaries.html">React Error Boundary Component</a>.
We provide DefaultErrorBoundary as the default argument.</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">const</span> <span class="token function-variable function">catchreacterror</span> <span class="token operator">=</span> <span class="token punctuation">(</span>Boundary <span class="token operator">=</span> DefaultErrorBoundary<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
      </div>
<div style="text-align:center" align="center">
  <img src="https://p1.music.126.net/6tHW45dHH_qKtCw0rrkJOg==/109951164571395030.gif">
</div>
<h3 id="demo"><a href="#demo" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Demo</h3>
<p>we provide some demo, so you can understand the library more clearly</p>
<h3 id="client-side-render"><a href="#client-side-render" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>client side render</h3>
<div class="gatsby-highlight">
      <pre class="gatsby-code-sh"><code class="gatsby-code-sh">cd example-client
npm install
npm run dev</code></pre>
      </div>
<h3 id="server-side-render"><a href="#server-side-render" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>server side render</h3>
<div class="gatsby-highlight">
      <pre class="gatsby-code-sh"><code class="gatsby-code-sh">cd example-server
npm install
npm run dev</code></pre>
      </div>
<h3 id="how-to-use"><a href="#how-to-use" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>How to use</h3>
<h4 id="1install-catch-react-error"><a href="#1install-catch-react-error" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>1.install catch-react-error</h4>
<div class="gatsby-highlight">
      <pre class="gatsby-code-sh"><code class="gatsby-code-sh">npm install catch-react-error --save</code></pre>
      </div>
<h4 id="2-install-es7-decorator-babel-plugin"><a href="#2-install-es7-decorator-babel-plugin" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>2. Install ES7 Decorator babel plugin</h4>
<div class="gatsby-highlight">
      <pre class="gatsby-code-sh"><code class="gatsby-code-sh">npm install --save-dev @ babel / plugin-proposal-decorators
npm install --save-dev @ babel / plugin-proposal-class-properties</code></pre>
      </div>
<p>babel plugin configuration</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsxon"><code class="gatsby-code-jsxon">{
  &quot;plugins&quot;: [
    [&quot;@ babel / plugin-proposal-decorators&quot;, { &quot;legacy&quot;: true }],
    [&quot;@ babel / plugin-proposal-class-properties&quot;, { &quot;loose&quot;: true }]
  ]
}</code></pre>
      </div>
<h4 id="3-import-catch-react-error"><a href="#3-import-catch-react-error" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>3. import catch-react-error</h4>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">import</span> catchreacterror <span class="token keyword">from</span> <span class="token string">"catch-react-error"</span><span class="token punctuation">;</span></code></pre>
      </div>
<h4 id="4-use-catchreacterror-on-class-component"><a href="#4-use-catchreacterror-on-class-component" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>4. Use @catchreacterror on class component</h4>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code class="gatsby-code-jsx">@<span class="token function">catchreacterror</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">Count</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> count <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">===</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"count is three"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span><span class="token punctuation">{</span>count<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
      </div>
<h4 id="5-use-catchreacterror-on-functionc-component"><a href="#5-use-catchreacterror-on-functionc-component" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>5. Use @catchreacterror on functionc component</h4>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">function</span> <span class="token function">Count</span><span class="token punctuation">(</span><span class="token punctuation">{</span> count <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">===</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"count is three"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span><span class="token punctuation">{</span>count<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> SaleCount <span class="token operator">=</span> <span class="token function">catchreacterror</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>Count<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>App<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>SaleCount</span> <span class="token attr-name">count</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token number">3</span><span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span><span class="token punctuation">></span></span><span class="token constant">I</span>'m <span class="token constant">OK</span><span class="token punctuation">,</span> click me <span class="token operator">!</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
      </div>
<h4 id="6-how-to-write-a-customerrorboundary"><a href="#6-how-to-write-a-customerrorboundary" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>6. How to write a CustomErrorBoundary</h4>
<ol>
<li>create an normal Error Boundary Component</li>
</ol>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">class</span> <span class="token class-name">CustomErrorBoundary</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
<span class="token function">  constructor</span> <span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span> <span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>hasError<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">static</span> <span class="token function">getDerivedStateFromError</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>hasError<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token function">  componentDidCatch</span> <span class="token punctuation">(</span><span class="token class-name">error</span><span class="token punctuation">,</span> errorInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//do something as needed</span>
<span class="token function">    logErrorToMyService</span> <span class="token punctuation">(</span>error<span class="token punctuation">,</span> errorInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token function">  render</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>hasError<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span> Something <span class="token keyword">with</span> my app<span class="token punctuation">,</span>fallback ui<span class="token punctuation">.</span> <span class="token operator">&lt;</span><span class="token operator">/</span> h1<span class="token operator">></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
      </div>
<ol start="2">
<li>pass it as the argument</li>
</ol>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code class="gatsby-code-jsx">@<span class="token function">catchreacterror</span><span class="token punctuation">(</span>CustomErrorBoundary<span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">Count</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre>
      </div>
<p>or</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">const</span> SaleCount <span class="token operator">=</span> <span class="token function">catchreacterror</span><span class="token punctuation">(</span>CustomErrorBoundary<span class="token punctuation">)</span><span class="token punctuation">(</span>Count<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
      </div>
<h3 id="license"><a href="#license" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>License</h3>
<p>MIT.</p>]]></description><link>https://reactjs.org/blog/2020/01/02/catch-react-error.html</link><guid isPermaLink="false">https://reactjs.org/blog/2020/01/02/catch-react-error.html</guid><pubDate>Wed, 01 Jan 2020 16:00:00 GMT</pubDate></item><item><title><![CDATA[黑珍珠号的诅咒]]></title><description><![CDATA[<p><img src="https://p1.music.126.net/dwtcN86z-8-aHbKrGy_9pQ==/109951164578969593.jpg" alt="banner"></p>
<blockquote>
<p>本文作者：<a href="https://github.com/sylvenas">赵祥涛</a></p>
</blockquote>
<p>函数式编程（Functional Programming）这一理念不论是在前端领域还是后端领域，都逐渐热门起来，现在不大量使用函数式编程技术的大型应用程序已经很罕见了，比如前端流行的 React（核心思路数据即视图），Vue3.0 的 Composition API ，Redux ，Lodash 等等前端框架和库，无不充斥着函数式的思维，实际上函数式编程绝不是最近几年才被创造的编程范式，而是在计算机科学的开始，<a href="https://history.computer.org/pioneers/church.html">Alonzo Church</a> 在 20 世纪 30 年代发表的 <code class="gatsby-code-text">lambda</code> 演算，可以说是函数式编程的前世今生。</p>
<p>本系列文章适合拥有扎实的 JavaScript 基础和有一定函数式编程经验的人阅读，本文的目的是结合 JavaScript 的语言特性来讲解范畴论的一些概念和逻辑在编程中的实际应用。</p>
<h3 id="黑珍珠号的诅咒"><a href="#%E9%BB%91%E7%8F%8D%E7%8F%A0%E5%8F%B7%E7%9A%84%E8%AF%85%E5%92%92" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>黑珍珠号的诅咒</h3>
<h4 id="扬帆起航！"><a href="#%E6%89%AC%E5%B8%86%E8%B5%B7%E8%88%AA%EF%BC%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>扬帆起航！</h4>
<p>首先我们看一段 <code class="gatsby-code-text">双11大促销</code> 的代码，即作为对函数组合等概念的回顾，也作为即将开启的新征程的第一步：</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">const</span> <span class="token function-variable function">finalPrice</span> <span class="token operator">=</span> number <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> doublePrice <span class="token operator">=</span> number <span class="token operator">*</span> <span class="token number">2</span>
    <span class="token keyword">const</span> discount <span class="token operator">=</span> doublePrice <span class="token operator">*</span> <span class="token number">.8</span>
    <span class="token keyword">const</span> price <span class="token operator">=</span> discount <span class="token operator">-</span> <span class="token number">50</span>
    <span class="token keyword">return</span> price
<span class="token punctuation">}</span>

<span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">finalPrice</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token comment">// => 110</span></code></pre>
      </div>
<p>看看上面这段简单的 <code class="gatsby-code-text">双11购物狂欢节</code> 的代码，<strong>原价 100 **的商品，经过商家一顿花式大促销（<code class="gatsby-code-text">打折（八折）</code> + <code class="gatsby-code-text">优惠券（50）</code>）的操作之后，大家成功拿到</strong>剁手价 110**。<del>好划算，快剁手</del></p>
<p>如果你已经阅读了我们云音乐前端团队的另外一篇<a href="https://juejin.im/post/5d70e25de51d453c11684cc4">函数式编程入门文章</a>，我相信你已经知道如何书写函数式的程序了：即通过管道把数据在一系列纯函数间传递的程序。我们也知道了，这些程序就是声明式的行为规范。现在再次使用函数组合的思路保持数据管道操作，并消除这么多的中间变量，保持一种 <code class="gatsby-code-text">Point-Free</code> 风格：</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code class="gatsby-code-jsx">    <span class="token keyword">const</span> <span class="token function-variable function">compose</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">...</span>fns<span class="token punctuation">)</span> <span class="token operator">=></span> x <span class="token operator">=></span> fns<span class="token punctuation">.</span><span class="token function">reduceRight</span><span class="token punctuation">(</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> f<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">f</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span>

    <span class="token keyword">const</span> <span class="token function-variable function">double</span> <span class="token operator">=</span> x <span class="token operator">=></span> x <span class="token operator">*</span> <span class="token number">2</span>
    <span class="token keyword">const</span> <span class="token function-variable function">discount</span> <span class="token operator">=</span> x <span class="token operator">=></span> x <span class="token operator">*</span> <span class="token number">0.8</span>
    <span class="token keyword">const</span> <span class="token function-variable function">coupon</span> <span class="token operator">=</span> x <span class="token operator">=></span> x <span class="token operator">-</span> <span class="token number">50</span>

    <span class="token keyword">const</span> finalPrice <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span>coupon<span class="token punctuation">,</span> discount<span class="token punctuation">,</span> double<span class="token punctuation">)</span>

    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">finalPrice</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token comment">// => 110</span></code></pre>
      </div>
<p>嗯！终于有了点函数式的味道！这个时候，我们发现传给函数 <code class="gatsby-code-text">finalPrice</code> 的参数 <code class="gatsby-code-text">100</code> 像一个工厂的零配件一样在流水线上先后被函数 <code class="gatsby-code-text">double</code>、 <code class="gatsby-code-text">discount</code> 和 <code class="gatsby-code-text">coupon</code> 所操作。<code class="gatsby-code-text">100</code> 像水一样在管道中流通。看到这一幕我们是不是有点眼熟，Array 的 <code class="gatsby-code-text">map</code> ，<code class="gatsby-code-text">filter</code> ，不就是完全类似的概念吗？所以我们可以用 Array 把我们输入的参数进行包装：</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">const</span> <span class="token function-variable function">finalPrice</span> <span class="token operator">=</span> number <span class="token operator">=></span>
    <span class="token punctuation">[</span>number<span class="token punctuation">]</span>
        <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x <span class="token operator">*</span> <span class="token number">0.8</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x <span class="token operator">-</span> <span class="token number">50</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">finalPrice</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token comment">// => [110]</span></code></pre>
      </div>
<p>现在我们把 <code class="gatsby-code-text">number</code> 放进 Array 这个容器内，然后连续调用了三次 map ,来实现数据的管道流动。仔细观察发现 Array 只是我们数据的容器，我们也只是想利用 Array 的 map 方法罢了，其他的方法我们暂时用不到，那么我们何不创建一个 <code class="gatsby-code-text">Box</code> 容器呢？</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">const</span> <span class="token function-variable function">Box</span> <span class="token operator">=</span> x <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    map<span class="token punctuation">:</span> f <span class="token operator">=></span> <span class="token function">Box</span><span class="token punctuation">(</span><span class="token function">f</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    inspect<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token template-string"><span class="token string">`Box(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>x<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">finalPrice</span> <span class="token operator">=</span> str <span class="token operator">=></span>
    <span class="token function">Box</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x <span class="token operator">*</span> <span class="token number">0.8</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x <span class="token operator">-</span> <span class="token number">50</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">finalPrice</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token comment">// => Box(110)</span></code></pre>
      </div>
<blockquote>
<p>这里使用函数 Box 而不是 ES6 的 Class 来生产对象的原因是，尽量避免了“糟糕”的 new 和 this 关键字(摘自《 You Don’t Know JS 上册》)， new 让人误以为是创建了 Class 的实例，但其实根本不存在所谓的<code class="gatsby-code-text">实例化</code>，只是简单的<code class="gatsby-code-text">属性委托机制(对象组合的一种)</code>，而 this 则引入了执行上下文和词法作用域的问题，而我只是想创建一个简单的对象而已！        </p>
<p>inspect 方法的目的是为了使用 Node.js 中的 console.log 隐式的调用它，方便我们查看数据的类型；而这一方法在浏览器中不可行，可以用 <code class="gatsby-code-text">console.log(String(x))</code> 来代替; Node.js V12 API 有变更，可以采用 <a href="http://nodejs.cn/api/en/util.html#util_util_inspect_object_options"><code class="gatsby-code-text">Symbol.for(&#39;nodejs.util.inspect.custom&#39;)</code></a> 替代 inspect
<br>
这里使用连续 dot、dot、dot 的链式调用而不是使用 compose 组合的原因是为了更方便的理解，compose 更为函数式。</p>
</blockquote>
<h4 id="被封印的黑珍珠号"><a href="#%E8%A2%AB%E5%B0%81%E5%8D%B0%E7%9A%84%E9%BB%91%E7%8F%8D%E7%8F%A0%E5%8F%B7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>被封印的黑珍珠号</h4>
<p><img src="https://p1.music.126.net/eLyaFFUwmPlcaY9bxWhGkw==/109951164499400541.png" alt="杰克船长的黑珍珠号"></p>
<p>Box 中这个 <code class="gatsby-code-text">map</code> 跟数组那个著名的 <code class="gatsby-code-text">map</code> 一样，除了前者操作的是 <code class="gatsby-code-text">Box(x)</code> 而后者是 <code class="gatsby-code-text">[x]</code> 。它们的使用方式也几乎一致，把一个值丢进 Box ，然后不停的 map，map，map…：</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token function">Box</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// => Box(12)</span>

<span class="token function">Box</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>s <span class="token operator">=></span> s<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// => Box('HELLO')</span></code></pre>
      </div>
<p>这是讲解函数式编程的第一个容器，我们将它称之为 <code class="gatsby-code-text">Box</code>，而数据就像杰克船长瓶子中的黑珍珠号一样，我们只能通过 <code class="gatsby-code-text">map</code> 方法去操作其中的值，而 Box 像是一种虚拟的屏障，也可以说在一定程度上保护 Box 中的值不被随意的获取和操作。</p>
<p>为什么要使用这样的思路？因为我们能够在不离开 Box 的情况下操作容器里面的值。Box 里的值传递给 <code class="gatsby-code-text">map</code> 函数之后，就可以任我们操作；操作结束后，为了防止意外再把它放回它所属的 <code class="gatsby-code-text">Box</code>。这样做的结果是，我们能连续地调用 <code class="gatsby-code-text">map</code>，运行任何我们想运行的函数。甚至还可以改变值的类型，就像上面最后一个例子中那样。</p>
<blockquote>
<p>map 是可以使用 lambda 表达式变换容器内的值的有效且安全的途径。</p>
</blockquote>
<p>等等，如果我们能一直调用 <code class="gatsby-code-text">map.map.map</code> ，那我们是不是可以称这种类型为 <code class="gatsby-code-text">Mappable Type</code> ? 这样理解完全没有问题！</p>
<p><code class="gatsby-code-text">map</code> 知道如何在上下文中映射函数值。它首先会打开该容器，然后把值通过函数映射为另外一个值，最后把结果值再次包裹到一个新的同类型的容器中。而这种变换容器内的值的方法(map)称为 <a href="https://medium.com/@dtinth/what-is-a-functor-dcf510b098b6">Functor(函子)</a>。</p>
<p><img src="https://p1.music.126.net/T8BjeCqe_-mJUQczJoOdbw==/109951164499392356.png" alt="函子图解"></p>
<p><code class="gatsby-code-text">Functor(函子)</code> 是<a href="https://www.quantamagazine.org/with-category-theory-mathematics-escapes-from-equality-20191010/">范畴论</a>里的概念。范畴论又是什么？？？ 我不懂！！！</p>
<p>不慌！后面我们会再继续简单的讨论一下范畴论与 Functor 的概念和理论，让我们暂时忘记这个奇怪的名字，先跳过这个概念。</p>
<p>还是继续称之为我们都能理解的 Box 吧！</p>
<h4 id="黑珍珠号的救赎"><a href="#%E9%BB%91%E7%8F%8D%E7%8F%A0%E5%8F%B7%E7%9A%84%E6%95%91%E8%B5%8E" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>黑珍珠号的救赎</h4>
<p>类似于 <code class="gatsby-code-text">Box(2).map(x =&gt; x + 2)</code> 我们已经可以把任何类型的值，包装到 Box 中，然后不断的 map，map，map…。</p>
<p>另一个问题，我们怎么取出来我们的值呢？我想要的结果是 <code class="gatsby-code-text">4</code> 而不是 <code class="gatsby-code-text">Box(4)</code>!</p>
<p>如果黑珍珠号不能从瓶子中释放出来又有什么用处呢？接下来让杰克斯派洛船长抢过黑胡子的宝剑，释放出来黑珍珠号！</p>
<p>是时候为我们的这个最为原始的 Box 添加别的方法了。</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">const</span> <span class="token function-variable function">Box</span> <span class="token operator">=</span> x <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    map<span class="token punctuation">:</span> f <span class="token operator">=></span> <span class="token function">Box</span><span class="token punctuation">(</span><span class="token function">f</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    fold<span class="token punctuation">:</span> f <span class="token operator">=></span> <span class="token function">f</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span>
    inspect<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token template-string"><span class="token string">`Box(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>x<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">Box</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">fold</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">)</span>  <span class="token comment">// => 4</span></code></pre>
      </div>
<p>嗯，看出来 <code class="gatsby-code-text">fold</code> 和 <code class="gatsby-code-text">map</code> 的区别了吗？</p>
<p><strong><code class="gatsby-code-text">map</code> 是把函数执行的结果重新包装到 Box 中后然返回一个新的 Box 类型，而 <code class="gatsby-code-text">fold</code> 则是直接把函数执行的结果 return 出来，就结束了！</strong></p>
<h3 id="box-的实际应用"><a href="#box-%E7%9A%84%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Box 的实际应用</h3>
<h4 id="try-catch"><a href="#try-catch" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Try-Catch</h4>
<p>在许多情况下都会发生 JavaScript 错误，特别是在与服务器通讯时，或者是在试图访问一个 null 对象的属性时。我们总是要预先做好最坏的打算，而这种大部分都是通过 <code class="gatsby-code-text">try-catch</code> 来实现的。</p>
<p>举例来说：</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">const</span> <span class="token function-variable function">getUser</span> <span class="token operator">=</span> id <span class="token operator">=></span>
    <span class="token punctuation">[</span><span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">'Loren'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">'Zora'</span> <span class="token punctuation">}</span><span class="token punctuation">]</span>
        <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span>id <span class="token operator">===</span> id<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

<span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token comment">// => 'Loren'</span>

<span class="token keyword">const</span> name2 <span class="token operator">=</span> <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name2<span class="token punctuation">)</span> <span class="token comment">// => 'TypeError: Cannot read property 'name' of undefined'</span></code></pre>
      </div>
<p>那么现在代码报错了，使用 <code class="gatsby-code-text">try-catch</code> 可以一定程度上解决这个问题：</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>message<span class="token punctuation">)</span> <span class="token comment">// => 'TypeError: Cannot read property 'name' of undefined'</span>
<span class="token punctuation">}</span></code></pre>
      </div>
<p>一旦发生了错误，JavaScript 会立即终止执行，并创建导致该问题的函数的调用堆栈跟踪，并保存到 Error 对象中，catch 就像是我们代码的避风港湾一样。但是 <code class="gatsby-code-text">try-catch</code> 能妥善的解决我们的问题吗？<code class="gatsby-code-text">try-catch</code> 存在以下缺点：</p>
<ul>
<li>违反了<a href="https://en.wikipedia.org/wiki/Referential_transparency">引用透明</a>原则，因为抛出异常会导致函数调用出现另一个出口，所以不能确保单一的可预测的返回值。</li>
<li>会引起<a href="https://juejin.im/post/5d70e25de51d453c11684cc4#heading-11">副作用</a>，因为异常会在函数调用之外对堆栈引发不可预料的影响。</li>
<li>违反<a href="https://www.commonlounge.com/discussion/e16d75c8232c4161b474f4b62c261c9d#trycatch">局域性的原则</a>，因为用于恢复异常的代码和原始的函数调用渐行渐远，当发生错误的时候，函数会离开局部栈和环境。</li>
<li>不能只关心函数的返回值，调用者需要负责声明 catch 块中的异常匹配类型来管理特定的异常;难以与其他函数组合或链接，总不能让管道中的下一个函数处理上一个函数抛出的错误吧。</li>
<li>当有多个异常条件的时候会出现<a href="https://guide.freecodecamp.org/javascript/error-handling-and-try-catch-throw/">嵌套的异常处理块</a>。</li>
</ul>
<blockquote>
<p>异常应该由一个地方抛出，而不是随处可见。</p>
</blockquote>
<p>上面的描述和代码可以看出，<code class="gatsby-code-text">try-catch</code> 是完全被动的解决方式，也非常的不“函数式”，若是能轻松的处理错误甚至包容错误，该有多好？下面不妨让我们使用Box理念，来优化这些问题</p>
<h4 id="向左-向右"><a href="#%E5%90%91%E5%B7%A6-%E5%90%91%E5%8F%B3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>向左? 向右?</h4>
<p>仔细分析 <code class="gatsby-code-text">try-catch</code> 代码块的逻辑，发现我们的代码出口要么在 try 中，要么在 catch 中(函数总不能有两个返回值吧)。按照我们代码设计的期望，我们是希望代码从 try 分支走完的，catch 是我们的一个兜底方案，那么我们可以类比 try 为 <code class="gatsby-code-text">Right</code> 指代正常的分支，catch 为 <code class="gatsby-code-text">Left</code> 指代出现异常的分支，他们两者绝不会同时出现！那么我们扩展一下我们的 <code class="gatsby-code-text">Box</code> ，分别为 <code class="gatsby-code-text">Left</code> 和 <code class="gatsby-code-text">Right</code> ，看代码：</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">const</span> <span class="token function-variable function">Left</span> <span class="token operator">=</span> x <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    map<span class="token punctuation">:</span> f <span class="token operator">=></span> <span class="token function">Left</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span>
    fold<span class="token punctuation">:</span> <span class="token punctuation">(</span>f<span class="token punctuation">,</span> g<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">f</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span>
    inspect<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token template-string"><span class="token string">`Left(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>x<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">Right</span> <span class="token operator">=</span> x <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    map<span class="token punctuation">:</span> f <span class="token operator">=></span> <span class="token function">Right</span><span class="token punctuation">(</span><span class="token function">f</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    fold<span class="token punctuation">:</span> <span class="token punctuation">(</span>f<span class="token punctuation">,</span> g<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">g</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span>
    inspect<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token template-string"><span class="token string">`Right(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>x<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> resultLeft <span class="token operator">=</span> <span class="token function">Left</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>resultLeft<span class="token punctuation">)</span>  <span class="token comment">// => Left(4)</span>

<span class="token keyword">const</span> resultRight <span class="token operator">=</span> <span class="token function">Right</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>resultRight<span class="token punctuation">)</span>  <span class="token comment">// => Right(2.5)</span></code></pre>
      </div>
<p><code class="gatsby-code-text">Left</code> 和 <code class="gatsby-code-text">Right</code> 的区别在于 Left 会自动跳过 <code class="gatsby-code-text">map</code> 方法传递的函数，而 Right 则类似于最基本的 Box，会执行函数并把返回值重新包装到 Right 容器里面。<code class="gatsby-code-text">Left</code> 和 <code class="gatsby-code-text">Right</code> 完全类似于 Promise 中的 <code class="gatsby-code-text">Reject</code> 和 <code class="gatsby-code-text">Resolve</code>，一个 Promise 的结果要么是 Reject 要么是 Resolve，而拥有 Right 和 Left 分支的结构体，我们可以称之为 <strong>Either</strong> ，要么向左，要么向右，很好理解，对吧！上面的代码说明了 Left 和 Right 的基本用法，现在把我们的 <code class="gatsby-code-text">Left</code> 和 <code class="gatsby-code-text">Right</code> 应用到 <code class="gatsby-code-text">getUser</code> 函数上吧！</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">const</span> <span class="token function-variable function">getUser</span> <span class="token operator">=</span> id <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">'Loren'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">'Zora'</span> <span class="token punctuation">}</span><span class="token punctuation">]</span>
        <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span>id <span class="token operator">===</span> id<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> user <span class="token operator">?</span> <span class="token function">Right</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token function">Left</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">fold</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token string">'not found'</span><span class="token punctuation">,</span> x <span class="token operator">=></span> x<span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token comment">// => not found</span></code></pre>
      </div>
<p>不可相信！我们现在竟然能线性的处理错误，并且甚至能够给出一个 <code class="gatsby-code-text">not found</code> 的提醒了（通过给 fold 提供），但是再仔细思考一下，是不是我们原始的 <code class="gatsby-code-text">getUser</code> 函数，有可能会返回 <code class="gatsby-code-text">undefined</code> 或者一个正常的值，是不是可以直接包装一下这个函数的返回值呢？</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">const</span> <span class="token function-variable function">fromNullable</span> <span class="token operator">=</span> x <span class="token operator">=></span>
    x <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token function">Right</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token function">Left</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">getUser</span> <span class="token operator">=</span> id <span class="token operator">=></span>
    <span class="token function">fromNullable</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">'Loren'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">'Zora'</span> <span class="token punctuation">}</span><span class="token punctuation">]</span>
            <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span>id <span class="token operator">===</span> id<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">fold</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token string">'not found'</span><span class="token punctuation">,</span> c <span class="token operator">=></span> c<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token comment">// => not found</span></code></pre>
      </div>
<p>现在我们已经成功处理了可能出现 null 或者 undefined 的情况，那么 try-catch 呢？是否也可以被 Either 包装一下呢？</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">const</span> <span class="token function-variable function">tryCatch</span> <span class="token operator">=</span> <span class="token punctuation">(</span>f<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">Right</span><span class="token punctuation">(</span><span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">Left</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">jsonFormat</span> <span class="token operator">=</span> str <span class="token operator">=></span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">app</span> <span class="token operator">=</span> <span class="token punctuation">(</span>str<span class="token punctuation">)</span> <span class="token operator">=></span>
    <span class="token function">tryCatch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">jsonFormat</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span>path<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">fold</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token string">'default path'</span><span class="token punctuation">,</span> x <span class="token operator">=></span> x<span class="token punctuation">)</span>

<span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">app</span><span class="token punctuation">(</span><span class="token string">'{"path":"some path..."}'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token comment">// => 'some path...'</span>

<span class="token keyword">const</span> result2 <span class="token operator">=</span> <span class="token function">app</span><span class="token punctuation">(</span><span class="token string">'the way to death'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result2<span class="token punctuation">)</span> <span class="token comment">// => 'default path'</span></code></pre>
      </div>
<p>现在我们的 try-catch 即使报错了，也不会打断我们的函数组合了,并且错误得到了合理的控制，不会随意的 throw 出来一个 Error 对象了。</p>
<blockquote>
<p>此处建议打开网易云音乐听一首<a href="https://music.163.com/#/song?id=1365888841">《向左向右》</a>！放松一下，顺带回味一下我们的 Right 与 Left。</p>
</blockquote>
<h3 id="什么是-functor-怎么使用-functor-为什么使用-functor"><a href="#%E4%BB%80%E4%B9%88%E6%98%AF-functor-%E6%80%8E%E4%B9%88%E4%BD%BF%E7%94%A8-functor-%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BD%BF%E7%94%A8-functor" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>什么是 Functor? 怎么使用 Functor? 为什么使用 Functor?</h3>
<h4 id="什么是-functor"><a href="#%E4%BB%80%E4%B9%88%E6%98%AF-functor" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>什么是 Functor?</h4>
<p>上面我们定义了一个简单的 Box，其实也就是拥有 <code class="gatsby-code-text">map</code> 和 <code class="gatsby-code-text">fold</code> 方法的类型。让我们把脚步放慢一点，再仔细观察和思考一下我们的 <code class="gatsby-code-text">map</code>：<code class="gatsby-code-text">Box(a) -&gt; Box(b)</code> ，本质上就是通过一个函数 <code class="gatsby-code-text">a -&gt; b</code> 把一个 <code class="gatsby-code-text">Box(a)</code> 映射为 <code class="gatsby-code-text">Box(b)</code>。这和中学代数中的函数知识何其类似，不妨再回顾一下代数课本中函数的定义：</p>
<p><strong>假设 A 和 B 是两个集合，若按照某种对应法则，使得 A 的任一元素在 B 中都有唯一的元素和它对应，则称这种对应为从集合 A 到集合 B 的函数。</strong></p>
<p>上面的集合 A 和集合 B，拿到我们的程序世界，完全可以类比与 String 、Boolean、Number 和更抽象的 Object，通常我们可以把数据类型视作所有可能值的一个集合（ Set ）。像 Boolean 就可以看作是 <code class="gatsby-code-text">[true,false]</code> 的集合，Number 是所有实数的集合，所有的集合，以集合为对象，集合之间的映射作为箭头，则构成了一个范畴：</p>
<p><img src="https://p1.music.126.net/IQIDMxhCvN2lKYDPfBE6rQ==/109951164499395888.png" alt="范畴"></p>
<p>看图：a，b，c 分别表示三个范畴，现在我们做个类比：a 为字符串的集合(String)，b 为实数的集合(Number)，c 为 Boolean 的集合；那么我们完全可以实现映射函数 <code class="gatsby-code-text">g</code> 为 <code class="gatsby-code-text">str =&gt; str.length</code>，而函数 <code class="gatsby-code-text">f</code> 为 <code class="gatsby-code-text">number =&gt; number &gt;=0 ? true : false</code>，那么我们就可以通过函数 <code class="gatsby-code-text">g</code> 完成从字符串范畴到实数范畴的映射，然后通过函数 <code class="gatsby-code-text">f</code> 从实数范畴映射到 Boolean 范畴。</p>
<p>现在重新回顾一下之前跳过的那个晦涩的名字： Functor （函子）就是范畴到范畴之间映射的那个箭头！而这个箭头一般通过 map 方法配合一个变换函数（i.e. <code class="gatsby-code-text">str =&gt; str.length</code> ）来实现,这样理解起来就很容易了，对吧（<del>才怪</del>）</p>
<p>如果我们有了函数 g 和函数 f，那么我们一定可以推导出函数 <code class="gatsby-code-text">h = f·g</code> ，也就是 <code class="gatsby-code-text">const h = compose(f,g)</code>，而这就是上图下半部分 <code class="gatsby-code-text">a -&gt; c</code>的变换过程，这不就是中学的数学<code class="gatsby-code-text">结合律</code>吗? <del>我们可都是学过高数的，谁不会啊</del></p>
<p>等等，a，b，c 上面的那个 id 箭头又是什么鬼？自己映射到自己？不错！
对于任何 <code class="gatsby-code-text">Functor</code>，通过函数 <code class="gatsby-code-text">const id = x =&gt; x</code> 可以实现 <code class="gatsby-code-text">fx.map(id) == id(fx)</code>，而这被称为 <code class="gatsby-code-text">Identity</code>，也就是数学中的<code class="gatsby-code-text">同一律</code>。</p>
<p>这也是为什么我们一定要引入范畴论，引入 <code class="gatsby-code-text">Functor</code> 的概念，而不只是简单的把他们称为 <code class="gatsby-code-text">mappale</code> 或者其他什么东西，因为这样我们就可以在保持名称不变的基础上更加理解伴随着数学原理而来的 Functor 的其他的定理(<code class="gatsby-code-text">Composition</code> 和 <code class="gatsby-code-text">Identity</code>)，不要因为这个晦涩的名称而让我们驻步不前。</p>
<blockquote>
<p>上面的介绍仅仅是方便前端渣渣们(<del>和Haskell大神相比</del>)，在一定程度上理解范畴。并不是十分的严谨(<del>非常不严谨好不</del>)，范畴中的对象可以不是集合，箭头也可以不是映射…停停！！打住！再说下去我就可以转行做代数老师了(ahhhh.jpg)。</p>
</blockquote>
<h4 id="怎么使用-functor"><a href="#%E6%80%8E%E4%B9%88%E4%BD%BF%E7%94%A8-functor" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>怎么使用 Functor?</h4>
<p>现在再次让我们回到代码的世界，毫无疑问 <code class="gatsby-code-text">Functor</code> 这个概念太常见了。其实绝大多数的开发人员一直在使用 <code class="gatsby-code-text">Functor</code> 却没有意识到而已。比如：</p>
<ul>
<li>Array 的 <code class="gatsby-code-text">map</code> 和 <code class="gatsby-code-text">filter</code>。</li>
<li>jQuery 的 <code class="gatsby-code-text">css</code> 和 <code class="gatsby-code-text">style</code>。</li>
<li>Promise 的 <code class="gatsby-code-text">then</code> 和 <code class="gatsby-code-text">catch</code> 方法(Promise 也是一种 Functor? Yes！)。</li>
<li>Rxjs Observable 的 <code class="gatsby-code-text">map</code> 和 <code class="gatsby-code-text">filter</code> (异步函数的组合？Relax！)。</li>
</ul>
<p>都是返回同样类型的 <code class="gatsby-code-text">Functor</code>，因此可以不断的链式调用，其实这些都是 Box 理念的延伸：</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x <span class="token operator">></span> <span class="token number">2</span><span class="token punctuation">)</span>

<span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"#mybtn"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token string">"width"</span><span class="token punctuation">,</span><span class="token string">"100px"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token string">"height"</span><span class="token punctuation">,</span><span class="token string">"100px"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token string">"background"</span><span class="token punctuation">,</span><span class="token string">"red"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

Rx<span class="token punctuation">.</span>Observable<span class="token punctuation">.</span><span class="token function">fromEvent</span><span class="token punctuation">(</span>$input<span class="token punctuation">,</span> <span class="token string">'keyup'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>e <span class="token operator">=></span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>text <span class="token operator">=></span> text<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">debounceTime</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>    </code></pre>
      </div>
<h4 id="为什么使用-functor"><a href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BD%BF%E7%94%A8-functor" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>为什么使用 Functor?</h4>
<p>把值装进一个容器（比如 Box，Right，Left 等），然后只能用 <code class="gatsby-code-text">map</code> 来操作它，这么做的理有到底是什么呢？如果我们换种方式来思考，答案就很明显了：让容器自己去运用函数能给我们带来什么好处呢？答案是：
<strong>抽象，对于函数运用的抽象。</strong></p>
<p>纵观整个函数式编程的核心就在于把一个个的小函数组合成更高级的函数。
举个函数组合的例子：如果想给任何 <code class="gatsby-code-text">Functor</code> 应用一个统一的 map ，该如何处理？答案是 <a href="https://juejin.im/post/5d70e25de51d453c11684cc4#heading-15"><code class="gatsby-code-text">Partial Application</code></a>：</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">const</span> <span class="token function-variable function">partial</span> <span class="token operator">=</span>
    <span class="token punctuation">(</span>fn<span class="token punctuation">,</span> <span class="token operator">...</span>presetArgs<span class="token punctuation">)</span> <span class="token operator">=></span>
        <span class="token punctuation">(</span><span class="token operator">...</span>laterArgs<span class="token punctuation">)</span> <span class="token operator">=></span>
            <span class="token function">fn</span><span class="token punctuation">(</span><span class="token operator">...</span>presetArgs<span class="token punctuation">,</span> <span class="token operator">...</span>laterArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">double</span> <span class="token operator">=</span> n <span class="token operator">=></span> n <span class="token operator">*</span> <span class="token number">2</span>
<span class="token keyword">const</span> <span class="token function-variable function">map</span> <span class="token operator">=</span> <span class="token punctuation">(</span>fn<span class="token punctuation">,</span> <span class="token constant">F</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token constant">F</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>
<span class="token keyword">const</span> mapDouble <span class="token operator">=</span> <span class="token function">partial</span><span class="token punctuation">(</span>map<span class="token punctuation">,</span> double<span class="token punctuation">)</span>

<span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token function">mapDouble</span><span class="token punctuation">(</span><span class="token function">Box</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fold</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>  <span class="token comment">// => 2</span></code></pre>
      </div>
<p>关键在于 <code class="gatsby-code-text">mapDouble</code> 函数返回的结果是一个等待接收第二个参数 F (Box(1)) 的函数; 一旦收到第二个参数，则会直接执行 <code class="gatsby-code-text">F.map(fn)</code> ，相当于 <code class="gatsby-code-text">Box(1).map(double)</code> ,该表达式返回的结果为 <code class="gatsby-code-text">Box(2)</code> ,所以后面可以继续 <code class="gatsby-code-text">.fold</code>等等链式操作。</p>
<h3 id="总结与计划"><a href="#%E6%80%BB%E7%BB%93%E4%B8%8E%E8%AE%A1%E5%88%92" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结与计划</h3>
<h4 id="总结"><a href="#%E6%80%BB%E7%BB%93" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h4>
<p>上面通过双十一购物狂欢节的例子，介绍了函数式编程的几个基本概念（pure function，compose）等，并逐渐引入了功能强大的 <code class="gatsby-code-text">Box</code> 理念，也就是最基本的 <code class="gatsby-code-text">Functor</code>。后面通过无时不刻可能出现的 null ，介绍了 <code class="gatsby-code-text">Either</code> 可以用来做 null 的包容器。再通过 <code class="gatsby-code-text">try-catch</code> 的例子，了解了比较 pure 的处理错误的方式， Either 当然不仅仅是这两种用法，后面会继续介绍其他高级的用法。最后总结了什么是 <code class="gatsby-code-text">Functor</code>，怎么使用 <code class="gatsby-code-text">Functor</code>，以及使用 <code class="gatsby-code-text">Functor</code> 的优势何在。</p>
<h4 id="计划"><a href="#%E8%AE%A1%E5%88%92" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>计划</h4>
<p><code class="gatsby-code-text">Functor</code> 是我们介绍的范畴论中的最最最基本的一个概念，不过我们目前解决的都是最简单的问题（更优秀的组合（map），更健壮的代码（fromNullAble），更纯的错误处理（TryCatch）），但是嵌套的 try-catch 呢？异步函数怎么组合呢？后面会继续通过 <code class="gatsby-code-text">双11购物狂欢节的案例</code> 来介绍范畴论中的其他概念和实际用法示例（实际目的：继续揭露奸商的套路，<del>顺便转行做代数老师，摆脱 34岁 淘汰的潜规则; 狗头.jpg</del>）。</p>
<p>参考资料与引用文章：   </p>
<ul>
<li><a href="https://medium.com/@dtinth/what-is-a-functor-dcf510b098b6">What is a functor?</a>   </li>
<li><a href="https://medium.com/@cscalfani/so-you-want-to-be-a-functional-programmer-part-1-1f15e387e536">So You Want to be a Functional Programmer</a>   </li>
<li><a href="https://hackernoon.com/two-years-of-functional-programming-in-javascript-lessons-learned-1851667c726">Two Years of Functional Programming in JavaScript: Lessons Learned</a>   </li>
<li><a href="https://medium.com/javascript-scene/master-the-javascript-interview-what-is-functional-programming-7f218c68b3a0">Master the JavaScript Interview: What is Functional Programming?</a>    </li>
<li><a href="https://github.com/MostlyAdequate/mostly-adequate-guide">《JavaScript函数式编程指南》</a>      </li>
<li><a href="https://book.douban.com/subject/25883834/">《You Don’t Know JS》</a>   </li>
<li><a href="https://bartoszmilewski.com/2014/10/28/category-theory-for-programmers-the-preface/">写给程序员的范畴论</a></li>
</ul>]]></description><link>https://reactjs.org/blog/2019/09/10/黑珍珠号的诅咒.html</link><guid isPermaLink="false">https://reactjs.org/blog/2019/09/10/黑珍珠号的诅咒.html</guid><pubDate>Mon, 09 Sep 2019 16:00:00 GMT</pubDate></item><item><title><![CDATA[移动端适配方案rem & vh、vw]]></title><description><![CDATA[<h3 id="rem布局"><a href="#rem%E5%B8%83%E5%B1%80" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>rem布局</h3>
<h4 id="lib-flexible"><a href="#lib-flexible" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>lib-flexible</h4>
<p>假设设计MM给我们的设计稿尺寸为<code class="gatsby-code-text">750 x 1340</code>，那么我们前端拿到设计稿之后要如何动手开始开发呢？经过上面的介绍了移动端开发的基本概念之后，应该有了一些基本的思路，我们可以使用js动态计算rem的方案来实现。</p>
<p>rem是根据html节点的font-size来做计算的</p>
<p>举个例子：假如html元素的font-size为 <code class="gatsby-code-text">Npx</code>,一个元素的宽度设定为<code class="gatsby-code-text">2rem</code>;则该元素的实际宽度为：<code class="gatsby-code-text">2 * N px</code>；</p>
<p>换句话说px与rem的一定是成正比关系的。</p>
<p>那么既然设计MM给我们的设计稿尺寸为<code class="gatsby-code-text">750 x 1340</code>，那么我们完全可以把屏幕的布局视口平均分为750份；设计稿中的某个元的宽度直接按照，占了750份中的多少份来计算就可以了。</p>
<p>举例：
iPhone6的布局视口宽度为<code class="gatsby-code-text">document.documentElement.clientWidth = 375px</code>分为750份，则每份的宽度为<code class="gatsby-code-text">375px/750 = 0.5px</code>;并把<code class="gatsby-code-text">0.5px</code>设置为html元素的<code class="gatsby-code-text">font-size</code>;</p>
<p>现在有一个元素的宽度为<code class="gatsby-code-text">20px</code>,则只需要把元素的宽度用CSS编写为<code class="gatsby-code-text">20rem</code>即可！</p>
<p>因为<code class="gatsby-code-text">20px</code>，相对于平均分成<code class="gatsby-code-text">750</code>份之后,确实是只占了<code class="gatsby-code-text">20</code>份，每份是<code class="gatsby-code-text">0.5rem</code>。</p>
<p><strong>但是我们这样做了之后就会发现有问题啊，为何结果没有达到我们的预期呢？至少从数学计算的角度来说，我们的逻辑没问题！</strong></p>
<p>那么问题出在哪里呢？</p>
<p><strong>是浏览器在作妖！chrome的浏览器所允许的最小<code class="gatsby-code-text">font-size</code>为<code class="gatsby-code-text">12px</code>,所以我们设置了html元素的<code class="gatsby-code-text">font-size=.5px</code>是被忽略的，并且被重置为了<code class="gatsby-code-text">12px</code></strong></p>
<p>那么我们再次运用小学数学知识，只要把html元素的<code class="gatsby-code-text">font-size</code>等比例扩大100倍，然后元素的大小在缩小100倍不就可以解决这个问题啦！</p>
<p>所以我们把html元素的<code class="gatsby-code-text">font-size = 50px</code>,然后元素的宽度设定为<code class="gatsby-code-text">.2rem</code>，这样在计算之后不就没问题啦！</p>
<p>现在总结一下计算公式：</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token comment">// html元素的font-size大小，单位：px</span>
<span class="token keyword">const</span> htmlFontSize <span class="token operator">=</span> <span class="token punctuation">(</span>document<span class="token punctuation">.</span>documentElement<span class="token punctuation">.</span>clientWidth <span class="token operator">/</span> <span class="token number">750</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">;</span>

<span class="token comment">// 普通元素宽度，单位：rem</span>
<span class="token keyword">const</span> eleWidth <span class="token operator">=</span> <span class="token punctuation">(</span>设计稿宽度<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">100</span><span class="token punctuation">;</span></code></pre>
      </div>
<p>如果上面的换算觉得还是麻烦，可以借助<code class="gatsby-code-text">postCss</code>的插件<code class="gatsby-code-text">px2rem</code>来帮助我们完成换算，我们在代码中直接写px就可以了！</p>
<p>其实这也是阿里巴巴<code class="gatsby-code-text">lib-flexible</code>的大概实现原理！</p>
<h4 id="rem的缺陷"><a href="#rem%E7%9A%84%E7%BC%BA%E9%99%B7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>rem的缺陷</h4>
<p>rem是弹性布局的一种实现方式，弹性布局可以算作响应式布局的一种，但响应式布局不是弹性布局，弹性布局强调等比缩放，100%还原；响应式布局强调不同屏幕要有不同的显示，比图媒体查询。</p>
<p>一般内容型的网站，都不太使用使用rem,因为大屏用户可以自己选择要更大的字体，还是更多的内容，一旦使用了rem，就剥夺了用户的自由；一些偏向App类型的，图标类的，图片类的，比如：淘宝，活动页面，比较适合使用rem,因为调大字体时并不能调大图片的大小。同时rem存在一下问题：</p>
<ul>
<li><strong>字体问题</strong> - 字体大小并不能使用rem,字体的大小和字体宽度并不成正比关系，这个关系完全取决于字体的作者。所以字体大小不能使用rem。</li>
<li><strong>PC浏览</strong> - 如果用户在PC段浏览页面怎么办？一般我们都会设置一个最大宽度，大于这个宽度的话，页面居中，两边留白，或者直接跳PC页面</li>
</ul>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">var</span> clientWidth <span class="token operator">=</span> document<span class="token punctuation">.</span>documentElement<span class="token punctuation">.</span>clientWidth<span class="token punctuation">;</span>
clientWidth <span class="token operator">=</span> clientWidth <span class="token operator">&lt;</span> <span class="token number">780</span> <span class="token operator">?</span> clientWidth <span class="token punctuation">:</span> <span class="token number">780</span><span class="token punctuation">;</span>
document<span class="token punctuation">.</span>documentElement<span class="token punctuation">.</span>style<span class="token punctuation">.</span>fontSize <span class="token operator">=</span> clientWidth <span class="token operator">/</span> <span class="token number">100</span> <span class="token operator">+</span> <span class="token string">'px'</span><span class="token punctuation">;</span></code></pre>
      </div>
<p>设置body的宽度为100rem，并水平居中:</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-css"><code class="gatsby-code-css"><span class="token selector">body</span> <span class="token punctuation">{</span>
    <span class="token property">margin</span><span class="token punctuation">:</span> auto<span class="token punctuation">;</span>
    <span class="token property">width</span><span class="token punctuation">:</span> 100rem
<span class="token punctuation">}</span></code></pre>
      </div>
<h3 id="vh、vw方案"><a href="#vh%E3%80%81vw%E6%96%B9%E6%A1%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>vh、vw方案</h3>
<p>vh、vw方案即将视觉视口宽度<code class="gatsby-code-text">window.innerWidth</code>和视觉视口宽度<code class="gatsby-code-text">window.innerHeight</code>等分为100份。</p>
<p>本质上来说，<code class="gatsby-code-text">flexible</code>方案就是模仿这种方案，随着浏览器兼容性的进步，<code class="gatsby-code-text">vh、vw</code>方案已经可以直接用了。</p>
<p>
  <a
    class="gatsby-resp-image-link"
    href="/static/vw-vh-5379a182408150a2dce7cf759fa14c00-1d83a.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block; ; max-width: 840px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 48.36309523809524%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAABcklEQVQoz31Sf2uCUBT1+3+GbcQgIvqr0SA3ptCvRRCUTslW1mowjcraKrXUs/feTH0Fe3C5713PPffcexXCMITruszonZ4oijhP45cWBAHzFJMaIHQ6HeTzeRQKBTQaDQ6QJf3vZPECJdF1HaZpQpIk2ItFAjwrVtU31OsN5nu9Pvp9BbVaHYYxxOkUcMQCJTsfVVVhWRY8z8PxeEyq5nL3aDZbrM3NZoP9fo9K5RHSiwzHoe8Dy2EKNU1LEimhbdtYLlfY7fZJodubO2iazrVZrYrEnuAeXKxWa2y333+E3W6XBFZsKe12mym8bLlcfoAoPmM6/cBgYGBovDOFrdYrUbzlW5ZlGcViEaVSiSSJ2P3srgbt+z4mkynGI5ORjkZjzOefRIR3vZTZbAZFUVi7pjnhql1umc7K+rLJfE8pDjEufgvnQa9J277nZyrGZFGqICRG8dyvlflO7wIlOJDKztpBFMYA5lNwGkNiCTbi47+f4vfotZzyxAAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
        alt="vw-vh"
        title=""
        src="/static/vw-vh-5379a182408150a2dce7cf759fa14c00-acf85.png"
        srcset="/static/vw-vh-5379a182408150a2dce7cf759fa14c00-c1418.png 210w,
/static/vw-vh-5379a182408150a2dce7cf759fa14c00-5d5d8.png 420w,
/static/vw-vh-5379a182408150a2dce7cf759fa14c00-acf85.png 840w,
/static/vw-vh-5379a182408150a2dce7cf759fa14c00-de0cd.png 1260w,
/static/vw-vh-5379a182408150a2dce7cf759fa14c00-1d83a.png 1344w"
        sizes="(max-width: 840px) 100vw, 840px"
      />
    </span>
  </span>
  
  </a>
    </p>
<p>举例来说：视觉视口为375px,那么<code class="gatsby-code-text">1vw = 3.75px</code>,这时UI给定一个元素的宽为<code class="gatsby-code-text">20px</code>(设备独立像素)，那么我们只要只需要把它设置为<code class="gatsby-code-text">20 / 3.75 = 5.3333vw</code>。</p>
<p>这里的比例关系我们也不用自己换算，我们可以使用<code class="gatsby-code-text">PostCSS</code>的<code class="gatsby-code-text">postcss-px-viewport</code>插件帮助我们完成这个过程。写代码时，我们只需要根据UI给的设计图写px单位即可.</p>
<p>没有任何一种方案是完美的，vw,vh也存在一下缺陷：</p>
<ul>
<li><code class="gatsby-code-text">px</code>转换成vw不一定能完全整除，因此有一定的像素差。</li>
<li>当容器使用vw,margin使用px时，很容易造成整体宽度超过100vw,从而影响布局效果。当然我们也是可以避免的，比如使用<code class="gatsby-code-text">padding</code>代替<code class="gatsby-code-text">margin</code>，结合<code class="gatsby-code-text">calc</code>函数使用</li>
<li>兼容性
部分机型不支持vw,vh，可以采用csspolyfill来进行降级处理，推荐<a href="https://github.com/rodneyrehm/viewport-units-buggyfill">viewport-units-buggyfill</a></li>
</ul>]]></description><link>https://reactjs.org/blog/2019/05/27/mobile-css.html</link><guid isPermaLink="false">https://reactjs.org/blog/2019/05/27/mobile-css.html</guid><pubDate>Sun, 26 May 2019 16:00:00 GMT</pubDate></item><item><title><![CDATA[移动端开发基础知识]]></title><description><![CDATA[<h3 id="单位"><a href="#%E5%8D%95%E4%BD%8D" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>单位</h3>
<h4 id="英寸"><a href="#%E8%8B%B1%E5%AF%B8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>英寸</h4>
<p>一般用英寸描述屏幕的物理大小，如电脑显示器的<code class="gatsby-code-text">13</code>、<code class="gatsby-code-text">15</code>,手机显示器的<code class="gatsby-code-text">4.8</code>,<code class="gatsby-code-text">5.7</code>等使用的单位都是英寸。</p>
<p>需要注意的是英寸都是指屏幕对角线的长度</p>
<blockquote>
<p>英寸(inch,缩写为in)在荷兰语中本意是指大拇指，一英寸就是普通人拇指指甲底部的宽度。</p>
</blockquote>
<p>英寸和厘米的换算规则为：<code class="gatsby-code-text">1英寸 = 2.54厘米</code></p>
<h4 id="屏幕比例"><a href="#%E5%B1%8F%E5%B9%95%E6%AF%94%E4%BE%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>屏幕比例</h4>
<p>只确定了对角线的长度(屏幕英寸)，2个边的长度还是无法确定，所以有了<code class="gatsby-code-text">4:3</code>，<code class="gatsby-code-text">16:9</code>这种屏幕宽高比，这样就可以计算出屏幕的两个边长了</p>
<h4 id="分辨率"><a href="#%E5%88%86%E8%BE%A8%E7%8E%87" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>分辨率</h4>
<h5 id="像素"><a href="#%E5%83%8F%E7%B4%A0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>像素</h5>
<p>像素即一个小方块，具有特定的位置和颜色。</p>
<p>图片、电子屏幕(手机、电脑)就是由无数个具有特定颜色和特定位置的小方块拼接而成。
像素可以作为图片或者电子屏幕的最小组成单位。
下面我们使用<code class="gatsby-code-text">sketch</code>打开一张图片：</p>
<p>
  <a
    class="gatsby-resp-image-link"
    href="/static/pixel-ec09ddc015613e5fde67e410ac04ea5f-50506.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block; ; max-width: 840px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 78.01778907242695%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAABYlAAAWJQFJUiTwAAADjklEQVQ4y22UbWyTVRTH6we/mGjEhMSQLC77oBPdQBQlilMHDIH5hrIZWBE3zBBjdEy3+S6TDyYwYEC2GQfBVyqkjLE3cVniPoDIGhyLItWt3Vjf+7R92udp61rKz3sf6MIyzpOTe899zvnf/7nnnmuKRCKosRjhmI4ejxPX4+hCw+EwISWEqgbx+p0EFBdK2IeihlGiYl0LENY1YrpOXMRpcZ2IsE2KEiQmAGOaTlSMWkwjmUySAa4IvWqMaaHyyxjrWlL4amFBQhCJRomoUcJCFVXFZHde5t9RB2OjozidTlKpFJmrGXqOWtjXUMeBuvfYX7uN/e/X0izsH79qRRdAUsbHx/F6fSJDjXBEFcAxTIGggtfnw+PxGCrFevggVSWFbFiSx6MmE4/fegsPi3HT8vupfmERh/Y1GX4OhwNFUYgKZvLoolH1WsohsRgKhVCCQVLpDAf3fMSObUW8Vb6AhbffyYLb7uChOXOoLiukseZJWptqRRYYGU26XARFnFSXmJuyhtRQSOwm6DfWm6lYOY+Nq3IoWXg3z+TPpXTxPMzCfqVoLjWbV+Jxu5mcnJzOLBAI4PN6JUPFoC0XZHEujoywfvUjvF6aw9Z1eVS/nMvWsjw+fOMB6ivnY342h7VP3UvfcSseATAxMWFkJ+MlqWlAv99PPJlgoKubdcWFNNUvoe2LZRz4bBm765/A2l7JwIkG9n5cRPmKfFoat+MURRkeHjYYZknNAEz8l6T/eAfm1Ys51dHM+dPf0PldDUdaKzjd34zTPsgvJ9upeukxDn3SYMTY7XbcIn3JbgagNFRxp8bFFdq8dimW9s8Zs//Ob78epvunBkb/6sXtPE/fsZ28WbaIU9ZjRiNIUBmfrcM0YJallCPffk3Tp6W4x/q4cO4Heo/WEfQOkYpfovP7t2lp+sDwCwavnduNGDcF/Nv2BxVPz+efEQu2wRYsrWYCrrNMJS7SuGEp1j17DT+fzzuD3SyGMu0rokt0MX8xN4e2XVsYGviSth2r8Dn6uWCz8No9d3Gp52cD0C8a4sb4WQzlDrKPpdS8Ws7GNQX0du+keVcV52xWWndvYU1BLv7LLsMncP38ZgBm70+2SolEwnDu7+niueJ83n2+hE0F97F9RTHrlz/IO5Vlxv90Oj3r/AxA+fSoohc1TTOeoampKbJiO3uGMx2dDJ3o5M+TXQx2d+G/3u/yEbkZ4P+k1ho6lRRm3gAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
        alt="像素"
        title=""
        src="/static/pixel-ec09ddc015613e5fde67e410ac04ea5f-acf85.png"
        srcset="/static/pixel-ec09ddc015613e5fde67e410ac04ea5f-c1418.png 210w,
/static/pixel-ec09ddc015613e5fde67e410ac04ea5f-5d5d8.png 420w,
/static/pixel-ec09ddc015613e5fde67e410ac04ea5f-acf85.png 840w,
/static/pixel-ec09ddc015613e5fde67e410ac04ea5f-de0cd.png 1260w,
/static/pixel-ec09ddc015613e5fde67e410ac04ea5f-50506.png 1574w"
        sizes="(max-width: 840px) 100vw, 840px"
      />
    </span>
  </span>
  
  </a>
    </p>
<p>我们通常所说的分辨率有两种，一种屏幕分辨率一种是图像分辨率</p>
<h5 id="屏幕分辨率"><a href="#%E5%B1%8F%E5%B9%95%E5%88%86%E8%BE%A8%E7%8E%87" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>屏幕分辨率</h5>
<p>屏幕分辨率是指一个屏幕具体有多少个像素点组成。</p>
<p>下面是<code class="gatsby-code-text">apple</code>的官网对手机分辨率的描述：</p>
<p>
  <a
    class="gatsby-resp-image-link"
    href="/static/pixel-big-7e1c3e7fc16bb776b25bd1889425e08f-0df46.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block; ; max-width: 840px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 77.96178343949045%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAABYlAAAWJQFJUiTwAAADuElEQVQ4y2WU+09bdRjG+x9pjDdgcXNsy2hpax2CYYOKsMoKLaUDeqOsXFyUxVtmYmKyLCH+YnQx0xiXLTLRIQQGdFwGNINybaH3KwJmfnxPJzrmD296zsl5P33e93m+R5VMJomn0oQTGTK5HPt7f/L48V/s7e+z88cuu3s7pLNx0rk4mZ0U+d090jsZUvltUrk82VyWfD5PLp+T+yyqREJezmRIpjOF36nxcYYGf+a3obuMDg8x/WCYyYm7jI/f5v7YbQILYwQWR1gM3COeTJCUnpT0JkVUPJVCNfFglolJP/6pKfx+P25bE9rXi9CcOIrNXMUlRxVOiw63VYu3Rc3A1fe49a2bX37s51FgnnB4m1hcppSKxRKo1jc2WVlZIRhUKoinzcbb6uOUHSuho80owAqcNh0eq46eNj1f9L/DN9dbGPzhQ1E6x9b2NltbYbbCYYGHUcXjcZSxlV3GolG8HXYqTx9Df7QYr7Mer/0NXALzWDT02HX0e9/ks94zXL9q4uGcn42NEKFQiGgsJtcbqKICUSomD7bl3zzOVgylJVSfOk7vJRMeRZ1FS1eLBq/tLfp7LtDnqeGKz8jC/AzBlVUCgQDLy0GpZVQK6GlgZ4cNfclL1J/R0Ndtwt2ilb3q6LTr+fLTK8zcn2X03hTDv47IqFuFnrSYkReXFbf/B/S2tVD+ygtY6yp4v+tdHIrCVi3OCwbufD/Io4frzEwuiSERNjfDhVEjiby4LfFKp54BRiJ4LlpQv/wc7ZZaejuNOGTcy54KuuxGvhr4iTl/EP/4PHOza8xMzxYMVcCxeEK8SBwGRiJRXM2NaF59Hq/DRLfrLK4mDV22ctobTtPeZObG13cYG5nFPznHwsIiq6urREXIgRfPACM4TQ3oil/E5zbhkwy6mzU4zWXy/ATWc0fEGDM3vxtk9PdpNiVySt8B4zBQ4qPs0FZTg0Ei43Of/yfU5TiaygSsxtN8ijZjMe7GGm7euPUk1E8JUurf2Ch5DEtAzbVGDK8Vidt1orAaZ7NOSoGV0WlRc7lDR7ellM7mKoISE2VvB4xDChVgKBTGarZgOHkEa32VAM/htD4JtkugCtB3Uc/H3RVc+6iW4NIC8URS+iP/KVT2ppRyE5KdmBtMVOvV1GpP4nHUSgYNhbPsFHPcMrqvtZwPXDoGPm9kc3258FE4tMNsNls4dtlsjozkqK6yEsNpNVWlRXRYzuKxV+CS6Dib1AJUy4kpp69Dy7VPzjMvR29paZm1tTXJYLrA+RuJBdFXssIDWAAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
        alt="像素-图片放大"
        title=""
        src="/static/pixel-big-7e1c3e7fc16bb776b25bd1889425e08f-acf85.png"
        srcset="/static/pixel-big-7e1c3e7fc16bb776b25bd1889425e08f-c1418.png 210w,
/static/pixel-big-7e1c3e7fc16bb776b25bd1889425e08f-5d5d8.png 420w,
/static/pixel-big-7e1c3e7fc16bb776b25bd1889425e08f-acf85.png 840w,
/static/pixel-big-7e1c3e7fc16bb776b25bd1889425e08f-de0cd.png 1260w,
/static/pixel-big-7e1c3e7fc16bb776b25bd1889425e08f-0df46.png 1570w"
        sizes="(max-width: 840px) 100vw, 840px"
      />
    </span>
  </span>
  
  </a>
    </p>
<p><code class="gatsby-code-text">iphone xs max</code>和<code class="gatsby-code-text">iphone SE</code>的分辨率分别为<code class="gatsby-code-text">2688 x 1242</code>和<code class="gatsby-code-text">1136 x 640</code>,这表示手机分别在垂直和水平方向上所具有的像素点数。</p>
<p>当然分辨率高不代表屏幕就清晰，屏幕的清晰程度还与尺寸有关。</p>
<blockquote>
<p>同尺寸下，自然分辨率越高屏幕越清晰</p>
</blockquote>
<h5 id="图像分辨率"><a href="#%E5%9B%BE%E5%83%8F%E5%88%86%E8%BE%A8%E7%8E%87" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>图像分辨率</h5>
<p>我们通常所说的<code class="gatsby-code-text">图片分辨率</code>实际上是指图片所含有的<code class="gatsby-code-text">像素数</code>,比如一张图片的分辨率为<code class="gatsby-code-text">800 x 400</code>。这表示图片分别在垂直和水平上所具有的像素点数为<code class="gatsby-code-text">800</code>和<code class="gatsby-code-text">400</code>。</p>
<p>统一尺寸的图片，分辨率越高，图片越清晰。</p>
<p>
  <a
    class="gatsby-resp-image-link"
    href="/static/pixel-img-3da3d8f9cd1802210d6ba267df228b40-033cb.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block; ; max-width: 840px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 19.27710843373494%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAABYlAAAWJQFJUiTwAAABMklEQVQY0x2Qu0pCAQBA/Q+n9mho9AeioQa3NpFaBYfIQZDC7CXmC9R7MS1T8YEPNDHDyBzUEGsSLQ0NUbsqLQ01ncztDIczHNn7cMxAmtIfjfn4nDCczGj2B7yNJHrSjHqrQ3so0RlPaLx2aY+ntAYjnjs9upOvhVtvd2jN/e+fX2TrRhdq+yWGaB6VO4xGCLElxLDF0iitfjbs1zjCcRQmkR1/imNvgBWjgD6Ww3gRZNkochBOo3EFSDaayFb3zGyaXGjnoTWDBeWhg20hguDzodCdoPZE8AgCS1oT+miOI4sN+a4Ze+IGw7kTuc6KL5lFtX9GqPqCTLgtEy7VyNcaXBVKxB+rBIplnNEkYrGCmLnDHozgvq/gzRawBGO4H57wpnLY4hk8/5zIcBpJL3b8AdSB73u9VYZ3AAAAAElFTkSuQmCC'); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
        alt="图像分辨率"
        title=""
        src="/static/pixel-img-3da3d8f9cd1802210d6ba267df228b40-acf85.png"
        srcset="/static/pixel-img-3da3d8f9cd1802210d6ba267df228b40-c1418.png 210w,
/static/pixel-img-3da3d8f9cd1802210d6ba267df228b40-5d5d8.png 420w,
/static/pixel-img-3da3d8f9cd1802210d6ba267df228b40-acf85.png 840w,
/static/pixel-img-3da3d8f9cd1802210d6ba267df228b40-de0cd.png 1260w,
/static/pixel-img-3da3d8f9cd1802210d6ba267df228b40-033cb.png 1328w"
        sizes="(max-width: 840px) 100vw, 840px"
      />
    </span>
  </span>
  
  </a>
    </p>
<h5 id="ppi"><a href="#ppi" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>PPI</h5>
<p><code class="gatsby-code-text">PPI</code>(Pixel Per Inch):每英寸包括的像素数。</p>
<p><code class="gatsby-code-text">PPI</code>可以用于描述屏幕的清晰度以及一张图片的质量。</p>
<p>使用<code class="gatsby-code-text">PPI</code>描述图片时，<code class="gatsby-code-text">PPI</code>越高，图片质量越高，使用<code class="gatsby-code-text">PPI</code>描述屏时，<code class="gatsby-code-text">PPI</code>越高，屏幕越清晰。</p>
<p>在上面描述手机分辨率的图片中，我们可以看到：<code class="gatsby-code-text">iPhone XS Max</code> 和 <code class="gatsby-code-text">iPhone SE</code>的<code class="gatsby-code-text">PPI</code>的分辨率分别为458和326，这足以证明前者的屏幕更清晰。</p>
<p>由于手机尺寸为手机对角线的长度，我们通常使用如下的方法计算<code class="gatsby-code-text">PPI</code>：</p>
<p>
  <a
    class="gatsby-resp-image-link"
    href="/static/ppi-calc-836564e5f2d512435e3e3010b514155f-cfc05.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block; ; max-width: 764px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 27.486910994764397%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAwklEQVQY03VQSQqEQAz0/68RD+JBvQiiuDxAENqbeHA5aLvXUIF2GHACRUIlXUm1dd83GMzrugrO88RxHNi2Dfu+YxxHzPP88Nd1SWaPM1rrR8Mygn3foyxLpGkKx3Hg+z6yLIPruui6TsA6CALYto0wDKXveR6mafoKsuCGqqpQ1zWapkEcxyLMBQQHh2FAkiSCKIpEjL08z+XiH0Fja1kWsUYbtE6+bVsURSGLaNPw5nt4zKvlf8HLlFKSzaO3MPwHL9J4fgdjBOEAAAAASUVORK5CYII='); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
        alt="ppi计算方法"
        title=""
        src="/static/ppi-calc-836564e5f2d512435e3e3010b514155f-cfc05.png"
        srcset="/static/ppi-calc-836564e5f2d512435e3e3010b514155f-fb287.png 210w,
/static/ppi-calc-836564e5f2d512435e3e3010b514155f-e130e.png 420w,
/static/ppi-calc-836564e5f2d512435e3e3010b514155f-cfc05.png 764w"
        sizes="(max-width: 764px) 100vw, 764px"
      />
    </span>
  </span>
  
  </a>
    </p>
<p>iPhone6的<code class="gatsby-code-text">PPI</code>为</p>
<p>
  <a
    class="gatsby-resp-image-link"
    href="/static/iPhone6-ppi-a3d33327ca7eed848713665016aff809-a17e5.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block; ; max-width: 454px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 32.59911894273127%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAAA/ElEQVQoz5VRyWqEUBD0/7/Hg4cBQXFQx4OjiHpRUEFxGUHct0q6ISEThJCCounl1avXT8An9n3HNE1YlgXzPDPHccQwDMx1Xb97FM/zpGMcf1OgRhzHeD6fsCwLjuNA13UYhoE8z5EkCVRV5ZppmtA07U3sJ1gwCAKkaQrP8yBJEkRRxO124wGqk1Pf97kuyzKqqnoTOY4D27YxCYLruuyEXEZRxJHyvu85lmWJoii4Tm6pTk/Psgxd10FRFDZCr3s8HhBerxfqukbTNMy2bUGuaYBIOYl+zRFpp5TT3m3bZqEwDHldAi5wv995BXTBfyFc/RTtg26/6v3FD2KQEFiC2PtpAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
        alt="iphone6-ppi"
        title=""
        src="/static/iPhone6-ppi-a3d33327ca7eed848713665016aff809-a17e5.png"
        srcset="/static/iPhone6-ppi-a3d33327ca7eed848713665016aff809-1df6e.png 210w,
/static/iPhone6-ppi-a3d33327ca7eed848713665016aff809-800bf.png 420w,
/static/iPhone6-ppi-a3d33327ca7eed848713665016aff809-a17e5.png 454w"
        sizes="(max-width: 454px) 100vw, 454px"
      />
    </span>
  </span>
  
  </a>
    </p>
<p>那它每英寸包含约<code class="gatsby-code-text">326</code>个物理像素点。</p>
<h5 id="dpi"><a href="#dpi" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>DPI</h5>
<p><code class="gatsby-code-text">DPI</code>(Dot Per Inch):即每英寸包括的点数。</p>
<p>这里的点是一个抽象的单位，它可以是屏幕像素点，图片像素点也可以是打印机的墨点。</p>
<p>平时你可能会看到使用<code class="gatsby-code-text">DPI</code>来描述图片和屏幕，这时的<code class="gatsby-code-text">DPI</code>应该和PPI是等价的。</p>
<blockquote>
<p><code class="gatsby-code-text">DPI</code>更多的时候是用来描述打印机，表示打印机每英寸可以打印的点数。这个和开发无关，不继续深入研究</p>
</blockquote>
<h3 id="设备独立像素"><a href="#%E8%AE%BE%E5%A4%87%E7%8B%AC%E7%AB%8B%E5%83%8F%E7%B4%A0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>设备独立像素</h3>
<p>实际上，上面我们描述的像素像素都是物理像素，即设备上真实的物理单元。</p>
<p>下面我们来看看设备独立像素究竟是如何产生的：</p>
<p>智能手机发展的速度非常之快，在几年之前，我们还用着分辨率非常低的手机，比如下面白色的手机，它的分辨率是<code class="gatsby-code-text">320 x 480</code>，我们可以在上面浏览正常的蚊子、图片等等。</p>
<p>但是，随着科技的发展，低分辨率的手机已经不能满足我们的需求了。很快，更高分辨率的屏幕诞生了，比如下面的黑色手机，它的分辨率是640 x 960,正好是白色手机的两倍。</p>
<p>理论上来说，在白色手机上相同大小的图片和文字，在黑色手机上会被压缩一倍，因为它的分辨率提高了一倍。但是如果真的这样下去，岂不是后面出现更高分辨率的手机，页面元素会变得越来越小吗？</p>
<p>
  <a
    class="gatsby-resp-image-link"
    href="/static/iphone-retina-f55c8ec98ceafae3cdd029db0e98a823-4d295.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block; ; max-width: 840px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 83.73590982286635%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAABYlAAAWJQFJUiTwAAACt0lEQVQ4y3WUy07bQBSG8z6oqI8AafsOQDdUdE1X9AHoCoq6oohLUcVdKHuQ2KC2ggCCNoGQAK0gQBLfHTu2Qxwuf+ecYAcTONLJyM7M53/Of2ZiEFGv1+G6Lmq1Gnzf59GyyrBtG3d3d5wUnudhbW0NKysrWF1d5UwkEvyO1lHEbm9voeu6AFicJyd/IUkyKhUHqqrBESPNoRgaGkIsFnsyx8cnGsDr62vIsswwTdNwenqOYlGBbTnQVFMo90LgwMBHtLe/REdHHPH4G8Q7X6Oz8xXa2l5gePhzU6GiKAJS5FQUVShUUCiUcHlZQtW7QhBTU9NiB//EjkyeQ1ku29jd/Y2FhcUmkJQRLJ/PI5PJIps9Es8NoPcAOD39nf8LPkipqjqSyW3Mzy9EFa6vryOdTuPnj1/Y2/2D5OY2dnb2cHXlh6ZMTX5joKJo4mNFXFwUWO3W1k4USKYQlEZN03mSphkolWR4bjVUODs7h/39DA4Pc0inDpBK7ePo6ASbm1tRoGEYwtUKtw6Z4Dgeb1XXy/wcxNzcPHK5Y66baVhiHbWW06qQgOQyQWkCpeO4wmUjAiSFpMgVqisVl7Nard0DF6NAamLHaYBIIS3SNLMFmMsesxFkDJWEVEYUUsEJSDVUVZULTkmLSiWlpYYPXSZjaN6TwEKhcJ/FsCUet83MzCwODrKipSScn19yyrKKjY0k1/dJIPVfE1iMAElF8I7qbFkVce7r3LthY9/c3PBWG9ulukj8VdoKjZ5XDftwdPQrxsbGsbS0zCZQLi8nMDLyBRMTk82zLEnSvcM2Q6jQZAyZYgsVwVnu7//w7OUwOPipAaQfgtHxM02TbxhSp+sG3zq+Xw8VZjKH6O19h+7uHvT0vOWxq6sbfX3vcXaWbwKDoHuRtlw2y3gcATQIv+aLY1lrmfMfSkurdZQFH50AAAAASUVORK5CYII='); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
        alt="2x手机"
        title=""
        src="/static/iphone-retina-f55c8ec98ceafae3cdd029db0e98a823-acf85.png"
        srcset="/static/iphone-retina-f55c8ec98ceafae3cdd029db0e98a823-c1418.png 210w,
/static/iphone-retina-f55c8ec98ceafae3cdd029db0e98a823-5d5d8.png 420w,
/static/iphone-retina-f55c8ec98ceafae3cdd029db0e98a823-acf85.png 840w,
/static/iphone-retina-f55c8ec98ceafae3cdd029db0e98a823-4d295.png 1242w"
        sizes="(max-width: 840px) 100vw, 840px"
      />
    </span>
  </span>
  
  </a>
    </p>
<p>然而，事实并不是这样，我们现在使用的智能手机，不管分辨率多高，他们所展示的界面比例都是类似的。乔布斯在iPhone4的发布会上首次提出了Retina Display(视网膜屏幕)的概念，它正式解决了上面的问题，这也使它成为一款跨时代的手机。</p>
<p>
  <a
    class="gatsby-resp-image-link"
    href="/static/apple-retina-2ad95e749c50edd51012ee561609d470-f916c.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block; ; max-width: 840px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 75.55110220440882%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAABYlAAAWJQFJUiTwAAAD1ElEQVQ4y02Ta2xTdRjGT1e6XtauXe+39bat62BubusubU93YyvdwCxzgaG4BJQQI5tBgxqR+AFJwBgTGZCIUaKCGk1MNJr4SRKDLvhJxMQIZtCy4WQRlojxgx/8+fYsIX54857///+c53n+5z2PMjc3RzqdRs2r5HI5rdR8nrzU/7uqqvcrn81ppWayqH0Z+rMqXW0Psu+JvSiDg4MoioLZZKLaUI3BYEAn68re/a7TaVVV6bKukjIoOjZI12vPVRqur7sHpVAo4HI6CYdChIJB6kNhAn4/4WAYv9ePz+PDbrNjs9qwWqzYaqSba7AZa6g1rZfdYtOEhvJibnR0FHutHWuNHNpsOB1O6hwOHHY7RoNRCP0kYg1ar6zdTjdBbxBvnQdPnRuPwyV4l+ZwMDdQIRzBJQfhYFTcRYlF4njdXpJNzTQ1NLGppZU6u1MTMlWbNNdxwYT8cqOA3MYbwCWEPpeP8eI4ypbCFlHwyrUqL7mFzI9bBC5cvMgv5RJffn2BDz/7go1CrNfp8fsCROujBHxBTTgoxC2pVqZ2Ps6T+w+gjBW24XVGRCkmoIgAIvjdIb5ZuMTqX/e4unSL0t17dKYz8p30ggkRiybwiTOP08Pw6BjHTr3HoWNnhPAZlK3F7QQ8zQJopjHRwbffLbBw6Xt+/nWR68srXLm6yI+LN+no6hWHBhEOUV8fF+EwGXWIIyfe4dW3PuGl195edzixbQ/hQBq3I0m2d4w7d9f4+99/WFpd5Vp5iSuLN7hSWqa7R8WoNws2RiSaJNfdy+sH93Py/OccmX+fF4+fYfbp51C2T+4jHsvQ1Vlk8/AUi+UyK2t/cGPlN64tLXH5ujgU4r7MMFajUwbRQLpnkMJIkd0zM5z66CuOnjzHkVMf8OzzL6NM75gl1TJCZ1eR9vbN4myF1T/XKP0uhMvL/FCqEN4kmy/gqK0MIsLh4/NMPTpDbmOSN899ytHT59kz9wKzB8ThrscOoQ7tozszIxGboXz7Nrfu3qEk/drKbS6XyvwkgxnYPInb1SQDaePgK29w4uy77N25nfmzH5Pa1LH+Hw7Ij71792FisUGaU0N0pKfJ9oty/y4yAzvozhZkPUH/6CM0JlXi0T4SiR7aukYY2/ow01OTtHepGPQbNMJ8Lo8yvvUhFNkw15hJPlBgU+8eGtsnsDh86PRVWK0uEvEsqdQwjQ19EkGnJMZCUyJJczyKQSZfieQ6YT9KcWwcXZVsSvwikUbUkadobB2ixmLGYjJrufXZHaQSbdQ5A1Rv0GORxNRKVM0SRUu1YIwWjXBACP8DKqwYPcS64coAAAAASUVORK5CYII='); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
        alt="apple-retina"
        title=""
        src="/static/apple-retina-2ad95e749c50edd51012ee561609d470-acf85.png"
        srcset="/static/apple-retina-2ad95e749c50edd51012ee561609d470-c1418.png 210w,
/static/apple-retina-2ad95e749c50edd51012ee561609d470-5d5d8.png 420w,
/static/apple-retina-2ad95e749c50edd51012ee561609d470-acf85.png 840w,
/static/apple-retina-2ad95e749c50edd51012ee561609d470-f916c.png 998w"
        sizes="(max-width: 840px) 100vw, 840px"
      />
    </span>
  </span>
  
  </a>
    </p>
<p>在iPhone4使用的视网膜屏幕中，把两个像素当成1个像素使用，这样让屏幕看起来更精致，同时能保持元素的大小不变。</p>
<p>
  <a
    class="gatsby-resp-image-link"
    href="/static/retina-ex-c0e2a89637045cf5de0738b1fd5c9673-5176d.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block; ; max-width: 840px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 35.74660633484163%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAAB+0lEQVQozz2O20uTARiHP3XRVKRpgWw4ne1Q2xDLlTFaOkOdrUUyx0yiFqg334WUlIcwKkzDSNrWtm+HEknC0tQ2O2BYBCuFJMggvFpd9Ic8rY/o4uH3vLw/Xl4hl8sRlyQSiYRMMvmXJPF4XM5wOEw2m2Vra0v2VCr1r5eUU5Ji+a5EMBhke3sbYXllBUEQUCqLUSh2UVBQ9H8uLSmTXRRF7kxOyb67RIWydA+FCiXK4jIq9qmp1NTIu1AogvAynaHWoKfN7eaEs5VDNjtGo4FLgQBnO89TsbeC4eHrRGJJTnt76L7QR7vHh93ZgaPFxVR4hujsMr6LIvHkDEIm8wpVeTn7jSZ0hgOotVqqqquxWCwcNFspyn89OHiV6QcPqTFaabA3o9WbMdc3YrI20NTqwXXGj9ZYh5R4hLD2cRPtEQ86WwfV9a1U1TnRmI9TqT+KxnAYZbmG4ZExZhdWsZ7sosnXT4tfxOHtx9HZR6M7wDFPAFNTF8/S7/IHN75T6xpA3yaia+5Fa+9BY/OirjuF2uKkUKVj4PIQz9c2aRcn6B6NcG5Ewj8awzcUxXstJuPonWBp/QvCTu4347EFxqPz3Ao94eb0Y27cSzB2N8LYZIgrI7dZXErzbecXM8vrPH2TzfOZ+bcbzK5+Qlp8T/zFB+7Pvebrj5/8AeOMLv8ouoosAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
        alt="retina-ex"
        title=""
        src="/static/retina-ex-c0e2a89637045cf5de0738b1fd5c9673-acf85.png"
        srcset="/static/retina-ex-c0e2a89637045cf5de0738b1fd5c9673-c1418.png 210w,
/static/retina-ex-c0e2a89637045cf5de0738b1fd5c9673-5d5d8.png 420w,
/static/retina-ex-c0e2a89637045cf5de0738b1fd5c9673-acf85.png 840w,
/static/retina-ex-c0e2a89637045cf5de0738b1fd5c9673-de0cd.png 1260w,
/static/retina-ex-c0e2a89637045cf5de0738b1fd5c9673-5176d.png 1326w"
        sizes="(max-width: 840px) 100vw, 840px"
      />
    </span>
  </span>
  
  </a>
    </p>
<p>如果黑色的手机使用了视网膜屏幕的技术，那么显示结果应该是下面的情况，比如列表的宽度为300个像素，那么在一条水平线上，白色手机会用300个物理像素去渲染它，而黑色手机实际上会用600个像素去渲染它。</p>
<p>我们必须用一种单位来同时告诉不同分辨率的手机，它们在街面上显示的元素的大小是多少，这个单位就是设备独立像素(Device Independent Pixels)简称<code class="gatsby-code-text">DIP</code>或<code class="gatsby-code-text">DP</code>,上面我们说，列表的宽度为300个像素，实际上我们可以说：列表的宽度为300个设备独立像素。</p>
<p>
  <a
    class="gatsby-resp-image-link"
    href="/static/ipnone-retina2-0801eb35c1cccccf1f3be999403d38a1-4cd15.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block; ; max-width: 840px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 90.14084507042254%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAABYlAAAWJQFJUiTwAAADUUlEQVQ4y22Ua08TURCGN+BnjeESo8EfpaCSEL+Z+FH9DYhGRWJi1AAiECG0QqhRY+IFVIRCS1ugVCotvWzvpd3eb/TyemaWLqKcZHL27M4+Z+acd0aCGKVSCfl8HuVyGfV6ndeJRAKZTAbN0Wg0eHa5XDCbzbBarcIsWFtbxcLCAoLBIH+XisUiIpEIFEVhyM7ODmKxGJLJJKLRKFKpFG9CY2VlBS0tLZAkia219ZT23NV1EeFwGBKBmj/SC8v6BoKBiFhnkdhPIZlQUKvVGDgxMck/d3aeQ0dHJy6c70J7eyfa2jpw5vRZWCxWSJSW1+uFx+OB3+9HOBSF7A/Cs+eD1+NHOp3RIpyamoZeNwu3y4OtrW3YtxzY2tzm9dDQExVIZyfLMkfndrux+1u1UDCMgBwSkaY1oE6nx+dPX5FJ5xhCm+65vchlCxgZfimAFkiFQgEOhwOLi4uwWW2Ym5vHqtGEpaVlmE0WZDM5DajXv8H4+CTW161Y/mlkX7PZgtVVEx4+GITNtqECnU4njEYj36BpzcwRkuPmhl1Ek9WAs7NzmJ6ewS+HE86dXZhM6+y7uWnH0OMnAmhTgXQpNNN55nNFTqmQF9LZV8RtKxrQYHiL79+WhIaAlKL6Ksk0fxsbGxeRH6YcCoVYNmTJZIqd6IdoJC6ej2QzP2/Aly+LqJSrh5uleC6XDjA6OnZ0hnQhJBs2ASJLC9mcBPwqgAeVmpCT6kszrV+OvjoCUoQE4yhFdMciVE6IsFJlEPlRhBTx6MiYmjJVCulPNRl+X0A1vzr/LRsCfnj/kSE+r+pLWqX1i+fDaoRNIInb51XFfGSySD1zDGgwvBMajfDtunb38NvpQjgYxdOnz1QgNQKfz8eVQkYgEmzT/gUu/VhG9aCunTOlXas2MDnxWk2ZpEKVQt0iIAe4Aqj0qErI0iLlWr2m6fDGjZsYfDSE/v4BDNy9zzOJuq/vugpsdpVcLseXEo3EePdsJs+7x2P7WnOYmdFp3eUks9u3IZEzAallxeNxcdCirkMRBgfkoOiNZbCSxYjH93H71h309FzB1au96O7uwbVrvbh06TLu3bvPRyORIz00GnWWDl0ORVoXaVar1f8abHNQMyb9ViqVY+//AAXP1+vTiRV6AAAAAElFTkSuQmCC'); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
        alt="iphone retina 例子"
        title=""
        src="/static/ipnone-retina2-0801eb35c1cccccf1f3be999403d38a1-acf85.png"
        srcset="/static/ipnone-retina2-0801eb35c1cccccf1f3be999403d38a1-c1418.png 210w,
/static/ipnone-retina2-0801eb35c1cccccf1f3be999403d38a1-5d5d8.png 420w,
/static/ipnone-retina2-0801eb35c1cccccf1f3be999403d38a1-acf85.png 840w,
/static/ipnone-retina2-0801eb35c1cccccf1f3be999403d38a1-de0cd.png 1260w,
/static/ipnone-retina2-0801eb35c1cccccf1f3be999403d38a1-4cd15.png 1278w"
        sizes="(max-width: 840px) 100vw, 840px"
      />
    </span>
  </span>
  
  </a>
    </p>
<p>打开chrome的开发者工具，我们可以模拟各个手机型号的显示情况，每种型号上面会显示一个尺寸，比如iPhone X显示的尺寸就是375 x 812,实际上iPhone X的分辨率会比这高很多，这里显示的就是设备独立像素。</p>
<p>
  <a
    class="gatsby-resp-image-link"
    href="/static/chrome-mobile-5db0d932e1842531cf9cf7604e848547-9f2ec.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block; ; max-width: 840px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 56.30769230769231%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAABUUlEQVQoz52SzW7DIBCE/f7v12sPkXpoYwcbg83PwnQWx46jRq1UpBFml/2YBXciAmMMrJ0QQoD3HvM8I6XU1s65Ni+May7n3HIja1puXdvsnG/xTgPDcMNwM62g7weqb4BxnFrcWov+OsAwF/yCyYy4sWaeLNzsYHUf8856dEpVlyFVrMuKIgm1CGLMdMOZcdQKoTNJjIXU4jpSFDhCwS2lVMSQN6C2EYJgvF7pyuPjKyAzXgiabcLn5QJrJlSpbJEGFKgQKYQm6GL2rJ/iBlTtI3HvMAbGNodaVHig8xlv7wtSeADPqnSYzg51qG0dIupYr6I8FUW2GE8OFaI6gDE/O6x1A+r9nYFHEdf/Amq7r4CSXwN3HcC95b+A5XBYftyh6peW0wZk4dmBOlNg5oGFL94e7CR9sE7/wc2lHNpfuInPLne1bx6S799Pojs98BvE+19sTIzofgAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
        alt="chrome模拟mobile"
        title=""
        src="/static/chrome-mobile-5db0d932e1842531cf9cf7604e848547-acf85.png"
        srcset="/static/chrome-mobile-5db0d932e1842531cf9cf7604e848547-c1418.png 210w,
/static/chrome-mobile-5db0d932e1842531cf9cf7604e848547-5d5d8.png 420w,
/static/chrome-mobile-5db0d932e1842531cf9cf7604e848547-acf85.png 840w,
/static/chrome-mobile-5db0d932e1842531cf9cf7604e848547-de0cd.png 1260w,
/static/chrome-mobile-5db0d932e1842531cf9cf7604e848547-9f2ec.png 1300w"
        sizes="(max-width: 840px) 100vw, 840px"
      />
    </span>
  </span>
  
  </a>
    </p>
<h4 id="设备像素比"><a href="#%E8%AE%BE%E5%A4%87%E5%83%8F%E7%B4%A0%E6%AF%94" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>设备像素比</h4>
<p>设备像素比<code class="gatsby-code-text">device pixek ratio</code>简称dpr,即物理像素和设备独立像素的比值。</p>
<p>在<code class="gatsby-code-text">web</code>中，浏览器为我们提供了<code class="gatsby-code-text">window.devicePixelRatio</code>来帮助我们获取<code class="gatsby-code-text">dpr</code>。</p>
<p>在<code class="gatsby-code-text">css</code>中，可以使用媒体查询<code class="gatsby-code-text">min-device-pixel-ratio</code>，区分<code class="gatsby-code-text">dpr</code>：</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-css"><code class="gatsby-code-css"><span class="token atrule"><span class="token rule">@media</span> <span class="token punctuation">(</span><span class="token property">-webkit-min-device-pixel-ratio</span><span class="token punctuation">:</span>2<span class="token punctuation">)</span></span><span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre>
      </div>
<p>在<code class="gatsby-code-text">React Native</code>中，我们也可以使用<code class="gatsby-code-text">PixelRatio.get()</code>来获取<code class="gatsby-code-text">dpr</code>。</p>
<p>当然，上面的规则也有例外，iPhone6、7、8 plus的实际物理像素是<code class="gatsby-code-text">1080 x 1920</code>,在开发者工具中我们可以看到：它的设备独立像素是<code class="gatsby-code-text">414 x 736</code>,设备像素比为3，设备独立像素和设别像素比的乘积不等于<code class="gatsby-code-text">1080 x 1920</code>,而是等于<code class="gatsby-code-text">1242 x 2208</code>。</p>
<p>实际上，手机会自动把<code class="gatsby-code-text">1242 x 2208</code>个像素点塞进<code class="gatsby-code-text">1080 x 1920</code>个物理像素点来渲染，我们不用关心这个过程，而<code class="gatsby-code-text">1242 x 2208</code>被成为屏幕的设计像素。我们开发的过程中也是以这个<code class="gatsby-code-text">设计像素</code>为准。</p>
<p>实际上，从苹果提出视网膜屏幕开始，才出现设备像素比这个概念，因为在这之前，移动设备都是直接使用物理像素来进行展示。</p>
<p>紧接着，Android同样使用了其他的技术方案来实现DPR大于1的屏幕，不过远离是类似的。由于Android屏幕尺寸非常多、分辨率高低宽度非常大，不像苹果只有它自己的几款固定设备、尺寸。所以，为了保证各种设备的显示效果，Android按照设备的像素密度将设备分成了几个区间：</p>
<p>
  <a
    class="gatsby-resp-image-link"
    href="/static/android-dpr-2f6a68ec5978fe4ccfdc24d2bccf69da-b7101.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block; ; max-width: 840px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 56.705539358600575%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAACXklEQVQoz3WS20uTcRjH9/9EIER0Vd1EF9EJMiUzqku7EbrJKykGgsvUmkm40cVm5DscjqzZQcXDWGurmJvv3BYb1Q66o3OT1J0+ve9PXgOrBx54jt/n+zy/n45D0mw2hWp2o9EQqsW12L9Ezek04zDA/5o02d3dxWw2YzQaMRgM2O12EReAanO9Xv8LZGNjA1mW8fv9wrZYLPT396PX65mdnWVqakoASZKEw+HYB9TYaeJfWWF+YZFEKoXNZqO3t5euri6sVivRaBSXy4Xb7SYQCJDNZsnlcmxtbZFS6mu12j7DeDwuJqpFA0NDGAaHealMVtkVi0Xy+Tw+n49CoSCG7u3tsba2RiKRQNswHA7/AXQ6neIOEwp1WQ5Rr9YIKQUej4edXztkMhnBTAVQGaVSaeRVmVgsRjKZJJ1OiwHq2XTVapXvP3+Qy+f4phQsLC6xXdnms3K3T14v5UpFrLO87FIa16kqLErKisHgKkklLhg2G0SUcwiG6mttFooiod4osBIQdiQSwef17b9+vYHb5aZSLh/cOhKOUC6VDvx0MkVdBawp6OOTNvoGB5BeObj34D7dPT2YpQn0Aw+53NHBhbZ2RkwmhkdHuavk7nR3M26TGBkbE/rI+ISnpjFqKP9wbifDaZeVo9Y+LnkmOTNn4cgLAxc9ds65JFqkQVpsQ7SuznDWbaPFMcKx6VGuBJ2cmrdwYsbE8TfPOLk0zvNSHN30dpLzsXd0ht5yNfiadtnJ9fB7WgPTtIVm6Ih+EHpt/SOdWS+3il+Fqv6NnI+bhS/cVvy2jIfHhTC/Aci58dK3cfwrAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
        alt="安卓设备像素比"
        title=""
        src="/static/android-dpr-2f6a68ec5978fe4ccfdc24d2bccf69da-acf85.png"
        srcset="/static/android-dpr-2f6a68ec5978fe4ccfdc24d2bccf69da-c1418.png 210w,
/static/android-dpr-2f6a68ec5978fe4ccfdc24d2bccf69da-5d5d8.png 420w,
/static/android-dpr-2f6a68ec5978fe4ccfdc24d2bccf69da-acf85.png 840w,
/static/android-dpr-2f6a68ec5978fe4ccfdc24d2bccf69da-de0cd.png 1260w,
/static/android-dpr-2f6a68ec5978fe4ccfdc24d2bccf69da-b7101.png 1372w"
        sizes="(max-width: 840px) 100vw, 840px"
      />
    </span>
  </span>
  
  </a>
    </p>
<p>当然，所有的Android设备不一定严格按照上面的分辨率，每个类型可能对应几种不同分辨率，所以，每个Android手机都能根据给定的区间范围，确定自己的DPR,从而拥有类似的显示。当然，仅仅是类似，由于各个设备的尺寸、分辨率上的差异，设别独立像素也不会完全相等，所以各种Android设备仍然不能做到在展示上完全相等。</p>
<h4 id="原生移动端开发"><a href="#%E5%8E%9F%E7%94%9F%E7%A7%BB%E5%8A%A8%E7%AB%AF%E5%BC%80%E5%8F%91" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>原生移动端开发</h4>
<p>在IOS,Android和React Native开发中样式单位其实都使用的是设备独立像素。</p>
<p>ios的尺寸单位是<code class="gatsby-code-text">pt</code>,Android的尺寸单位是<code class="gatsby-code-text">dp</code>,React-Native中没有指定明确的单位，他们其实都是设别独立像素<code class="gatsby-code-text">dp</code>。</p>
<p>在使用React Native开发App时，UI给我们的圆形如一般时基于iPhone6的像素给定的。</p>
<p>为了适配所有机型，我们在写样式时需要把物理像素转换为设备独立像素：例如：如果给定一个元素的高度为200px(这里的px指物理像素，非css像素)，iPhone6的设备像素比为2，我们给定的height应为<code class="gatsby-code-text">200px/2 = 100dp</code>。</p>
<p>当然，最好的是，你可以和设计沟通好，所有的UI图都按照设备独立像素来出。</p>
<p>我们还可以在代码(RN)中进行<code class="gatsby-code-text">px</code>和<code class="gatsby-code-text">dp</code>的转换：</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">import</span> <span class="token punctuation">{</span> PixelRatio <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-native'</span>

<span class="token keyword">const</span> dpr <span class="token operator">=</span> PixelRatio<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// px 转换为 dp</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">pxToDp</span><span class="token punctuation">(</span>px<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> px <span class="token operator">/</span> dpr
<span class="token punctuation">}</span>

<span class="token comment">// dp 转换为 px</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">dpToPx</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> dp <span class="token operator">*</span> dpr
<span class="token punctuation">}</span></code></pre>
      </div>
<h4 id="web端开发"><a href="#web%E7%AB%AF%E5%BC%80%E5%8F%91" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>web端开发</h4>
<p>在写CSS时，我们用到最多的单位是px,即CSS像素，当页面缩放比例为100%时，一个CSS像素等于一个设备独立像素。</p>
<p>但是CSS像素是很容易被改变的，当用户对浏览器进行了放大，CSS像素会被放大，这时一个CSS像素会跨越更多的物理像素。</p>
<p><code class="gatsby-code-text">页面缩放系数 = CSS像素 / 设备独立像素</code></p>
<h4 id="关于屏幕"><a href="#%E5%85%B3%E4%BA%8E%E5%B1%8F%E5%B9%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>关于屏幕</h4>
<p>这里多说两句<code class="gatsby-code-text">Retina屏幕</code>，因为我在很多文章中看到对<code class="gatsby-code-text">Retina屏幕</code>的误解。</p>
<p>Retina只是苹果提出的一个营销术语：</p>
<blockquote>
<p>在普通的使用距离下，人的肉眼无法分辨单个的像素点</p>
</blockquote>
<p>为什么强调<code class="gatsby-code-text">普通的使用距离下</code>呢？我们来看看它的计算公式：</p>
<p>
  <a
    class="gatsby-resp-image-link"
    href="/static/2k-4k-b811ba1a6f4d1565f3d510185b79490c-cabe3.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block; ; max-width: 840px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 46.64586583463338%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAABA0lEQVQoz62RzU6EMBRGSym0MNNCoeMIA1EEXczGnT8LdWGMK41mYlyY6Ev4/p8tajITJhGNi5Ob3qSn370lhBD8M8Om7/tgjIFz3uPOru+t8SuhlBJKKVRVhbIoQL+Ef07ohGmaItO6FwtKsRNyLITAvojQxDFqwSG2PzQUKiucTKcw8zkCWzX1cWHrqijx1na4ywzOIgEVsHFCB/MojlSCpU15mhvcZDme2xbvl1e4z2c4jyeQY4TMjndsLzw0B3jZa/DaHWJVLvBU1bhOEjyaGW5TjZOxCUO7l6VN00mFOor7ve1ygSLgMLZqu8s8CHtC+v373s8jD/HW6idORAnd4AM8Z8PmFNZEZAAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
        alt="4k屏幕"
        title=""
        src="/static/2k-4k-b811ba1a6f4d1565f3d510185b79490c-acf85.png"
        srcset="/static/2k-4k-b811ba1a6f4d1565f3d510185b79490c-c1418.png 210w,
/static/2k-4k-b811ba1a6f4d1565f3d510185b79490c-5d5d8.png 420w,
/static/2k-4k-b811ba1a6f4d1565f3d510185b79490c-acf85.png 840w,
/static/2k-4k-b811ba1a6f4d1565f3d510185b79490c-de0cd.png 1260w,
/static/2k-4k-b811ba1a6f4d1565f3d510185b79490c-cabe3.png 1282w"
        sizes="(max-width: 840px) 100vw, 840px"
      />
    </span>
  </span>
  
  </a>
    </p>
<p>a代表人眼视角，h代表像素间距，d代表肉眼与屏幕的距离，符合以上条件的屏幕可以使肉眼看不见单个物理像素点。</p>
<p>它不能单纯的表达分辨率和PPI,只是一种视觉表达的效果。</p>
<p>让多个物理像素渲染一个独立像素只是<code class="gatsby-code-text">Retina屏幕</code>为了达到效果而使用的一种技术。而不是所有<code class="gatsby-code-text">DPR &gt; 1</code>的屏幕就是<code class="gatsby-code-text">Retina屏幕</code>。</p>
<p>比如：给你一块超大尺寸的屏幕，即使它的PPI很高，DPR很高，但是在因为屏幕太大了，所以近距离还是可以看到它的物理像素点，这就不算Retina屏。</p>
<p><img src=""></p>
<p>我们经常使用K和P这两个单位来描述屏幕。</p>
<p>P代表的就是屏幕纵向的像素点数，比如：<code class="gatsby-code-text">1080P</code>即纵向有<code class="gatsby-code-text">1080</code>个像素，分辨率为<code class="gatsby-code-text">1920 x 1080</code>的屏幕就属于1080P屏幕。</p>
<p>我们平常所说的高清屏其实就是屏幕的物理分辨率达到或者超过<code class="gatsby-code-text">1920 x 1080</code>的屏幕。</p>
<p>K代表屏幕的横向有几个1024个像素，一般来讲横向像素超过<code class="gatsby-code-text">2048</code>就术语<code class="gatsby-code-text">2K</code>屏，横向像素超过<code class="gatsby-code-text">4096</code>就属于<code class="gatsby-code-text">4K</code>屏。</p>
<h3 id="视口"><a href="#%E8%A7%86%E5%8F%A3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>视口</h3>
<p>视口(viewport)代表当前可见的计算机图形区域。在WEB浏览器术语中，通常与浏览器窗口相同，但不包括浏览器的UI,菜单栏—即指你正在浏览文档的那一部分。</p>
<h4 id="布局视口"><a href="#%E5%B8%83%E5%B1%80%E8%A7%86%E5%8F%A3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>布局视口</h4>
<p>
  <a
    class="gatsby-resp-image-link"
    href="/static/layout-viewport-ec5a1f624481179047403a2a8ed4dddf-fc236.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block; ; max-width: 840px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 80.99041533546325%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAABYlAAAWJQFJUiTwAAACWklEQVQ4y41Uy27TQBT1D4HEgvIosKGlgiWIPwFWILGqKJ8BYVF+gkWRECVS1VZukrZpm8R5+BE/Er/j8eHecRxctRW50vF4Zu499zUzihACrutiMpkgCAKEYQjHcTAajeScJc/zpaGwsa7rkvT05BT1+h7ssQvTGKOvDaTSTcJ7tu3AMi3MZjO5ppimiU6ng36/j263h/OzHoZDE449wYjGMAgRRzGiG8BZBD5nFkEIipAjY1Lf9xebPKZpKr1HUYQkSZDEBeK4+h8XewR2yuVTPM+TRtel47qeJK7WqFrTy/ooCDnCavF5kR0UEbpyPU1nco3T4kw4Ip6zbtVOEnJ3ubOlZJmQBiyWZePrl5okKaXdbsuRm5Bl2WKd63ctIS9ybVj+7NZx+9YdbH36DFU9ws7Oz0VESZIuR1i2X1VVbG5uYePZC9xbeYDVh4+xcvc+tre/L8rwX0L2zEqc9ts37/Dh/Ue8evkaa0/Xifg51tc28Gj1CWq1b1K3dF5mJgmn0+k/QvLC8Ki7zUaTDnpbjiVazRYaR00c7B9KnZybIts7b0rOhBxhMCesgGUahFhWBFkJKoMkjH4cALvUvf0OFU9D3qIr19bhqRdIL3SkXVNidq4jOzeQHQ8hGhrEYQdi7wzi9wmyX8fIwwSKPbZhD3SEtgeP7q9rWPDp/PmOB0s3kAZ0JnUXqeEhI4Mspu5GjKSYhzGyoEBOtZd3eUSPg+O5GNIL09M0jG1yQo+G1teQzQ/voiT5HLgK/ih8I5jUsiy6GTa9Mob8HwwG8hmrNusyU34F3Pm/GLm63ZsWbVgAAAAASUVORK5CYII='); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
        alt="布局视口"
        title=""
        src="/static/layout-viewport-ec5a1f624481179047403a2a8ed4dddf-acf85.png"
        srcset="/static/layout-viewport-ec5a1f624481179047403a2a8ed4dddf-c1418.png 210w,
/static/layout-viewport-ec5a1f624481179047403a2a8ed4dddf-5d5d8.png 420w,
/static/layout-viewport-ec5a1f624481179047403a2a8ed4dddf-acf85.png 840w,
/static/layout-viewport-ec5a1f624481179047403a2a8ed4dddf-fc236.png 1252w"
        sizes="(max-width: 840px) 100vw, 840px"
      />
    </span>
  </span>
  
  </a>
    
布局视口(<code class="gatsby-code-text">layout viewport</code>):当我们以百分比来指定一个元素的大小时，它的计算值是有这个元素的包含块计算而来的。当这个元素是最顶级的元素时，他就是基于布局视口来计算的。</p>
<p>布局视口是网页布局的基准窗口</p>
<p>在PC浏览器上，布局视口就等于当前浏览器的窗口大小(不包括borders,margins,滚动条)。</p>
<p>在移动端，布局视口被赋予一个默认值，大部分为<code class="gatsby-code-text">980px</code>,这保证PC的网页可以在手机浏览器上呈现，但是非常小，用户可以手动对网页进行放大。</p>
<p>我们可以通过调用<code class="gatsby-code-text">document.documentElement.clientWidth / clientHeight</code>来获取布局视口的宽高。</p>
<h4 id="视觉视口"><a href="#%E8%A7%86%E8%A7%89%E8%A7%86%E5%8F%A3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>视觉视口</h4>
<p>
  <a
    class="gatsby-resp-image-link"
    href="/static/visual-viewport-7d7ccf6b7263d5f9b7f32e4d05ecba1f-64f22.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block; ; max-width: 840px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 78.91472868217055%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAABYlAAAWJQFJUiTwAAACHUlEQVQ4y41UW2oUQRTt3YiIYsQNKC5AGfKjJL5wBWr8VyTgHoIoLiD+RuICgmvQMTM9mUe/qt/POt57O9Uz02EYL9yuorrq9LnnnmoLFEmSwPd9xHEs8yiKMJvN4LoumqbhLdBaox+8xsl7zHurqipMJhN4nof5fI6zs184/ztB4McYjy4EfBMgRxiGdG6BLMuWgMPhEOPxGKPRCMM/5wRo0wcUFnOXgBXyvECWZnKon2maIk3arOsaFj+4PC6XN+R5LmNVlcQuJgYR+KNlUaIsSxSXo5kX3XrRAvJmLvdqaNIzFVCtG9FpVU8zXw1eE0DHcdZ0YpZVWSFUEZWay5phHwSBzJkRs+s3R0o2DA1gQZqZ+dcv33By8qNjMZ1OhbXsI9DVjneAbJlVwCxrWakgxJPHe7h/7wFOT3/i6OgzlArlXUkVsHZbATnruhEPHh5+wssXr3Dr5m3c2bmL69duyAds2+6k2QpoxD4+/o43rw/w4f1HDAa72N97hqf7z/Ho4QAHb9+JTHzWVLUOSEKvaUhiK6Xgej6chSvmVYGSZKNzE30/EMCrDOkRzBzour0+utFLLVXSdXlbLAHJY/7Qhg4SNGmJ2otoJJA4Q/L7QrxoPGY03pQNkbK4Uywyl8Vasi1YnzAK6eotEIWtRbg8PrAp68sKxdh8j1kXTpvmfBUZlNeN5zb9HPphmfYzOxZcGkANYcC+nf4n/wHkl8I//8zhtgAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
        alt="视觉视口"
        title=""
        src="/static/visual-viewport-7d7ccf6b7263d5f9b7f32e4d05ecba1f-acf85.png"
        srcset="/static/visual-viewport-7d7ccf6b7263d5f9b7f32e4d05ecba1f-c1418.png 210w,
/static/visual-viewport-7d7ccf6b7263d5f9b7f32e4d05ecba1f-5d5d8.png 420w,
/static/visual-viewport-7d7ccf6b7263d5f9b7f32e4d05ecba1f-acf85.png 840w,
/static/visual-viewport-7d7ccf6b7263d5f9b7f32e4d05ecba1f-de0cd.png 1260w,
/static/visual-viewport-7d7ccf6b7263d5f9b7f32e4d05ecba1f-64f22.png 1290w"
        sizes="(max-width: 840px) 100vw, 840px"
      />
    </span>
  </span>
  
  </a>
    
视觉视口(visual viewport):用户通过屏幕真实看到的区域。</p>
<p>视觉视口默认等于当前浏览器的窗口大小，(包含滚动条宽度)。</p>
<p>当用户对浏览器进行缩放时，不会改变布局窗口的大小，所以页面布局是不变的，但是缩放会改变视觉视口的大小。</p>
<p>例如：用户将浏览器窗口放大了200%，这时浏览器窗口中的CSS像素会随着数据额的放大而放大，这时一个CSS像素会跨越更多的物理像素。</p>
<p>所以，布局视口会限制你的CSS布局而视觉视口决定用户具体能看到什么。</p>
<p>我们可以通过调用<code class="gatsby-code-text">window.innerWidth / innerHeight</code>来获取视觉视口大小。</p>
<h4 id="理想视口"><a href="#%E7%90%86%E6%83%B3%E8%A7%86%E5%8F%A3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>理想视口</h4>
<p>
  <a
    class="gatsby-resp-image-link"
    href="/static/chrome-mobile-5db0d932e1842531cf9cf7604e848547-9f2ec.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block; ; max-width: 840px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 56.30769230769231%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAABUUlEQVQoz52SzW7DIBCE/f7v12sPkXpoYwcbg83PwnQWx46jRq1UpBFml/2YBXciAmMMrJ0QQoD3HvM8I6XU1s65Ni+May7n3HIja1puXdvsnG/xTgPDcMNwM62g7weqb4BxnFrcWov+OsAwF/yCyYy4sWaeLNzsYHUf8856dEpVlyFVrMuKIgm1CGLMdMOZcdQKoTNJjIXU4jpSFDhCwS2lVMSQN6C2EYJgvF7pyuPjKyAzXgiabcLn5QJrJlSpbJEGFKgQKYQm6GL2rJ/iBlTtI3HvMAbGNodaVHig8xlv7wtSeADPqnSYzg51qG0dIupYr6I8FUW2GE8OFaI6gDE/O6x1A+r9nYFHEdf/Amq7r4CSXwN3HcC95b+A5XBYftyh6peW0wZk4dmBOlNg5oGFL94e7CR9sE7/wc2lHNpfuInPLne1bx6S799Pojs98BvE+19sTIzofgAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
        alt="理想视口"
        title=""
        src="/static/chrome-mobile-5db0d932e1842531cf9cf7604e848547-acf85.png"
        srcset="/static/chrome-mobile-5db0d932e1842531cf9cf7604e848547-c1418.png 210w,
/static/chrome-mobile-5db0d932e1842531cf9cf7604e848547-5d5d8.png 420w,
/static/chrome-mobile-5db0d932e1842531cf9cf7604e848547-acf85.png 840w,
/static/chrome-mobile-5db0d932e1842531cf9cf7604e848547-de0cd.png 1260w,
/static/chrome-mobile-5db0d932e1842531cf9cf7604e848547-9f2ec.png 1300w"
        sizes="(max-width: 840px) 100vw, 840px"
      />
    </span>
  </span>
  
  </a>
    </p>
<p>布局视口在移动端展示的效果并不是一个理想的效果，所以理想视口(ideal viewport)就诞生了：网站页面在移动端展示的理想大小。</p>
<p>如上图，我们在描述设备独立像素时曾使用过这张图，在浏览器调试移动端页面上给定的元素大小就是理想视口大小，它的单位正是设备独立像素。</p>
<p>在上面介绍CSS像素时，曾提到<code class="gatsby-code-text">页面的缩放系数 = CSS像素 / 设备独立像素</code>，实际上说<code class="gatsby-code-text">页面的缩放系数 = 理想视口宽度 / 视觉视口宽度</code>更为准确。</p>
<p>所以，当页面缩放比例为100%时，<code class="gatsby-code-text">CSS像素 = 设备独立像素</code>，<code class="gatsby-code-text">理想视口 = 视觉视口</code>。</p>
<p>我们可以通过调用<code class="gatsby-code-text">screen.width / height</code>来获取理想视口大小。</p>
<h4 id="meta-viewport"><a href="#meta-viewport" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Meta viewport</h4>
<p>我们可以借助<code class="gatsby-code-text">&lt;meta&gt;</code>元素viewport来帮助我们设置视口、缩放等，从而让移动端得到更好的展示效果。</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-html"><code class="gatsby-code-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>width=device-width, initial-scale=1.0<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></code></pre>
      </div>
<p>上面<code class="gatsby-code-text">viewport</code>的一个配置，我们来看看他们的具体含义：</p>
<ul>
<li>
<p>width(正整数或device-width) — 以pixels(整数)为单位，定义布局视口的宽度。</p>
</li>
<li>
<p>height(正整数或device-height) — 以pixels(整数)为单位，定义布局视口的高度。</p>
</li>
<li>
<p>initial-scale(0.0 - 10.0) — 定义页面初始缩放比例。</p>
</li>
<li>
<p>minimun-scale(0.0 - 10.0) — 定义页面可缩放的最小值；必须小于或者等于<code class="gatsby-code-text">maximun-scale</code>的值。</p>
</li>
<li>
<p>maximun-scale(0.0 -10.0) — 定义页面可放大的最大值；必须大于或者等于<code class="gatsby-code-text">minimun-scale</code>的值。</p>
</li>
<li>
<p>user-scalable(yes or no) — 如果设置为no,用户将不能放大或缩小网页。默认值为yes(IOS10以后，该属性被Safari浏览器全部重置为yes)</p>
</li>
</ul>
<h4 id="移动端适配"><a href="#%E7%A7%BB%E5%8A%A8%E7%AB%AF%E9%80%82%E9%85%8D" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>移动端适配</h4>
<p>为了在移动端让页面获得更好的显示效果，我们必须让布局视口、视觉视口都尽可能等于理想视口。</p>
<p><code class="gatsby-code-text">deive-width</code>就等于理想视口的宽度，所以设置<code class="gatsby-code-text">width=device-width</code>就相当于让布局视口等于理想视口。</p>
<p>由于<code class="gatsby-code-text">initial-scale = 理想视口宽度 / 视觉视口宽度</code>，所以我们设置<code class="gatsby-code-text">initial-scale=1</code>,就相当于让视觉视口等于理想视口。</p>
<p>这时，1个CSS像素就等于1个设备独立像素，而且我们也是基于理想视口来进行布局的，所以呈现出来的页面布局在各种设备上都能大致相似。</p>
<h4 id="缩放"><a href="#%E7%BC%A9%E6%94%BE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>缩放</h4>
<p>上面提到的width可以决定布局适口的宽度，实际上它并不是布局适口的唯一决定性因素，设置initial-scale也有可能影响到布局视口，因为布局视口宽度取 的是width和视觉视口宽度的最大值。</p>
<p>例如：若手机的理想视口宽度为<code class="gatsby-code-text">400px</code>,设置<code class="gatsby-code-text">width=device-width,initial-scale=2</code>,此时<code class="gatsby-code-text">视觉视口宽度 = 理想适口宽度 / initial-scale</code>即<code class="gatsby-code-text">200px</code>,布局视口取两者最大值即<code class="gatsby-code-text">device-width 400px</code>。</p>
<p>若设置<code class="gatsby-code-text">width=device-width,initial-scale=0.5</code>,此时<code class="gatsby-code-text">视觉视口宽度 = 理想视口宽度 / initial-scale</code>即<code class="gatsby-code-text">800px</code>,布局视口取两者最大值<code class="gatsby-code-text">800px</code>。</p>]]></description><link>https://reactjs.org/blog/2019/05/24/mobile.html</link><guid isPermaLink="false">https://reactjs.org/blog/2019/05/24/mobile.html</guid><pubDate>Thu, 23 May 2019 16:00:00 GMT</pubDate></item><item><title><![CDATA[How JavaScript Work: 内存管理/垃圾收集/内存泄漏]]></title><description><![CDATA[<h3 id="javascript-是如何工作的：内存管理--处理常见的-4-种内存泄漏"><a href="#javascript-%E6%98%AF%E5%A6%82%E4%BD%95%E5%B7%A5%E4%BD%9C%E7%9A%84%EF%BC%9A%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86--%E5%A4%84%E7%90%86%E5%B8%B8%E8%A7%81%E7%9A%84-4-%E7%A7%8D%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>JavaScript 是如何工作的：内存管理 + 处理常见的 4 种内存泄漏</h3>
<p>我们将讨论另外一个越来越被开发人员忽视的主题，原因是应用于日常基础内存管理的程序语言越来越成熟和复杂。我们也将会在 <a href="https://www.sessionstack.com/?utm_source=medium&#x26;utm_medium=blog&#x26;utm_content=Post-3-v8-intro">SessionStack</a> 提供一些关于如何处理 JavaScript 内存泄漏的建议，我们需要确认 SessionStack 不会导致内存泄漏，或者不会增加我们集成的 web 应用程序的消耗。</p>
<h4 id="概览"><a href="#%E6%A6%82%E8%A7%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>概览</h4>
<p>例如，像 C 这样的编程语言，有 <code class="gatsby-code-text">malloc()</code> 和 <code class="gatsby-code-text">free()</code> 这样的基础内存管理函数。开发人员可以使用这些函数来显式分配和释放操作系统的内存。</p>
<p>与此同时，JavaScrip 在对象被创建时分配内存，并在对象不再使用时“自动”释放内存，这个过程被称为垃圾回收。这种看似“自动”释放资源的特性是导致混乱的来源，它给了 JavaScript（和其他高级语言）开发者们一种错觉，他们可以选择不去关心内存管理。<strong>这是一种错误的观念</strong></p>
<p>即使使用高级语言，开发者也应该对内存管理有一些理解（至少关于基本的内存管理）。有时，自动内存管理存在的问题（比如垃圾回收器的错误或内存限制等）要求开发者需要理解内存管理，才能处理的更合适（或找到代价最少的替代方案）。</p>
<h4 id="内存生命周期"><a href="#%E5%86%85%E5%AD%98%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>内存生命周期</h4>
<p>无论你使用哪种程序语言，内存生命周期总是大致相同的：</p>
<p><img src="https://cdn-images-1.medium.com/max/800/1*slxXgq_TO38TgtoKpWa_jQ.png"></p>
<p>以下是对循环中每一步具体情况的概述：</p>
<ul>
<li>
<p> <strong>内存分配</strong> — 内存由操作系统分配，它允许你的应用程序使用。在基础语言中 (比如 C 语言)，这是一个开发人员应该处理的显式操作。然而在高级系统中，语言已经帮你完成了这些工作。</p>
</li>
<li>
<p> <strong>内存使用</strong> — 这是你的程序真正使用之前分配的内存的时候，<strong>读写</strong>操作在你使用代码中已分配的变量时发生。</p>
</li>
<li>
<p> <strong>内存释放</strong> — 释放你明确不需要的内存，让其再次空闲和可用。和<strong>内存分配</strong>一样，在基础语言中这是显式操作。
关于调用栈和内存堆的概念的快速概览，可以阅读我们的<a href="https://blog.sessionstack.com/how-does-javascript-actually-work-part-1-b0bacc073cf">关于主题的第一篇文章</a>。</p>
</li>
</ul>
<h4 id="内存是什么"><a href="#%E5%86%85%E5%AD%98%E6%98%AF%E4%BB%80%E4%B9%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>内存是什么?</h4>
<p>在直接跳到有关 JavaScript 中的内存部分之前，我们将简要地讨论一下内存的概况以及它是如何工作的：</p>
<p>在硬件层面上，内存包含大量的<a href="https://en.wikipedia.org/wiki/Flip-flop_%28electronics%29">触发器</a>。每一个触发器包含一些晶体管并能够存储一位。单独的触发器可通过<strong>唯一标识符</strong>寻址, 所以我们可以读取和覆盖它们。因此，从概念上讲，我们可以把整个计算机内存看作是我们可以读写的一个大的位组。</p>
<p>作为人类，我们并不擅长在位操作中实现我们所有的思路和算法，我们把它们组装成更大的组，它可以用来表示数字。8 位称为 1 个字节。除字节外，还有单词（有时是 16，有时是 32 位）。</p>
<p>很多东西存储在内存中:</p>
<ol>
<li>所有程序使用的所有变量和其他数据。</li>
<li>程序的代码，包括操作系统的代码。</li>
</ol>
<p>编译器和操作系统一起为您处理了大部分的内存管理，但是我们建议您看看底层发生了什么。</p>
<p>当你编译代码时，编译器可以检查原始数据类型，并提前计算它们需要多少内存。然后所需的数量被分配给<strong>栈空间</strong>中的程序。分配这些变量的空间称为栈空间，因为随着函数被调用，它们的内存被添加到现有的内存之上。当它们终止时，它们以 LIFO（后进先出）顺序被移除。 例如，请考虑以下声明：</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code class="gatsby-code-jsx">int n<span class="token punctuation">;</span> <span class="token comment">// 4 bytes</span>
int x<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// array of 4 elements, each 4 bytes</span>
double m<span class="token punctuation">;</span> <span class="token comment">// 8 bytes</span></code></pre>
      </div>
<p>编译器可以立即计算到代码需要</p>
<p>4 + 4 × 4 + 8 = 28 bytes</p>
<blockquote>
<p>这是它处理 integers 和 doubles 类型当前大小的方式。大约 20 年前，integers 通常是 2 个字节，doubles 通常是 4 个字节。您的代码不应该依赖于某一时刻基本数据类型的大小。</p>
</blockquote>
<p>编译器将插入与操作系统交互的代码，为堆栈中的变量请求存储所需的字节数。</p>
<p>在上面的例子中，编译器知道每个变量的具体内存地址。 事实上，只要我们写入变量 <code class="gatsby-code-text">n</code>，它就会在内部被翻译成类似“内存地址 4127963”的内容。</p>
<p>注意，如果我们试图在这里访问 <code class="gatsby-code-text">x[4]</code>，我们将访问与 m 关联的数据。这是因为我们正在访问数组中不存在的一个元素 - 它比数组中最后一个实际分配的元素 <code class="gatsby-code-text">x[3]</code> 深了 4 个字节，并且最终可能会读取（或覆盖）一些 <code class="gatsby-code-text">m</code> 的位。这对项目的其余部分有预料之外的影响。</p>
<p><img src="https://cdn-images-1.medium.com/max/800/1*5aBou4onl1B8xlgwoGTDOg.png"></p>
<p>当函数调用其他函数时，每个其他函数调用时都会产生自己的栈块。栈块保留了它所有的局部变量和一个记录了执行地点程序计数器。当函数调用完成时，其内存块可再次用于其他方面。</p>
<h4 id="动态分配"><a href="#%E5%8A%A8%E6%80%81%E5%88%86%E9%85%8D" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>动态分配</h4>
<p>遗憾的是，当我们不知道编译时变量需要多少内存时，事情变得不再简单。假设我们想要做如下的事情：</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code class="gatsby-code-jsx">int n <span class="token operator">=</span> <span class="token function">readInput</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// reads input from the user</span>
<span class="token operator">...</span>
<span class="token comment">// create an array with "n" elements</span></code></pre>
      </div>
<p>这里，在编译时，编译器不知道数组需要多少内存，因为它是由用户提供的值决定的。</p>
<p>因此，它不能为堆栈上的变量分配空间。相反，我们的程序需要在运行时明确地向操作系统请求正确的内存量。这个内存是从<strong>堆空间</strong>分配的。下表总结了静态和动态内存分配之间的区别：</p>
<p><img src="https://cdn-images-1.medium.com/max/800/1*qY-yRQWGI-DLS3zRHYHm9A.png"></p>
<p>静态和动态内存分配的区别</p>
<p>为了充分理解动态内存分配是如何工作的，我们需要在<strong>指针</strong>上花费更多的时间，这可能与本文的主题略有偏差。如果您有兴趣了解更多信息，请在评论中告诉我们，我们可以在以后的文章中详细介绍指针。</p>
<h4 id="javascript-中的内存分配"><a href="#javascript-%E4%B8%AD%E7%9A%84%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>JavaScript 中的内存分配</h4>
<p>现在我们将解释第一步（<strong>分配内存</strong>）是如何在JavaScript中工作的。</p>
<p>JavaScript 减轻了开发人员处理内存分配的责任 - JavaScript自己执行了内存分配，同时声明了值。</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">var</span> n <span class="token operator">=</span> <span class="token number">374</span><span class="token punctuation">;</span> <span class="token comment">// allocates memory for a number</span>
<span class="token keyword">var</span> s <span class="token operator">=</span> <span class="token string">'sessionstack'</span><span class="token punctuation">;</span> <span class="token comment">// allocates memory for a string </span>
<span class="token keyword">var</span> o <span class="token operator">=</span> <span class="token punctuation">{</span>
  a<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  b<span class="token punctuation">:</span> <span class="token keyword">null</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// allocates memory for an object and its contained values</span>
<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">'str'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// (like object) allocates memory for the</span>
                           <span class="token comment">// array and its contained values</span>
<span class="token keyword">function</span> <span class="token function">f</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> a <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token comment">// allocates a function (which is a callable object)</span>
<span class="token comment">// function expressions also allocate an object</span>
someElement<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  someElement<span class="token punctuation">.</span>style<span class="token punctuation">.</span>backgroundColor <span class="token operator">=</span> <span class="token string">'blue'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
      </div>
<p>一些函数调用也会导致对象分配：</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">var</span> d <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// allocates a Date object</span>

<span class="token keyword">var</span> e <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// allocates a DOM element</span></code></pre>
      </div>
<p>方法可以分配新的值或对象：</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">var</span> s1 <span class="token operator">=</span> <span class="token string">'sessionstack'</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> s2 <span class="token operator">=</span> s1<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// s2 is a new string</span>
<span class="token comment">// Since strings are immutable, </span>
<span class="token comment">// JavaScript may decide to not allocate memory, </span>
<span class="token comment">// but just store the [0, 3] range.</span>
<span class="token keyword">var</span> a1 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'str1'</span><span class="token punctuation">,</span> <span class="token string">'str2'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> a2 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'str3'</span><span class="token punctuation">,</span> <span class="token string">'str4'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> a3 <span class="token operator">=</span> a1<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>a2<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">// new array with 4 elements being</span>
<span class="token comment">// the concatenation of a1 and a2 elements</span></code></pre>
      </div>
<h4 id="在-javascript-中使用内存"><a href="#%E5%9C%A8-javascript-%E4%B8%AD%E4%BD%BF%E7%94%A8%E5%86%85%E5%AD%98" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>在 JavaScript 中使用内存</h4>
<p>基本上在 JavaScript 中使用分配的内存，意味着在其中读写。</p>
<p>这可以通过读取或写入变量或对象属性的值，甚至传递一个变量给函数来完成。</p>
<h4 id="在内存不再需要时释放内存"><a href="#%E5%9C%A8%E5%86%85%E5%AD%98%E4%B8%8D%E5%86%8D%E9%9C%80%E8%A6%81%E6%97%B6%E9%87%8A%E6%94%BE%E5%86%85%E5%AD%98" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>在内存不再需要时释放内存</h4>
<p>绝大部分内存管理问题都处于这个阶段。</p>
<p>这里最困难的任务是确定何时不再需要这些分配了的内存。它通常需要开发人员确定程序中的哪个部分不再需要这些内存，并将其释放。</p>
<p>高级语言嵌入了一个称为<strong>垃圾回收器</strong>的软件，其工作是跟踪内存分配和使用情况，以便找到何时何种情况下不再需要这些分配了的内存，它将自动释放内存。</p>
<p>不幸的是，这个过程是一个近似值，因为预估是否需要某些内存的问题通常是<a href="http://en.wikipedia.org/wiki/Decidability_%28logic%29">不可判定的</a>（无法通过算法解决）。</p>
<p>大多数垃圾回收器通过收集不能再访问的内存来工作，例如，所有指向它的变量都超出了作用域。然而，这是可以收集的一组内存空间的近似值，因为在某种情况下内存位置可能仍然有一个指向它的变量，但它将不会被再次访问。</p>
<h4 id="垃圾回收机制"><a href="#%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E6%9C%BA%E5%88%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>垃圾回收机制</h4>
<p>由于发现一些内存是否“不再需要”事实上是不可判定的，所以垃圾收集在实施一般问题解决方案时具有局限性。本节将解释主要垃圾收集算法及其局限性的基本概念。</p>
<h4 id="内存引用"><a href="#%E5%86%85%E5%AD%98%E5%BC%95%E7%94%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>内存引用</h4>
<p>垃圾收集算法所依赖的主要概念来源于<strong>附录参考资料</strong>。</p>
<p>在内存管理的上下文中，如果一个对象可以访问另一个对象（可以是隐式的或显式的），则称该对象引用另一个对象。例如, 一个 JavaScript 引用了它的 <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Inheritance_and_the_prototype_chain">prototype</a> (<strong>隐式引用</strong>)和它的属性值(<strong>显式引用</strong>)。</p>
<p>在这种情况下，“对象”的概念扩展到比普通JavaScript对象更广泛的范围，并包含函数作用域（或全局<strong>词法范围</strong>）。</p>
<blockquote>
<p>词法作用域定义了变量名如何在嵌套函数中解析：即使父函数已经返回，内部函数仍包含父函数的作用域。</p>
</blockquote>
<h4 id="引用计数垃圾收集"><a href="#%E5%BC%95%E7%94%A8%E8%AE%A1%E6%95%B0%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>引用计数垃圾收集</h4>
<p>这是最简单的垃圾收集算法。 如果有<strong>零个指向它</strong>的引用，则该对象被认为是“可垃圾回收的”。</p>
<p>请看下面的代码:</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">var</span> o1 <span class="token operator">=</span> <span class="token punctuation">{</span>
  o2<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    x<span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 2 objects are created. </span>
<span class="token comment">// 'o2' is referenced by 'o1' object as one of its properties.</span>
<span class="token comment">// None can be garbage-collected</span>

<span class="token keyword">var</span> o3 <span class="token operator">=</span> o1<span class="token punctuation">;</span> <span class="token comment">// the 'o3' variable is the second thing that </span>
            <span class="token comment">// has a reference to the object pointed by 'o1'. </span>
                                                       
o1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>      <span class="token comment">// now, the object that was originally in 'o1' has a         </span>
            <span class="token comment">// single reference, embodied by the 'o3' variable</span>

<span class="token keyword">var</span> o4 <span class="token operator">=</span> o3<span class="token punctuation">.</span>o2<span class="token punctuation">;</span> <span class="token comment">// reference to 'o2' property of the object.</span>
                <span class="token comment">// This object has now 2 references: one as</span>
                <span class="token comment">// a property. </span>
                <span class="token comment">// The other as the 'o4' variable</span>

o3 <span class="token operator">=</span> <span class="token string">'374'</span><span class="token punctuation">;</span> <span class="token comment">// The object that was originally in 'o1' has now zero</span>
            <span class="token comment">// references to it. </span>
            <span class="token comment">// It can be garbage-collected.</span>
            <span class="token comment">// However, what was its 'o2' property is still</span>
            <span class="token comment">// referenced by the 'o4' variable, so it cannot be</span>
            <span class="token comment">// freed.</span>

o4 <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// what was the 'o2' property of the object originally in</span>
           <span class="token comment">// 'o1' has zero references to it. </span>
           <span class="token comment">// It can be garbage collected.</span></code></pre>
      </div>
<h4 id="周期产生问题"><a href="#%E5%91%A8%E6%9C%9F%E4%BA%A7%E7%94%9F%E9%97%AE%E9%A2%98" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>周期产生问题</h4>
<p>在周期循环中有一个限制。在下面的例子中，两个对象被创建并相互引用，这就创建了一个循环。在函数调用之后，它们会超出界限，所以它们实际上是无用的，并且可以被释放。然而，引用计数算法认为，由于两个对象中的每一个都被至少引用了一次，所以两者都不能被垃圾收集。</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">function</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> o1 <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> o2 <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  o1<span class="token punctuation">.</span>p <span class="token operator">=</span> o2<span class="token punctuation">;</span> <span class="token comment">// o1 references o2</span>
  o2<span class="token punctuation">.</span>p <span class="token operator">=</span> o1<span class="token punctuation">;</span> <span class="token comment">// o2 references o1. This creates a cycle.</span>
<span class="token punctuation">}</span>

<span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
      </div>
<p><img src="https://cdn-images-1.medium.com/max/800/1*GF3p99CQPZkX3UkgyVKSHw.png"></p>
<h4 id="标记和扫描算法"><a href="#%E6%A0%87%E8%AE%B0%E5%92%8C%E6%89%AB%E6%8F%8F%E7%AE%97%E6%B3%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>标记和扫描算法</h4>
<p>为了确定是否需要某个对象，本算法判断该对象是否可访问。</p>
<p>标记和扫描算法经过这 3 个步骤：</p>
<p>1.根节点：一般来说，根是代码中引用的全局变量。例如，在 JavaScript 中，可以充当根节点的全局变量是“window”对象。Node.js 中的全局对象被称为“global”。完整的根节点列表由垃圾收集器构建。
2.然后算法检查所有根节点和他们的子节点并且把他们标记为活跃的（意思是他们不是垃圾）。任何根节点不能访问的变量将被标记为垃圾。
3.最后，垃圾收集器释放所有未被标记为活跃的内存块，并将这些内存返回给操作系统。</p>
<p><img src="https://cdn-images-1.medium.com/max/800/1*WVtok3BV0NgU95mpxk9CNg.gif"></p>
<p>标记和扫描算法行为的可视化。</p>
<p>因为“一个对象有零引用”导致该对象不可达，所以这个算法比前一个算法更好。我们在周期中看到的情形恰巧相反，是不正确的。</p>
<p>截至 2012 年，所有现代浏览器都内置了标记扫描式的垃圾回收器。去年在 JavaScript 垃圾收集（通用/增量/并发/并行垃圾收集）领域中所做的所有改进都是基于这种算法（标记和扫描）的实现改进，但这不是对垃圾收集算法本身的改进，也不是对判断一个对象是否可达这个目标的改进。</p>
<p><a href="https://en.wikipedia.org/wiki/Tracing_garbage_collection">在本文中</a>, 您可以阅读有关垃圾回收跟踪的更详细的信息，文章也包括标记和扫描算法以及其优化。</p>
<h4 id="周期不再是问题"><a href="#%E5%91%A8%E6%9C%9F%E4%B8%8D%E5%86%8D%E6%98%AF%E9%97%AE%E9%A2%98" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>周期不再是问题</h4>
<p>在上面的第一个例子中，函数调用返回后，两个对象不再被全局对象中的某个变量引用。因此，垃圾收集器会认为它们不可访问。</p>
<p><img src="https://cdn-images-1.medium.com/max/800/1*FbbOG9mcqWZtNajjDO6SaA.png"></p>
<p>即使两个对象之间有引用，从根节点它们也不再可达。</p>
<h4 id="统计垃圾收集器的直观行为"><a href="#%E7%BB%9F%E8%AE%A1%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E5%99%A8%E7%9A%84%E7%9B%B4%E8%A7%82%E8%A1%8C%E4%B8%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>统计垃圾收集器的直观行为</h4>
<p>尽管垃圾收集器很方便，但他们也有自己的一套权衡策略。其中之一是不确定性。换句话说，GCs（垃圾收集器）们是不可预测的。你不能确定一个垃圾收集器何时会执行收集。这意味着在某些情况下，程序其实需要使用更多的内存。其他情况下，在特别敏感的应用程序中，短暂暂停可能是显而易见的。尽管不确定性意味着不能确定一个垃圾收集器何时执行收集，大多数 GC 共享分配中的垃圾收集通用模式。如果没有执行分配，大多数 GC 保持空闲状态。考虑如下场景：</p>
<ol>
<li>大量的分配被执行。</li>
<li>大多数这些元素（或全部）被标记为不可访问（假设我们废除一个指向我们不再需要的缓存的引用）。</li>
<li>没有执行更深的内存分配。</li>
</ol>
<p>在这种情况下，大多数 GC 不会运行任何更深层次的收集。换句话说，即使存在不可用的引用可用于收集，收集器也不会声明这些引用。这些并不是严格的泄漏，但仍会导致高于日常的内存使用率。</p>
<h4 id="什么是内存泄漏"><a href="#%E4%BB%80%E4%B9%88%E6%98%AF%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>什么是内存泄漏?</h4>
<p>就像内存描述的那样，内存泄漏是应用程序过去使用但不再需要的尚未返回到操作系统或可用内存池的内存片段。</p>
<p><img src="https://cdn-images-1.medium.com/max/800/1*0B-dAUOH7NrcCDP6GhKHQw.jpeg"></p>
<p>编程语言偏好不同的内存管理方式。但是，某段内存是否被使用实际上是一个<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Memory_Management#Release_when_the_memory_is_not_needed_anymore">不可判定问题</a>。换句话说，只有开发人员可以明确某块内存是否可以返回给操作系统。</p>
<p>某些编程语言提供了帮助开发人员执行上述操作的功能。其他人则希望开发人员能够完全明确某段内存何时处于未使用状态。维基百科在如何<a href="https://en.wikipedia.org/wiki/Manual_memory_management">手工</a>和<a href="https://en.wikipedia.org/wiki/Garbage_collection_%28computer_science%29">自动</a>内存管理方面有很好的文章。</p>
<h4 id="javascript-常见的四种内存泄漏"><a href="#javascript-%E5%B8%B8%E8%A7%81%E7%9A%84%E5%9B%9B%E7%A7%8D%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>JavaScript 常见的四种内存泄漏</h4>
<h4 id="1：全局变量"><a href="#1%EF%BC%9A%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>1：全局变量</h4>
<p>JavaScript 用一种有趣的方式处理未声明的变量：当引用一个未声明的变量时，在 <em>global</em> 对象中创建一个新变量。在浏览器中，全局对象将是 <code class="gatsby-code-text">window</code>，这意味着</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    bar <span class="token operator">=</span> <span class="token string">"some text"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
      </div>
<p>等同于:</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    window<span class="token punctuation">.</span>bar <span class="token operator">=</span> <span class="token string">"some text"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
      </div>
<p>我们假设 <code class="gatsby-code-text">bar</code> 的目的只是引用 foo 函数中的一个变量。然而，如果你不使用 <code class="gatsby-code-text">var</code> 来声明它，就会创建一个冗余的全局变量。在上面的情况中，这不会造成很严重的后果。你可以想象一个更具破坏性的场景。</p>
<p>你也可以用 <code class="gatsby-code-text">this</code> 意外地创建一个全局变量：</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>var1 <span class="token operator">=</span> <span class="token string">"potential accidental global"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// Foo called on its own, this points to the global object (window)</span>
<span class="token comment">// rather than being undefined.</span>
<span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
      </div>
<blockquote>
<p>你可以通过在 JavaScript 文件的开头添加 <code class="gatsby-code-text">&#39;use strict&#39;;</code> 来避免这些后果，这将开启一种更严格的 JavaScript 解析模式，从而防止意外创建全局变量。</p>
</blockquote>
<p>意外的全局变量当然是个问题，然而更常出现的情况是，你的代码会受到显式的全局变量的影响，而这些全局变量无法通过垃圾收集器收集。需要特别注意用于临时存储和处理大量信息的全局变量。如果你必须使用全局变量来存储数据，当你这样做的时候，要保证一旦完成使用就把他们<strong>赋值为 null 或重新赋值</strong> 。</p>
<h4 id="2：被忘记的定时器或者回调函数"><a href="#2%EF%BC%9A%E8%A2%AB%E5%BF%98%E8%AE%B0%E7%9A%84%E5%AE%9A%E6%97%B6%E5%99%A8%E6%88%96%E8%80%85%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>2：被忘记的定时器或者回调函数</h4>
<p>我们以经常在 JavaScript 中使用的 <code class="gatsby-code-text">setInterval</code> 为例。</p>
<p>提供观察者和其他接受回调的工具库通常确保所有对回调的引用在其实例无法访问时也变得无法访问。然而，下面的代码并不鲜见：</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">var</span> serverData <span class="token operator">=</span> <span class="token function">loadData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> renderer <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'renderer'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>renderer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        renderer<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>serverData<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//This will be executed every ~5 seconds.</span></code></pre>
      </div>
<p>上面的代码片段显示了使用定时器引用节点或无用数据的后果。</p>
<p><code class="gatsby-code-text">renderer</code> 对象可能会在某些时候被替换或删除，这会使得间隔处理程序封装的块变得冗余。如果发生这种情况，处理程序及其依赖项都不会被收集，因为间隔处理需要先备停止（请记住，它仍然是活动的）。这一切都归结为一个事实，即事实存储和处理负载数据的 <code class="gatsby-code-text">serverData</code> 也不会被收集。</p>
<p>当使用观察者时，你需要确保一旦依赖于它们的事务已经处理完成，你编写了明确的调用来删除它们（不再需要观察者，或者对象将变得不可用时）。</p>
<p>幸运的是，大多数现代浏览器都会为你做这件事：即使你忘记删除监听器，当观察对象变得无法访问时，它们也会自动收集观察者处理程序。过去一些浏览器无法处理这些情况（旧的 IE6）。</p>
<p>但是，尽管如此，一旦对象变得过时，移除观察者才是符合最佳实践的。看下面的例子：</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">var</span> element <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'launch-button'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">onClick</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   counter<span class="token operator">++</span><span class="token punctuation">;</span>
   element<span class="token punctuation">.</span>innerHtml <span class="token operator">=</span> <span class="token string">'text '</span> <span class="token operator">+</span> counter<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
element<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> onClick<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Do stuff</span>
element<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> onClick<span class="token punctuation">)</span><span class="token punctuation">;</span>
element<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Now when element goes out of scope,</span>
<span class="token comment">// both element and onClick will be collected even in old browsers // that don't handle cycles well.</span></code></pre>
      </div>
<p>现在的浏览器支持检测这些循环并适当地处理它们的垃圾收集器，因此在制造一个无法访问的节点之前，你不再需要调用 <code class="gatsby-code-text">removeEventListener</code>。</p>
<p>如果您利用 <code class="gatsby-code-text">jQuery</code> API（其他库和框架也支持这个），您也可以在节点废弃之前删除监听器。即使应用程序在较旧的浏览器版本下运行，这些库也会确保没有内存泄漏。</p>
<p>3：闭包</p>
<p>JavaScript开发的一个关键方面是闭包：一个内部函数可以访问外部（封闭）函数的变量。由于JavaScript运行时的实现细节，可能以如下方式泄漏内存：</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">var</span> theThing <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> <span class="token function-variable function">replaceThing</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> originalThing <span class="token operator">=</span> theThing<span class="token punctuation">;</span>
  <span class="token keyword">var</span> <span class="token function-variable function">unused</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>originalThing<span class="token punctuation">)</span> <span class="token comment">// a reference to 'originalThing'</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"hi"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  theThing <span class="token operator">=</span> <span class="token punctuation">{</span>
    longStr<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span><span class="token number">1000000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'*'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    someMethod<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"message"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token function">setInterval</span><span class="token punctuation">(</span>replaceThing<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
      </div>
<p>一旦调用了 <code class="gatsby-code-text">replaceThing</code> 函数，<code class="gatsby-code-text">theThing</code> 就得到一个新的对象，它由一个大数组和一个新的闭包（<code class="gatsby-code-text">someMethod</code>）组成。然而 <code class="gatsby-code-text">originalThing</code> 被一个由 <code class="gatsby-code-text">unused</code> 变量（这是从前一次调用 <code class="gatsby-code-text">replaceThing</code> 变量的 <code class="gatsby-code-text">Thing</code> 变量）所持有的闭包所引用。需要记住的是<strong>一旦为同一个父作用域内的闭包创建作用域，作用域将被共享。</strong></p>
<p>在个例子中，<code class="gatsby-code-text">someMethod</code> 创建的作用域与 <code class="gatsby-code-text">unused</code> 共享。<code class="gatsby-code-text">unused</code> 包含一个关于 <code class="gatsby-code-text">originalThing</code> 的引用。即使 <code class="gatsby-code-text">unused</code> 从未被引用过，<code class="gatsby-code-text">someMethod</code> 也可以通过 <code class="gatsby-code-text">replaceThing</code> 作用域之外的 <code class="gatsby-code-text">theThing</code> 来使用它（例如全局的某个地方）。由于 <code class="gatsby-code-text">someMethod</code> 与 <code class="gatsby-code-text">unused</code> 共享闭包范围，<code class="gatsby-code-text">unused</code> 指向 <code class="gatsby-code-text">originalThing</code> 的引用强制它保持活动状态（两个闭包之间的整个共享范围）。这阻止了它们的垃圾收集。</p>
<p>在上面的例子中，为闭包 <code class="gatsby-code-text">someMethod</code> 创建的作用域与 <code class="gatsby-code-text">unused</code> 共享，而 <code class="gatsby-code-text">unused</code> 又引用 <code class="gatsby-code-text">originalThing</code>。<code class="gatsby-code-text">someMethod</code> 可以通过 <code class="gatsby-code-text">replaceThing</code> 范围之外的 <code class="gatsby-code-text">theThing</code> 来引用，尽管 <code class="gatsby-code-text">unused</code> 从来没有被引用过。事实上，unused 对 <code class="gatsby-code-text">originalThing</code> 的引用要求它保持活跃，因为 <code class="gatsby-code-text">someMethod</code> 与 unused 的共享封闭范围。</p>
<p>所有这些都可能导致大量的内存泄漏。当上面的代码片段一遍又一遍地运行时，您可以预期到内存使用率的上升。当垃圾收集器运行时，其大小不会缩小。一个闭包链被创建（在例子中它的根就是 <code class="gatsby-code-text">theThing</code> 变量），并且每个闭包作用域都包含对大数组的间接引用。</p>
<p>Meteor 团队发现了这个问题，<a href="https://blog.meteor.com/an-interesting-kind-of-javascript-memory-leak-8b47d2e7f156">它们有一篇很棒的文章</a>详细地描述了这个问题。</p>
<h4 id="4：超出-dom-的引用"><a href="#4%EF%BC%9A%E8%B6%85%E5%87%BA-dom-%E7%9A%84%E5%BC%95%E7%94%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>4：超出 DOM 的引用</h4>
<p>有些情况下开发人员在数据结构中存储 DOM 节点。假设你想快速更新表格中几行的内容。如果在字典或数组中存储对每个 DOM 行的引用，就会产生两个对同一个 DOM 元素的引用：一个在 DOM 树中，另一个在字典中。如果你决定删除这些行，你需要记住让两个引用都无法访问。</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">var</span> elements <span class="token operator">=</span> <span class="token punctuation">{</span>
    button<span class="token punctuation">:</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    image<span class="token punctuation">:</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'image'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">doStuff</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    elements<span class="token punctuation">.</span>image<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">'http://example.com/image_name.png'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">removeImage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// The image is a direct child of the body element.</span>
    document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'image'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// At this point, we still have a reference to #button in the</span>
    <span class="token comment">//global elements object. In other words, the button element is</span>
    <span class="token comment">//still in memory and cannot be collected by the GC.</span>
<span class="token punctuation">}</span></code></pre>
      </div>
<p>在涉及 DOM 树内的内部节点或叶节点时，还有一个额外的因素需要考虑。如果你在代码中保留对表格单元格（<code class="gatsby-code-text">td</code> 标记）的引用，并决定从 DOM 中删除该表格但保留对该特定单元格的引用，则可以预见到严重的内存泄漏。你可能会认为垃圾收集器会释放除了那个单元格之外的所有东西。但情况并非如此。由于单元格是表格的子节点，并且子节点保持对父节点的引用，所以<strong>对表格单元格的这种单引用会把整个表格保存在内存中</strong>。</p>]]></description><link>https://reactjs.org/blog/2019/02/05/menory-management.html</link><guid isPermaLink="false">https://reactjs.org/blog/2019/02/05/menory-management.html</guid><pubDate>Mon, 04 Feb 2019 16:00:00 GMT</pubDate></item><item><title><![CDATA[前端资源加载优先级]]></title><description><![CDATA[<p>浏览器里并不是每一个资源加载都很重要。 </p>
<p>为了达到重要的资源先加载，浏览器有试探法，尝试对资源进行权重分配，例如CSS会在脚本和图片之前先加载。 因为浏览器在试探权重分配，所以并不总是分配的很正确，通常因为没有足够的信息，浏览器可能做出错误的决定。</p>
<p>下面介绍如何在现代浏览器中以代码的形式来调整资源加载的优先级。</p>
<h3 id="默认优先级"><a href="#%E9%BB%98%E8%AE%A4%E4%BC%98%E5%85%88%E7%BA%A7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>默认优先级</h3>
<p>如前所述，浏览器根据它们的重要程度为不同类型的资源分配不同的相对优先级。 像页面的<code class="gatsby-code-text">&lt;head&gt;</code>中的<code class="gatsby-code-text">&lt;script&gt;</code>标记将以”高优先级(High priority)“(CSS是”最高优先级(Highest priority)“)加载到Chrome中，但如果它具有<code class="gatsby-code-text">async</code>属性，则该优先级将更改为”低(Low priority)“（意味着它可以加载并异步运行）。在查看站点的加载性能时，优先级变得很重要。 除了测量和分析关键渲染路径的常用技术之外，了解Chrome对每种资源的优先级分配也很有用。您可以在Chrome开发者工具的”网络”面板中找到它。 这是它的样子：</p>
<p>
  <a
    class="gatsby-resp-image-link"
    href="/static/network-priority-3ab504487833ef302dc01c0e95f4c45b-82ec2.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block; ; max-width: 840px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 33.58885017421603%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAABVklEQVQozz1R2bKQMBTj/39MP8AHde5FoCzd91IWZ+JpHX3I9JDkkAaGkhOCdxD8wLFvkIJDEPZt7fNOnFaywzuLGBzB045H5Cs8GxGtQ02xv2f49rHixywxcY9fh+/nIiPNFqtK9OzAVMT3iXee+wvjprGZjHFkEKvA123CF0aXchXDx7yjYd7JpDxcvuHLAx1Knw8dIX2BdBmx/u4a44b0E/M4wRwCW4iYKDScL4bPcQRjDM45lJzxPjee+8JZCq6rdj7GSNV30p7Oe6p21Qoxj8iK4yE+p7+7w8/PBfPKIU2ATxUhX/00PsO2W8YTyiXyiK413z/vsTBYuqGjWRr6F+nCMM0LpFIolHxTUku77xtaGyRKde3jxwQpFd737ZrSGpn8YplQnUGlRoZ8bXfYqIoQgpYTKtU4z7NDUYgnU0MIAdba/3qbW5imymVfcBJvyde0P7UoEcF1kFZkAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
        alt="network priority"
        title=""
        src="/static/network-priority-3ab504487833ef302dc01c0e95f4c45b-acf85.png"
        srcset="/static/network-priority-3ab504487833ef302dc01c0e95f4c45b-c1418.png 210w,
/static/network-priority-3ab504487833ef302dc01c0e95f4c45b-5d5d8.png 420w,
/static/network-priority-3ab504487833ef302dc01c0e95f4c45b-acf85.png 840w,
/static/network-priority-3ab504487833ef302dc01c0e95f4c45b-de0cd.png 1260w,
/static/network-priority-3ab504487833ef302dc01c0e95f4c45b-bd6c2.png 1680w,
/static/network-priority-3ab504487833ef302dc01c0e95f4c45b-70dc4.png 2520w,
/static/network-priority-3ab504487833ef302dc01c0e95f4c45b-82ec2.png 2870w"
        sizes="(max-width: 840px) 100vw, 840px"
      />
    </span>
  </span>
  
  </a>
    </p>
<blockquote>
<p>Chrome开发者工具中网络面板中的优先级,如果没有看到该列，您可以通过右键单击列标题来启用“优先级”列 </p>
</blockquote>
<p>优先级使您了解浏览器处理每个资源的相对重要性。 请记住，微妙的差异足以让浏览器分配不同的优先级; 例如，作为初始渲染的一部分的图像优先于高于从屏幕外开始的图像。</p>
<p>如果您发现资源加载的优先级与您想要的不同，您会怎么做？本文展示了三种不同的声明性解决方案，它们都是相对较新的<code class="gatsby-code-text">&lt;link&gt;</code>类型。 如果您的资源对用户体验至关重要，但加载的优先级过低，则可以尝试通过以下两种方式之一进行修复：<code class="gatsby-code-text">预加载(Preload)</code>或<code class="gatsby-code-text">预链接(Preconnect)</code>。 另一方面，如果您希望浏览器在完成处理其他内容时获取某些资源，请尝试<code class="gatsby-code-text">预获取(Prefetch)</code>。</p>
<h3 id="预加载preload"><a href="#%E9%A2%84%E5%8A%A0%E8%BD%BDpreload" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>预加载(Preload)</h3>
<p><code class="gatsby-code-text">&lt;link rel=&quot;preload&quot;&gt;</code>通知浏览器接下来可能用到的资源，并尽快开始加载资源。 你可以像这样使用：</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-html"><code class="gatsby-code-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>preload<span class="token punctuation">"</span></span> <span class="token attr-name">as</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>script<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>super-important.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>preload<span class="token punctuation">"</span></span> <span class="token attr-name">as</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>style<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>critical.css<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></code></pre>
      </div>
<p>如你期望，“as”告诉浏览器资源类型。你要通过<code class="gatsby-code-text">as</code>设置正确的类型，否则浏览器不会使用预加载的资源。 </p>
<p>浏览器在空闲的时候会去加载相应的资源，并在合适的时候使用它们。</p>
<p><code class="gatsby-code-text">&lt;link rel=&quot;preload&quot;&gt;</code>是浏览器的强制性指令，preload后浏览器就必定去预加载相应的资源。使用时需要仔细测试，确保您不会因为使用它而意外导致任何资源加载2次。使用<code class="gatsby-code-text">&lt;link rel=&quot;preload&quot;&gt;</code>获取但在3秒内未被当前页面使用的资源将在Chrome开发者工具的控制台中触发警告，因此请务必留意这些！</p>
<p>
  <a
    class="gatsby-resp-image-link"
    href="/static/preload-warn-f48470be88108b285548d14b675ad70d-bfb40.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block; ; max-width: 840px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 18.72015281757402%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA6UlEQVQY0z2O626CQBCFef8HqoltjGmT/jBtgnJRKMplKewS0ICXRFn8CrR2kpM5M2fOzBhKKZJEkGc5YRixC0Oqak/TNNR1/Zd/MfAHjsfjPx+0oVaqwGiamtP5xBBaa+73juv1yuVy7heXtO1t7Gvd0nV6PCJlPmqHw6Gfv/OIon/OqKSLSpdU0qHI12TCQWZr0thCRCv8zQIRr0gTi1J5lLmNFCZit6BSLvLbJQw+e5/NuUkwAntK4Dwjgjd26xmb5YQva0rozYn81157YevOENt3NuYEz3wi9ucjBq8UHyP2hUV3S/kBYHMnYhMdaAAAAAAASUVORK5CYII='); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
        alt="preload warn"
        title=""
        src="/static/preload-warn-f48470be88108b285548d14b675ad70d-acf85.png"
        srcset="/static/preload-warn-f48470be88108b285548d14b675ad70d-c1418.png 210w,
/static/preload-warn-f48470be88108b285548d14b675ad70d-5d5d8.png 420w,
/static/preload-warn-f48470be88108b285548d14b675ad70d-acf85.png 840w,
/static/preload-warn-f48470be88108b285548d14b675ad70d-de0cd.png 1260w,
/static/preload-warn-f48470be88108b285548d14b675ad70d-bd6c2.png 1680w,
/static/preload-warn-f48470be88108b285548d14b675ad70d-bfb40.png 2094w"
        sizes="(max-width: 840px) 100vw, 840px"
      />
    </span>
  </span>
  
  </a>
    </p>
<p>图中显示unused.js通过预加载进行了资源加载，但是接下来并没有使用，如果用不到的资源最好不要使用预加载。</p>
<h4 id="preload使用场景"><a href="#preload%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>preload使用场景</h4>
<h5 id="字体"><a href="#%E5%AD%97%E4%BD%93" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>字体</h5>
<p>字体资源是预获取的一个很好的例子</p>
<p>为了减少用户等待站点文本内容的时间，以及避免系统字体与样式中定义的字体之间应用时的闪烁，您可以在HTML中使用<code class="gatsby-code-text">&lt;link rel =&quot;preload&quot;&gt;</code>让浏览器知道样式文件中需要加载的字体资源。</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-html"><code class="gatsby-code-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>preload<span class="token punctuation">"</span></span> <span class="token attr-name">as</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>font<span class="token punctuation">"</span></span> <span class="token attr-name">crossorigin</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>crossorigin<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>font/woff2<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>myfont.woff2<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></code></pre>
      </div>
<p>请注意，使用<code class="gatsby-code-text">crossorigin</code>很重要; 如果没有此属性，浏览器将忽略预加载的字体，并发起一个新的请求。 这是因为浏览器使用匿名请求加载字体，也只有使用<code class="gatsby-code-text">crossorigin</code>属性使预加载请求匿名。</p>
<blockquote>
<p>如果您使用的是CDN，例如Google字体，请确保您预加载的字体文件与CSS中的字体文件匹配，由于unicode范围，权重和字体变体，这可能很棘手。 字体也可以定期更新，如果你预加载了一个旧版本的字体，但在样式文件中使用了新版本的字符，则最终可能会下载相同字体的两个版本并浪费用户的带宽。 这种情况请考虑使用<code class="gatsby-code-text">&lt;link rel =&quot;preconnect&quot;&gt;</code>。</p>
</blockquote>
<h4 id="关键路径css和javascript"><a href="#%E5%85%B3%E9%94%AE%E8%B7%AF%E5%BE%84css%E5%92%8Cjavascript" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>关键路径CSS和JavaScript</h4>
<p>在谈论页面性能时，一个有用的概念是“关键路径”。 关键路径是指在初始渲染之前必须加载的资源。 这些资源(如CSS)对于获取用户屏幕上的第一个像素至关重要。以前，建议将此内容内嵌到您的HTML中。</p>
<p>但是，在多页，服务器端呈现的场景中，这很快就会变成大量浪费的字节。 它还使版本控制变得更加困难，因为关键代码中的任何更改都会使任何内联页面无效。<code class="gatsby-code-text">&lt;link rel =&quot;preload&quot;&gt;</code>允许您保留单个文件版本控制和缓存的好处，同时为您提供尽快请求资源的机制。</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-html"><code class="gatsby-code-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>preload<span class="token punctuation">"</span></span> <span class="token attr-name">as</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>script<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>super-important.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>preload<span class="token punctuation">"</span></span> <span class="token attr-name">as</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>style<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>critical.css<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></code></pre>
      </div>
<p>预加载缺点：需要额外的往返。 这个额外的往返来自于浏览器先获取HTML，然后它才能从HTML中找出要加载的下一个资源。</p>
<p>解决额外往返的一种方法是使用<code class="gatsby-code-text">HTTP/2推送</code>，在这种情况下，您可以将关键资源附加到和发送HTML的同一连接。 这可以保证用户浏览器检索HTML和开始下载关键资源之间没有停顿时间。 但是，在使用HTTP/2推送时要小心，因为这是控制用户带宽使用的一种非常有力的方式，并且留给浏览器做决定的空间很小，例如不检索已经在缓存中的文件！</p>
<h3 id="预连接preconnect"><a href="#%E9%A2%84%E8%BF%9E%E6%8E%A5preconnect" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>预连接(Preconnect)</h3>
<p><code class="gatsby-code-text">&lt;link rel =&quot;preconnect&quot;&gt;</code>通知浏览器您的页面打算与另一个来源建立连接，并且您希望该过程尽快启动。</p>
<p>建立连接通常需要在慢速网络中占用大量时间，特别是在涉及安全连接时，因为它可能涉及DNS查找，重定向以及到处理用户请求的最终服务器的多次往返。 提前处理所有这些可以使您的应用程序对用户感觉更加快捷，而不会对带宽的使用产生负面影响。 建立连接的大部分时间都花在等待上，而不是交换数据。</p>
<p>告知浏览器您的意图就像在页面中添加链接标记一样简单：</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-html"><code class="gatsby-code-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>preconnect<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://example.com<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></code></pre>
      </div>
<p>在这种情况下，我们让浏览器知道我们打算连接到”example.com”并从那里检索内容。请记住，虽然<code class="gatsby-code-text">&lt;link rel =&quot;preconnect&quot;&gt;</code>轻量，但它仍然占用宝贵的CPU时间，特别是在安全连接上。 如果在10秒内没有使用连接，这会特别糟糕，因为浏览器会关闭它，浪费所有早期的连接工作。</p>
<p>一般情况下，尝试使用<link rel ="preload">，因为它是一个更全面的性能优化方案，其它更复杂的情况，你需要使用<link rel ="preconnect">。</p>
<blockquote>
<p>注意：</p>
<p>实际上还有另一个与连接相关的<code class="gatsby-code-text">&lt;link&gt;</code>类型：<code class="gatsby-code-text">&lt;link rel =&quot;dns-prefetch&quot;&gt;</code>。 这仅处理DNS查找，它是<code class="gatsby-code-text">&lt;link rel =&quot;preconnect&quot;&gt;</code>的一小部分。<code class="gatsby-code-text">&lt;link rel =&quot;dns-prefetch&quot;&gt;</code>具有更广泛的浏览器支持，因此它可以作为一个很好的后备。 您可以用相同的方式使用它：<code class="gatsby-code-text">&lt;link rel =&quot;dns-prefetch&quot; href =&quot;https://example.com&quot;&gt;</code></p>
</blockquote>
<h4 id="preconnect用例cdn"><a href="#preconnect%E7%94%A8%E4%BE%8Bcdn" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Preconnect用例CDN</h4>
<p>知道资源会从哪里来，但不知道最终获取什么资源。有时您知道将从给定的CDN中检索资源，但并不知道完整路径。 根据用户的使用情况或其它运行时特征，从CDN上获取一个或多个资源。</p>
<p>在这种情况下，如果您要获取的资源很重要，您可能希望通过预连接到服务器来节省尽可能多的时间。 浏览器不会在需要之前开始提取文件（也就是说，一旦请求以某种方式从您的页面发出），但至少它可以提前处理连接，从而使用户无需等待几次往返。</p>
<h4 id="preconnect-流媒体"><a href="#preconnect-%E6%B5%81%E5%AA%92%E4%BD%93" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Preconnect 流媒体</h4>
<p>流媒体不同来源的流媒体，您可能希望在连接阶段节省一些时间但不一定立即开始获取内容。根据页面处理流内容的方式，您可能需要等到脚本加载完毕并做好准备后才处理流。 一旦准备加载资源，预连接可帮助您缩短单次往返的等待时间。</p>
<h3 id="预获取prefetch"><a href="#%E9%A2%84%E8%8E%B7%E5%8F%96prefetch" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>预获取(Prefetch)</h3>
<p>它通过向浏览器通知将来需要的资源来加速页面的后续展现，例如，如果用户采取了我们期望的操作，则我们可以提前加载稍后可能需要的东西。 </p>
<p>当前页面加载并且有可用带宽时，这些资源在Chrome中以最低优先级获取。这意味着预获取最适合提前做好用户下一步可能做的事情的准备，例如检索结果列表中的第一个产品详细信息页面，或检索分页内容中的下一页。</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>prefetch<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>page-2.html<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></code></pre>
      </div>
<p>但请记住，预取不会递归地起作用。 在上面的示例中, 除非您明确预获取page-2.html中的内容，否则浏览器不会提前下载page-2.html所需的任何资源。</p>
<h3 id="预获取prefetch不会覆盖"><a href="#%E9%A2%84%E8%8E%B7%E5%8F%96prefetch%E4%B8%8D%E4%BC%9A%E8%A6%86%E7%9B%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>预获取(Prefetch)不会覆盖</h3>
<p>请务必注意，不能使用<code class="gatsby-code-text">&lt;link rel =&quot;prefetch&quot;&gt;</code>作为降低现有资源优先级的方法。 在下面的HTML中，您可能认为在预取中声明<code class="gatsby-code-text">optional.css</code>会降低后续<code class="gatsby-code-text">&lt;link rel =&quot;stylesheet&quot;&gt;</code>的优先级：</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-html"><code class="gatsby-code-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>prefetch<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>optional.css<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>optional.css<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
    Hello!
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre>
      </div>
<p>事情上，这会导致样式表被加载两次（尽管第二个可能命中缓存），一次是默认的最高优先级，一次是最低优先级：</p>
<p>
  <a
    class="gatsby-resp-image-link"
    href="/static/prefetch-warn-259ac63e9dc81f1988d3c134da0eb2e0-6fd6f.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block; ; max-width: 840px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 15.087719298245613%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAt0lEQVQI1x2N0U6EMBRE+f/f8S98MsboanTjQoFCS+G2TbvALse6DyeZnMlkqlZbJK7kDeL1TtoOnCTawTG6gPOZ3swPF9KOtlJcwsyRcRLUMNP0luAj1/WgqjvD88uJWi9IOih71Cg0w8JvO/FdD5x+FO3oKb9cesdZmYLl9ePM29eFT7Py9J5pTKbyImitEVm47WthI8ZACL68CpO1dF2HL/39thfnH/l/Z61hcRM5Z5SLtDbwB6bg4qsLSnVMAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
        alt="prefetch不会覆盖"
        title=""
        src="/static/prefetch-warn-259ac63e9dc81f1988d3c134da0eb2e0-acf85.png"
        srcset="/static/prefetch-warn-259ac63e9dc81f1988d3c134da0eb2e0-c1418.png 210w,
/static/prefetch-warn-259ac63e9dc81f1988d3c134da0eb2e0-5d5d8.png 420w,
/static/prefetch-warn-259ac63e9dc81f1988d3c134da0eb2e0-acf85.png 840w,
/static/prefetch-warn-259ac63e9dc81f1988d3c134da0eb2e0-de0cd.png 1260w,
/static/prefetch-warn-259ac63e9dc81f1988d3c134da0eb2e0-bd6c2.png 1680w,
/static/prefetch-warn-259ac63e9dc81f1988d3c134da0eb2e0-6fd6f.png 1710w"
        sizes="(max-width: 840px) 100vw, 840px"
      />
    </span>
  </span>
  
  </a>
    </p>
<p>资源多次加载对用户来说是不好的。 在这种情况下，他们不仅要等待渲染阻止CSS，而且还可能通过两次下载文件来浪费他们的带宽。务必彻底分析您的网络请求，并留意任何相同资源的多次加载！</p>
<p><strong>什么时候该用<code class="gatsby-code-text">&lt;link rel=”preload”&gt;</code>？什么时候又该用<code class="gatsby-code-text">&lt;link rel=”prefetch”&gt;</code> ?</strong></p>
<p><strong>建议：对于当前页面很有必要的资源使用<code class="gatsby-code-text">preload</code>，对于可能在将来的页面中使用的资源使用<code class="gatsby-code-text">prefetch</code>。</strong></p>]]></description><link>https://reactjs.org/blog/2019/01/12/load-priority.html</link><guid isPermaLink="false">https://reactjs.org/blog/2019/01/12/load-priority.html</guid><pubDate>Fri, 11 Jan 2019 16:00:00 GMT</pubDate></item><item><title><![CDATA[FP18：Semigroup]]></title><description><![CDATA[<p>所谓<code class="gatsby-code-text">Semigroup</code>(半群)，其实就是含有concat方法的数据类型，典型的如字符串和数组，看代码：</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">const</span> resStr <span class="token operator">=</span> <span class="token string">'a'</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token string">'b'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token string">'b'</span><span class="token punctuation">)</span> 
<span class="token comment">// => 'abc'</span>

<span class="token keyword">const</span> resArr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment">// => [1,2,3,4,5,6]</span></code></pre>
      </div>
<p>实际上，我们还可以发现一个规律<code class="gatsby-code-text">Semigroup</code>是可以随意的合并操作的，什么意思呢？</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">const</span> resStr <span class="token operator">=</span> <span class="token string">'a'</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token string">'b'</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token string">'b'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// => 'abc'</span>

<span class="token keyword">const</span> resArr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment">// => [1,2,3,4,5,6]</span></code></pre>
      </div>
<p>无论前后的顺序如何，或者无论怎么组合，得到的结果是一致的。
完全类似于数据的加法运算：</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token number">1</span> <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">3</span> 
<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">3</span>
<span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span></code></pre>
      </div>
<p>但是我们却不能直接使用<code class="gatsby-code-text">1.concat(2).concat(3)</code>这样的代码，因为number并没有实现<code class="gatsby-code-text">concat</code>方法，但是我们可以自己简单实现一个Sum的<code class="gatsby-code-text">Semigroup</code>。</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">const</span> <span class="token function-variable function">Sum</span> <span class="token operator">=</span> x <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    x<span class="token punctuation">,</span>
    concat<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> x<span class="token punctuation">:</span> y <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=></span>
        <span class="token function">Sum</span><span class="token punctuation">(</span>x <span class="token operator">+</span> y<span class="token punctuation">)</span><span class="token punctuation">,</span>
    inspect<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span>
        <span class="token template-string"><span class="token string">`Sum(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>x<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
Sum<span class="token punctuation">.</span><span class="token function-variable function">empty</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">Sum</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></code></pre>
      </div>
<p>现在就可以直接这样使用Sum了：</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">const</span> res1 <span class="token operator">=</span> <span class="token function">Sum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token function">Sum</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token function">Sum</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>Sum<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// => Sum(6)</span>
<span class="token keyword">const</span> res2 <span class="token operator">=</span> <span class="token function">Sum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token function">Sum</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token function">Sum</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// => Sum(6)</span></code></pre>
      </div>
<p>Sum的使用场景不是很多，仅仅是为了学习而建立的，下面看几个使用场景比较多的<code class="gatsby-code-text">Semigroup</code></p>
<ul>
<li>
<p>All:</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token boolean">true</span> <span class="token operator">&amp;&amp;</span> <span class="token boolean">true</span>  <span class="token comment">// true</span>
<span class="token boolean">true</span> <span class="token operator">&amp;&amp;</span> <span class="token boolean">false</span> <span class="token comment">// false</span>
<span class="token punctuation">{</span>
<span class="token keyword">const</span> <span class="token function-variable function">All</span> <span class="token operator">=</span> x <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    x<span class="token punctuation">,</span>
    concat<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> x<span class="token punctuation">:</span> y <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=></span>
        <span class="token function">All</span><span class="token punctuation">(</span>x <span class="token operator">&amp;&amp;</span> y<span class="token punctuation">)</span><span class="token punctuation">,</span>
    inspect<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span>
        <span class="token template-string"><span class="token string">`All(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>x<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

All<span class="token punctuation">.</span><span class="token function-variable function">empty</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">All</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token function">All</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token function">All</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>All<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
      </div>
</li>
<li>
<p>First:</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token punctuation">{</span>
<span class="token keyword">const</span> <span class="token function-variable function">First</span> <span class="token operator">=</span> x <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    x<span class="token punctuation">,</span>
    concat<span class="token punctuation">:</span> _ <span class="token operator">=></span>
        <span class="token function">First</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span>
    inspect<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span>
        <span class="token template-string"><span class="token string">`First(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>x<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token function">First</span><span class="token punctuation">(</span><span class="token string">'bob'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token string">'smith'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
      </div>
</li>
<li>
<p>Max &#x26; Min</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token punctuation">{</span>
<span class="token keyword">const</span> <span class="token function-variable function">Max</span> <span class="token operator">=</span> x <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    x<span class="token punctuation">,</span>
    concat<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> x<span class="token punctuation">:</span> y <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=></span>
        <span class="token function">Max</span><span class="token punctuation">(</span>x <span class="token operator">></span> y <span class="token operator">?</span> x <span class="token punctuation">:</span> y<span class="token punctuation">)</span><span class="token punctuation">,</span>
    inspect<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span>
        <span class="token template-string"><span class="token string">`Max(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>x<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

Max<span class="token punctuation">.</span><span class="token function-variable function">empty</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">Max</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">Infinity</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">Min</span> <span class="token operator">=</span> x <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    x<span class="token punctuation">,</span>
    concat<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> x<span class="token punctuation">:</span> y <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=></span>
        <span class="token function">Min</span><span class="token punctuation">(</span>x <span class="token operator">&lt;</span> y <span class="token operator">?</span> x <span class="token punctuation">:</span> y<span class="token punctuation">)</span><span class="token punctuation">,</span>
    inspect<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span>
        <span class="token template-string"><span class="token string">`Min(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>x<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

Min<span class="token punctuation">.</span><span class="token function-variable function">empty</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">Min</span><span class="token punctuation">(</span><span class="token number">Infinity</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
      </div>
</li>
<li>
<p>Either</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">const</span> <span class="token function-variable function">Right</span> <span class="token operator">=</span> x <span class="token operator">=></span>
<span class="token punctuation">(</span><span class="token punctuation">{</span>
    chain<span class="token punctuation">:</span> f <span class="token operator">=></span> <span class="token function">f</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span>
    ap<span class="token punctuation">:</span> other <span class="token operator">=></span> other<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span>
    traverse<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token keyword">of</span><span class="token punctuation">,</span> f<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">f</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>Right<span class="token punctuation">)</span><span class="token punctuation">,</span>
    map<span class="token punctuation">:</span> f <span class="token operator">=></span> <span class="token function">Right</span><span class="token punctuation">(</span><span class="token function">f</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    fold<span class="token punctuation">:</span> <span class="token punctuation">(</span>f<span class="token punctuation">,</span> g<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">g</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span>
    concat<span class="token punctuation">:</span> o <span class="token operator">=></span>
        o<span class="token punctuation">.</span><span class="token function">fold</span><span class="token punctuation">(</span>_ <span class="token operator">=></span> <span class="token function">Right</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span>
            y <span class="token operator">=></span> <span class="token function">Right</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    inspect<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token template-string"><span class="token string">`Right(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>x<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token function-variable function">Left</span> <span class="token operator">=</span> x <span class="token operator">=></span>
<span class="token punctuation">(</span><span class="token punctuation">{</span>
    chain<span class="token punctuation">:</span> f <span class="token operator">=></span> <span class="token function">Left</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span>
    ap<span class="token punctuation">:</span> other <span class="token operator">=></span> <span class="token function">Left</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span>
    traverse<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token keyword">of</span><span class="token punctuation">,</span> f<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">of</span><span class="token punctuation">(</span><span class="token function">Left</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    map<span class="token punctuation">:</span> f <span class="token operator">=></span> <span class="token function">Left</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span>
    fold<span class="token punctuation">:</span> <span class="token punctuation">(</span>f<span class="token punctuation">,</span> g<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">f</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span>
    concat<span class="token punctuation">:</span> o <span class="token operator">=></span>
        o<span class="token punctuation">.</span><span class="token function">fold</span><span class="token punctuation">(</span>_ <span class="token operator">=></span> <span class="token function">Left</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span>
            y <span class="token operator">=></span> o<span class="token punctuation">)</span><span class="token punctuation">,</span>
    inspect<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token template-string"><span class="token string">`Left(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>x<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token function-variable function">fromNullable</span> <span class="token operator">=</span> x <span class="token operator">=></span>
x <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token function">Right</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token function">Left</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token function-variable function">tryCatch</span> <span class="token operator">=</span> f <span class="token operator">=></span> <span class="token punctuation">{</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">Right</span><span class="token punctuation">(</span><span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">Left</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// List from https://github.com/DrBoolean/immutable-ext</span>
<span class="token keyword">const</span> stats <span class="token operator">=</span> List<span class="token punctuation">.</span><span class="token keyword">of</span><span class="token punctuation">(</span><span class="token punctuation">{</span>page<span class="token punctuation">:</span><span class="token string">'home'</span><span class="token punctuation">,</span> view<span class="token punctuation">:</span> <span class="token number">40</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span>page<span class="token punctuation">:</span><span class="token string">'about'</span><span class="token punctuation">,</span> view<span class="token punctuation">:</span> <span class="token number">40</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span>page<span class="token punctuation">:</span><span class="token string">'blog'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
state<span class="token punctuation">.</span><span class="token function">foldMap</span><span class="token punctuation">(</span>x <span class="token operator">=></span> 
    <span class="token function">fromNullable</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>views<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>Sum<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">Right</span><span class="token punctuation">(</span>Sum<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre>
      </div>
</li>
</ul>]]></description><link>https://reactjs.org/blog/2018/12/13/FP18-Semigroup.html</link><guid isPermaLink="false">https://reactjs.org/blog/2018/12/13/FP18-Semigroup.html</guid><pubDate>Wed, 12 Dec 2018 16:00:00 GMT</pubDate></item><item><title><![CDATA[FP17：Transform Naturally]]></title><description><![CDATA[<h3 id="令人生厌的嵌套"><a href="#%E4%BB%A4%E4%BA%BA%E7%94%9F%E5%8E%8C%E7%9A%84%E5%B5%8C%E5%A5%97" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>令人生厌的嵌套</h3>
<p>我想要提出一个关于嵌套的问题。但不是那种马上会唤起老母亲整理打扫天性的那种问题，而是我们马上会在之后的章节中遇到的问题。在任何情况下，我所谓的<em>嵌套</em>是将不同的两个类型套在同一个值上，某种意义上，看上去就像一个全新的类型。</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token function">Right</span><span class="token punctuation">(</span><span class="token function">Maybe</span><span class="token punctuation">(</span><span class="token string">'b'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token constant">IO</span><span class="token punctuation">(</span><span class="token function">Task</span><span class="token punctuation">(</span><span class="token constant">IO</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">[</span><span class="token function">Identity</span><span class="token punctuation">(</span><span class="token string">'bee thousand'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code></pre>
      </div>
<p>现在，我们用一些精心制作的例证来说明仿佛我们已经能够摆脱这些常见的嵌套情形。但是实际上我们编码的时候，不同的类型就像耳机线一样乱成一团，仿佛一种恶魔召唤的邪恶产物。如果我们编码的时候不是一丝不苟地组织正在使用的类型，最后代码会比猫咪咖啡厅的披头族更加难以理解。</p>
<h3 id="一场情景喜剧"><a href="#%E4%B8%80%E5%9C%BA%E6%83%85%E6%99%AF%E5%96%9C%E5%89%A7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>一场情景喜剧</h3>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token comment">// getValue :: Selector -> Task Error (Maybe String)</span>
<span class="token comment">// postComment :: String -> Task Error Comment</span>
<span class="token comment">// validate :: String -> Either ValidationError String</span>

<span class="token comment">// saveComment :: () -> Task Error (Maybe (Either ValidationError (Task Error Comment)))</span>
<span class="token keyword">const</span> saveComment <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span>
  <span class="token function">map</span><span class="token punctuation">(</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token function">map</span><span class="token punctuation">(</span>postComment<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">map</span><span class="token punctuation">(</span><span class="token function">map</span><span class="token punctuation">(</span>validate<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">'#comment'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
      </div>
<p>让类型声明形同虚设的坏家伙们都在这里了。容我稍微解释一下这一段代码。一开始，用<code class="gatsby-code-text">getValue(&#39;#comment&#39;)</code>获取用户输入，这是一个<code class="gatsby-code-text">action</code>，从一个<code class="gatsby-code-text">element</code>中获取文本。但是可能会因为字符串值不存在而获取失败，从而返回<code class="gatsby-code-text">Task Error(Maybe String)</code>。在这之后，我们需要<code class="gatsby-code-text">map</code>所有<code class="gatsby-code-text">Task</code>和<code class="gatsby-code-text">Maybe</code>传递文本到<code class="gatsby-code-text">validate</code>。最后，我们不是得到<code class="gatsby-code-text">ValiadtionError</code>或者想要的<code class="gatsby-code-text">String</code>。然后，从过层层 map，把当前<code class="gatsby-code-text">Task Error(Maybe(Either ValidationError String))</code>中的<code class="gatsby-code-text">String</code>传入<code class="gatsby-code-text">postComment</code>，最后返回<code class="gatsby-code-text">Task</code>的结果。
简直乱得骇人。一大堆抽象类型乱得像一幅业余表现主义的烂作，还混杂着波洛克式的多态，蒙德里安风的大统一。对于这种常见的情况，有许多解决方法。把这些类型编好弄成一个巨大的容器，分类后再<code class="gatsby-code-text">join</code>，将其同化，解构，等等。而重点，就在于通过 <em>Natural Transformations</em> 将他们同化。</p>
<h3 id="全都很自然"><a href="#%E5%85%A8%E9%83%BD%E5%BE%88%E8%87%AA%E7%84%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>全都很自然</h3>
<p><em>Natural Transformations</em>是“functor 之间的态射”，就是，一个操作容器本身的函数。类型上来说，它是个函数<code class="gatsby-code-text">(Functor f, Functor g) =&gt; f a -&gt; g a</code>。让这个函数特殊的是，在任何情况下，都不能得知 functor 中的内容。就像两个党派交换机密文件，都会把东西封在马尼拉纸信封里，戳上“最高机密”。这是一个结构上的操作。functor 外壳的变化。形式上，<em>Natural Transformations</em> 作用于如下功能：</p>
<img width=600 src="images/natural_transformation.png" alt="natural transformation diagram" />
<p>或者代码:</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token comment">// nt :: (Functor f, Functor g) => f a -> g a</span>
<span class="token function">compose</span><span class="token punctuation">(</span><span class="token function">map</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">,</span> nt<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token function">compose</span><span class="token punctuation">(</span>nt<span class="token punctuation">,</span> <span class="token function">map</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
      </div>
<p>两者都体现了同样的东西：我们可以先自然变换再<code class="gatsby-code-text">map</code>，或者先<code class="gatsby-code-text">map</code>再自然变换，结果都是一样的。顺便，在 <a href="ch7.md#free-as-in-theorem">free theorem</a> 中，也提到，自然变换不仅局限于函数和类型（以及 functor）。</p>
<h3 id="有原则的类型转换"><a href="#%E6%9C%89%E5%8E%9F%E5%88%99%E7%9A%84%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>有原则的类型转换</h3>
<p>作为程序员，我们对类型转换十分熟悉。我们经常把<code class="gatsby-code-text">String</code>转换成<code class="gatsby-code-text">Boolean</code>，或者<code class="gatsby-code-text">Integer</code> 转换成<code class="gatsby-code-text">Float</code>（虽然<code class="gatsby-code-text">JavaScript</code>只有<code class="gatsby-code-text">Number</code>）。这些类型之间的区别很简单，这些类型都是一些代数容器，我们手头有一些可以运用的理论。</p>
<p>以下是一些例子：</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token comment">// idToMaybe :: Identity a -> Maybe a</span>
<span class="token keyword">const</span> <span class="token function-variable function">idToMaybe</span> <span class="token operator">=</span> x <span class="token operator">=></span> Maybe<span class="token punctuation">.</span><span class="token keyword">of</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>$value<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// idToIO :: Identity a -> IO a</span>
<span class="token keyword">const</span> <span class="token function-variable function">idToIO</span> <span class="token operator">=</span> x <span class="token operator">=></span> <span class="token constant">IO</span><span class="token punctuation">.</span><span class="token keyword">of</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>$value<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// eitherToTask :: Either a b -> Task a b</span>
<span class="token keyword">const</span> eitherToTask <span class="token operator">=</span> <span class="token function">either</span><span class="token punctuation">(</span>Task<span class="token punctuation">.</span>rejected<span class="token punctuation">,</span> Task<span class="token punctuation">.</span><span class="token keyword">of</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// ioToTask :: IO a -> Task () a</span>
<span class="token keyword">const</span> <span class="token function-variable function">ioToTask</span> <span class="token operator">=</span> x <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name">Task</span><span class="token punctuation">(</span><span class="token punctuation">(</span>reject<span class="token punctuation">,</span> resolve<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span><span class="token function">unsafePerform</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// maybeToTask :: Maybe a -> Task () a</span>
<span class="token keyword">const</span> <span class="token function-variable function">maybeToTask</span> <span class="token operator">=</span> x <span class="token operator">=></span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>isNothing <span class="token operator">?</span> Task<span class="token punctuation">.</span><span class="token function">rejected</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> Task<span class="token punctuation">.</span><span class="token keyword">of</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>$value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// arrayToMaybe :: [a] -> Maybe a</span>
<span class="token keyword">const</span> <span class="token function-variable function">arrayToMaybe</span> <span class="token operator">=</span> x <span class="token operator">=></span> Maybe<span class="token punctuation">.</span><span class="token keyword">of</span><span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
      </div>
<p>看到了吗？这些只是从一个 functor 换到了另一个。在转换过程中的数据丢失是被允许的，只要要被<code class="gatsby-code-text">map</code>的数据在转换（shape shift shuffle）中不会消失即可。这就是重点，<code class="gatsby-code-text">map</code>必须以定义执行，就算在转换之后。</p>
<p>从另一个角度来看，转换的是某个作用（effects）。由此可以认为，<code class="gatsby-code-text">ioToTask</code>就是从同步到异步的转换，和<code class="gatsby-code-text">arrayToMaybe</code>是从非确定性到可能失败。要注意的是，在<code class="gatsby-code-text">JavaScript</code> 里，并不能把异步变到同步，无法实现<code class="gatsby-code-text">taskToIO</code>方法，那是个”超自然”变换。</p>
<h3 id="方法狂-feature-envy"><a href="#%E6%96%B9%E6%B3%95%E7%8B%82-feature-envy" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>方法狂 Feature Envy</h3>
<p>假设要使用一些其他类型的方法（feature），比如对一个<code class="gatsby-code-text">List</code>进行<code class="gatsby-code-text">sortBy</code>。<em>Natural Transformations</em> 提供了变换为目标类型的巧妙方式，只要该类型支持<code class="gatsby-code-text">map</code>操作。</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token comment">// arrayToList :: [a] -> List a</span>
<span class="token keyword">const</span> arrayToList <span class="token operator">=</span> List<span class="token punctuation">.</span><span class="token keyword">of</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> doListyThings <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span><span class="token function">sortBy</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">filter</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span><span class="token punctuation">,</span> arrayToList<span class="token punctuation">,</span> <span class="token function">map</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> doListyThings_ <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span><span class="token function">sortBy</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">filter</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">map</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">,</span> arrayToList<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// law applied</span></code></pre>
      </div>
<p>捏一把鼻子，颠三下魔杖，放进<code class="gatsby-code-text">arrayToList</code>，当当当当，<code class="gatsby-code-text">[a]</code>变成了<code class="gatsby-code-text">List a</code>，甚至还可以对其<code class="gatsby-code-text">sortBy</code>。</p>
<p>此外，如<code class="gatsby-code-text">doListyThings_</code>所示，将映射操作<code class="gatsby-code-text">map(f)</code>移到 <em>Natural Transformations</em> 的左边，更加容易实现函数的优化或者复合。</p>
<h3 id="同构的-javascript-isomorphic-javascript"><a href="#%E5%90%8C%E6%9E%84%E7%9A%84-javascript-isomorphic-javascript" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>同构的 JavaScript Isomorphic JavaScript</h3>
<p>当把一个值前后怎么转换都不会丢失任何数据时，可称之为 <em>同构 Isomorphic</em> 。看上去挺高大上，不过就是“保持相同的数据”而已。如果两个类型在 <em>Natural Transformations</em> 中既可以<code class="gatsby-code-text">to</code>也可以<code class="gatsby-code-text">from</code> ，就被称之为是 <em>同构 Isomorphic</em> ，证明如下：</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token comment">// promiseToTask :: Promise a b -> Task a b</span>
<span class="token keyword">const</span> <span class="token function-variable function">promiseToTask</span> <span class="token operator">=</span> x <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name">Task</span><span class="token punctuation">(</span><span class="token punctuation">(</span>reject<span class="token punctuation">,</span> resolve<span class="token punctuation">)</span> <span class="token operator">=></span> x<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span>reject<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// taskToPromise :: Task a b -> Promise a b</span>
<span class="token keyword">const</span> <span class="token function-variable function">taskToPromise</span> <span class="token operator">=</span> x <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=></span> x<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span>reject<span class="token punctuation">,</span> resolve<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> x <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'ring'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">taskToPromise</span><span class="token punctuation">(</span><span class="token function">promiseToTask</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">===</span> x<span class="token punctuation">;</span>

<span class="token keyword">const</span> y <span class="token operator">=</span> Task<span class="token punctuation">.</span><span class="token keyword">of</span><span class="token punctuation">(</span><span class="token string">'rabbit'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">promiseToTask</span><span class="token punctuation">(</span><span class="token function">taskToPromise</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">===</span> y<span class="token punctuation">;</span></code></pre>
      </div>
<p>证毕。</p>
<p><code class="gatsby-code-text">Promise</code>与<code class="gatsby-code-text">Task</code>是 <em>同构 Isomorphic</em> 。也可以实现方法<code class="gatsby-code-text">listToArray</code>使之与<code class="gatsby-code-text">arrayToList</code>构成  <em>同构Isomorphism</em>。反之，与 <code class="gatsby-code-text">arrayToMaybe</code>无法 <em>同构 Isomorphism</em>，因为转换时有数据丢失。</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token comment">// maybeToArray :: Maybe a -> [a]</span>
<span class="token keyword">const</span> <span class="token function-variable function">maybeToArray</span> <span class="token operator">=</span> x <span class="token operator">=></span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>isNothing <span class="token operator">?</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token punctuation">[</span>x<span class="token punctuation">.</span>$value<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// arrayToMaybe :: [a] -> Maybe a</span>
<span class="token keyword">const</span> <span class="token function-variable function">arrayToMaybe</span> <span class="token operator">=</span> x <span class="token operator">=></span> Maybe<span class="token punctuation">.</span><span class="token keyword">of</span><span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> x <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'elvis costello'</span><span class="token punctuation">,</span> <span class="token string">'the attractions'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// 不 isomorphic</span>
<span class="token function">maybeToArray</span><span class="token punctuation">(</span><span class="token function">arrayToMaybe</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ['elvis costello']</span>

<span class="token comment">// 但是是一个 natural transformation</span>
<span class="token function">compose</span><span class="token punctuation">(</span>arrayToMaybe<span class="token punctuation">,</span> <span class="token function">map</span><span class="token punctuation">(</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">'elvis'</span><span class="token punctuation">,</span> <span class="token string">'lou'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Just('lou costello')</span>
<span class="token comment">// ==</span>
<span class="token function">compose</span><span class="token punctuation">(</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">'elvis'</span><span class="token punctuation">,</span> <span class="token string">'lou'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> arrayToMaybe<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Just('lou costello')</span></code></pre>
      </div>
<p>这就是 <em>Natural Transformations</em>，然而，因为两边的<code class="gatsby-code-text">map</code>都得到相同的结果。行文到本章的一半，似乎已经将 <em>Isomorphic</em> 说的差不多了，但是可别被这些表象所迷惑，真正的 <em>Isomorphic</em> 比我们想象的要广泛，有用的多。话不多说，让我们继续。</p>
<h3 id="更加宽泛的定义"><a href="#%E6%9B%B4%E5%8A%A0%E5%AE%BD%E6%B3%9B%E7%9A%84%E5%AE%9A%E4%B9%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>更加宽泛的定义</h3>
<p>这些结构函数绝不仅仅局限于类型转换。
以下是一些不同的例子：</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code class="gatsby-code-jsx">reverse <span class="token punctuation">:</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>a<span class="token punctuation">]</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">[</span>a<span class="token punctuation">]</span>

join <span class="token punctuation">:</span><span class="token punctuation">:</span> <span class="token punctuation">(</span>Monad m<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">m</span> <span class="token punctuation">(</span>m a<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> m a

head <span class="token punctuation">:</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>a<span class="token punctuation">]</span> <span class="token operator">-</span><span class="token operator">></span> a

<span class="token keyword">of</span> <span class="token punctuation">:</span><span class="token punctuation">:</span> a <span class="token operator">-</span><span class="token operator">></span> f a</code></pre>
      </div>
<p>Natural Transformations 的法则同样适用于上述方法。其中可能让你有点疑惑的是，<code class="gatsby-code-text">head :: [a] -&gt; a</code>可以被看做成<code class="gatsby-code-text">head :: [a] -&gt; Identity a</code>。在其中的任何地方，都可以插入<code class="gatsby-code-text">Identity</code>，因为<code class="gatsby-code-text">a</code>与<code class="gatsby-code-text">Identity a</code>为 Isomorphic。（看，我说过 <em>Isomorphic</em> 用途很广泛吧）</p>
<h3 id="实现单层嵌套的方法"><a href="#%E5%AE%9E%E7%8E%B0%E5%8D%95%E5%B1%82%E5%B5%8C%E5%A5%97%E7%9A%84%E6%96%B9%E6%B3%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实现单层嵌套的方法</h3>
<p>回到之前的场景。在其中试试 <em>Natural Transformations</em>，使调用中的各个类型统一化，从而可以将函数<code class="gatsby-code-text">join</code>起来。</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token comment">// getValue :: Selector -> Task Error (Maybe String)</span>
<span class="token comment">// postComment :: String -> Task Error Comment</span>
<span class="token comment">// validate :: String -> Either ValidationError String</span>

<span class="token comment">// saveComment :: () -> Task Error Comment</span>
<span class="token keyword">const</span> saveComment <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span>
  <span class="token function">chain</span><span class="token punctuation">(</span>postComment<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">chain</span><span class="token punctuation">(</span>eitherToTask<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">map</span><span class="token punctuation">(</span>validate<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">chain</span><span class="token punctuation">(</span>maybeToTask<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">'#comment'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
      </div>
<p>这里具体的操作仅仅加入了<code class="gatsby-code-text">chain(maybeToTask)</code>和<code class="gatsby-code-text">chain(eigherToTack)</code>。都是同样的效果。在<code class="gatsby-code-text">join</code>时很自然的将<code class="gatsby-code-text">Task</code>的 functor 转换到另一个<code class="gatsby-code-text">Task</code>的 functor。就像窗边的尖刺驱鸟器，从源头扼杀了嵌套。就像他们巴黎（city of the light）人说的：“Mieux vaut prévenir que guérir” - 花一英镑去治疗不如花一盎司用于预防。</p>
<h3 id="小结"><a href="#%E5%B0%8F%E7%BB%93" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结</h3>
<p><em>Natural Transformations</em>是操作 functor 的方法。在范畴学中是非常重要的概念，特别是采用多种抽象化机制时，就会用的更多。上述例子，仅仅局限于几个具体的应用中。如上文所言，只要转换类型时,确保可组合性，即可以实现所需要的不同作用 effects。同时可以解决嵌套问题，虽然会将类型同化到最低的共同母类（lowest common denominator），在实际应用中，一般是作用最易变的函子（通常是<code class="gatsby-code-text">Task</code> ）（functor with most volatile effects）。</p>
<p>这种连续而冗长的类型是实现的代价 - 从以太中召唤而来。当然，隐式作用（implicit effects）更有潜在风险，所以也算是合理的方案。不过,如果想归并大量类型，还需要更多的工具。之后，我们将通过 <em>Traverable</em> 讨论重组类型。</p>]]></description><link>https://reactjs.org/blog/2018/12/11/FP17-Transform-Naturally.html</link><guid isPermaLink="false">https://reactjs.org/blog/2018/12/11/FP17-Transform-Naturally.html</guid><pubDate>Mon, 10 Dec 2018 16:00:00 GMT</pubDate></item><item><title><![CDATA[How JavaScript Work: 引擎、运行时、调用栈概述]]></title><description><![CDATA[<ul>
<li>
<p><a href="https://juejin.im/post/5c090bd9e51d45242973cad2">JavaScript 如何工作系列: 引擎、运行时、调用栈概述</a></p>
</li>
<li>
<p><a href="https://juejin.im/post/5a102e656fb9a044fd1158c6">JavaScript 如何工作：在 V8 引擎里 5 个优化代码的技巧</a></p>
</li>
<li>
<p><a href="https://juejin.im/post/5a2559ae6fb9a044fe4634ba">JavaScript 工作原理：内存管理 + 处理常见的4种内存泄漏</a></p>
</li>
<li>
<p><a href="https://juejin.im/post/5a221d35f265da43356291cc">JavaScript 如何工作的: 事件循环和异步编程的崛起 + 5 个关于如何使用 async/await 编写更好的技巧</a></p>
</li>
<li>
<p><a href="https://juejin.im/entry/5a731a955188257a6d634f3e">Event Loop</a></p>
</li>
<li>
<p><a href="https://zhuanlan.zhihu.com/p/55511602?utm_source=wechat_session&#x26;utm_medium=social&#x26;utm_oi=880452006622420992">Event Loop in Node</a></p>
</li>
<li>
<p><a href="https://github.com/xitu/gold-miner/blob/master/TODO/how-javascript-works-deep-dive-into-websockets-and-http-2-with-sse-how-to-pick-the-right-path.md">JavaScript 是如何工作的：深入剖析 WebSockets 和拥有 SSE 技术 的 HTTP/2，以及如何在二者中做出正确的选择</a></p>
</li>
<li>
<p><a href="https://github.com/xitu/gold-miner/blob/master/TODO1/how-javascript-works-the-rendering-engine-and-tips-to-optimize-its-performance.md">JavaScript 是如何工作的：渲染引擎和性能优化技巧</a></p>
</li>
</ul>
<p>JavaScript 越来越流行，在前端、后端、hybrid apps、嵌入式设备开发等方向上都有它活跃的身影。
这篇文章是 How JavaScript Works 系列的开篇，该系列的文章旨在深入挖掘 JavaScript 及其实际的工作原理。我们认为了解 JavaScript 的构建块及其共同作用，可以帮助我们写出更优雅、更高效的代码和应用。
正如 GitHut stats 所展示的一样，JavaScript 各方面的统计数据都是棒棒哒，顶多也就在个别统计项上落后了其他语言那么一丢丢。</p>
<p>如果项目深度依赖 JavaScript，这意味着开发者需要对底层有极其深入的了解，并利用语言和生态提供的一切东西来构建出色的应用。</p>
<p>然而，事实上，很多开发者虽然每天都在使用 JavaScript，却对其背后发生的事情一无所知。</p>
<h3 id="概述"><a href="#%E6%A6%82%E8%BF%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>概述</h3>
<p>几乎每个人都听说过 V8 引擎的概念，大多数人也都知道 JavaScript 是一门单线程语言或者知道它是基于回调队列的。</p>
<p>在这篇文章中，我们将详细的介绍这些概念并且解释 JavaScript 实际的运行方式，通过对这些细节的了解，你可以写出更好、无阻塞的应用。</p>
<p>如果你是一名 JavaScript 新手，这篇文章将帮助你理解为什么 JavaScript 和其它语言对比起来显得那么”奇怪”。</p>
<p>如果你是一名老司机，希望能够为你带来一些对 JavaScript 运行时的新思考。</p>
<h3 id="javascript-引擎"><a href="#javascript-%E5%BC%95%E6%93%8E" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>JavaScript 引擎</h3>
<p>说起 JavaScript 引擎，不得不提的就是 Google 的 V8 引擎，Chrome 和 Nodejs 内部也是使用的 V8。这里有一个简单的视图：</p>
<p>
  <a
    class="gatsby-resp-image-link"
    href="/static/V8-4d5a7011a294a4858925defb02b2579c-e663a.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block; ; max-width: 840px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 75.22211253701876%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABrklEQVQ4y5WSS0/CQBDH/Uwe/ARe/Goe8eTVeJILSqxNxVewkdDaIKU2aqKGVmwLEW0oLH3wd3fRimh5bDLZ2Z2Z38zuzApmrNFoNN6/ZPIua63Mg0XkBaOBChAVcdhObVngGcCYVxV396Adb+Byfx3hR+nHNg84mZXrScT1wN3FTm4N25urIF1xbKe2Sd9M4G+H8U78Kt6tLfh2DsOekdqmC/j3yd+GMAwxGBAQQqie/Kqg3+9zQUaT/lQYxzEuzs8gCgdURBwdCgiCHvpUJEmCIAgoFAool8uIoii7wu/Ltufi9ELGgwN0B28w7g2YtyZarRYUReE+SZJA0zQ0m830PBNYrijwPoCztoSSKeHx7hGvzivq9Xrq22g0FgO6joPrhg5Yz4BWg93pwKDBnufxZ7LdoT6VSgW2bS8AdF0oqjru8pDAsl9gGAYHybKMDk3A9KWAev0GJ1d0Bof0H9/aKVCliYIggO/7/A8ty5oPZIGieIQb3cbTk0UbUeVAliifz3MQa06xWOSNmgtko8AApqnTv9N5I9jcsZlkMHau1Wq8KWzEFhrsZdZ0zCfxunmcDBbmwQAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
        alt="V8"
        title=""
        src="/static/V8-4d5a7011a294a4858925defb02b2579c-acf85.png"
        srcset="/static/V8-4d5a7011a294a4858925defb02b2579c-c1418.png 210w,
/static/V8-4d5a7011a294a4858925defb02b2579c-5d5d8.png 420w,
/static/V8-4d5a7011a294a4858925defb02b2579c-acf85.png 840w,
/static/V8-4d5a7011a294a4858925defb02b2579c-e663a.png 1013w"
        sizes="(max-width: 840px) 100vw, 840px"
      />
    </span>
  </span>
  
  </a>
    </p>
<p>就如JVM虚拟机一样，JS引擎中也有堆(Memory Heap)和栈(Call Stack)的概念。</p>
<ul>
<li>
<p>栈-用来存储方法调用的地方，以及基础数据类型(如var a = 1)也是存储在栈里面的，会随着方法调用结束而自动销毁掉(入栈—>方法调用后—>出栈)。</p>
</li>
<li>
<p>堆-JS引擎中给对象分配的内存空间是放在堆中的。如var foo = {name: ‘foo’} 那么这个foo所指向的对象是存储在堆中的。</p>
</li>
</ul>
<p>此外，JS中存在闭包的概念，对于基本类型变量如果存在与闭包当中，那么也将存储在堆中。详细可见此处1,3</p>
<p>关于闭包的情况，就涉及到Captured Variables。我们知道Local Variables是最简单的情形，是直接存储在栈中的。而Captured Variables是对于存在闭包情况和with,try catch情况的变量。</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">function</span> <span class="token function">foo</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> x<span class="token punctuation">;</span> <span class="token comment">// local variables</span>
  <span class="token keyword">var</span> y<span class="token punctuation">;</span> <span class="token comment">// captured variable, bar中引用了y</span>

  <span class="token keyword">function</span> <span class="token function">bar</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// bar 中的context会capture变量y</span>
    <span class="token function">use</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> bar<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
      </div>
<p>复制代码如上述情况，变量y存在与bar()的闭包中，因此y是captured variable，是存储在堆中的。</p>
<h3 id="runtime"><a href="#runtime" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>RunTime</h3>
<p>JS在浏览器中可以调用浏览器提供的API，如window对象，DOM相关API等。这些接口并不是由V8引擎提供的，是存在与浏览器当中的。因此简单来说，对于这些相关的外部接口，可以在运行时供JS调用，以及JS的事件循环(Event Loop)和事件队列(Callback Queue)，把这些称为RunTime。有些地方也把JS所用到的core lib核心库也看作RunTime的一部分。</p>
<p>
  <a
    class="gatsby-resp-image-link"
    href="/static/RunTime-b8b9d51ed2ef32832a63c4430eb8a323-18f60.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block; ; max-width: 840px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 74.7534516765286%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACnElEQVQ4y5VTTW8SURSdf+KPcuEPcNFEV2o0ummbGjdqdOfGjXGh0USMGhMoFmgpXwPD90dLFRAsAsMwhWEoMAzHex8dShM16U1O3ps7M+eed+95Ei4R8/n8wt555MW25yInjcdjaJqGXq93Bp2edbE6OX4/mUxWiBxim4jGtFrLQtLu7i7C4TCSySQSioJEIoZMOgZFkWmvIJVKIRQKIRKJLChsW2hSNRuFgz6U1DHyJQ2VnxY0fQZJluULx7L116goNzDpuS4cT6Fiq/Hi1QmurbVw84GGtXsqrl7/jXefDEixWAyjkXlW2UYleQvPN67gMPFwUWA2g2EYQikfPZPJQe008MV7itsbHaw/6WLrmYb7j7r4FjQhRaNRTKfTZeWx7kf/+CWmg+h5jvrMCi3LwnA4oswM7z8buLOpYv2xhs2nGu5uqfD4iZA/7HQ6qFR+4Oj7EfQTU5CY5hSFQgGlUkkMhhWuRlQ5xRvXAK6vBj4Q3n4cIFscQ+KGB/f3ISdSKKTzkKkF/b4OWY4hm80il8uBBxePx52OCov8KySv14NgKIq6AcRNBeFkCPVaXShzgosyzr24ILUswuwcnJO829uIp9NAqw3tMIHUQQG/Go3lEBh+v39pm7+ZfDVHCr2IUx/nBhnUnCBfLKJBhOxLVVXR7Xbh8/mEV9kJDjhm5AAeFMPJSR7PNpJk4giJPCXDF4s51Go1QajrusDOzg72qc+stt1uL28Nv+OBcuHhcLgg3NvbAyOfKxLy4mj8MhgMgi3FPnW73aJAvV4nH2bItyNUq1XR53K5LMCOaDabC0L+OczTppUJuH9MzNPlXCAQAN+owWAgFHKv2Eq8Z3WMVqtF7uhDYvl8E1gVg/f8I6+maQrwftX8/4s/8K9LoLGupMYAAAAASUVORK5CYII='); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
        alt="V8"
        title=""
        src="/static/RunTime-b8b9d51ed2ef32832a63c4430eb8a323-acf85.png"
        srcset="/static/RunTime-b8b9d51ed2ef32832a63c4430eb8a323-c1418.png 210w,
/static/RunTime-b8b9d51ed2ef32832a63c4430eb8a323-5d5d8.png 420w,
/static/RunTime-b8b9d51ed2ef32832a63c4430eb8a323-acf85.png 840w,
/static/RunTime-b8b9d51ed2ef32832a63c4430eb8a323-18f60.png 1014w"
        sizes="(max-width: 840px) 100vw, 840px"
      />
    </span>
  </span>
  
  </a>
    </p>
<p>同样，在Node.js中，可以把Node的各种库提供的API称为RunTime。所以可以这么理解，Chrome和Node.js都采用相同的V8引擎，但拥有不同的运行环境(RunTime Environments)</p>
<h3 id="call-stack"><a href="#call-stack" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Call Stack</h3>
<p>JS被设计为单线程运行的，这是因为JS主要用来实现很多交互相关的操作，如DOM相关操作，如果是多线程会造成复杂的同步问题(例如当两个线程同时操作同一个DOM元素的时候该如何处理)。因此JS自诞生以来就是单线程的，而且主线程都是用来进行界面相关的渲染操作 (为什么说是主线程，因为HTML5 提供了Web Worker，独立的一个后台JS，用来处理一些耗时数据操作。因为不会修改相关DOM及页面元素，因此不影响页面性能)，如果有阻塞产生会导致浏览器卡死。</p>
<p>如果一个递归调用没有终止条件，是一个死循环的话，会导致调用栈内存不够而溢出，如：</p>
<div class="gatsby-highlight">
      <pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
      </div>
<p>例子中foo函数循环调用其本身，且没有终止条件，浏览器控制台输出调用栈达到最大调用次数。</p>
<p>JS线程如果遇到比较耗时操作，如读取文件，AJAX请求操作怎么办？这里JS用到了Callback回调函数来处理。
对于Call Stack中的每个方法调用，都会形成它自己的一个执行上下文Execution Context，关于执行上下文的详细阐述请看<a href="https://juejin.im/post/5a5ee28f6fb9a01cbe655860">这篇文章</a></p>]]></description><link>https://reactjs.org/blog/2018/11/12/overview-of-the-engine-the-runtime-the-call-stack.html</link><guid isPermaLink="false">https://reactjs.org/blog/2018/11/12/overview-of-the-engine-the-runtime-the-call-stack.html</guid><pubDate>Sun, 11 Nov 2018 16:00:00 GMT</pubDate></item></channel></rss>