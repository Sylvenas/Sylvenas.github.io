{"componentChunkName":"component---src-templates-blog-template-js","path":"/blog/2020/01/18/abort-controller.html","result":{"data":{"markdownRemark":{"html":"<h3>应用场景</h3>\n<p>现在前端主流的技术方案都是<a href=\"https://www.freecodecamp.org/news/what-exactly-is-client-side-rendering-and-hows-it-different-from-server-side-rendering-bd5c786b340d/\">服务端渲染</a>，那就面临着一个问题，Node.js需要承担接口转发的任务，所以原来的<a href=\"https://www.freecodecamp.org/news/what-exactly-is-client-side-rendering-and-hows-it-different-from-server-side-rendering-bd5c786b340d/\">客户端渲染</a>的<code class=\"language-text\">http</code>请求的路线(brower -> server),需要调整为(Node.js -> server);看上去没有什么本质的区别，无非是原来是又浏览器发起请求，现在改为Node.js发起请求。</p>\n<p>但是高并发呢？举个例子，假如有1000000个请求，原来从browser请求到server,server端如果没有做限流处理，那么部分请求就会一直处于<code class=\"language-text\">pendding</code>状态；但是1000000个<code class=\"language-text\">pendding</code>是分布在每个客户端上的，所以并没有什么压力；但是如果是Node.js发起的请求，则会出现很大一部分请求在Node.js端处于<code class=\"language-text\">pendding</code>状态，则会导致Node.js的CPU和内存占用压力剧增。</p>\n<h3>Promise timeout方案</h3>\n<p>前端<code class=\"language-text\">http</code>请求的代码一般会添加一个<code class=\"language-text\">timeout</code>的时间限制，配合<code class=\"language-text\">Promise.race</code>大概的代码思路是：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">timeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> ms <span class=\"token operator\">=</span> <span class=\"token number\">2000</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n                code<span class=\"token operator\">:</span> <span class=\"token number\">999</span><span class=\"token punctuation\">,</span>\n                msg<span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\"> 调用接口超时: ></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>ms<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">ms</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> ms<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\nPromise<span class=\"token punctuation\">.</span><span class=\"token function\">race</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> option<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">timeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>\n        <span class=\"token parameter\">res</span> <span class=\"token operator\">=></span> res<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token parameter\">err</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n            console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'请求失败'</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">return</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">reject</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n                code<span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n                msg<span class=\"token operator\">:</span> <span class=\"token string\">'加载失败'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">)</span></code></pre></div>\n<p>上面的代码很简单，借助<code class=\"language-text\">Promise.race</code>,如果期望的fetch请求在2000ms内没有返回，则timeout中的<code class=\"language-text\">promise</code>会进入<code class=\"language-text\">rejected</code>状态，导致整个promise reject,相当于正常的fetch请求我们不会继续处理，直接抛弃了。</p>\n<p>但是事实如此吗？这个被我们抛弃的Promise实际上依然处于<code class=\"language-text\">pendding</code>状态，直到http请求结束，promise进入<code class=\"language-text\">resolve or reject</code>状态，下图可见，错误日志已经打印出来了，但是http依然处于<code class=\"language-text\">pendding</code>的状态；可见<code class=\"language-text\">Promise.race</code>并不能真正的\"抛弃请求\"。内存占用，cpu占用依然存在。</p>\n<p><img src=\"../../images/promise-timeout.jpg\" alt=\"promise-timeout\"></p>\n<p>上面的例子是发生在browser,问题不大，因为通常一个页面请求不会超过10个，对于单个用户机器来说，性能完全没有什么问题。</p>\n<p><strong>但是如果上述事件是发生在Node.js请求server的过程中呢？大量的请求堆积在Node.js端，导致机器cpu或者内存占满，别忘了我们是服务端渲染，这个时候，用户打开页面将会异常缓慢(肯本没有机会继续处理页面渲染了)，或者长时间的等待之后502</strong>。</p>\n<blockquote>\n<p>上面的例子是在云音乐项目中实际案例。</p>\n</blockquote>\n<p>所以我们需要找到另外一种解决方案(能真正取消fetch请求的方案)，此时<code class=\"language-text\">[AbortController](https://developer.mozilla.org/en-US/docs/Web/API/AbortController)</code>映入眼帘。</p>\n<h3>AbortController使用方法</h3>\n<p>使用方法很简单，直接看文档。\n<a href=\"https://developer.mozilla.org/en-US/docs/Web/API/AbortController\">MDN文档</a><br>\n<a href=\"https://developers.google.com/web/updates/2017/09/abortable-fetch\">Google Developers: abortable-fetch</a></p>\n<p>现在我们已经确定<code class=\"language-text\">AbortController</code>可以真正的取消请求，但是对性能的影响呢？下面我们做个实验：</p>\n<h3>使用AbortController取消 Node.js -> java server的请求</h3>\n<h4>测试代码：</h4>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> fetch <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'node-fetch'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> AbortController <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'abort-controller'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">App</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> controller <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">AbortController</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> signal <span class=\"token operator\">=</span> controller<span class=\"token punctuation\">.</span>signal<span class=\"token punctuation\">;</span>\n    Promise<span class=\"token punctuation\">.</span><span class=\"token function\">race</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token function\">fetchInterface</span><span class=\"token punctuation\">(</span>signal<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">timeout</span><span class=\"token punctuation\">(</span>controller<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">res</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// console.log('请求成功')</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token parameter\">err</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">//console.log('请求失败')</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">timeout</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">controller</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> ms <span class=\"token operator\">=</span> <span class=\"token number\">2000</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">// 是否取消请求</span>\n            controller<span class=\"token punctuation\">.</span><span class=\"token function\">abort</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n                code<span class=\"token operator\">:</span> <span class=\"token number\">999</span><span class=\"token punctuation\">,</span>\n                msg<span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\"> 调用接口超时: ></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>ms<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">ms</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> ms<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">fetchInterface</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">signal</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token string\">'http://xx.xx.xx.xx:xxxx/fiveseconds'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n        signal\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">response</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">// handle success</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">error</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">// handle error</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n\n<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> index <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> index <span class=\"token operator\">&lt;</span> <span class=\"token number\">10000</span><span class=\"token punctuation\">;</span> index<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">App</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// 全部延迟到6s之后关闭进程</span>\n<span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'测试结束'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">6000</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h4>Node.js 进程性能监控</h4>\n<h5>监控工具</h5>\n<p>Node.js 版本 - v10.16.3<br>\n<a href=\"https://github.com/nearform/node-clinic\">node-clinic</a></p>\n<p>测试命令：<code class=\"language-text\">clinic doctor -- node abort.js</code></p>\n<h5>测试方法</h5>\n<p>在Node.js端连续发起<strong>10000</strong>次(<del>再多电脑散热器要揭竿而起</del>)fetch请求,请求随机延迟0-5秒之后响应；</p>\n<p>设置2s的超时期限；分别测试2s之后，取消请求与不取消请求的差别下Node.js进程的性能对比；</p>\n<blockquote>\n<p>最后采用<code class=\"language-text\">setTimeout 6s</code>的原因是全部延迟Node.js进程到6s之后结束,取消请求会导致2s后进程关闭，后面的性能数据无法继续采集</p>\n</blockquote>\n<h6>测试结果</h6>\n<ul>\n<li>\n<p>不取消请求的结果</p>\n<ul>\n<li>相同点：2s之后<code class=\"language-text\">Promise.race</code>返回的promise毫无疑问处于rejected状态</li>\n<li><strong>不同点：2s之后，原来发起的请求，依然处于pending状态，Node.js进程并未结束，需等待所有异步请求结束之后才会结束进程</strong></li>\n</ul>\n</li>\n<li>\n<p>取消请求的结果</p>\n<ul>\n<li>相同点：2s之后<code class=\"language-text\">Promise.race</code>返回的promise毫无疑问处于rejected状态</li>\n<li><strong>不同点：2s之后，原来发起的请求，处于canceled状态，Node.js进程结束</strong></li>\n</ul>\n</li>\n<li>\n<p>性能图对比：</p>\n<ul>\n<li>不取消请求\n<ul>\n<li>cpu持续占用，最高600%</li>\n<li>内存逐渐小幅度增加，最高252MB</li>\n<li>active handles到结束逐渐减少</li>\n</ul>\n</li>\n</ul>\n<p><img src=\"../../images/%E4%B8%8D%E5%8F%96%E6%B6%88%E8%AF%B7%E6%B1%82.png\" alt=\"不取消请求\"></p>\n<ul>\n<li>取消请求\n<ul>\n<li>2s内cpu持续占用，最高355%，2s后极速降低为0</li>\n<li>2s内内存逐渐小幅度增加，最高248MB，2后极速降低到133MB</li>\n<li>active handles 2s后极速降低到0</li>\n</ul>\n</li>\n</ul>\n<p><img src=\"../../images/%E5%8F%96%E6%B6%88%E8%AF%B7%E6%B1%82.png\" alt=\"取消请求\"></p>\n</li>\n</ul>\n<blockquote>\n<p>CPU占用超过100%的原因JS为单线程，但是Node.js为多线程，Node.js会启用其他线程进行垃圾回收，性能优化等等,所以CPU占用是一个综合之后的数据</p>\n</blockquote>\n<h3>node-fetch timeout</h3>\n<p>现在在Node.js端做转发请求一般会使用<a href=\"https://github.com/node-fetch/node-fetch\">node-fetch</a>库，node-fetch本身实现了<code class=\"language-text\">timeout</code>的option，node-fetch <code class=\"language-text\">timeout</code>的实现原理如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span>timeout<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    req<span class=\"token punctuation\">.</span><span class=\"token function\">once</span><span class=\"token punctuation\">(</span><span class=\"token string\">'socket'</span><span class=\"token punctuation\">,</span> <span class=\"token parameter\">socket</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        reqTimeout <span class=\"token operator\">=</span> <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">FetchError</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">network timeout at: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>request<span class=\"token punctuation\">.</span>url<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span> <span class=\"token string\">'request-timeout'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token function\">finalize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">.</span>timeout<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>node-fetch并不推荐使用<code class=\"language-text\">timeout</code>，而是建议使用标准的<code class=\"language-text\">AbortController</code>来控制超时：</p>\n<ul>\n<li><a href=\"https://github.com/node-fetch/node-fetch#request-cancellation-with-abortsignal\">node-fetch timeout vs abortsignal</a></li>\n<li><a href=\"https://stackoverflow.com/questions/54204342/node-fetch-why-is-signal-recommended-over-timeout\">建议使用AbortController的原因</a></li>\n</ul>\n<h3>结论</h3>\n<p>引入<a href=\"https://www.npmjs.com/package/abort-controller\"><code class=\"language-text\">abort-controller</code></a> polyfill包 <strong>3kb</strong>，还是值得的,周下载量超过200万，应该是挺多人在使用。</p>","excerpt":"应用场景 现在前端主流的技术方案都是服务端渲染，那就面临着一个问题，Node.js需要承担接口转发的任务，所以原来的客户端渲染的请求的路线(brower -> server),需要调整为(Node.js -> server);看上去没有什么本质的区别，无非是原来是又浏览器发起请求，现在改为Node.js发起请求。 但是高并发呢？举个例子，假如有1000000个请求，原来从browser请求到server,server端如果没有做限流处理，那么部分请求就会一直处于状态；但是100000…","fields":{"slug":"/blog/2020/01/18/abort-controller.html","date":"January 17, 2020"},"frontmatter":{"title":"Abort-Controller","img":"./img/2016-09-23.jpeg","author":["Sylvenas"],"categories":"http"}}},"pageContext":{"slug":"/blog/2020/01/18/abort-controller.html"}},"staticQueryHashes":[]}