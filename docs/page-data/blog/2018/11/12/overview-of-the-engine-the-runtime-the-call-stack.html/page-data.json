{"componentChunkName":"component---src-templates-blog-template-js","path":"/blog/2018/11/12/overview-of-the-engine-the-runtime-the-call-stack.html","result":{"data":{"markdownRemark":{"html":"<ul>\n<li>\n<p><a href=\"https://juejin.im/post/5c090bd9e51d45242973cad2\">JavaScript 如何工作系列: 引擎、运行时、调用栈概述</a></p>\n</li>\n<li>\n<p><a href=\"https://juejin.im/post/5a102e656fb9a044fd1158c6\">JavaScript 如何工作：在 V8 引擎里 5 个优化代码的技巧</a></p>\n</li>\n<li>\n<p><a href=\"https://juejin.im/post/5a2559ae6fb9a044fe4634ba\">JavaScript 工作原理：内存管理 + 处理常见的4种内存泄漏</a></p>\n</li>\n<li>\n<p><a href=\"https://juejin.im/post/5a221d35f265da43356291cc\">JavaScript 如何工作的: 事件循环和异步编程的崛起 + 5 个关于如何使用 async/await 编写更好的技巧</a></p>\n</li>\n<li>\n<p><a href=\"https://juejin.im/entry/5a731a955188257a6d634f3e\">Event Loop</a></p>\n</li>\n<li>\n<p><a href=\"https://zhuanlan.zhihu.com/p/55511602?utm_source=wechat_session&#x26;utm_medium=social&#x26;utm_oi=880452006622420992\">Event Loop in Node</a></p>\n</li>\n<li>\n<p><a href=\"https://github.com/xitu/gold-miner/blob/master/TODO/how-javascript-works-deep-dive-into-websockets-and-http-2-with-sse-how-to-pick-the-right-path.md\">JavaScript 是如何工作的：深入剖析 WebSockets 和拥有 SSE 技术 的 HTTP/2，以及如何在二者中做出正确的选择</a></p>\n</li>\n<li>\n<p><a href=\"https://github.com/xitu/gold-miner/blob/master/TODO1/how-javascript-works-the-rendering-engine-and-tips-to-optimize-its-performance.md\">JavaScript 是如何工作的：渲染引擎和性能优化技巧</a></p>\n</li>\n</ul>\n<p>JavaScript 越来越流行，在前端、后端、hybrid apps、嵌入式设备开发等方向上都有它活跃的身影。\r\n这篇文章是 How JavaScript Works 系列的开篇，该系列的文章旨在深入挖掘 JavaScript 及其实际的工作原理。我们认为了解 JavaScript 的构建块及其共同作用，可以帮助我们写出更优雅、更高效的代码和应用。\r\n正如 GitHut stats 所展示的一样，JavaScript 各方面的统计数据都是棒棒哒，顶多也就在个别统计项上落后了其他语言那么一丢丢。</p>\n<p>如果项目深度依赖 JavaScript，这意味着开发者需要对底层有极其深入的了解，并利用语言和生态提供的一切东西来构建出色的应用。</p>\n<p>然而，事实上，很多开发者虽然每天都在使用 JavaScript，却对其背后发生的事情一无所知。</p>\n<h3>概述</h3>\n<p>几乎每个人都听说过 V8 引擎的概念，大多数人也都知道 JavaScript 是一门单线程语言或者知道它是基于回调队列的。</p>\n<p>在这篇文章中，我们将详细的介绍这些概念并且解释 JavaScript 实际的运行方式，通过对这些细节的了解，你可以写出更好、无阻塞的应用。</p>\n<p>如果你是一名 JavaScript 新手，这篇文章将帮助你理解为什么 JavaScript 和其它语言对比起来显得那么\"奇怪\"。</p>\n<p>如果你是一名老司机，希望能够为你带来一些对 JavaScript 运行时的新思考。</p>\n<h3>JavaScript 引擎</h3>\n<p>说起 JavaScript 引擎，不得不提的就是 Google 的 V8 引擎，Chrome 和 Nodejs 内部也是使用的 V8。这里有一个简单的视图：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 920px; margin:0;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/4d5a7011a294a4858925defb02b2579c/4b2cc/V8.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 75.21739130434784%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABuklEQVQ4y5WS247SUBSGeScvfArjQxnjlRdeGG99BmKRqIWJnEKB4eAwDPawC4kQCgOdoRlbevhMy0DmxBT/ZGUna+39Zf1rrwzPKIqi7Xkbd3OHlEmD+e4U/CFshoSBkwp9Bhgkpzf/RPvHK3rF14Q33dtamA7c24uibYRb4Gr0no/vXvD5w0twT7f2o+De/VTg3S4c6wuW+oaF/hb/Rt/dJgzDJ6GZp+YWBME+Hmqz8fB9/9Gbgx16nkexIPMtL5GTvlIsFJLa1ZWNLMvk83my2SydTufeiB4BYwuxRiNBsaSg/vmL7VzSaDUYj8domkq73cZ1XRzHoVwus1gsDlveAccjQbV5zuQavq8kCh2ZyXiCIQx0Xd8/jOHz+TwdaOgGA12F4YDo9wUDYWAKgRACRVGwLIvpdHp8h8IwOBucQ+CCt2Goqntgs9lMILPZjEqlchzQNAX9/gVybZs3hZ7ATNOk1+uxXq+xbZt6vX4c0DAMTk5+0u5aWNYltVotgWmahiRJ9Pt9ut0uuVyO5XJ5GLhLxj/YUBTOfp3SarUSm/EqrVYrSqVSMsdqtZqsza6J1MX+Hz1c7H8aR3lqOw6ACgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"V8\"\n        title=\"V8\"\n        src=\"/static/4d5a7011a294a4858925defb02b2579c/c0255/V8.png\"\n        srcset=\"/static/4d5a7011a294a4858925defb02b2579c/81c8e/V8.png 230w,\n/static/4d5a7011a294a4858925defb02b2579c/08a84/V8.png 460w,\n/static/4d5a7011a294a4858925defb02b2579c/c0255/V8.png 920w,\n/static/4d5a7011a294a4858925defb02b2579c/4b2cc/V8.png 1013w\"\n        sizes=\"(max-width: 920px) 100vw, 920px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>就如JVM虚拟机一样，JS引擎中也有堆(Memory Heap)和栈(Call Stack)的概念。</p>\n<ul>\n<li>\n<p>栈-用来存储方法调用的地方，以及基础数据类型(如var a = 1)也是存储在栈里面的，会随着方法调用结束而自动销毁掉(入栈-->方法调用后-->出栈)。</p>\n</li>\n<li>\n<p>堆-JS引擎中给对象分配的内存空间是放在堆中的。如var foo = {name: 'foo'} 那么这个foo所指向的对象是存储在堆中的。</p>\n</li>\n</ul>\n<p>此外，JS中存在闭包的概念，对于基本类型变量如果存在与闭包当中，那么也将存储在堆中。详细可见此处1,3</p>\n<p>关于闭包的情况，就涉及到Captured Variables。我们知道Local Variables是最简单的情形，是直接存储在栈中的。而Captured Variables是对于存在闭包情况和with,try catch情况的变量。</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">foo</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">var</span> x<span class=\"token punctuation\">;</span> <span class=\"token comment\">// local variables</span>\r\n  <span class=\"token keyword\">var</span> y<span class=\"token punctuation\">;</span> <span class=\"token comment\">// captured variable, bar中引用了y</span>\r\n\r\n  <span class=\"token keyword\">function</span> <span class=\"token function\">bar</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token comment\">// bar 中的context会capture变量y</span>\r\n    <span class=\"token function\">use</span><span class=\"token punctuation\">(</span>y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token punctuation\">}</span>\r\n\r\n  <span class=\"token keyword\">return</span> bar<span class=\"token punctuation\">;</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>复制代码如上述情况，变量y存在与bar()的闭包中，因此y是captured variable，是存储在堆中的。</p>\n<h3>RunTime</h3>\n<p>JS在浏览器中可以调用浏览器提供的API，如window对象，DOM相关API等。这些接口并不是由V8引擎提供的，是存在与浏览器当中的。因此简单来说，对于这些相关的外部接口，可以在运行时供JS调用，以及JS的事件循环(Event Loop)和事件队列(Callback Queue)，把这些称为RunTime。有些地方也把JS所用到的core lib核心库也看作RunTime的一部分。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 920px; margin:0;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/b8b9d51ed2ef32832a63c4430eb8a323/d7ab4/RunTime.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 74.78260869565217%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAClElEQVQ4y5VUXWvTYBTOX/FniXfeiTAQQXAORMGvm4mX4nYjbCDere3GZB9dF5olTWfSpu0y2nRZdW2XtE2TurXLxyPn7RJa8UIPHM57DjnP+5yPNxz+Q6IomjvHLtmQ+RG4yWQC13XheV6iruvN+aRhGM4AxcAhouiG2Vi4vb095PN5SJIEURQhShKKxQJEcerLsgz6plQqsYQgoOQIfSdE3RigXPmJpumga4X4dRWCKxaLs0VhYn3ED+0Jois+iRJDRVHmyn+53MP9R5dYWOrh4VMLdx+0kROuwBGDwPfhB4TnQs3ew/vnd9CuryZl2bbNGPb7fahqCYPBJVbXR1hYusTiaxtL72w8fmFBVq7BFQqFOYZu5wssYxk33nESnQKp8H0fjjMEohusrLtYfGMzpq8+9PHsrY1iaQyOSqGE83MTZ+YZxuNpg73RNXT9BKZpJgxnJfVthJX1IT5/dZl+WhtCb0zA8YeHyAsCRLEARfoOVVHgug6OjgQ2ENJsNgtN026nHM6tz5/CZdIbkI5rMDygMBQhH8swGgaazWby0fb2Nit5dheDIILvR/CDW/UjhGEELp1K4aRhAGcmWg0Zaq2Kc9NEuVzGYDBAr9fD1tZWUnIM+DeWbLHT6TROTk8BxwXca5Q0jfWNGFmWhW63i83NzYQhLXi83EEQMJ2NcanUBmo1HXmFZgyUSyoMw2AMh8MhGxgB0r7SmS4hEBJiTwOj2Hg8nvZwd3cXgiBA03RUtAobAgEdHBywM61VJpNBtVplF5Gl5Hq9zlTXdWYrlQq7kAHyPA+ezyGXy7EnSOVRbH9/n8V2dnYQr1en02ElXlxcoN1uM0uxVqvFXhQ3Go1Y84kVaTwIx3HmYvQT+Rf5DV48TG9FPDlhAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"V8\"\n        title=\"V8\"\n        src=\"/static/b8b9d51ed2ef32832a63c4430eb8a323/c0255/RunTime.png\"\n        srcset=\"/static/b8b9d51ed2ef32832a63c4430eb8a323/81c8e/RunTime.png 230w,\n/static/b8b9d51ed2ef32832a63c4430eb8a323/08a84/RunTime.png 460w,\n/static/b8b9d51ed2ef32832a63c4430eb8a323/c0255/RunTime.png 920w,\n/static/b8b9d51ed2ef32832a63c4430eb8a323/d7ab4/RunTime.png 1014w\"\n        sizes=\"(max-width: 920px) 100vw, 920px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>同样，在Node.js中，可以把Node的各种库提供的API称为RunTime。所以可以这么理解，Chrome和Node.js都采用相同的V8引擎，但拥有不同的运行环境(RunTime Environments)</p>\n<h3>Call Stack</h3>\n<p>JS被设计为单线程运行的，这是因为JS主要用来实现很多交互相关的操作，如DOM相关操作，如果是多线程会造成复杂的同步问题(例如当两个线程同时操作同一个DOM元素的时候该如何处理)。因此JS自诞生以来就是单线程的，而且主线程都是用来进行界面相关的渲染操作 (为什么说是主线程，因为HTML5 提供了Web Worker，独立的一个后台JS，用来处理一些耗时数据操作。因为不会修改相关DOM及页面元素，因此不影响页面性能)，如果有阻塞产生会导致浏览器卡死。</p>\n<p>如果一个递归调用没有终止条件，是一个死循环的话，会导致调用栈内存不够而溢出，如：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">foo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token function\">foo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token punctuation\">}</span>\r\n<span class=\"token function\">foo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>例子中foo函数循环调用其本身，且没有终止条件，浏览器控制台输出调用栈达到最大调用次数。</p>\n<p>JS线程如果遇到比较耗时操作，如读取文件，AJAX请求操作怎么办？这里JS用到了Callback回调函数来处理。\r\n对于Call Stack中的每个方法调用，都会形成它自己的一个执行上下文Execution Context，关于执行上下文的详细阐述请看<a href=\"https://juejin.im/post/5a5ee28f6fb9a01cbe655860\">这篇文章</a></p>","excerpt":"JavaScript 如何工作系列: 引擎、运行时、调用栈概述 JavaScript 如何工作：在 V8 引擎里 5 个优化代码的技巧 JavaScript 工作原理：内存管理 + 处理常见的4种内存泄漏 JavaScript 如何工作的: 事件循环和异步编程的崛起 + 5 个关于如何使用 async/await 编写更好的技巧 Event Loop Event Loop in Node JavaScript 是如何工作的：深入剖析 WebSockets 和拥有 SSE 技术 的 HTTP/…","fields":{"slug":"/blog/2018/11/12/overview-of-the-engine-the-runtime-the-call-stack.html","date":"November 11, 2018"},"frontmatter":{"title":"How JavaScript Work: 引擎、运行时、调用栈概述","img":"./img/2015-03-25.jpg","author":["Sylvenas"],"categories":"JavaScript"}}},"pageContext":{"slug":"/blog/2018/11/12/overview-of-the-engine-the-runtime-the-call-stack.html"}},"staticQueryHashes":[]}